"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Mike = void 0;

require("source-map-support/register");

var _teen_process = require("teen_process");

var _logger = _interopRequireDefault(require("./logger"));

const DEFAULT_REMOTE = 'origin';
const DEFAULT_BRANCH = 'gh-pages';
const MIKE_VER_STRING = 'mike 1.';

class Mike {
  remote;
  branch;
  prefix;
  configFile;
  _mikeVerified = false;

  constructor(opts) {
    this.remote = opts.remote || DEFAULT_REMOTE;
    this.branch = opts.branch || DEFAULT_BRANCH;
    this.prefix = opts.prefix;
    this.configFile = opts.configFile;
  }

  async verifyMike() {
    if (this._mikeVerified) {
      return;
    }

    try {
      const {
        stdout
      } = await this.exec('--version', [], false);

      if (!stdout.includes(MIKE_VER_STRING)) {
        throw new Error('Mike was installed but was not version 1.x');
      }
    } catch (err) {
      throw new Error(`Could not verify appropriate mike binary exists: ${err}`);
    }

    this._mikeVerified = true;
  }

  getMikeArgs(cmdName, cmdArgs) {
    return [cmdName, ...cmdArgs, '--config-file', this.configFile, '--remote', this.remote, '--branch', this.branch, '--prefix', this.prefix];
  }

  async exec(mikeCmd, mikeArgs = [], verify = true) {
    if (verify) {
      await this.verifyMike();
    }

    const args = this.getMikeArgs(mikeCmd, mikeArgs);

    _logger.default.debug(`Running mike ${args.join(' ')}`);

    return await (0, _teen_process.exec)('mike', args);
  }

  async list() {
    const {
      stdout
    } = await this.exec('list');
    return stdout.split('\n').map(s => s.trim()).filter(Boolean);
  }

  async setDefault(alias) {
    await this.exec('set-default', [alias]);
  }

  async deploy(opts) {
    const args = [opts.version];

    if (opts.alias) {
      args.push(opts.alias, '--update-aliases');
    }

    if (opts.shouldPush) {
      args.push('--push');
    }

    if (opts.shouldRebase) {
      args.push('--rebase');
    }

    if (opts.commit) {
      args.push('--message', opts.commit);
    }

    await this.exec('deploy', args);
  }

}

exports.Mike = Mike;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJERUZBVUxUX1JFTU9URSIsIkRFRkFVTFRfQlJBTkNIIiwiTUlLRV9WRVJfU1RSSU5HIiwiTWlrZSIsInJlbW90ZSIsImJyYW5jaCIsInByZWZpeCIsImNvbmZpZ0ZpbGUiLCJfbWlrZVZlcmlmaWVkIiwiY29uc3RydWN0b3IiLCJvcHRzIiwidmVyaWZ5TWlrZSIsInN0ZG91dCIsImV4ZWMiLCJpbmNsdWRlcyIsIkVycm9yIiwiZXJyIiwiZ2V0TWlrZUFyZ3MiLCJjbWROYW1lIiwiY21kQXJncyIsIm1pa2VDbWQiLCJtaWtlQXJncyIsInZlcmlmeSIsImFyZ3MiLCJsb2ciLCJkZWJ1ZyIsImpvaW4iLCJsaXN0Iiwic3BsaXQiLCJtYXAiLCJzIiwidHJpbSIsImZpbHRlciIsIkJvb2xlYW4iLCJzZXREZWZhdWx0IiwiYWxpYXMiLCJkZXBsb3kiLCJ2ZXJzaW9uIiwicHVzaCIsInNob3VsZFB1c2giLCJzaG91bGRSZWJhc2UiLCJjb21taXQiXSwic291cmNlcyI6WyIuLi8uLi9saWIvbWlrZS5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBleGVjIH0gZnJvbSAndGVlbl9wcm9jZXNzJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuXG5jb25zdCBERUZBVUxUX1JFTU9URSA9ICdvcmlnaW4nO1xuY29uc3QgREVGQVVMVF9CUkFOQ0ggPSAnZ2gtcGFnZXMnO1xuY29uc3QgTUlLRV9WRVJfU1RSSU5HID0gJ21pa2UgMS4nO1xuXG5leHBvcnQgY2xhc3MgTWlrZSB7XG4gIC8qKiBAdHlwZSBzdHJpbmcgKi8gcmVtb3RlO1xuICAvKiogQHR5cGUgc3RyaW5nICovIGJyYW5jaDtcbiAgLyoqIEB0eXBlIHN0cmluZz8gKi8gcHJlZml4O1xuICAvKiogQHR5cGUgc3RyaW5nICovIGNvbmZpZ0ZpbGU7XG4gIC8qKiBAdHlwZSBib29sZWFuICovIF9taWtlVmVyaWZpZWQgPSBmYWxzZTtcblxuICBjb25zdHJ1Y3RvciAoLyoqIEB0eXBlIE1pa2VPcHRzICovb3B0cykge1xuICAgIHRoaXMucmVtb3RlID0gb3B0cy5yZW1vdGUgfHwgREVGQVVMVF9SRU1PVEU7XG4gICAgdGhpcy5icmFuY2ggPSBvcHRzLmJyYW5jaCB8fCBERUZBVUxUX0JSQU5DSDtcbiAgICB0aGlzLnByZWZpeCA9IG9wdHMucHJlZml4O1xuICAgIHRoaXMuY29uZmlnRmlsZSA9IG9wdHMuY29uZmlnRmlsZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUaHJvdyBhbiBlcnJvciBpZiB0aGUgJ21pa2UnIGJpbmFyeSBjYW5ub3QgYmUgZm91bmRcbiAgICpcbiAgICogQHRocm93cyBFcnJvclxuICAgKi9cbiAgYXN5bmMgdmVyaWZ5TWlrZSAoKSB7XG4gICAgaWYgKHRoaXMuX21pa2VWZXJpZmllZCkge1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICB0cnkge1xuICAgICAgY29uc3Qge3N0ZG91dH0gPSBhd2FpdCB0aGlzLmV4ZWMoJy0tdmVyc2lvbicsIFtdLCBmYWxzZSk7XG4gICAgICBpZiAoIXN0ZG91dC5pbmNsdWRlcyhNSUtFX1ZFUl9TVFJJTkcpKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignTWlrZSB3YXMgaW5zdGFsbGVkIGJ1dCB3YXMgbm90IHZlcnNpb24gMS54Jyk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCB2ZXJpZnkgYXBwcm9wcmlhdGUgbWlrZSBiaW5hcnkgZXhpc3RzOiAke2Vycn1gKTtcbiAgICB9XG4gICAgdGhpcy5fbWlrZVZlcmlmaWVkID0gdHJ1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgYW4gYXJyYXkgb2YgYXJncyBiYXNlZCBvbiB0aGUgY2xhc3MgbWVtYmVycyB0aGF0IGNhbiBiZSB1c2VkIHdpdGggTWlrZS1yZWxhdGVkIHN1YnByb2Nlc3NcbiAgICogZXhlY3V0aW9uXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBjbWROYW1lIC0gdGhlIG5hbWUgb2YgdGhlIG1pa2UgY29tbWFuZCB0byBydW5cbiAgICogQHBhcmFtIHtzdHJpbmdbXX0gY21kQXJncyAtIGFuIGFycmF5IG9mIGNvbW1hbmQtc3BlY2lmaWMgYXJndW1lbnRzXG4gICAqXG4gICAqIEByZXR1cm5zIHN0cmluZ1tdXG4gICAqL1xuICBnZXRNaWtlQXJncyAoY21kTmFtZSwgY21kQXJncykge1xuICAgIHJldHVybiBbXG4gICAgICBjbWROYW1lLCAuLi5jbWRBcmdzLFxuICAgICAgJy0tY29uZmlnLWZpbGUnLCB0aGlzLmNvbmZpZ0ZpbGUsXG4gICAgICAnLS1yZW1vdGUnLCB0aGlzLnJlbW90ZSxcbiAgICAgICctLWJyYW5jaCcsIHRoaXMuYnJhbmNoLFxuICAgICAgJy0tcHJlZml4JywgdGhpcy5wcmVmaXgsXG4gICAgXTtcbiAgfVxuXG4gIC8qKlxuICAgKiBFeGVjIG1pa2UgYXMgYSBzdWJwcm9jZXNzXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBtaWtlQ21kIC0gdGhlIG1pa2UgY29tbWFuZCB0byBydW5cbiAgICogQHBhcmFtIHtzdHJpbmdbXX0gW21pa2VBcmdzPVtdXSAtIHRoZSBhcmd1bWVudHMgdG8gcGFzcyB0byB0aGUgbWlrZSBjb21tYW5kXG4gICAqIEBwYXJhbSB7Ym9vbGVhbj99IFt2ZXJpZnk9dHJ1ZV0gLSB3aGV0aGVyIHRvIHZlcmlmeSBtaWtlIGV4aXN0cyBmaXJzdFxuICAgKlxuICAgKiBAcmV0dXJucyBQcm9taXNlPGltcG9ydCgndGVlbl9wcm9jZXNzJykuRXhlY1Jlc3VsdDxzdHJpbmc+PlxuICAgKi9cbiAgYXN5bmMgZXhlYyAobWlrZUNtZCwgbWlrZUFyZ3MgPSBbXSwgdmVyaWZ5ID0gdHJ1ZSkge1xuICAgIGlmICh2ZXJpZnkpIHtcbiAgICAgIGF3YWl0IHRoaXMudmVyaWZ5TWlrZSgpO1xuICAgIH1cbiAgICBjb25zdCBhcmdzID0gdGhpcy5nZXRNaWtlQXJncyhtaWtlQ21kLCBtaWtlQXJncyk7XG4gICAgbG9nLmRlYnVnKGBSdW5uaW5nIG1pa2UgJHthcmdzLmpvaW4oJyAnKX1gKTtcbiAgICByZXR1cm4gYXdhaXQgZXhlYygnbWlrZScsIGFyZ3MpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybiB0aGUgbGlzdCBvZiBtaWtlIGRlcGxveXNcbiAgICpcbiAgICogQHJldHVybnMgc3RyaW5nW11cbiAgICovXG4gIGFzeW5jIGxpc3QgKCkge1xuICAgIGNvbnN0IHtzdGRvdXR9ID0gYXdhaXQgdGhpcy5leGVjKCdsaXN0Jyk7XG4gICAgcmV0dXJuIHN0ZG91dC5zcGxpdCgnXFxuJykubWFwKChzKSA9PiBzLnRyaW0oKSkuZmlsdGVyKEJvb2xlYW4pO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldCB0aGUgZGVmYXVsdCB2ZXJzaW9uIG9yIGFsaWFzXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBhbGlhcyAtIHRoZSB2ZXJzaW9uIG9yIGFsaWFzXG4gICAqL1xuICBhc3luYyBzZXREZWZhdWx0IChhbGlhcykge1xuICAgIGF3YWl0IHRoaXMuZXhlYygnc2V0LWRlZmF1bHQnLCBbYWxpYXNdKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBEZXBsb3kgZG9jcyB0byB0aGUgYnJhbmNoXG4gICAqXG4gICAqIEBwYXJhbSB7TWlrZURlcGxveU9wdHN9IG9wdHMgLSB0aGUgZGVwbG95IG9wdGlvbnNcbiAgICovXG4gIGFzeW5jIGRlcGxveSAob3B0cykge1xuICAgIGNvbnN0IGFyZ3MgPSBbb3B0cy52ZXJzaW9uXTtcbiAgICBpZiAob3B0cy5hbGlhcykge1xuICAgICAgYXJncy5wdXNoKG9wdHMuYWxpYXMsICctLXVwZGF0ZS1hbGlhc2VzJyk7XG4gICAgfVxuICAgIGlmIChvcHRzLnNob3VsZFB1c2gpIHtcbiAgICAgIGFyZ3MucHVzaCgnLS1wdXNoJyk7XG4gICAgfVxuICAgIGlmIChvcHRzLnNob3VsZFJlYmFzZSkge1xuICAgICAgYXJncy5wdXNoKCctLXJlYmFzZScpO1xuICAgIH1cbiAgICBpZiAob3B0cy5jb21taXQpIHtcbiAgICAgIGFyZ3MucHVzaCgnLS1tZXNzYWdlJywgb3B0cy5jb21taXQpO1xuICAgIH1cbiAgICBhd2FpdCB0aGlzLmV4ZWMoJ2RlcGxveScsIGFyZ3MpO1xuICB9XG5cbn1cblxuLyoqXG4gKiBAdHlwZWRlZiBNaWtlT3B0cyAtIG9wdGlvbnMgZm9yIGluc3RhbnRpYXRpbmcgYSBNaWtlIG9iamVjdFxuICogQHByb3BlcnR5IHtzdHJpbmd9IFtyZW1vdGU9XCJvcmlnaW5cIl0gLSB0aGUgZ2l0IHJlbW90ZSB0byBwdXNoIGRvY3MgdG9cbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbYnJhbmNoPVwiZ2gtcGFnZXNcIl0gLSB0aGUgZ2l0IGJyYW5jaCB0byBwdXNoIGRvY3MgdG9cbiAqIEBwcm9wZXJ0eSB7c3RyaW5nP30gcHJlZml4IC0gdGhlIHBhdGggcHJlZml4IG9uIHRoZSBicmFuY2ggaWYgYW55XG4gKiBAcHJvcGVydHkge3N0cmluZ30gY29uZmlnRmlsZSAtIHRoZSBta2RvY3MgY29uZmlnIGZpbGUgdG8gdXNlXG4gKi9cblxuLyoqXG4gKiBAdHlwZWRlZiBNaWtlRGVwbG95T3B0cyAtIG9wdGlvbnMgZm9yIGRlcGxveWluZyBkb2NzIHdpdGggTWlrZVxuICogQHBhcmFtIHtzdHJpbmd9IHZlcnNpb24gLSB0aGUgdmVyc2lvbiB0byBkZXBsb3lcbiAqIEBwYXJhbSB7c3RyaW5nP30gYWxpYXMgLSB0aGUgYWxpYXMgdG8gYWxpYXMgKG9yIHJlLWFsaWFzKSB0aGUgdmVyc2lvblxuICogQHBhcmFtIHtzdHJpbmc/fSBjb21taXQgLSB0aGUgY29tbWl0IG1lc3NhZ2UgdG8gdXNlIGFzIGFuIG92ZXJyaWRlXG4gKiBAcGFyYW0ge2Jvb2xlYW4/fSBzaG91bGRQdXNoIC0gd2hldGhlciBtaWtlIHNob3VsZCBwdXNoIHRoZSBjb21taXRzIHRvIHRoZSByZW1vdGVcbiAqIEBwYXJhbSB7Ym9vbGVhbj99IHNob3VsZFJlYmFzZSAtIHdoZXRoZXIgbWlrZSBzaG91bGQgcmViYXNlXG4gKi9cbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFB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