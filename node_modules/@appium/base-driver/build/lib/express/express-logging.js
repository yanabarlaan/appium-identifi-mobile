"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.startLogFormatter = exports.endLogFormatter = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

require("@colors/colors");

var _morgan = _interopRequireDefault(require("morgan"));

var _logger = _interopRequireDefault(require("./logger"));

var _constants = require("../constants");

function compile(fmt) {
  fmt = fmt.replace(/"/g, '\\"');
  fmt = fmt.replace(/:([-\w]{2,})(?:\[([^\]]+)\])?/g, function replace(_, name, arg) {
    return `"\n    + (tokens["${name}"](req, res, "${arg}") || "-") + "`;
  });
  let js = `  return "${fmt}";`;
  return new Function('tokens, req, res', js);
}

function requestEndLoggingFormat(tokens, req, res) {
  let status = res.statusCode;
  let statusStr = ':status';

  if (status >= 500) {
    statusStr = statusStr.red;
  } else if (status >= 400) {
    statusStr = statusStr.yellow;
  } else if (status >= 300) {
    statusStr = statusStr.cyan;
  } else {
    statusStr = statusStr.green;
  }

  let fn = compile(`${'<-- :method :url '.white}${statusStr} ${':response-time ms - :res[content-length]'.grey}`);
  return fn(tokens, req, res);
}

const endLogFormatter = (0, _morgan.default)((tokens, req, res) => {
  _logger.default.info(requestEndLoggingFormat(tokens, req, res), (res.jsonResp || '').grey);
});
exports.endLogFormatter = endLogFormatter;
const requestStartLoggingFormat = compile(`${'-->'.white} ${':method'.white} ${':url'.white}`);
const startLogFormatter = (0, _morgan.default)((tokens, req, res) => {
  let reqBody = '';

  if (req.body) {
    try {
      reqBody = _lodash.default.truncate(_lodash.default.isString(req.body) ? req.body : JSON.stringify(req.body), {
        length: _constants.MAX_LOG_BODY_LENGTH
      });
    } catch (ign) {}
  }

  _logger.default.info(requestStartLoggingFormat(tokens, req, res), reqBody.grey);
}, {
  immediate: true
});
exports.startLogFormatter = startLogFormatter;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJjb21waWxlIiwiZm10IiwicmVwbGFjZSIsIl8iLCJuYW1lIiwiYXJnIiwianMiLCJGdW5jdGlvbiIsInJlcXVlc3RFbmRMb2dnaW5nRm9ybWF0IiwidG9rZW5zIiwicmVxIiwicmVzIiwic3RhdHVzIiwic3RhdHVzQ29kZSIsInN0YXR1c1N0ciIsInJlZCIsInllbGxvdyIsImN5YW4iLCJncmVlbiIsImZuIiwid2hpdGUiLCJncmV5IiwiZW5kTG9nRm9ybWF0dGVyIiwibG9nIiwiaW5mbyIsImpzb25SZXNwIiwicmVxdWVzdFN0YXJ0TG9nZ2luZ0Zvcm1hdCIsInN0YXJ0TG9nRm9ybWF0dGVyIiwicmVxQm9keSIsImJvZHkiLCJ0cnVuY2F0ZSIsImlzU3RyaW5nIiwiSlNPTiIsInN0cmluZ2lmeSIsImxlbmd0aCIsIk1BWF9MT0dfQk9EWV9MRU5HVEgiLCJpZ24iLCJpbW1lZGlhdGUiXSwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvZXhwcmVzcy9leHByZXNzLWxvZ2dpbmcuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCAnQGNvbG9ycy9jb2xvcnMnO1xuaW1wb3J0IG1vcmdhbiBmcm9tICdtb3JnYW4nO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgeyBNQVhfTE9HX0JPRFlfTEVOR1RIIH0gZnJvbSAnLi4vY29uc3RhbnRzJztcblxuXG4vLyBDb3BpZWQgdGhlIG1vcmdhbiBjb21waWxlIGZ1bmN0aW9uIG92ZXIgc28gdGhhdCBjb29sZXIgZm9ybWF0c1xuLy8gbWF5IGJlIGNvbmZpZ3VyZWRcbmZ1bmN0aW9uIGNvbXBpbGUgKGZtdCkge1xuICAvLyBlc2NhcGUgcXVvdGVzXG4gIGZtdCA9IGZtdC5yZXBsYWNlKC9cIi9nLCAnXFxcXFwiJyk7XG4gIGZtdCA9IGZtdC5yZXBsYWNlKC86KFstXFx3XXsyLH0pKD86XFxbKFteXFxdXSspXFxdKT8vZyxcbiAgICBmdW5jdGlvbiByZXBsYWNlIChfLCBuYW1lLCBhcmcpIHtcbiAgICAgIHJldHVybiBgXCJcXG4gICAgKyAodG9rZW5zW1wiJHtuYW1lfVwiXShyZXEsIHJlcywgXCIke2FyZ31cIikgfHwgXCItXCIpICsgXCJgO1xuICAgIH0pO1xuICBsZXQganMgPSBgICByZXR1cm4gXCIke2ZtdH1cIjtgO1xuICByZXR1cm4gbmV3IEZ1bmN0aW9uKCd0b2tlbnMsIHJlcSwgcmVzJywganMpO1xufVxuXG5mdW5jdGlvbiByZXF1ZXN0RW5kTG9nZ2luZ0Zvcm1hdCAodG9rZW5zLCByZXEsIHJlcykge1xuICBsZXQgc3RhdHVzID0gcmVzLnN0YXR1c0NvZGU7XG4gIGxldCBzdGF0dXNTdHIgPSAnOnN0YXR1cyc7XG4gIGlmIChzdGF0dXMgPj0gNTAwKSB7XG4gICAgc3RhdHVzU3RyID0gc3RhdHVzU3RyLnJlZDtcbiAgfSBlbHNlIGlmIChzdGF0dXMgPj0gNDAwKSB7XG4gICAgc3RhdHVzU3RyID0gc3RhdHVzU3RyLnllbGxvdztcbiAgfSBlbHNlIGlmIChzdGF0dXMgPj0gMzAwKSB7XG4gICAgc3RhdHVzU3RyID0gc3RhdHVzU3RyLmN5YW47XG4gIH0gZWxzZSB7XG4gICAgc3RhdHVzU3RyID0gc3RhdHVzU3RyLmdyZWVuO1xuICB9XG4gIGxldCBmbiA9IGNvbXBpbGUoYCR7JzwtLSA6bWV0aG9kIDp1cmwgJy53aGl0ZX0ke3N0YXR1c1N0cn0gJHsnOnJlc3BvbnNlLXRpbWUgbXMgLSA6cmVzW2NvbnRlbnQtbGVuZ3RoXScuZ3JleX1gKTtcbiAgcmV0dXJuIGZuKHRva2VucywgcmVxLCByZXMpO1xufVxuXG5jb25zdCBlbmRMb2dGb3JtYXR0ZXIgPSBtb3JnYW4oKHRva2VucywgcmVxLCByZXMpID0+IHtcbiAgbG9nLmluZm8ocmVxdWVzdEVuZExvZ2dpbmdGb3JtYXQodG9rZW5zLCByZXEsIHJlcyksXG4gICAgKHJlcy5qc29uUmVzcCB8fCAnJykuZ3JleSk7XG59KTtcblxuY29uc3QgcmVxdWVzdFN0YXJ0TG9nZ2luZ0Zvcm1hdCA9IGNvbXBpbGUoYCR7Jy0tPicud2hpdGV9ICR7JzptZXRob2QnLndoaXRlfSAkeyc6dXJsJy53aGl0ZX1gKTtcblxuY29uc3Qgc3RhcnRMb2dGb3JtYXR0ZXIgPSBtb3JnYW4oKHRva2VucywgcmVxLCByZXMpID0+IHtcbiAgLy8gbW9yZ2FuIG91dHB1dCBpcyByZWRpcmVjdGVkIHN0cmFpZ2h0IHRvIHdpbnN0b25cbiAgbGV0IHJlcUJvZHkgPSAnJztcbiAgaWYgKHJlcS5ib2R5KSB7XG4gICAgdHJ5IHtcbiAgICAgIHJlcUJvZHkgPSBfLnRydW5jYXRlKF8uaXNTdHJpbmcocmVxLmJvZHkpID8gcmVxLmJvZHkgOiBKU09OLnN0cmluZ2lmeShyZXEuYm9keSksIHtcbiAgICAgICAgbGVuZ3RoOiBNQVhfTE9HX0JPRFlfTEVOR1RILFxuICAgICAgfSk7XG4gICAgfSBjYXRjaCAoaWduKSB7fVxuICB9XG4gIGxvZy5pbmZvKHJlcXVlc3RTdGFydExvZ2dpbmdGb3JtYXQodG9rZW5zLCByZXEsIHJlcyksIHJlcUJvZHkuZ3JleSk7XG59LCB7aW1tZWRpYXRlOiB0cnVlfSk7XG5cbmV4cG9ydCB7IGVuZExvZ0Zvcm1hdHRlciwgc3RhcnRMb2dGb3JtYXR0ZXIgfTtcbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFLQSxTQUFTQSxPQUFULENBQWtCQyxHQUFsQixFQUF1QjtFQUVyQkEsR0FBRyxHQUFHQSxHQUFHLENBQUNDLE9BQUosQ0FBWSxJQUFaLEVBQWtCLEtBQWxCLENBQU47RUFDQUQsR0FBRyxHQUFHQSxHQUFHLENBQUNDLE9BQUosQ0FBWSxnQ0FBWixFQUNKLFNBQVNBLE9BQVQsQ0FBa0JDLENBQWxCLEVBQXFCQyxJQUFyQixFQUEyQkMsR0FBM0IsRUFBZ0M7SUFDOUIsT0FBUSxxQkFBb0JELElBQUssaUJBQWdCQyxHQUFJLGdCQUFyRDtFQUNELENBSEcsQ0FBTjtFQUlBLElBQUlDLEVBQUUsR0FBSSxhQUFZTCxHQUFJLElBQTFCO0VBQ0EsT0FBTyxJQUFJTSxRQUFKLENBQWEsa0JBQWIsRUFBaUNELEVBQWpDLENBQVA7QUFDRDs7QUFFRCxTQUFTRSx1QkFBVCxDQUFrQ0MsTUFBbEMsRUFBMENDLEdBQTFDLEVBQStDQyxHQUEvQyxFQUFvRDtFQUNsRCxJQUFJQyxNQUFNLEdBQUdELEdBQUcsQ0FBQ0UsVUFBakI7RUFDQSxJQUFJQyxTQUFTLEdBQUcsU0FBaEI7O0VBQ0EsSUFBSUYsTUFBTSxJQUFJLEdBQWQsRUFBbUI7SUFDakJFLFNBQVMsR0FBR0EsU0FBUyxDQUFDQyxHQUF0QjtFQUNELENBRkQsTUFFTyxJQUFJSCxNQUFNLElBQUksR0FBZCxFQUFtQjtJQUN4QkUsU0FBUyxHQUFHQSxTQUFTLENBQUNFLE1BQXRCO0VBQ0QsQ0FGTSxNQUVBLElBQUlKLE1BQU0sSUFBSSxHQUFkLEVBQW1CO0lBQ3hCRSxTQUFTLEdBQUdBLFNBQVMsQ0FBQ0csSUFBdEI7RUFDRCxDQUZNLE1BRUE7SUFDTEgsU0FBUyxHQUFHQSxTQUFTLENBQUNJLEtBQXRCO0VBQ0Q7O0VBQ0QsSUFBSUMsRUFBRSxHQUFHbkIsT0FBTyxDQUFFLEdBQUUsb0JBQW9Cb0IsS0FBTSxHQUFFTixTQUFVLElBQUcsMkNBQTJDTyxJQUFLLEVBQTdGLENBQWhCO0VBQ0EsT0FBT0YsRUFBRSxDQUFDVixNQUFELEVBQVNDLEdBQVQsRUFBY0MsR0FBZCxDQUFUO0FBQ0Q7O0FBRUQsTUFBTVcsZUFBZSxHQUFHLHFCQUFPLENBQUNiLE1BQUQsRUFBU0MsR0FBVCxFQUFjQyxHQUFkLEtBQXNCO0VBQ25EWSxnQkFBSUMsSUFBSixDQUFTaEIsdUJBQXVCLENBQUNDLE1BQUQsRUFBU0MsR0FBVCxFQUFjQyxHQUFkLENBQWhDLEVBQ0UsQ0FBQ0EsR0FBRyxDQUFDYyxRQUFKLElBQWdCLEVBQWpCLEVBQXFCSixJQUR2QjtBQUVELENBSHVCLENBQXhCOztBQUtBLE1BQU1LLHlCQUF5QixHQUFHMUIsT0FBTyxDQUFFLEdBQUUsTUFBTW9CLEtBQU0sSUFBRyxVQUFVQSxLQUFNLElBQUcsT0FBT0EsS0FBTSxFQUFuRCxDQUF6QztBQUVBLE1BQU1PLGlCQUFpQixHQUFHLHFCQUFPLENBQUNsQixNQUFELEVBQVNDLEdBQVQsRUFBY0MsR0FBZCxLQUFzQjtFQUVyRCxJQUFJaUIsT0FBTyxHQUFHLEVBQWQ7O0VBQ0EsSUFBSWxCLEdBQUcsQ0FBQ21CLElBQVIsRUFBYztJQUNaLElBQUk7TUFDRkQsT0FBTyxHQUFHekIsZ0JBQUUyQixRQUFGLENBQVczQixnQkFBRTRCLFFBQUYsQ0FBV3JCLEdBQUcsQ0FBQ21CLElBQWYsSUFBdUJuQixHQUFHLENBQUNtQixJQUEzQixHQUFrQ0csSUFBSSxDQUFDQyxTQUFMLENBQWV2QixHQUFHLENBQUNtQixJQUFuQixDQUE3QyxFQUF1RTtRQUMvRUssTUFBTSxFQUFFQztNQUR1RSxDQUF2RSxDQUFWO0lBR0QsQ0FKRCxDQUlFLE9BQU9DLEdBQVAsRUFBWSxDQUFFO0VBQ2pCOztFQUNEYixnQkFBSUMsSUFBSixDQUFTRSx5QkFBeUIsQ0FBQ2pCLE1BQUQsRUFBU0MsR0FBVCxFQUFjQyxHQUFkLENBQWxDLEVBQXNEaUIsT0FBTyxDQUFDUCxJQUE5RDtBQUNELENBWHlCLEVBV3ZCO0VBQUNnQixTQUFTLEVBQUU7QUFBWixDQVh1QixDQUExQiJ9