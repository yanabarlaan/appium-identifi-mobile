"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.JWProxy = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _support = require("@appium/support");

var _axios = _interopRequireDefault(require("axios"));

var _status = require("../jsonwp-status/status");

var _errors = require("../protocol/errors");

var _protocol = require("../protocol");

var _constants = require("../constants");

var _protocolConverter = _interopRequireDefault(require("./protocol-converter"));

var _helpers = require("../protocol/helpers");

var _http = _interopRequireDefault(require("http"));

var _https = _interopRequireDefault(require("https"));

const DEFAULT_LOG = _support.logger.getLogger('WD Proxy');

const DEFAULT_REQUEST_TIMEOUT = 240000;
const COMPACT_ERROR_PATTERNS = [/\bECONNREFUSED\b/, /socket hang up/];
const {
  MJSONWP,
  W3C
} = _constants.PROTOCOLS;

class JWProxy {
  constructor(opts = {}) {
    var _opts$keepAlive;

    _lodash.default.defaults(this, opts, {
      scheme: 'http',
      server: 'localhost',
      port: 4444,
      base: _constants.DEFAULT_BASE_PATH,
      reqBasePath: _constants.DEFAULT_BASE_PATH,
      sessionId: null,
      timeout: DEFAULT_REQUEST_TIMEOUT
    });

    this.scheme = this.scheme.toLowerCase();
    this._activeRequests = [];
    this._downstreamProtocol = null;
    const agentOpts = {
      keepAlive: (_opts$keepAlive = opts.keepAlive) !== null && _opts$keepAlive !== void 0 ? _opts$keepAlive : true,
      maxSockets: 10,
      maxFreeSockets: 5
    };
    this.httpAgent = new _http.default.Agent(agentOpts);
    this.httpsAgent = new _https.default.Agent(agentOpts);
    this.protocolConverter = new _protocolConverter.default(this.proxy.bind(this), opts.log);
    this._log = opts.log;
  }

  get log() {
    var _this$_log;

    return (_this$_log = this._log) !== null && _this$_log !== void 0 ? _this$_log : DEFAULT_LOG;
  }

  async request(requestConfig) {
    const reqPromise = (0, _axios.default)(requestConfig);

    this._activeRequests.push(reqPromise);

    try {
      return await reqPromise;
    } finally {
      _lodash.default.pull(this._activeRequests, reqPromise);
    }
  }

  getActiveRequestsCount() {
    return this._activeRequests.length;
  }

  cancelActiveRequests() {
    this._activeRequests = [];
  }

  endpointRequiresSessionId(endpoint) {
    return !_lodash.default.includes(['/session', '/sessions', '/status'], endpoint);
  }

  set downstreamProtocol(value) {
    this._downstreamProtocol = value;
    this.protocolConverter.downstreamProtocol = value;
  }

  get downstreamProtocol() {
    return this._downstreamProtocol;
  }

  getUrlForProxy(url) {
    if (url === '') {
      url = '/';
    }

    const proxyBase = `${this.scheme}://${this.server}:${this.port}${this.base}`;
    const endpointRe = '(/(session|status))';
    let remainingUrl = '';

    if (/^http/.test(url)) {
      const first = new RegExp(`(https?://.+)${endpointRe}`).exec(url);

      if (!first) {
        throw new Error('Got a complete url but could not extract JWP endpoint');
      }

      remainingUrl = url.replace(first[1], '');
    } else if (new RegExp('^/').test(url)) {
      remainingUrl = url;
    } else {
      throw new Error(`Did not know what to do with url '${url}'`);
    }

    const stripPrefixRe = new RegExp('^.*?(/(session|status).*)$');

    if (stripPrefixRe.test(remainingUrl)) {
      remainingUrl = stripPrefixRe.exec(remainingUrl)[1];
    }

    if (!new RegExp(endpointRe).test(remainingUrl)) {
      remainingUrl = `/session/${this.sessionId}${remainingUrl}`;
    }

    const requiresSessionId = this.endpointRequiresSessionId(remainingUrl);

    if (requiresSessionId && this.sessionId === null) {
      throw new Error('Trying to proxy a session command without session id');
    }

    const sessionBaseRe = new RegExp('^/session/([^/]+)');

    if (sessionBaseRe.test(remainingUrl)) {
      const match = sessionBaseRe.exec(remainingUrl);
      remainingUrl = remainingUrl.replace(match[1], this.sessionId);
    } else if (requiresSessionId) {
      throw new Error(`Could not find :session section for url: ${remainingUrl}`);
    }

    remainingUrl = remainingUrl.replace(/\/$/, '');
    return proxyBase + remainingUrl;
  }

  async proxy(url, method, body = null) {
    method = method.toUpperCase();
    const newUrl = this.getUrlForProxy(url);

    const truncateBody = content => _lodash.default.truncate(_lodash.default.isString(content) ? content : JSON.stringify(content), {
      length: _constants.MAX_LOG_BODY_LENGTH
    });

    const reqOpts = {
      url: newUrl,
      method,
      headers: {
        'content-type': 'application/json; charset=utf-8',
        'user-agent': 'appium',
        accept: 'application/json, */*'
      },
      proxy: false,
      timeout: this.timeout,
      httpAgent: this.httpAgent,
      httpsAgent: this.httpsAgent
    };

    if (_support.util.hasValue(body) && method !== 'GET') {
      if (typeof body !== 'object') {
        try {
          reqOpts.data = JSON.parse(body);
        } catch (e) {
          throw new Error(`Cannot interpret the request body as valid JSON: ${truncateBody(body)}`);
        }
      } else {
        reqOpts.data = body;
      }
    }

    this.log.debug(`Proxying [${method} ${url || '/'}] to [${method} ${newUrl}] ` + (reqOpts.data ? `with body: ${truncateBody(reqOpts.data)}` : 'with no body'));

    const throwProxyError = error => {
      const err = new Error(`The request to ${url} has failed`);
      err.response = {
        data: error,
        status: 500
      };
      throw err;
    };

    let isResponseLogged = false;

    try {
      const {
        data,
        status,
        headers
      } = await this.request(reqOpts);

      if (!_lodash.default.isPlainObject(data)) {
        throwProxyError(data);
      }

      this.log.debug(`Got response with status ${status}: ${truncateBody(data)}`);
      isResponseLogged = true;
      const isSessionCreationRequest = /\/session$/.test(url) && method === 'POST';

      if (isSessionCreationRequest) {
        if (status === 200) {
          this.sessionId = data.sessionId || (data.value || {}).sessionId;
        }

        this.downstreamProtocol = this.getProtocolFromResBody(data);
        this.log.info(`Determined the downstream protocol as '${this.downstreamProtocol}'`);
      }

      if (_lodash.default.has(data, 'status') && parseInt(data.status, 10) !== 0) {
        throwProxyError(data);
      }

      const res = {
        statusCode: status,
        headers,
        body: data
      };
      return [res, data];
    } catch (e) {
      var _e$response, _e$response2;

      let proxyErrorMsg = e.message;

      if (_support.util.hasValue(e.response)) {
        if (!isResponseLogged) {
          const error = truncateBody(e.response.data);
          this.log.info(_support.util.hasValue(e.response.status) ? `Got response with status ${e.response.status}: ${error}` : `Got response with unknown status: ${error}`);
        }
      } else {
        proxyErrorMsg = `Could not proxy command to the remote server. Original error: ${e.message}`;

        if (COMPACT_ERROR_PATTERNS.some(p => p.test(e.message))) {
          this.log.info(e.message);
        } else {
          this.log.info(e.stack);
        }
      }

      throw new _errors.errors.ProxyRequestError(proxyErrorMsg, (_e$response = e.response) === null || _e$response === void 0 ? void 0 : _e$response.data, (_e$response2 = e.response) === null || _e$response2 === void 0 ? void 0 : _e$response2.status);
    }
  }

  getProtocolFromResBody(resObj) {
    if (_lodash.default.isInteger(resObj.status)) {
      return MJSONWP;
    }

    if (!_lodash.default.isUndefined(resObj.value)) {
      return W3C;
    }
  }

  requestToCommandName(url, method) {
    const extractCommandName = pattern => {
      const pathMatch = pattern.exec(url);
      return pathMatch ? (0, _protocol.routeToCommandName)(pathMatch[1], method, this.reqBasePath) : null;
    };

    let commandName = (0, _protocol.routeToCommandName)(url, method, this.reqBasePath);

    if (!commandName && _lodash.default.includes(url, `${this.reqBasePath}/session/`)) {
      commandName = extractCommandName(new RegExp(`${_lodash.default.escapeRegExp(this.reqBasePath)}/session/[^/]+(.+)`));
    }

    if (!commandName && _lodash.default.includes(url, this.reqBasePath)) {
      commandName = extractCommandName(new RegExp(`${_lodash.default.escapeRegExp(this.reqBasePath)}(/.+)`));
    }

    return commandName;
  }

  async proxyCommand(url, method, body = null) {
    const commandName = this.requestToCommandName(url, method);

    if (!commandName) {
      return await this.proxy(url, method, body);
    }

    this.log.debug(`Matched '${url}' to command name '${commandName}'`);
    return await this.protocolConverter.convertAndProxy(commandName, url, method, body);
  }

  async command(url, method, body = null) {
    let response;
    let resBodyObj;

    try {
      [response, resBodyObj] = await this.proxyCommand(url, method, body);
    } catch (err) {
      if ((0, _errors.isErrorType)(err, _errors.errors.ProxyRequestError)) {
        throw err.getActualError();
      }

      throw new _errors.errors.UnknownError(err.message);
    }

    const protocol = this.getProtocolFromResBody(resBodyObj);

    if (protocol === MJSONWP) {
      if (response.statusCode === 200 && resBodyObj.status === 0) {
        return resBodyObj.value;
      }

      const status = parseInt(resBodyObj.status, 10);

      if (!isNaN(status) && status !== 0) {
        let message = resBodyObj.value;

        if (_lodash.default.has(message, 'message')) {
          message = message.message;
        }

        throw (0, _errors.errorFromMJSONWPStatusCode)(status, _lodash.default.isEmpty(message) ? (0, _status.getSummaryByCode)(status) : message);
      }
    } else if (protocol === W3C) {
      if (response.statusCode < 300) {
        return resBodyObj.value;
      }

      if (_lodash.default.isPlainObject(resBodyObj.value) && resBodyObj.value.error) {
        throw (0, _errors.errorFromW3CJsonCode)(resBodyObj.value.error, resBodyObj.value.message, resBodyObj.value.stacktrace);
      }
    } else if (response.statusCode === 200) {
      return resBodyObj;
    }

    throw new _errors.errors.UnknownError(`Did not know what to do with response code '${response.statusCode}' ` + `and response body '${_lodash.default.truncate(JSON.stringify(resBodyObj), {
      length: 300
    })}'`);
  }

  getSessionIdFromUrl(url) {
    const match = url.match(/\/session\/([^/]+)/);
    return match ? match[1] : null;
  }

  async proxyReqRes(req, res) {
    let statusCode;
    let resBodyObj;

    try {
      let response;
      [response, resBodyObj] = await this.proxyCommand(req.originalUrl, req.method, req.body);
      res.headers = response.headers;
      statusCode = response.statusCode;
    } catch (err) {
      [statusCode, resBodyObj] = (0, _errors.getResponseForW3CError)((0, _errors.isErrorType)(err, _errors.errors.ProxyRequestError) ? err.getActualError() : err);
    }

    res.set('content-type', 'application/json; charset=utf-8');

    if (!_lodash.default.isPlainObject(resBodyObj)) {
      const error = new _errors.errors.UnknownError(`The downstream server response with the status code ${statusCode} is not a valid JSON object: ` + _lodash.default.truncate(`${resBodyObj}`, {
        length: 300
      }));
      [statusCode, resBodyObj] = (0, _errors.getResponseForW3CError)(error);
    }

    if (_lodash.default.has(resBodyObj, 'sessionId')) {
      const reqSessionId = this.getSessionIdFromUrl(req.originalUrl);

      if (reqSessionId) {
        this.log.info(`Replacing sessionId ${resBodyObj.sessionId} with ${reqSessionId}`);
        resBodyObj.sessionId = reqSessionId;
      } else if (this.sessionId) {
        this.log.info(`Replacing sessionId ${resBodyObj.sessionId} with ${this.sessionId}`);
        resBodyObj.sessionId = this.sessionId;
      }
    }

    resBodyObj.value = (0, _helpers.formatResponseValue)(resBodyObj.value);
    res.status(statusCode).send(JSON.stringify((0, _helpers.formatStatus)(resBodyObj)));
  }

}

exports.JWProxy = JWProxy;
var _default = JWProxy;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJERUZBVUxUX0xPRyIsImxvZ2dlciIsImdldExvZ2dlciIsIkRFRkFVTFRfUkVRVUVTVF9USU1FT1VUIiwiQ09NUEFDVF9FUlJPUl9QQVRURVJOUyIsIk1KU09OV1AiLCJXM0MiLCJQUk9UT0NPTFMiLCJKV1Byb3h5IiwiY29uc3RydWN0b3IiLCJvcHRzIiwiXyIsImRlZmF1bHRzIiwic2NoZW1lIiwic2VydmVyIiwicG9ydCIsImJhc2UiLCJERUZBVUxUX0JBU0VfUEFUSCIsInJlcUJhc2VQYXRoIiwic2Vzc2lvbklkIiwidGltZW91dCIsInRvTG93ZXJDYXNlIiwiX2FjdGl2ZVJlcXVlc3RzIiwiX2Rvd25zdHJlYW1Qcm90b2NvbCIsImFnZW50T3B0cyIsImtlZXBBbGl2ZSIsIm1heFNvY2tldHMiLCJtYXhGcmVlU29ja2V0cyIsImh0dHBBZ2VudCIsImh0dHAiLCJBZ2VudCIsImh0dHBzQWdlbnQiLCJodHRwcyIsInByb3RvY29sQ29udmVydGVyIiwiUHJvdG9jb2xDb252ZXJ0ZXIiLCJwcm94eSIsImJpbmQiLCJsb2ciLCJfbG9nIiwicmVxdWVzdCIsInJlcXVlc3RDb25maWciLCJyZXFQcm9taXNlIiwicHVzaCIsInB1bGwiLCJnZXRBY3RpdmVSZXF1ZXN0c0NvdW50IiwibGVuZ3RoIiwiY2FuY2VsQWN0aXZlUmVxdWVzdHMiLCJlbmRwb2ludFJlcXVpcmVzU2Vzc2lvbklkIiwiZW5kcG9pbnQiLCJpbmNsdWRlcyIsImRvd25zdHJlYW1Qcm90b2NvbCIsInZhbHVlIiwiZ2V0VXJsRm9yUHJveHkiLCJ1cmwiLCJwcm94eUJhc2UiLCJlbmRwb2ludFJlIiwicmVtYWluaW5nVXJsIiwidGVzdCIsImZpcnN0IiwiUmVnRXhwIiwiZXhlYyIsIkVycm9yIiwicmVwbGFjZSIsInN0cmlwUHJlZml4UmUiLCJyZXF1aXJlc1Nlc3Npb25JZCIsInNlc3Npb25CYXNlUmUiLCJtYXRjaCIsIm1ldGhvZCIsImJvZHkiLCJ0b1VwcGVyQ2FzZSIsIm5ld1VybCIsInRydW5jYXRlQm9keSIsImNvbnRlbnQiLCJ0cnVuY2F0ZSIsImlzU3RyaW5nIiwiSlNPTiIsInN0cmluZ2lmeSIsIk1BWF9MT0dfQk9EWV9MRU5HVEgiLCJyZXFPcHRzIiwiaGVhZGVycyIsImFjY2VwdCIsInV0aWwiLCJoYXNWYWx1ZSIsImRhdGEiLCJwYXJzZSIsImUiLCJkZWJ1ZyIsInRocm93UHJveHlFcnJvciIsImVycm9yIiwiZXJyIiwicmVzcG9uc2UiLCJzdGF0dXMiLCJpc1Jlc3BvbnNlTG9nZ2VkIiwiaXNQbGFpbk9iamVjdCIsImlzU2Vzc2lvbkNyZWF0aW9uUmVxdWVzdCIsImdldFByb3RvY29sRnJvbVJlc0JvZHkiLCJpbmZvIiwiaGFzIiwicGFyc2VJbnQiLCJyZXMiLCJzdGF0dXNDb2RlIiwicHJveHlFcnJvck1zZyIsIm1lc3NhZ2UiLCJzb21lIiwicCIsInN0YWNrIiwiZXJyb3JzIiwiUHJveHlSZXF1ZXN0RXJyb3IiLCJyZXNPYmoiLCJpc0ludGVnZXIiLCJpc1VuZGVmaW5lZCIsInJlcXVlc3RUb0NvbW1hbmROYW1lIiwiZXh0cmFjdENvbW1hbmROYW1lIiwicGF0dGVybiIsInBhdGhNYXRjaCIsImNvbW1hbmROYW1lIiwiZXNjYXBlUmVnRXhwIiwicHJveHlDb21tYW5kIiwiY29udmVydEFuZFByb3h5IiwiY29tbWFuZCIsInJlc0JvZHlPYmoiLCJnZXRBY3R1YWxFcnJvciIsIlVua25vd25FcnJvciIsInByb3RvY29sIiwiaXNOYU4iLCJpc0VtcHR5Iiwic3RhY2t0cmFjZSIsImdldFNlc3Npb25JZEZyb21VcmwiLCJwcm94eVJlcVJlcyIsInJlcSIsIm9yaWdpbmFsVXJsIiwic2V0IiwicmVxU2Vzc2lvbklkIiwic2VuZCJdLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2xpYi9qc29ud3AtcHJveHkvcHJveHkuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGxvZ2dlciwgdXRpbCB9IGZyb20gJ0BhcHBpdW0vc3VwcG9ydCc7XG5pbXBvcnQgYXhpb3MgZnJvbSAnYXhpb3MnO1xuaW1wb3J0IHsgZ2V0U3VtbWFyeUJ5Q29kZSB9IGZyb20gJy4uL2pzb253cC1zdGF0dXMvc3RhdHVzJztcbmltcG9ydCB7XG4gIGVycm9ycywgaXNFcnJvclR5cGUsIGVycm9yRnJvbU1KU09OV1BTdGF0dXNDb2RlLCBlcnJvckZyb21XM0NKc29uQ29kZSxcbiAgZ2V0UmVzcG9uc2VGb3JXM0NFcnJvcixcbn0gZnJvbSAnLi4vcHJvdG9jb2wvZXJyb3JzJztcbmltcG9ydCB7IHJvdXRlVG9Db21tYW5kTmFtZSB9IGZyb20gJy4uL3Byb3RvY29sJztcbmltcG9ydCB7IE1BWF9MT0dfQk9EWV9MRU5HVEgsIERFRkFVTFRfQkFTRV9QQVRILCBQUk9UT0NPTFMgfSBmcm9tICcuLi9jb25zdGFudHMnO1xuaW1wb3J0IFByb3RvY29sQ29udmVydGVyIGZyb20gJy4vcHJvdG9jb2wtY29udmVydGVyJztcbmltcG9ydCB7IGZvcm1hdFJlc3BvbnNlVmFsdWUsIGZvcm1hdFN0YXR1cyB9IGZyb20gJy4uL3Byb3RvY29sL2hlbHBlcnMnO1xuaW1wb3J0IGh0dHAgZnJvbSAnaHR0cCc7XG5pbXBvcnQgaHR0cHMgZnJvbSAnaHR0cHMnO1xuXG5jb25zdCBERUZBVUxUX0xPRyA9IGxvZ2dlci5nZXRMb2dnZXIoJ1dEIFByb3h5Jyk7XG5jb25zdCBERUZBVUxUX1JFUVVFU1RfVElNRU9VVCA9IDI0MDAwMDtcbmNvbnN0IENPTVBBQ1RfRVJST1JfUEFUVEVSTlMgPSBbXG4gIC9cXGJFQ09OTlJFRlVTRURcXGIvLFxuICAvc29ja2V0IGhhbmcgdXAvLFxuXTtcblxuY29uc3Qge01KU09OV1AsIFczQ30gPSBQUk9UT0NPTFM7XG5cbmNsYXNzIEpXUHJveHkge1xuICBjb25zdHJ1Y3RvciAob3B0cyA9IHt9KSB7XG4gICAgXy5kZWZhdWx0cyh0aGlzLCBvcHRzLCB7XG4gICAgICBzY2hlbWU6ICdodHRwJyxcbiAgICAgIHNlcnZlcjogJ2xvY2FsaG9zdCcsXG4gICAgICBwb3J0OiA0NDQ0LFxuICAgICAgYmFzZTogREVGQVVMVF9CQVNFX1BBVEgsXG4gICAgICByZXFCYXNlUGF0aDogREVGQVVMVF9CQVNFX1BBVEgsXG4gICAgICBzZXNzaW9uSWQ6IG51bGwsXG4gICAgICB0aW1lb3V0OiBERUZBVUxUX1JFUVVFU1RfVElNRU9VVCxcbiAgICB9KTtcbiAgICB0aGlzLnNjaGVtZSA9IHRoaXMuc2NoZW1lLnRvTG93ZXJDYXNlKCk7XG4gICAgdGhpcy5fYWN0aXZlUmVxdWVzdHMgPSBbXTtcbiAgICB0aGlzLl9kb3duc3RyZWFtUHJvdG9jb2wgPSBudWxsO1xuICAgIGNvbnN0IGFnZW50T3B0cyA9IHtcbiAgICAgIGtlZXBBbGl2ZTogb3B0cy5rZWVwQWxpdmUgPz8gdHJ1ZSxcbiAgICAgIG1heFNvY2tldHM6IDEwLFxuICAgICAgbWF4RnJlZVNvY2tldHM6IDUsXG4gICAgfTtcbiAgICB0aGlzLmh0dHBBZ2VudCA9IG5ldyBodHRwLkFnZW50KGFnZW50T3B0cyk7XG4gICAgdGhpcy5odHRwc0FnZW50ID0gbmV3IGh0dHBzLkFnZW50KGFnZW50T3B0cyk7XG4gICAgdGhpcy5wcm90b2NvbENvbnZlcnRlciA9IG5ldyBQcm90b2NvbENvbnZlcnRlcih0aGlzLnByb3h5LmJpbmQodGhpcyksIG9wdHMubG9nKTtcbiAgICB0aGlzLl9sb2cgPSBvcHRzLmxvZztcbiAgfVxuXG4gIGdldCBsb2cgKCkge1xuICAgIHJldHVybiB0aGlzLl9sb2cgPz8gREVGQVVMVF9MT0c7XG4gIH1cblxuICAvKipcbiAgICogUGVyZm9ybXMgcmVxdWVzdHMgdG8gdGhlIGRvd25zdHJlYW0gc2VydmVyXG4gICAqXG4gICAqIEBwcml2YXRlIC0gRG8gbm90IGNhbGwgdGhpcyBtZXRob2QgZGlyZWN0bHksXG4gICAqIGl0IHVzZXMgY2xpZW50LXNwZWNpZmljIGFyZ3VtZW50cyBhbmQgcmVzcG9uc2VzIVxuICAgKlxuICAgKiBAcGFyYW0ge0F4aW9zUmVxdWVzdENvbmZpZ30gcmVxdWVzdENvbmZpZ1xuICAgKiBAcmV0dXJucyB7QXhpb3NSZXNwb25zZX1cbiAgICovXG4gIGFzeW5jIHJlcXVlc3QgKHJlcXVlc3RDb25maWcpIHtcbiAgICBjb25zdCByZXFQcm9taXNlID0gYXhpb3MocmVxdWVzdENvbmZpZyk7XG4gICAgdGhpcy5fYWN0aXZlUmVxdWVzdHMucHVzaChyZXFQcm9taXNlKTtcbiAgICB0cnkge1xuICAgICAgcmV0dXJuIGF3YWl0IHJlcVByb21pc2U7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIF8ucHVsbCh0aGlzLl9hY3RpdmVSZXF1ZXN0cywgcmVxUHJvbWlzZSk7XG4gICAgfVxuICB9XG5cbiAgZ2V0QWN0aXZlUmVxdWVzdHNDb3VudCAoKSB7XG4gICAgcmV0dXJuIHRoaXMuX2FjdGl2ZVJlcXVlc3RzLmxlbmd0aDtcbiAgfVxuXG4gIGNhbmNlbEFjdGl2ZVJlcXVlc3RzICgpIHtcbiAgICB0aGlzLl9hY3RpdmVSZXF1ZXN0cyA9IFtdO1xuICB9XG5cbiAgZW5kcG9pbnRSZXF1aXJlc1Nlc3Npb25JZCAoZW5kcG9pbnQpIHtcbiAgICByZXR1cm4gIV8uaW5jbHVkZXMoWycvc2Vzc2lvbicsICcvc2Vzc2lvbnMnLCAnL3N0YXR1cyddLCBlbmRwb2ludCk7XG4gIH1cblxuICBzZXQgZG93bnN0cmVhbVByb3RvY29sICh2YWx1ZSkge1xuICAgIHRoaXMuX2Rvd25zdHJlYW1Qcm90b2NvbCA9IHZhbHVlO1xuICAgIHRoaXMucHJvdG9jb2xDb252ZXJ0ZXIuZG93bnN0cmVhbVByb3RvY29sID0gdmFsdWU7XG4gIH1cblxuICBnZXQgZG93bnN0cmVhbVByb3RvY29sICgpIHtcbiAgICByZXR1cm4gdGhpcy5fZG93bnN0cmVhbVByb3RvY29sO1xuICB9XG5cbiAgZ2V0VXJsRm9yUHJveHkgKHVybCkge1xuICAgIGlmICh1cmwgPT09ICcnKSB7XG4gICAgICB1cmwgPSAnLyc7XG4gICAgfVxuICAgIGNvbnN0IHByb3h5QmFzZSA9IGAke3RoaXMuc2NoZW1lfTovLyR7dGhpcy5zZXJ2ZXJ9OiR7dGhpcy5wb3J0fSR7dGhpcy5iYXNlfWA7XG4gICAgY29uc3QgZW5kcG9pbnRSZSA9ICcoLyhzZXNzaW9ufHN0YXR1cykpJztcbiAgICBsZXQgcmVtYWluaW5nVXJsID0gJyc7XG4gICAgaWYgKC9eaHR0cC8udGVzdCh1cmwpKSB7XG4gICAgICBjb25zdCBmaXJzdCA9IChuZXcgUmVnRXhwKGAoaHR0cHM/Oi8vLispJHtlbmRwb2ludFJlfWApKS5leGVjKHVybCk7XG4gICAgICBpZiAoIWZpcnN0KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignR290IGEgY29tcGxldGUgdXJsIGJ1dCBjb3VsZCBub3QgZXh0cmFjdCBKV1AgZW5kcG9pbnQnKTtcbiAgICAgIH1cbiAgICAgIHJlbWFpbmluZ1VybCA9IHVybC5yZXBsYWNlKGZpcnN0WzFdLCAnJyk7XG4gICAgfSBlbHNlIGlmICgobmV3IFJlZ0V4cCgnXi8nKSkudGVzdCh1cmwpKSB7XG4gICAgICByZW1haW5pbmdVcmwgPSB1cmw7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgRGlkIG5vdCBrbm93IHdoYXQgdG8gZG8gd2l0aCB1cmwgJyR7dXJsfSdgKTtcbiAgICB9XG5cbiAgICBjb25zdCBzdHJpcFByZWZpeFJlID0gbmV3IFJlZ0V4cCgnXi4qPygvKHNlc3Npb258c3RhdHVzKS4qKSQnKTtcbiAgICBpZiAoc3RyaXBQcmVmaXhSZS50ZXN0KHJlbWFpbmluZ1VybCkpIHtcbiAgICAgIHJlbWFpbmluZ1VybCA9IHN0cmlwUHJlZml4UmUuZXhlYyhyZW1haW5pbmdVcmwpWzFdO1xuICAgIH1cblxuICAgIGlmICghKG5ldyBSZWdFeHAoZW5kcG9pbnRSZSkpLnRlc3QocmVtYWluaW5nVXJsKSkge1xuICAgICAgcmVtYWluaW5nVXJsID0gYC9zZXNzaW9uLyR7dGhpcy5zZXNzaW9uSWR9JHtyZW1haW5pbmdVcmx9YDtcbiAgICB9XG5cbiAgICBjb25zdCByZXF1aXJlc1Nlc3Npb25JZCA9IHRoaXMuZW5kcG9pbnRSZXF1aXJlc1Nlc3Npb25JZChyZW1haW5pbmdVcmwpO1xuXG4gICAgaWYgKHJlcXVpcmVzU2Vzc2lvbklkICYmIHRoaXMuc2Vzc2lvbklkID09PSBudWxsKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1RyeWluZyB0byBwcm94eSBhIHNlc3Npb24gY29tbWFuZCB3aXRob3V0IHNlc3Npb24gaWQnKTtcbiAgICB9XG5cbiAgICBjb25zdCBzZXNzaW9uQmFzZVJlID0gbmV3IFJlZ0V4cCgnXi9zZXNzaW9uLyhbXi9dKyknKTtcbiAgICBpZiAoc2Vzc2lvbkJhc2VSZS50ZXN0KHJlbWFpbmluZ1VybCkpIHtcbiAgICAgIC8vIHdlIGhhdmUgc29tZXRoaW5nIGxpa2UgL3Nlc3Npb24vOmlkL2Zvb2Jhciwgc28gd2UgbmVlZCB0byByZXBsYWNlXG4gICAgICAvLyB0aGUgc2Vzc2lvbiBpZFxuICAgICAgY29uc3QgbWF0Y2ggPSBzZXNzaW9uQmFzZVJlLmV4ZWMocmVtYWluaW5nVXJsKTtcbiAgICAgIHJlbWFpbmluZ1VybCA9IHJlbWFpbmluZ1VybC5yZXBsYWNlKG1hdGNoWzFdLCB0aGlzLnNlc3Npb25JZCk7XG4gICAgfSBlbHNlIGlmIChyZXF1aXJlc1Nlc3Npb25JZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZCBub3QgZmluZCA6c2Vzc2lvbiBzZWN0aW9uIGZvciB1cmw6ICR7cmVtYWluaW5nVXJsfWApO1xuICAgIH1cbiAgICByZW1haW5pbmdVcmwgPSByZW1haW5pbmdVcmwucmVwbGFjZSgvXFwvJC8sICcnKTsgLy8gY2FuJ3QgaGF2ZSB0cmFpbGluZyBzbGFzaGVzXG5cbiAgICByZXR1cm4gcHJveHlCYXNlICsgcmVtYWluaW5nVXJsO1xuICB9XG5cbiAgYXN5bmMgcHJveHkgKHVybCwgbWV0aG9kLCBib2R5ID0gbnVsbCkge1xuICAgIG1ldGhvZCA9IG1ldGhvZC50b1VwcGVyQ2FzZSgpO1xuICAgIGNvbnN0IG5ld1VybCA9IHRoaXMuZ2V0VXJsRm9yUHJveHkodXJsKTtcbiAgICBjb25zdCB0cnVuY2F0ZUJvZHkgPSAoY29udGVudCkgPT4gXy50cnVuY2F0ZShcbiAgICAgIF8uaXNTdHJpbmcoY29udGVudCkgPyBjb250ZW50IDogSlNPTi5zdHJpbmdpZnkoY29udGVudCksXG4gICAgICB7IGxlbmd0aDogTUFYX0xPR19CT0RZX0xFTkdUSCB9KTtcbiAgICBjb25zdCByZXFPcHRzID0ge1xuICAgICAgdXJsOiBuZXdVcmwsXG4gICAgICBtZXRob2QsXG4gICAgICBoZWFkZXJzOiB7XG4gICAgICAgICdjb250ZW50LXR5cGUnOiAnYXBwbGljYXRpb24vanNvbjsgY2hhcnNldD11dGYtOCcsXG4gICAgICAgICd1c2VyLWFnZW50JzogJ2FwcGl1bScsXG4gICAgICAgIGFjY2VwdDogJ2FwcGxpY2F0aW9uL2pzb24sICovKicsXG4gICAgICB9LFxuICAgICAgcHJveHk6IGZhbHNlLFxuICAgICAgdGltZW91dDogdGhpcy50aW1lb3V0LFxuICAgICAgaHR0cEFnZW50OiB0aGlzLmh0dHBBZ2VudCxcbiAgICAgIGh0dHBzQWdlbnQ6IHRoaXMuaHR0cHNBZ2VudCxcbiAgICB9O1xuICAgIC8vIEdFVCBtZXRob2RzIHNob3VsZG4ndCBoYXZlIGFueSBib2R5LiBNb3N0IHNlcnZlcnMgYXJlIE9LIHdpdGggdGhpcywgYnV0IFdlYkRyaXZlckFnZW50IHRocm93cyA0MDAgZXJyb3JzXG4gICAgaWYgKHV0aWwuaGFzVmFsdWUoYm9keSkgJiYgbWV0aG9kICE9PSAnR0VUJykge1xuICAgICAgaWYgKHR5cGVvZiBib2R5ICE9PSAnb2JqZWN0Jykge1xuICAgICAgICB0cnkge1xuICAgICAgICAgIHJlcU9wdHMuZGF0YSA9IEpTT04ucGFyc2UoYm9keSk7XG4gICAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBpbnRlcnByZXQgdGhlIHJlcXVlc3QgYm9keSBhcyB2YWxpZCBKU09OOiAke3RydW5jYXRlQm9keShib2R5KX1gKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVxT3B0cy5kYXRhID0gYm9keTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICB0aGlzLmxvZy5kZWJ1ZyhgUHJveHlpbmcgWyR7bWV0aG9kfSAke3VybCB8fCAnLyd9XSB0byBbJHttZXRob2R9ICR7bmV3VXJsfV0gYCArXG4gICAgICAocmVxT3B0cy5kYXRhID8gYHdpdGggYm9keTogJHt0cnVuY2F0ZUJvZHkocmVxT3B0cy5kYXRhKX1gIDogJ3dpdGggbm8gYm9keScpKTtcblxuICAgIGNvbnN0IHRocm93UHJveHlFcnJvciA9IChlcnJvcikgPT4ge1xuICAgICAgY29uc3QgZXJyID0gbmV3IEVycm9yKGBUaGUgcmVxdWVzdCB0byAke3VybH0gaGFzIGZhaWxlZGApO1xuICAgICAgZXJyLnJlc3BvbnNlID0ge1xuICAgICAgICBkYXRhOiBlcnJvcixcbiAgICAgICAgc3RhdHVzOiA1MDBcbiAgICAgIH07XG4gICAgICB0aHJvdyBlcnI7XG4gICAgfTtcbiAgICBsZXQgaXNSZXNwb25zZUxvZ2dlZCA9IGZhbHNlO1xuICAgIHRyeSB7XG4gICAgICBjb25zdCB7ZGF0YSwgc3RhdHVzLCBoZWFkZXJzfSA9IGF3YWl0IHRoaXMucmVxdWVzdChyZXFPcHRzKTtcbiAgICAgIC8vIGBkYXRhYCBtaWdodCBiZSByZWFsbHkgYmlnXG4gICAgICAvLyBCZSBjYXJlZnVsIHdoaWxlIGhhbmRsaW5nIGl0IHRvIGF2b2lkIG1lbW9yeSBsZWFrc1xuICAgICAgaWYgKCFfLmlzUGxhaW5PYmplY3QoZGF0YSkpIHtcbiAgICAgICAgLy8gVGhlIHJlc3BvbnNlIHNob3VsZCBiZSBhIHZhbGlkIEpTT04gb2JqZWN0XG4gICAgICAgIC8vIElmIGl0IGNhbm5vdCBiZSBjb2VyY2VkIHRvIGFuIG9iamVjdCB0aGVuIHRoZSByZXNwb25zZSBpcyB3cm9uZ1xuICAgICAgICB0aHJvd1Byb3h5RXJyb3IoZGF0YSk7XG4gICAgICB9XG4gICAgICB0aGlzLmxvZy5kZWJ1ZyhgR290IHJlc3BvbnNlIHdpdGggc3RhdHVzICR7c3RhdHVzfTogJHt0cnVuY2F0ZUJvZHkoZGF0YSl9YCk7XG4gICAgICBpc1Jlc3BvbnNlTG9nZ2VkID0gdHJ1ZTtcbiAgICAgIGNvbnN0IGlzU2Vzc2lvbkNyZWF0aW9uUmVxdWVzdCA9IC9cXC9zZXNzaW9uJC8udGVzdCh1cmwpICYmIG1ldGhvZCA9PT0gJ1BPU1QnO1xuICAgICAgaWYgKGlzU2Vzc2lvbkNyZWF0aW9uUmVxdWVzdCkge1xuICAgICAgICBpZiAoc3RhdHVzID09PSAyMDApIHtcbiAgICAgICAgICB0aGlzLnNlc3Npb25JZCA9IGRhdGEuc2Vzc2lvbklkIHx8IChkYXRhLnZhbHVlIHx8IHt9KS5zZXNzaW9uSWQ7XG4gICAgICAgIH1cbiAgICAgICAgdGhpcy5kb3duc3RyZWFtUHJvdG9jb2wgPSB0aGlzLmdldFByb3RvY29sRnJvbVJlc0JvZHkoZGF0YSk7XG4gICAgICAgIHRoaXMubG9nLmluZm8oYERldGVybWluZWQgdGhlIGRvd25zdHJlYW0gcHJvdG9jb2wgYXMgJyR7dGhpcy5kb3duc3RyZWFtUHJvdG9jb2x9J2ApO1xuICAgICAgfVxuICAgICAgaWYgKF8uaGFzKGRhdGEsICdzdGF0dXMnKSAmJiBwYXJzZUludChkYXRhLnN0YXR1cywgMTApICE9PSAwKSB7XG4gICAgICAgIC8vIFNvbWUgc2VydmVycywgbGlrZSBjaHJvbWVkcml2ZXIgbWF5IHJldHVybiByZXNwb25zZSBjb2RlIDIwMCBmb3Igbm9uLXplcm8gSlNPTldQIHN0YXR1c2VzXG4gICAgICAgIHRocm93UHJveHlFcnJvcihkYXRhKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IHJlcyA9IHtzdGF0dXNDb2RlOiBzdGF0dXMsIGhlYWRlcnMsIGJvZHk6IGRhdGF9O1xuICAgICAgcmV0dXJuIFtyZXMsIGRhdGFdO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIC8vIFdlIG9ubHkgY29uc2lkZXIgYW4gZXJyb3IgdW5leHBlY3RlZCBpZiB0aGlzIHdhcyBub3RcbiAgICAgIC8vIGFuIGFzeW5jIHJlcXVlc3QgbW9kdWxlIGVycm9yIG9yIGlmIHRoZSByZXNwb25zZSBjYW5ub3QgYmUgY2FzdCB0b1xuICAgICAgLy8gYSB2YWxpZCBKU09OXG4gICAgICBsZXQgcHJveHlFcnJvck1zZyA9IGUubWVzc2FnZTtcbiAgICAgIGlmICh1dGlsLmhhc1ZhbHVlKGUucmVzcG9uc2UpKSB7XG4gICAgICAgIGlmICghaXNSZXNwb25zZUxvZ2dlZCkge1xuICAgICAgICAgIGNvbnN0IGVycm9yID0gdHJ1bmNhdGVCb2R5KGUucmVzcG9uc2UuZGF0YSk7XG4gICAgICAgICAgdGhpcy5sb2cuaW5mbyh1dGlsLmhhc1ZhbHVlKGUucmVzcG9uc2Uuc3RhdHVzKVxuICAgICAgICAgICAgPyBgR290IHJlc3BvbnNlIHdpdGggc3RhdHVzICR7ZS5yZXNwb25zZS5zdGF0dXN9OiAke2Vycm9yfWBcbiAgICAgICAgICAgIDogYEdvdCByZXNwb25zZSB3aXRoIHVua25vd24gc3RhdHVzOiAke2Vycm9yfWApO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBwcm94eUVycm9yTXNnID0gYENvdWxkIG5vdCBwcm94eSBjb21tYW5kIHRvIHRoZSByZW1vdGUgc2VydmVyLiBPcmlnaW5hbCBlcnJvcjogJHtlLm1lc3NhZ2V9YDtcbiAgICAgICAgaWYgKENPTVBBQ1RfRVJST1JfUEFUVEVSTlMuc29tZSgocCkgPT4gcC50ZXN0KGUubWVzc2FnZSkpKSB7XG4gICAgICAgICAgdGhpcy5sb2cuaW5mbyhlLm1lc3NhZ2UpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIHRoaXMubG9nLmluZm8oZS5zdGFjayk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHRocm93IG5ldyBlcnJvcnMuUHJveHlSZXF1ZXN0RXJyb3IocHJveHlFcnJvck1zZywgZS5yZXNwb25zZT8uZGF0YSwgZS5yZXNwb25zZT8uc3RhdHVzKTtcbiAgICB9XG4gIH1cblxuICBnZXRQcm90b2NvbEZyb21SZXNCb2R5IChyZXNPYmopIHtcbiAgICBpZiAoXy5pc0ludGVnZXIocmVzT2JqLnN0YXR1cykpIHtcbiAgICAgIHJldHVybiBNSlNPTldQO1xuICAgIH1cbiAgICBpZiAoIV8uaXNVbmRlZmluZWQocmVzT2JqLnZhbHVlKSkge1xuICAgICAgcmV0dXJuIFczQztcbiAgICB9XG4gIH1cblxuICByZXF1ZXN0VG9Db21tYW5kTmFtZSAodXJsLCBtZXRob2QpIHtcbiAgICBjb25zdCBleHRyYWN0Q29tbWFuZE5hbWUgPSAocGF0dGVybikgPT4ge1xuICAgICAgY29uc3QgcGF0aE1hdGNoID0gcGF0dGVybi5leGVjKHVybCk7XG4gICAgICByZXR1cm4gcGF0aE1hdGNoID8gcm91dGVUb0NvbW1hbmROYW1lKHBhdGhNYXRjaFsxXSwgbWV0aG9kLCB0aGlzLnJlcUJhc2VQYXRoKSA6IG51bGw7XG4gICAgfTtcbiAgICBsZXQgY29tbWFuZE5hbWUgPSByb3V0ZVRvQ29tbWFuZE5hbWUodXJsLCBtZXRob2QsIHRoaXMucmVxQmFzZVBhdGgpO1xuICAgIGlmICghY29tbWFuZE5hbWUgJiYgXy5pbmNsdWRlcyh1cmwsIGAke3RoaXMucmVxQmFzZVBhdGh9L3Nlc3Npb24vYCkpIHtcbiAgICAgIGNvbW1hbmROYW1lID0gZXh0cmFjdENvbW1hbmROYW1lKG5ldyBSZWdFeHAoYCR7Xy5lc2NhcGVSZWdFeHAodGhpcy5yZXFCYXNlUGF0aCl9L3Nlc3Npb24vW14vXSsoLispYCkpO1xuICAgIH1cbiAgICBpZiAoIWNvbW1hbmROYW1lICYmIF8uaW5jbHVkZXModXJsLCB0aGlzLnJlcUJhc2VQYXRoKSkge1xuICAgICAgY29tbWFuZE5hbWUgPSBleHRyYWN0Q29tbWFuZE5hbWUobmV3IFJlZ0V4cChgJHtfLmVzY2FwZVJlZ0V4cCh0aGlzLnJlcUJhc2VQYXRoKX0oLy4rKWApKTtcbiAgICB9XG4gICAgcmV0dXJuIGNvbW1hbmROYW1lO1xuICB9XG5cbiAgYXN5bmMgcHJveHlDb21tYW5kICh1cmwsIG1ldGhvZCwgYm9keSA9IG51bGwpIHtcbiAgICBjb25zdCBjb21tYW5kTmFtZSA9IHRoaXMucmVxdWVzdFRvQ29tbWFuZE5hbWUodXJsLCBtZXRob2QpO1xuICAgIGlmICghY29tbWFuZE5hbWUpIHtcbiAgICAgIHJldHVybiBhd2FpdCB0aGlzLnByb3h5KHVybCwgbWV0aG9kLCBib2R5KTtcbiAgICB9XG4gICAgdGhpcy5sb2cuZGVidWcoYE1hdGNoZWQgJyR7dXJsfScgdG8gY29tbWFuZCBuYW1lICcke2NvbW1hbmROYW1lfSdgKTtcblxuICAgIHJldHVybiBhd2FpdCB0aGlzLnByb3RvY29sQ29udmVydGVyLmNvbnZlcnRBbmRQcm94eShjb21tYW5kTmFtZSwgdXJsLCBtZXRob2QsIGJvZHkpO1xuICB9XG5cbiAgYXN5bmMgY29tbWFuZCAodXJsLCBtZXRob2QsIGJvZHkgPSBudWxsKSB7XG4gICAgbGV0IHJlc3BvbnNlO1xuICAgIGxldCByZXNCb2R5T2JqO1xuICAgIHRyeSB7XG4gICAgICBbcmVzcG9uc2UsIHJlc0JvZHlPYmpdID0gYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQodXJsLCBtZXRob2QsIGJvZHkpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgaWYgKGlzRXJyb3JUeXBlKGVyciwgZXJyb3JzLlByb3h5UmVxdWVzdEVycm9yKSkge1xuICAgICAgICB0aHJvdyBlcnIuZ2V0QWN0dWFsRXJyb3IoKTtcbiAgICAgIH1cbiAgICAgIHRocm93IG5ldyBlcnJvcnMuVW5rbm93bkVycm9yKGVyci5tZXNzYWdlKTtcbiAgICB9XG4gICAgY29uc3QgcHJvdG9jb2wgPSB0aGlzLmdldFByb3RvY29sRnJvbVJlc0JvZHkocmVzQm9keU9iaik7XG4gICAgaWYgKHByb3RvY29sID09PSBNSlNPTldQKSB7XG4gICAgICAvLyBHb3QgcmVzcG9uc2UgaW4gTUpTT05XUCBmb3JtYXRcbiAgICAgIGlmIChyZXNwb25zZS5zdGF0dXNDb2RlID09PSAyMDAgJiYgcmVzQm9keU9iai5zdGF0dXMgPT09IDApIHtcbiAgICAgICAgcmV0dXJuIHJlc0JvZHlPYmoudmFsdWU7XG4gICAgICB9XG4gICAgICBjb25zdCBzdGF0dXMgPSBwYXJzZUludChyZXNCb2R5T2JqLnN0YXR1cywgMTApO1xuICAgICAgaWYgKCFpc05hTihzdGF0dXMpICYmIHN0YXR1cyAhPT0gMCkge1xuICAgICAgICBsZXQgbWVzc2FnZSA9IHJlc0JvZHlPYmoudmFsdWU7XG4gICAgICAgIGlmIChfLmhhcyhtZXNzYWdlLCAnbWVzc2FnZScpKSB7XG4gICAgICAgICAgbWVzc2FnZSA9IG1lc3NhZ2UubWVzc2FnZTtcbiAgICAgICAgfVxuICAgICAgICB0aHJvdyBlcnJvckZyb21NSlNPTldQU3RhdHVzQ29kZShzdGF0dXMsIF8uaXNFbXB0eShtZXNzYWdlKSA/IGdldFN1bW1hcnlCeUNvZGUoc3RhdHVzKSA6IG1lc3NhZ2UpO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAocHJvdG9jb2wgPT09IFczQykge1xuICAgICAgLy8gR290IHJlc3BvbnNlIGluIFczQyBmb3JtYXRcbiAgICAgIGlmIChyZXNwb25zZS5zdGF0dXNDb2RlIDwgMzAwKSB7XG4gICAgICAgIHJldHVybiByZXNCb2R5T2JqLnZhbHVlO1xuICAgICAgfVxuICAgICAgaWYgKF8uaXNQbGFpbk9iamVjdChyZXNCb2R5T2JqLnZhbHVlKSAmJiByZXNCb2R5T2JqLnZhbHVlLmVycm9yKSB7XG4gICAgICAgIHRocm93IGVycm9yRnJvbVczQ0pzb25Db2RlKHJlc0JvZHlPYmoudmFsdWUuZXJyb3IsIHJlc0JvZHlPYmoudmFsdWUubWVzc2FnZSwgcmVzQm9keU9iai52YWx1ZS5zdGFja3RyYWNlKTtcbiAgICAgIH1cbiAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLnN0YXR1c0NvZGUgPT09IDIwMCkge1xuICAgICAgLy8gVW5rbm93biBwcm90b2NvbC4gS2VlcGluZyBpdCBiZWNhdXNlIG9mIHRoZSBiYWNrd2FyZCBjb21wYXRpYmlsaXR5XG4gICAgICByZXR1cm4gcmVzQm9keU9iajtcbiAgICB9XG4gICAgdGhyb3cgbmV3IGVycm9ycy5Vbmtub3duRXJyb3IoYERpZCBub3Qga25vdyB3aGF0IHRvIGRvIHdpdGggcmVzcG9uc2UgY29kZSAnJHtyZXNwb25zZS5zdGF0dXNDb2RlfScgYCArXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYGFuZCByZXNwb25zZSBib2R5ICcke18udHJ1bmNhdGUoSlNPTi5zdHJpbmdpZnkocmVzQm9keU9iaiksIHtsZW5ndGg6IDMwMH0pfSdgKTtcbiAgfVxuXG4gIGdldFNlc3Npb25JZEZyb21VcmwgKHVybCkge1xuICAgIGNvbnN0IG1hdGNoID0gdXJsLm1hdGNoKC9cXC9zZXNzaW9uXFwvKFteL10rKS8pO1xuICAgIHJldHVybiBtYXRjaCA/IG1hdGNoWzFdIDogbnVsbDtcbiAgfVxuXG4gIGFzeW5jIHByb3h5UmVxUmVzIChyZXEsIHJlcykge1xuICAgIC8vICEgdGhpcyBtZXRob2QgbXVzdCBub3QgdGhyb3cgYW55IGV4Y2VwdGlvbnNcbiAgICAvLyAhIG1ha2Ugc3VyZSB0byBjYWxsIHJlcy5zZW5kIGJlZm9yZSByZXR1cm5cbiAgICBsZXQgc3RhdHVzQ29kZTtcbiAgICBsZXQgcmVzQm9keU9iajtcbiAgICB0cnkge1xuICAgICAgbGV0IHJlc3BvbnNlO1xuICAgICAgW3Jlc3BvbnNlLCByZXNCb2R5T2JqXSA9IGF3YWl0IHRoaXMucHJveHlDb21tYW5kKHJlcS5vcmlnaW5hbFVybCwgcmVxLm1ldGhvZCwgcmVxLmJvZHkpO1xuICAgICAgcmVzLmhlYWRlcnMgPSByZXNwb25zZS5oZWFkZXJzO1xuICAgICAgc3RhdHVzQ29kZSA9IHJlc3BvbnNlLnN0YXR1c0NvZGU7XG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBbc3RhdHVzQ29kZSwgcmVzQm9keU9ial0gPSBnZXRSZXNwb25zZUZvclczQ0Vycm9yKFxuICAgICAgICBpc0Vycm9yVHlwZShlcnIsIGVycm9ycy5Qcm94eVJlcXVlc3RFcnJvcikgPyBlcnIuZ2V0QWN0dWFsRXJyb3IoKSA6IGVyclxuICAgICAgKTtcbiAgICB9XG4gICAgcmVzLnNldCgnY29udGVudC10eXBlJywgJ2FwcGxpY2F0aW9uL2pzb247IGNoYXJzZXQ9dXRmLTgnKTtcbiAgICBpZiAoIV8uaXNQbGFpbk9iamVjdChyZXNCb2R5T2JqKSkge1xuICAgICAgY29uc3QgZXJyb3IgPSBuZXcgZXJyb3JzLlVua25vd25FcnJvcihcbiAgICAgICAgYFRoZSBkb3duc3RyZWFtIHNlcnZlciByZXNwb25zZSB3aXRoIHRoZSBzdGF0dXMgY29kZSAke3N0YXR1c0NvZGV9IGlzIG5vdCBhIHZhbGlkIEpTT04gb2JqZWN0OiBgICtcbiAgICAgICAgXy50cnVuY2F0ZShgJHtyZXNCb2R5T2JqfWAsIHtsZW5ndGg6IDMwMH0pXG4gICAgICApO1xuICAgICAgW3N0YXR1c0NvZGUsIHJlc0JvZHlPYmpdID0gZ2V0UmVzcG9uc2VGb3JXM0NFcnJvcihlcnJvcik7XG4gICAgfVxuXG4gICAgLy8gaWYgdGhlIHByb3hpZWQgcmVzcG9uc2UgY29udGFpbnMgYSBzZXNzaW9uSWQgdGhhdCB0aGUgZG93bnN0cmVhbVxuICAgIC8vIGRyaXZlciBoYXMgZ2VuZXJhdGVkLCB3ZSBkb24ndCB3YW50IHRvIHJldHVybiB0aGF0IHRvIHRoZSBjbGllbnQuXG4gICAgLy8gSW5zdGVhZCwgcmV0dXJuIHRoZSBpZCBmcm9tIHRoZSByZXF1ZXN0IG9yIGZyb20gY3VycmVudCBzZXNzaW9uXG4gICAgaWYgKF8uaGFzKHJlc0JvZHlPYmosICdzZXNzaW9uSWQnKSkge1xuICAgICAgY29uc3QgcmVxU2Vzc2lvbklkID0gdGhpcy5nZXRTZXNzaW9uSWRGcm9tVXJsKHJlcS5vcmlnaW5hbFVybCk7XG4gICAgICBpZiAocmVxU2Vzc2lvbklkKSB7XG4gICAgICAgIHRoaXMubG9nLmluZm8oYFJlcGxhY2luZyBzZXNzaW9uSWQgJHtyZXNCb2R5T2JqLnNlc3Npb25JZH0gd2l0aCAke3JlcVNlc3Npb25JZH1gKTtcbiAgICAgICAgcmVzQm9keU9iai5zZXNzaW9uSWQgPSByZXFTZXNzaW9uSWQ7XG4gICAgICB9IGVsc2UgaWYgKHRoaXMuc2Vzc2lvbklkKSB7XG4gICAgICAgIHRoaXMubG9nLmluZm8oYFJlcGxhY2luZyBzZXNzaW9uSWQgJHtyZXNCb2R5T2JqLnNlc3Npb25JZH0gd2l0aCAke3RoaXMuc2Vzc2lvbklkfWApO1xuICAgICAgICByZXNCb2R5T2JqLnNlc3Npb25JZCA9IHRoaXMuc2Vzc2lvbklkO1xuICAgICAgfVxuICAgIH1cbiAgICByZXNCb2R5T2JqLnZhbHVlID0gZm9ybWF0UmVzcG9uc2VWYWx1ZShyZXNCb2R5T2JqLnZhbHVlKTtcbiAgICByZXMuc3RhdHVzKHN0YXR1c0NvZGUpLnNlbmQoSlNPTi5zdHJpbmdpZnkoZm9ybWF0U3RhdHVzKHJlc0JvZHlPYmopKSk7XG4gIH1cbn1cblxuZXhwb3J0IHsgSldQcm94eSB9O1xuZXhwb3J0IGRlZmF1bHQgSldQcm94eTtcbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFJQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxNQUFNQSxXQUFXLEdBQUdDLGdCQUFPQyxTQUFQLENBQWlCLFVBQWpCLENBQXBCOztBQUNBLE1BQU1DLHVCQUF1QixHQUFHLE1BQWhDO0FBQ0EsTUFBTUMsc0JBQXNCLEdBQUcsQ0FDN0Isa0JBRDZCLEVBRTdCLGdCQUY2QixDQUEvQjtBQUtBLE1BQU07RUFBQ0MsT0FBRDtFQUFVQztBQUFWLElBQWlCQyxvQkFBdkI7O0FBRUEsTUFBTUMsT0FBTixDQUFjO0VBQ1pDLFdBQVcsQ0FBRUMsSUFBSSxHQUFHLEVBQVQsRUFBYTtJQUFBOztJQUN0QkMsZ0JBQUVDLFFBQUYsQ0FBVyxJQUFYLEVBQWlCRixJQUFqQixFQUF1QjtNQUNyQkcsTUFBTSxFQUFFLE1BRGE7TUFFckJDLE1BQU0sRUFBRSxXQUZhO01BR3JCQyxJQUFJLEVBQUUsSUFIZTtNQUlyQkMsSUFBSSxFQUFFQyw0QkFKZTtNQUtyQkMsV0FBVyxFQUFFRCw0QkFMUTtNQU1yQkUsU0FBUyxFQUFF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