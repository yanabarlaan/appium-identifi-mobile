"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _lib = require("../../../lib");

var _fakeDriver = require("../protocol/fake-driver");

var _ws = _interopRequireDefault(require("ws"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _helpers = require("../../helpers");

describe('Websockets (e2e)', function () {
  let baseServer;
  let driver;
  let port;
  const SESSION_ID = 'foo';
  const WS_DATA = 'Hello';
  before(async function () {
    driver = new _fakeDriver.FakeDriver();
    driver.sessionId = SESSION_ID;
    port = await (0, _helpers.getTestPort)();
    baseServer = await (0, _lib.server)({
      routeConfiguringFunction: (0, _lib.routeConfiguringFunction)(driver),
      port
    });
  });
  after(async function () {
    await baseServer.close();
  });
  describe('web sockets support', function () {
    it('should be able to add websocket handler and remove it', async function () {
      const wss = new _ws.default.Server({
        noServer: true
      });
      wss.on('connection', ws => {
        if (ws && ws.readyState === _ws.default.OPEN) {
          ws.send(WS_DATA);
        }
      });
      const previousListenerCount = baseServer.listenerCount('upgrade');
      const endpoint = `${_lib.DEFAULT_WS_PATHNAME_PREFIX}/hello`;
      const timeout = 5000;
      await baseServer.addWebSocketHandler(endpoint, wss);
      baseServer.listenerCount('upgrade').should.be.above(previousListenerCount);

      _lodash.default.keys(await baseServer.getWebSocketHandlers()).length.should.eql(1);

      await new _bluebird.default((resolve, reject) => {
        const client = new _ws.default(`ws://${_helpers.TEST_HOST}:${port}${endpoint}`);
        client.once('connection', (ws, req) => {
          try {
            ws.should.not.be.empty;
            req.connection.remoteAddress.should.not.be.empty;
          } catch (e) {
            reject(e);
          }
        });
        client.once('message', data => {
          const dataStr = _lodash.default.isString(data) ? data : data.toString();
          dataStr.should.eql(WS_DATA);
          resolve();
        });
        client.once('error', reject);
        setTimeout(() => reject(new Error('No websocket messages have been received after the timeout')), timeout);
      });
      (await baseServer.removeWebSocketHandler(endpoint)).should.be.true;

      _lodash.default.keys(await baseServer.getWebSocketHandlers()).length.should.eql(0);

      await new _bluebird.default((resolve, reject) => {
        const client = new _ws.default(`ws://${_helpers.TEST_HOST}:${port}${endpoint}`);
        client.on('message', data => reject(new Error(`No websocket messages are expected after the handler ` + `has been removed. '${data}' is received instead. `)));
        client.on('error', resolve);
        setTimeout(resolve, timeout);
      });
      baseServer.listenerCount('upgrade').should.be.above(previousListenerCount);
    });
  });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJkZXNjcmliZSIsImJhc2VTZXJ2ZXIiLCJkcml2ZXIiLCJwb3J0IiwiU0VTU0lPTl9JRCIsIldTX0RBVEEiLCJiZWZvcmUiLCJGYWtlRHJpdmVyIiwic2Vzc2lvbklkIiwicm91dGVDb25maWd1cmluZ0Z1bmN0aW9uIiwiYWZ0ZXIiLCJjbG9zZSIsIml0Iiwid3NzIiwiV2ViU29ja2V0IiwiU2VydmVyIiwibm9TZXJ2ZXIiLCJvbiIsIndzIiwicmVhZHlTdGF0ZSIsIk9QRU4iLCJzZW5kIiwicHJldmlvdXNMaXN0ZW5lckNvdW50IiwibGlzdGVuZXJDb3VudCIsImVuZHBvaW50IiwiREVGQVVMVF9XU19QQVRITkFNRV9QUkVGSVgiLCJ0aW1lb3V0IiwiYWRkV2ViU29ja2V0SGFuZGxlciIsInNob3VsZCIsImJlIiwiYWJvdmUiLCJfIiwia2V5cyIsImdldFdlYlNvY2tldEhhbmRsZXJzIiwibGVuZ3RoIiwiZXFsIiwiQiIsInJlc29sdmUiLCJyZWplY3QiLCJjbGllbnQiLCJURVNUX0hPU1QiLCJvbmNlIiwicmVxIiwibm90IiwiZW1wdHkiLCJjb25uZWN0aW9uIiwicmVtb3RlQWRkcmVzcyIsImUiLCJkYXRhIiwiZGF0YVN0ciIsImlzU3RyaW5nIiwidG9TdHJpbmciLCJzZXRUaW1lb3V0IiwiRXJyb3IiLCJyZW1vdmVXZWJTb2NrZXRIYW5kbGVyIiwidHJ1ZSJdLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3Rlc3QvZTJlL2Jhc2Vkcml2ZXIvd2Vic29ja2V0cy5lMmUuc3BlYy5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHtcbiAgc2VydmVyLCByb3V0ZUNvbmZpZ3VyaW5nRnVuY3Rpb24sIERFRkFVTFRfV1NfUEFUSE5BTUVfUFJFRklYXG59IGZyb20gJy4uLy4uLy4uL2xpYic7XG5pbXBvcnQgeyBGYWtlRHJpdmVyIH0gZnJvbSAnLi4vcHJvdG9jb2wvZmFrZS1kcml2ZXInO1xuaW1wb3J0IFdlYlNvY2tldCBmcm9tICd3cyc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQge1RFU1RfSE9TVCwgZ2V0VGVzdFBvcnR9IGZyb20gJy4uLy4uL2hlbHBlcnMnO1xuXG5cbmRlc2NyaWJlKCdXZWJzb2NrZXRzIChlMmUpJywgZnVuY3Rpb24gKCkge1xuICBsZXQgYmFzZVNlcnZlcjtcbiAgbGV0IGRyaXZlcjtcbiAgbGV0IHBvcnQ7XG4gIGNvbnN0IFNFU1NJT05fSUQgPSAnZm9vJztcbiAgY29uc3QgV1NfREFUQSA9ICdIZWxsbyc7XG5cbiAgYmVmb3JlKGFzeW5jIGZ1bmN0aW9uICgpIHtcbiAgICBkcml2ZXIgPSBuZXcgRmFrZURyaXZlcigpO1xuICAgIGRyaXZlci5zZXNzaW9uSWQgPSBTRVNTSU9OX0lEO1xuICAgIHBvcnQgPSBhd2FpdCBnZXRUZXN0UG9ydCgpO1xuICAgIGJhc2VTZXJ2ZXIgPSBhd2FpdCBzZXJ2ZXIoe1xuICAgICAgcm91dGVDb25maWd1cmluZ0Z1bmN0aW9uOiByb3V0ZUNvbmZpZ3VyaW5nRnVuY3Rpb24oZHJpdmVyKSxcbiAgICAgIHBvcnQsXG4gICAgfSk7XG4gIH0pO1xuICBhZnRlcihhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgYXdhaXQgYmFzZVNlcnZlci5jbG9zZSgpO1xuICB9KTtcblxuICBkZXNjcmliZSgnd2ViIHNvY2tldHMgc3VwcG9ydCcsIGZ1bmN0aW9uICgpIHtcbiAgICBpdCgnc2hvdWxkIGJlIGFibGUgdG8gYWRkIHdlYnNvY2tldCBoYW5kbGVyIGFuZCByZW1vdmUgaXQnLCBhc3luYyBmdW5jdGlvbiAoKSB7XG4gICAgICBjb25zdCB3c3MgPSBuZXcgV2ViU29ja2V0LlNlcnZlcih7XG4gICAgICAgIG5vU2VydmVyOiB0cnVlLFxuICAgICAgfSk7XG4gICAgICB3c3Mub24oJ2Nvbm5lY3Rpb24nLCAod3MpID0+IHtcbiAgICAgICAgaWYgKHdzICYmIHdzLnJlYWR5U3RhdGUgPT09IFdlYlNvY2tldC5PUEVOKSB7XG4gICAgICAgICAgd3Muc2VuZChXU19EQVRBKTtcbiAgICAgICAgfVxuICAgICAgfSk7XG4gICAgICBjb25zdCBwcmV2aW91c0xpc3RlbmVyQ291bnQgPSBiYXNlU2VydmVyLmxpc3RlbmVyQ291bnQoJ3VwZ3JhZGUnKTtcbiAgICAgIGNvbnN0IGVuZHBvaW50ID0gYCR7REVGQVVMVF9XU19QQVRITkFNRV9QUkVGSVh9L2hlbGxvYDtcbiAgICAgIGNvbnN0IHRpbWVvdXQgPSA1MDAwO1xuICAgICAgYXdhaXQgYmFzZVNlcnZlci5hZGRXZWJTb2NrZXRIYW5kbGVyKGVuZHBvaW50LCB3c3MpO1xuICAgICAgYmFzZVNlcnZlci5saXN0ZW5lckNvdW50KCd1cGdyYWRlJykuc2hvdWxkLmJlLmFib3ZlKHByZXZpb3VzTGlzdGVuZXJDb3VudCk7XG4gICAgICBfLmtleXMoYXdhaXQgYmFzZVNlcnZlci5nZXRXZWJTb2NrZXRIYW5kbGVycygpKS5sZW5ndGguc2hvdWxkLmVxbCgxKTtcbiAgICAgIGF3YWl0IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgY29uc3QgY2xpZW50ID0gbmV3IFdlYlNvY2tldChgd3M6Ly8ke1RFU1RfSE9TVH06JHtwb3J0fSR7ZW5kcG9pbnR9YCk7XG4gICAgICAgIGNsaWVudC5vbmNlKCdjb25uZWN0aW9uJywgKHdzLCByZXEpID0+IHtcbiAgICAgICAgICB0cnkge1xuICAgICAgICAgICAgd3Muc2hvdWxkLm5vdC5iZS5lbXB0eTtcbiAgICAgICAgICAgIHJlcS5jb25uZWN0aW9uLnJlbW90ZUFkZHJlc3Muc2hvdWxkLm5vdC5iZS5lbXB0eTtcbiAgICAgICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgICAgICByZWplY3QoZSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgY2xpZW50Lm9uY2UoJ21lc3NhZ2UnLCAoZGF0YSkgPT4ge1xuICAgICAgICAgIGNvbnN0IGRhdGFTdHIgPSBfLmlzU3RyaW5nKGRhdGEpID8gZGF0YSA6IGRhdGEudG9TdHJpbmcoKTtcbiAgICAgICAgICBkYXRhU3RyLnNob3VsZC5lcWwoV1NfREFUQSk7XG4gICAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgICB9KTtcbiAgICAgICAgY2xpZW50Lm9uY2UoJ2Vycm9yJywgcmVqZWN0KTtcbiAgICAgICAgc2V0VGltZW91dCgoKSA9PiByZWplY3QobmV3IEVycm9yKCdObyB3ZWJzb2NrZXQgbWVzc2FnZXMgaGF2ZSBiZWVuIHJlY2VpdmVkIGFmdGVyIHRoZSB0aW1lb3V0JykpLFxuICAgICAgICAgIHRpbWVvdXQpO1xuICAgICAgfSk7XG5cbiAgICAgIChhd2FpdCBiYXNlU2VydmVyLnJlbW92ZVdlYlNvY2tldEhhbmRsZXIoZW5kcG9pbnQpKS5zaG91bGQuYmUudHJ1ZTtcbiAgICAgIF8ua2V5cyhhd2FpdCBiYXNlU2VydmVyLmdldFdlYlNvY2tldEhhbmRsZXJzKCkpLmxlbmd0aC5zaG91bGQuZXFsKDApO1xuICAgICAgYXdhaXQgbmV3IEIoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICBjb25zdCBjbGllbnQgPSBuZXcgV2ViU29ja2V0KGB3czovLyR7VEVTVF9IT1NUfToke3BvcnR9JHtlbmRwb2ludH1gKTtcbiAgICAgICAgY2xpZW50Lm9uKCdtZXNzYWdlJywgKGRhdGEpID0+XG4gICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihgTm8gd2Vic29ja2V0IG1lc3NhZ2VzIGFyZSBleHBlY3RlZCBhZnRlciB0aGUgaGFuZGxlciBgICtcbiAgICAgICAgICAgIGBoYXMgYmVlbiByZW1vdmVkLiAnJHtkYXRhfScgaXMgcmVjZWl2ZWQgaW5zdGVhZC4gYCkpXG4gICAgICAgICk7XG4gICAgICAgIGNsaWVudC5vbignZXJyb3InLCByZXNvbHZlKTtcbiAgICAgICAgc2V0VGltZW91dChyZXNvbHZlLCB0aW1lb3V0KTtcbiAgICAgIH0pO1xuICAgICAgYmFzZVNlcnZlci5saXN0ZW5lckNvdW50KCd1cGdyYWRlJykuc2hvdWxkLmJlLmFib3ZlKHByZXZpb3VzTGlzdGVuZXJDb3Vu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