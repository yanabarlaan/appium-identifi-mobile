"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("../logger.js"));

var _path = _interopRequireDefault(require("path"));

var _support = require("@appium/support");

var _lruCache = _interopRequireDefault(require("lru-cache"));

var _helpers = require("../helpers.js");

var _asyncLock = _interopRequireDefault(require("async-lock"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _crypto = _interopRequireDefault(require("crypto"));

const AAB_CACHE = new _lruCache.default({
  max: 10,
  dispose: (hash, extractedFilesRoot) => _support.fs.rimraf(extractedFilesRoot)
});
const AAB_CACHE_GUARD = new _asyncLock.default();
const UNIVERSAL_APK = 'universal.apk';
const aabUtilsMethods = {};
process.on('exit', () => {
  if (!AAB_CACHE.size) {
    return;
  }

  const paths = [...AAB_CACHE.values()];

  _logger.default.debug(`Performing cleanup of ${paths.length} cached .aab ` + _support.util.pluralize('package', paths.length));

  for (const appPath of paths) {
    try {
      _support.fs.rimrafSync(appPath);
    } catch (e) {
      _logger.default.warn(e.message);
    }
  }
});

aabUtilsMethods.extractUniversalApk = async function extractUniversalApk(aabPath, opts = {}) {
  if (!(await _support.fs.exists(aabPath))) {
    throw new Error(`The file at '${aabPath}' either does not exist or is not accessible`);
  }

  const aabName = _path.default.basename(aabPath);

  const apkName = aabName.substring(0, aabName.length - _path.default.extname(aabName).length) + '.apk';
  const tmpRoot = await _support.tempDir.openDir();

  const tmpApksPath = _path.default.join(tmpRoot, `${aabName}.apks`);

  try {
    return await AAB_CACHE_GUARD.acquire(aabPath, async () => {
      const aabHash = await _support.fs.hash(aabPath);
      const {
        keystore,
        keystorePassword,
        keyAlias,
        keyPassword
      } = opts;
      let cacheHash = aabHash;

      if (keystore) {
        if (!(await _support.fs.exists(keystore))) {
          throw new Error(`The keystore file at '${keystore}' either does not exist ` + `or is not accessible`);
        }

        if (!keystorePassword || !keyAlias || !keyPassword) {
          throw new Error('It is mandatory to also provide keystore password, key alias, ' + 'and key password if the keystore path is set');
        }

        const keystoreHash = await _support.fs.hash(keystore);

        const keyAliasHash = _crypto.default.createHash('sha1');

        keyAliasHash.update(keyAlias);
        cacheHash = [cacheHash, keystoreHash, keyAliasHash.digest('hex')].join(':');
      }

      _logger.default.debug(`Calculated the cache key for '${aabPath}': ${cacheHash}`);

      if (AAB_CACHE.has(cacheHash)) {
        const resultPath = _path.default.resolve(AAB_CACHE.get(cacheHash), apkName);

        if (await _support.fs.exists(resultPath)) {
          return resultPath;
        }

        AAB_CACHE.del(cacheHash);
      }

      await this.initAapt2();
      const args = ['build-apks', '--aapt2', this.binaries.aapt2, '--bundle', aabPath, '--output', tmpApksPath, ...(keystore ? ['--ks', keystore, '--ks-pass', `pass:${keystorePassword}`, '--ks-key-alias', keyAlias, '--key-pass', `pass:${keyPassword}`] : []), '--mode=universal'];

      _logger.default.debug(`Preparing universal .apks bundle from '${aabPath}'`);

      await this.execBundletool(args, `Cannot build a universal .apks bundle from '${aabPath}'`);

      _logger.default.debug(`Unpacking universal application bundle at '${tmpApksPath}' to '${tmpRoot}'`);

      await (0, _helpers.unzipFile)(tmpApksPath, tmpRoot);
      let universalApkPath;
      const fileDeletionPromises = [];
      const allFileNames = await _support.fs.readdir(tmpRoot);

      for (const fileName of allFileNames) {
        const fullPath = _path.default.join(tmpRoot, fileName);

        if (fileName === UNIVERSAL_APK) {
          universalApkPath = fullPath;
        } else {
          fileDeletionPromises.push(_support.fs.rimraf(fullPath));
        }
      }

      try {
        await _bluebird.default.all(fileDeletionPromises);
      } catch (ign) {}

      if (!universalApkPath) {
        _logger.default.debug(`The following items were extracted from the .aab bundle: ${allFileNames}`);

        throw new Error(`${UNIVERSAL_APK} cannot be found in '${aabPath}' bundle. ` + `Does the archive contain a valid application bundle?`);
      }

      const resultPath = _path.default.join(tmpRoot, apkName);

      _logger.default.debug(`Found ${UNIVERSAL_APK} at '${universalApkPath}'. Caching it to '${resultPath}'`);

      await _support.fs.mv(universalApkPath, resultPath);
      AAB_CACHE.set(cacheHash, tmpRoot);
      return resultPath;
    });
  } catch (e) {
    await _support.fs.rimraf(tmpRoot);
    throw e;
  }
};

var _default = aabUtilsMethods;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGliL3Rvb2xzL2FhYi11dGlscy5qcyIsIm5hbWVzIjpbIkFBQl9DQUNIRSIsIkxSVSIsIm1heCIsImRpc3Bvc2UiLCJoYXNoIiwiZXh0cmFjdGVkRmlsZXNSb290IiwiZnMiLCJyaW1yYWYiLCJBQUJfQ0FDSEVfR1VBUkQiLCJBc3luY0xvY2siLCJVTklWRVJTQUxfQVBLIiwiYWFiVXRpbHNNZXRob2RzIiwicHJvY2VzcyIsIm9uIiwic2l6ZSIsInBhdGhzIiwidmFsdWVzIiwibG9nIiwiZGVidWciLCJsZW5ndGgiLCJ1dGlsIiwicGx1cmFsaXplIiwiYXBwUGF0aCIsInJpbXJhZlN5bmMiLCJlIiwid2FybiIsIm1lc3NhZ2UiLCJleHRyYWN0VW5pdmVyc2FsQXBrIiwiYWFiUGF0aCIsIm9wdHMiLCJleGlzdHMiLCJFcnJvciIsImFhYk5hbWUiLCJwYXRoIiwiYmFzZW5hbWUiLCJhcGtOYW1lIiwic3Vic3RyaW5nIiwiZXh0bmFtZSIsInRtcFJvb3QiLCJ0ZW1wRGlyIiwib3BlbkRpciIsInRtcEFwa3NQYXRoIiwiam9pbiIsImFjcXVpcmUiLCJhYWJIYXNoIiwia2V5c3RvcmUiLCJrZXlzdG9yZVBhc3N3b3JkIiwia2V5QWxpYXMiLCJrZXlQYXNzd29yZCIsImNhY2hlSGFzaCIsImtleXN0b3JlSGFzaCIsImtleUFsaWFzSGFzaCIsImNyeXB0byIsImNyZWF0ZUhhc2giLCJ1cGRhdGUiLCJkaWdlc3QiLCJoYXMiLCJyZXN1bHRQYXRoIiwicmVzb2x2ZSIsImdldCIsImRlbCIsImluaXRBYXB0MiIsImFyZ3MiLCJiaW5hcmllcyIsImFhcHQyIiwiZXhlY0J1bmRsZXRvb2wiLCJ1bnppcEZpbGUiLCJ1bml2ZXJzYWxBcGtQYXRoIiwiZmlsZURlbGV0aW9uUHJvbWlzZXMiLCJhbGxGaWxlTmFtZXMiLCJyZWFkZGlyIiwiZmlsZU5hbWUiLCJmdWxsUGF0aCIsInB1c2giLCJCIiwiYWxsIiwiaWduIiwibXYiLCJzZXQiXSwic291cmNlUm9vdCI6Ii4uLy4uLy4uIiwic291cmNlcyI6WyJsaWIvdG9vbHMvYWFiLXV0aWxzLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyLmpzJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IHsgZnMsIHRlbXBEaXIsIHV0aWwgfSBmcm9tICdAYXBwaXVtL3N1cHBvcnQnO1xuaW1wb3J0IExSVSBmcm9tICdscnUtY2FjaGUnO1xuaW1wb3J0IHsgdW56aXBGaWxlIH0gZnJvbSAnLi4vaGVscGVycy5qcyc7XG5pbXBvcnQgQXN5bmNMb2NrIGZyb20gJ2FzeW5jLWxvY2snO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IGNyeXB0byBmcm9tICdjcnlwdG8nO1xuXG5jb25zdCBBQUJfQ0FDSEUgPSBuZXcgTFJVKHtcbiAgbWF4OiAxMCxcbiAgZGlzcG9zZTogKGhhc2gsIGV4dHJhY3RlZEZpbGVzUm9vdCkgPT4gZnMucmltcmFmKGV4dHJhY3RlZEZpbGVzUm9vdCksXG59KTtcbmNvbnN0IEFBQl9DQUNIRV9HVUFSRCA9IG5ldyBBc3luY0xvY2soKTtcbmNvbnN0IFVOSVZFUlNBTF9BUEsgPSAndW5pdmVyc2FsLmFwayc7XG5cbmNvbnN0IGFhYlV0aWxzTWV0aG9kcyA9IHt9O1xuXG5wcm9jZXNzLm9uKCdleGl0JywgKCkgPT4ge1xuICBpZiAoIUFBQl9DQUNIRS5zaXplKSB7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgY29uc3QgcGF0aHMgPSBbLi4uQUFCX0NBQ0hFLnZhbHVlcygpXTtcbiAgbG9nLmRlYnVnKGBQZXJmb3JtaW5nIGNsZWFudXAgb2YgJHtwYXRocy5sZW5ndGh9IGNhY2hlZCAuYWFiIGAgK1xuICAgIHV0aWwucGx1cmFsaXplKCdwYWNrYWdlJywgcGF0aHMubGVuZ3RoKSk7XG4gIGZvciAoY29uc3QgYXBwUGF0aCBvZiBwYXRocykge1xuICAgIHRyeSB7XG4gICAgICAvLyBBc3luY2hyb25vdXMgY2FsbHMgYXJlIG5vdCBzdXBwb3J0ZWQgaW4gb25FeGl0IGhhbmRsZXJcbiAgICAgIGZzLnJpbXJhZlN5bmMoYXBwUGF0aCk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgbG9nLndhcm4oZS5tZXNzYWdlKTtcbiAgICB9XG4gIH1cbn0pO1xuXG4vKipcbiAqIEB0eXBlZGVmIHtPYmplY3R9IEFwa0NyZWF0aW9uT3B0aW9uc1xuICogQHByb3BlcnR5IHtzdHJpbmd9IGtleXN0b3JlIFNwZWNpZmllcyB0aGUgcGF0aCB0byB0aGUgZGVwbG95bWVudCBrZXlzdG9yZSB1c2VkXG4gKiB0byBzaWduIHRoZSBBUEtzLiBUaGlzIGZsYWcgaXMgb3B0aW9uYWwuIElmIHlvdSBkb24ndCBpbmNsdWRlIGl0LFxuICogYnVuZGxldG9vbCBhdHRlbXB0cyB0byBzaWduIHlvdXIgQVBLcyB3aXRoIGEgZGVidWcgc2lnbmluZyBrZXkuXG4gKiBJZiB0aGUgLmFwayBoYXMgYmVlbiBhbHJlYWR5IHNpZ25lZCBhbmQgY2FjaGVkIHRoZW4gaXQgaXMgbm90IGdvaW5nIHRvIGJlIHJlc2lnbmVkXG4gKiB1bmxlc3MgYSBkaWZmZXJlbnQga2V5c3RvcmUgb3Iga2V5IGFsaWFzIGlzIHVzZWQuXG4gKiBAcHJvcGVydHkge3N0cmluZ30ga2V5c3RvcmVQYXNzd29yZCBTcGVjaWZpZXMgeW91ciBrZXlzdG9yZeKAmXMgcGFzc3dvcmQuXG4gKiBJdCBpcyBtYW5kYXRvcnkgdG8gcHJvdmlkZSB0aGlzIHZhbHVlIGlmIGBrZXlzdG9yZWAgb25lIGlzIGFzc2lnbmVkXG4gKiBvdGhlcndpc2UgaXQgaXMgZ29pbmcgdG8gYmUgaWdub3JlZC5cbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBrZXlBbGlhcyBTcGVjaWZpZXMgdGhlIGFsaWFzIG9mIHRoZSBzaWduaW5nIGtleSB5b3Ugd2FudCB0byB1c2UuXG4gKiBJdCBpcyBtYW5kYXRvcnkgdG8gcHJvdmlkZSB0aGlzIHZhbHVlIGlmIGBrZXlzdG9yZWAgb25lIGlzIGFzc2lnbmVkXG4gKiBvdGhlcndpc2UgaXQgaXMgZ29pbmcgdG8gYmUgaWdub3JlZC5cbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBrZXlQYXNzd29yZCBTcGVjaWZpZXMgdGhlIHBhc3N3b3JkIGZvciB0aGUgc2lnbmluZyBrZXkuXG4gKiBJdCBpcyBtYW5kYXRvcnkgdG8gcHJvdmlkZSB0aGlzIHZhbHVlIGlmIGBrZXlzdG9yZWAgb25lIGlzIGFzc2lnbmVkXG4gKiBvdGhlcndpc2UgaXQgaXMgZ29pbmcgdG8gYmUgaWdub3JlZC5cbiAqL1xuXG4vKipcbiAqIEJ1aWxkcyBhIHVuaXZlcnNhbCAuYXBrIGZyb20gdGhlIGdpdmVuIC5hYWIgcGFja2FnZS4gU2VlXG4gKiBodHRwczovL2RldmVsb3Blci5hbmRyb2lkLmNvbS9zdHVkaW8vY29tbWFuZC1saW5lL2J1bmRsZXRvb2wjZ2VuZXJhdGVfYXBrc1xuICogZm9yIG1vcmUgZGV0YWlscy5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gYWFiUGF0aCBGdWxsIHBhdGggdG8gdGhlIHNvdXJjZSAuYWFiIHBhY2thZ2VcbiAqIEBwYXJhbSB7QXBrQ3JlYXRpb25PcHRpb25zfSBvcHRzXG4gKiBAcmV0dXJucyBUaGUgcGF0aCB0byB0aGUgcmVzdWx0aW5nIHVuaXZlcnNhbCAuYXBrLiBUaGUgLmFwayBpcyBzdG9yZWQgaW4gdGhlIGludGVybmFsIGNhY2hlXG4gKiBieSBkZWZhdWx0LlxuICogQHRocm93cyB7RXJyb3J9IElmIHRoZXJlIHdhcyBhbiBlcnJvciB3aGlsZSBjcmVhdGluZyB0aGUgdW5pdmVyc2FsIC5hcGtcbiAqL1xuYWFiVXRpbHNNZXRob2RzLmV4dHJhY3RVbml2ZXJzYWxBcGsgPSBhc3luYyBmdW5jdGlvbiBleHRyYWN0VW5pdmVyc2FsQXBrIChhYWJQYXRoLCBvcHRzID0ge30pIHtcbiAgaWYgKCFhd2FpdCBmcy5leGlzdHMoYWFiUGF0aCkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSBmaWxlIGF0ICcke2FhYlBhdGh9JyBlaXRoZXIgZG9lcyBub3QgZXhpc3Qgb3IgaXMgbm90IGFjY2Vzc2libGVgKTtcbiAgfVxuXG4gIGNvbnN0IGFhYk5hbWUgPSBwYXRoLmJhc2VuYW1lKGFhYlBhdGgpO1xuICBjb25zdCBhcGtOYW1lID0gYWFiTmFtZS5zdWJzdHJpbmcoMCwgYWFiTmFtZS5sZW5ndGggLSBwYXRoLmV4dG5hbWUoYWFiTmFtZSkubGVuZ3RoKSArICcuYXBrJztcbiAgY29uc3QgdG1wUm9vdCA9IGF3YWl0IHRlbXBEaXIub3BlbkRpcigpO1xuICBjb25zdCB0bXBBcGtzUGF0aCA9IHBhdGguam9pbih0bXBSb290LCBgJHthYWJOYW1lfS5hcGtzYCk7XG4gIHRyeSB7XG4gICAgcmV0dXJuIGF3YWl0IEFBQl9DQUNIRV9HVUFSRC5hY3F1aXJlKGFhYlBhdGgsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGFhYkhhc2ggPSBhd2FpdCBmcy5oYXNoKGFhYlBhdGgpO1xuICAgICAgY29uc3Qge1xuICAgICAgICBrZXlzdG9yZSxcbiAgICAgICAga2V5c3RvcmVQYXNzd29yZCxcbiAgICAgICAga2V5QWxpYXMsXG4gICAgICAgIGtleVBhc3N3b3JkLFxuICAgICAgfSA9IG9wdHM7XG4gICAgICBsZXQgY2FjaGVIYXNoID0gYWFiSGFzaDtcbiAgICAgIGlmIChrZXlzdG9yZSkge1xuICAgICAgICBpZiAoIWF3YWl0IGZzLmV4aXN0cyhrZXlzdG9yZSkpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFRoZSBrZXlzdG9yZSBmaWxlIGF0ICcke2tleXN0b3JlfScgZWl0aGVyIGRvZXMgbm90IGV4aXN0IGAgK1xuICAgICAgICAgICAgYG9yIGlzIG5vdCBhY2Nlc3NpYmxlYCk7XG4gICAgICAgIH1cbiAgICAgICAgaWYgKCFrZXlzdG9yZVBhc3N3b3JkIHx8ICFrZXlBbGlhcyB8fCAha2V5UGFzc3dvcmQpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0l0IGlzIG1hbmRhdG9yeSB0byBhbHNvIHByb3ZpZGUga2V5c3RvcmUgcGFzc3dvcmQsIGtleSBhbGlhcywgJyArXG4gICAgICAgICAgICAnYW5kIGtleSBwYXNzd29yZCBpZiB0aGUga2V5c3RvcmUgcGF0aCBpcyBzZXQnKTtcbiAgICAgICAgfVxuICAgICAgICBjb25zdCBrZXlzdG9yZUhhc2ggPSBhd2FpdCBmcy5oYXNoKGtleXN0b3JlKTtcbiAgICAgICAgY29uc3Qga2V5QWxpYXNIYXNoID0gY3J5cHRvLmNyZWF0ZUhhc2goJ3NoYTEnKTtcbiAgICAgICAga2V5QWxpYXNIYXNoLnVwZGF0ZShrZXlBbGlhcyk7XG4gICAgICAgIGNhY2hlSGFzaCA9IFtjYWNoZUhhc2gsIGtleXN0b3JlSGFzaCwga2V5QWxpYXNIYXNoLmRpZ2VzdCgnaGV4JyldLmpvaW4oJzonKTtcbiAgICAgIH1cbiAgICAgIGxvZy5kZWJ1ZyhgQ2FsY3VsYXRlZCB0aGUgY2FjaGUga2V5IGZvciAnJHthYWJQYXRofSc6ICR7Y2FjaGVIYXNofWApO1xuICAgICAgaWYgKEFBQl9DQUNIRS5oYXMoY2FjaGVIYXNoKSkge1xuICAgICAgICBjb25zdCByZXN1bHRQYXRoID0gcGF0aC5yZXNvbHZlKEFBQl9DQUNIRS5nZXQoY2FjaGVIYXNoKSwgYXBrTmFtZSk7XG4gICAgICAgIGlmIChhd2FpdCBmcy5leGlzdHMocmVzdWx0UGF0aCkpIHtcbiAgICAgICAgICByZXR1cm4gcmVzdWx0UGF0aDtcbiAgICAgICAgfVxuICAgICAgICBBQUJfQ0FDSEUuZGVsKGNhY2hlSGFzaCk7XG4gICAgICB9XG5cbiAgICAgIGF3YWl0IHRoaXMuaW5pdEFhcHQyKCk7XG4gICAgICBjb25zdCBhcmdzID0gW1xuICAgICAgICAnYnVpbGQtYXBrcycsXG4gICAgICAgICctLWFhcHQyJywgdGhpcy5iaW5hcmllcy5hYXB0MixcbiAgICAgICAgJy0tYnVuZGxlJywgYWFiUGF0aCxcbiAgICAgICAgJy0tb3V0cHV0JywgdG1wQXBrc1BhdGgsXG4gICAgICAgIC4uLihrZXlzdG9yZSA/IFtcbiAgICAgICAgICAnLS1rcycsIGtleXN0b3JlLFxuICAgICAgICAgICctLWtzLXBhc3MnLCBgcGFzczoke2tleXN0b3JlUGFzc3dvcmR9YCxcbiAgICAgICAgICAnLS1rcy1rZXktYWxpYXMnLCBrZXlBbGlhcyxcbiAgICAgICAgICAnLS1rZXktcGFzcycsIGBwYXNzOiR7a2V5UGFzc3dvcmR9YCxcbiAgICAgICAgXSA6IFtdKSxcbiAgICAgICAgJy0tbW9kZT11bml2ZXJzYWwnXG4gICAgICBdO1xuICAgICAgbG9nLmRlYnVnKGBQcmVwYXJpbmcgdW5pdmVyc2FsIC5hcGtzIGJ1bmRsZSBmcm9tICcke2FhYlBhdGh9J2ApO1xuICAgICAgYXdhaXQgdGhpcy5leGVjQnVuZGxldG9vbChhcmdzLCBgQ2Fubm90IGJ1aWxkIGEgdW5pdmVyc2FsIC5hcGtzIGJ1bmRsZSBmcm9tICcke2FhYlBhdGh9J2ApO1xuXG4gICAgICBsb2cuZGVidWcoYFVucGFja2luZyB1bml2ZXJzYWwgYXBwbGljYXRpb24gYnVuZGxlIGF0ICcke3RtcEFwa3NQYXRofScgdG8gJyR7dG1wUm9vdH0nYCk7XG4gICAgICBhd2FpdCB1bnppcEZpbGUodG1wQXBrc1BhdGgsIHRtcFJvb3QpO1xuICAgICAgbGV0IHVuaXZlcnNhbEFwa1BhdGg7XG4gICAgICBjb25zdCBmaWxlRGVsZXRpb25Qcm9taXNlcyA9IFtdO1xuICAgICAgY29uc3QgYWxsRmlsZU5hbWVzID0gYXdhaXQgZnMucmVhZGRpcih0bXBSb290KTtcbiAgICAgIGZvciAoY29uc3QgZmlsZU5hbWUgb2YgYWxsRmlsZU5hbWVzKSB7XG4gICAgICAgIGNvbnN0IGZ1bGxQYXRoID0gcGF0aC5qb2luKHRtcFJvb3QsIGZpbGVOYW1lKTtcbiAgICAgICAgaWYgKGZpbGVOYW1lID09PSBVTklWRVJTQUxfQVBLKSB7XG4gICAgICAgICAgdW5pdmVyc2FsQXBrUGF0aCA9IGZ1bGxQYXRoO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGZpbGVEZWxldGlvblByb21pc2VzLnB1c2goZnMucmltcmFmKGZ1bGxQYXRoKSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IEIuYWxsKGZpbGVEZWxldGlvblByb21pc2VzKTtcbiAgICAgIH0gY2F0Y2ggKGlnbikge31cbiAgICAgIGlmICghdW5pdmVyc2FsQXBrUGF0aCkge1xuICAgICAgICBsb2cuZGVidWcoYFRoZSBmb2xsb3dpbmcgaXRlbXMgd2VyZSBleHRyYWN0ZWQgZnJvbSB0aGUgLmFhYiBidW5kbGU6ICR7YWxsRmlsZU5hbWVzfWApO1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYCR7VU5JVkVSU0FMX0FQS30gY2Fubm90IGJlIGZvdW5kIGluICcke2FhYlBhdGh9JyBidW5kbGUuIGAgK1xuICAgICAgICAgIGBEb2VzIHRoZSBhcmNoaXZlIGNvbnRhaW4gYSB2YWxpZCBhcHBsaWNhdGlvbiBidW5kbGU/YCk7XG4gICAgICB9XG4gICAgICBjb25zdCByZXN1bHRQYXRoID0gcGF0aC5qb2luKHRtcFJvb3QsIGFwa05hbWUpO1xuICAgICAgbG9nLmRlYnVnKGBGb3VuZCAke1VOSVZFUlNBTF9BUEt9IGF0ICcke3VuaXZlcnNhbEFwa1BhdGh9Jy4gQ2FjaGluZyBpdCB0byAnJHtyZXN1bHRQYXRofSdgKTtcbiAgICAgIGF3YWl0IGZzLm12KHVuaXZlcnNhbEFwa1BhdGgsIHJlc3VsdFBhdGgpO1xuICAgICAgQUFCX0NBQ0hFLnNldChjYWNoZUhhc2gsIHRtcFJvb3QpO1xuICAgICAgcmV0dXJuIHJlc3VsdFBhdGg7XG4gICAgfSk7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICBhd2FpdCBmcy5yaW1yYWYodG1wUm9vdCk7XG4gICAgdGhyb3cgZTtcbiAgfVxufTtcblxuZXhwb3J0IGRlZmF1bHQgYWFiVXRpbHNNZXRob2RzO1xuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLE1BQU1BLFNBQVMsR0FBRyxJQUFJQyxpQkFBSixDQUFRO0VBQ3hCQyxHQUFHLEVBQUUsRUFEbUI7RUFFeEJDLE9BQU8sRUFBRSxDQUFD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
