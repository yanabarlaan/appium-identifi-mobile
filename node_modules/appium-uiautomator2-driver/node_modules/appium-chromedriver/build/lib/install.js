"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.doInstall = doInstall;
exports.install = install;

require("source-map-support/register");

var _support = require("@appium/support");

var _storageClient = _interopRequireDefault(require("./storage-client"));

var _utils = require("./utils");

const DOWNLOAD_TIMEOUT_MS = 15 * 1000;
const LATEST_VERSION = 'LATEST';

async function formatCdVersion(ver) {
  return ver === LATEST_VERSION ? (await (0, _utils.retrieveData)(`${_utils.CD_CDN}/LATEST_RELEASE`, {
    'user-agent': 'appium',
    accept: '*/*'
  }, {
    timeout: DOWNLOAD_TIMEOUT_MS
  })).trim() : ver;
}

async function prepareChromedriverDir(platformName) {
  const chromedriverDir = (0, _utils.getChromedriverDir)(platformName);

  if (!(await _support.fs.exists(chromedriverDir))) {
    await (0, _support.mkdirp)(chromedriverDir);
  }

  return chromedriverDir;
}

async function install() {
  const osInfo = await (0, _utils.getOsInfo)();
  const client = new _storageClient.default({
    chromedriverDir: await prepareChromedriverDir(osInfo.name)
  });
  await client.syncDrivers({
    osInfo,
    versions: [await formatCdVersion(_utils.CD_VER)]
  });
}

async function doInstall() {
  await install();
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGliL2luc3RhbGwuanMiLCJuYW1lcyI6WyJET1dOTE9BRF9USU1FT1VUX01TIiwiTEFURVNUX1ZFUlNJT04iLCJmb3JtYXRDZFZlcnNpb24iLCJ2ZXIiLCJDRF9DRE4iLCJhY2NlcHQiLCJ0aW1lb3V0IiwidHJpbSIsInByZXBhcmVDaHJvbWVkcml2ZXJEaXIiLCJwbGF0Zm9ybU5hbWUiLCJjaHJvbWVkcml2ZXJEaXIiLCJmcyIsImV4aXN0cyIsImluc3RhbGwiLCJvc0luZm8iLCJjbGllbnQiLCJDaHJvbWVkcml2ZXJTdG9yYWdlQ2xpZW50IiwibmFtZSIsInN5bmNEcml2ZXJzIiwidmVyc2lvbnMiLCJDRF9WRVIiLCJkb0luc3RhbGwiXSwic291cmNlUm9vdCI6Ii4uLy4uIiwic291cmNlcyI6WyJsaWIvaW5zdGFsbC5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBmcywgbWtkaXJwIH0gZnJvbSAnQGFwcGl1bS9zdXBwb3J0JztcbmltcG9ydCBDaHJvbWVkcml2ZXJTdG9yYWdlQ2xpZW50IGZyb20gJy4vc3RvcmFnZS1jbGllbnQnO1xuaW1wb3J0IHtcbiAgQ0RfQ0ROLCBDRF9WRVIsIHJldHJpZXZlRGF0YSwgZ2V0T3NJbmZvLCBnZXRDaHJvbWVkcml2ZXJEaXIsXG59IGZyb20gJy4vdXRpbHMnO1xuXG5cbmNvbnN0IERPV05MT0FEX1RJTUVPVVRfTVMgPSAxNSAqIDEwMDA7XG5jb25zdCBMQVRFU1RfVkVSU0lPTiA9ICdMQVRFU1QnO1xuXG5hc3luYyBmdW5jdGlvbiBmb3JtYXRDZFZlcnNpb24gKHZlcikge1xuICByZXR1cm4gdmVyID09PSBMQVRFU1RfVkVSU0lPTlxuICAgID8gKGF3YWl0IHJldHJpZXZlRGF0YShgJHtDRF9DRE59L0xBVEVTVF9SRUxFQVNFYCwge1xuICAgICAgJ3VzZXItYWdlbnQnOiAnYXBwaXVtJyxcbiAgICAgIGFjY2VwdDogJyovKicsXG4gICAgfSwgeyB0aW1lb3V0OiBET1dOTE9BRF9USU1FT1VUX01TIH0pKS50cmltKClcbiAgICA6IHZlcjtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcHJlcGFyZUNocm9tZWRyaXZlckRpciAocGxhdGZvcm1OYW1lKSB7XG4gIGNvbnN0IGNocm9tZWRyaXZlckRpciA9IGdldENocm9tZWRyaXZlckRpcihwbGF0Zm9ybU5hbWUpO1xuICBpZiAoIWF3YWl0IGZzLmV4aXN0cyhjaHJvbWVkcml2ZXJEaXIpKSB7XG4gICAgYXdhaXQgbWtkaXJwKGNocm9tZWRyaXZlckRpcik7XG4gIH1cbiAgcmV0dXJuIGNocm9tZWRyaXZlckRpcjtcbn1cblxuYXN5bmMgZnVuY3Rpb24gaW5zdGFsbCAoKSB7XG4gIGNvbnN0IG9zSW5mbyA9IGF3YWl0IGdldE9zSW5mbygpO1xuICBjb25zdCBjbGllbnQgPSBuZXcgQ2hyb21lZHJpdmVyU3RvcmFnZUNsaWVudCh7XG4gICAgY2hyb21lZHJpdmVyRGlyOiBhd2FpdCBwcmVwYXJlQ2hyb21lZHJpdmVyRGlyKG9zSW5mby5uYW1lKSxcbiAgfSk7XG4gIGF3YWl0IGNsaWVudC5zeW5jRHJpdmVycyh7XG4gICAgb3NJbmZvLFxuICAgIHZlcnNpb25zOiBbYXdhaXQgZm9ybWF0Q2RWZXJzaW9uKENEX1ZFUildLFxuICB9KTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gZG9JbnN0YWxsICgpIHtcbiAgYXdhaXQgaW5zdGFsbCgpO1xufVxuXG5leHBvcnQgeyBpbnN0YWxsLCBkb0luc3RhbGwgfTtcbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBS0EsTUFBTUEsbUJBQW1CLEdBQUcsS0FBSyxJQUFqQztBQUNBLE1BQU1DLGNBQWMsR0FBRyxRQUF2Qjs7QUFFQSxlQUFlQyxlQUFmLENBQWdDQyxHQUFoQyxFQUFxQztFQUNuQyxPQUFPQSxHQUFHLEtBQUtGLGNBQVIsR0FDSCxDQUFDLE1BQU0seUJBQWMsR0FBRUcsYUFBTyxpQkFBdkIsRUFBeUM7SUFDaEQsY0FBYyxRQURrQztJQUVoREMsTUFBTSxFQUFFO0VBRndDLENBQXpDLEVBR047SUFBRUMsT0FBTyxFQUFFTjtFQUFYLENBSE0sQ0FBUCxFQUdvQ08sSUFIcEMsRUFERyxHQUtISixHQUxKO0FBTUQ7O0FBRUQsZUFBZUssc0JBQWYsQ0FBdUNDLFlBQXZDLEVBQXFEO0VBQ25ELE1BQU1DLGVBQWUsR0FBRywrQkFBbUJELFlBQW5CLENBQXhCOztFQUNBLElBQUksRUFBQyxNQUFNRSxZQUFHQyxNQUFILENBQVVGLGVBQVYsQ0FBUCxDQUFKLEVBQXVDO0lBQ3JDLE1BQU0scUJBQU9BLGVBQVAsQ0FBTjtFQUNEOztFQUNELE9BQU9BLGVBQVA7QUFDRDs7QUFFRCxlQUFlRyxPQUFmLEdBQTBCO0VBQ3hCLE1BQU1DLE1BQU0sR0FBRyxNQUFNLHVCQUFyQjtFQUNBLE1BQU1DLE1BQU0sR0FBRyxJQUFJQyxzQkFBSixDQUE4QjtJQUMzQ04sZUFBZSxFQUFFLE1BQU1GLHNCQUFzQixDQUFDTSxNQUFNLENBQUNHLElBQVI7RUFERixDQUE5QixDQUFmO0VBR0EsTUFBTUYsTUFBTSxDQUFDRyxXQUFQLENBQW1CO0lBQ3ZCSixNQUR1QjtJQUV2QkssUUFBUSxFQUFFLENBQUMsTUFBTWpCLGVBQWUsQ0FBQ2tCLGFBQUQsQ0FBdEI7RUFGYSxDQUFuQixDQUFOO0FBSUQ7O0FBRUQsZUFBZUMsU0FBZixHQUE0QjtFQUMxQixNQUFNUixPQUFPLEVBQWI7QUFDRCJ9
