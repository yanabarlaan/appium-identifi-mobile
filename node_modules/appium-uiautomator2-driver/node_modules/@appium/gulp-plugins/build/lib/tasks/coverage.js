'use strict';

require("source-map-support/register");

const B = require('bluebird');

const globby = require('globby');

const _ = require('lodash');

const cp = require('child_process');

const spawn = cp.spawn;
const exec = B.promisify(cp.exec);

const path = require('path');

const utils = require('../utils');

const log = require('fancy-log');

const configure = function configure(gulp, opts, env) {
  let npmBin;
  gulp.task('npm-bin', async function getNpmBin() {
    if (npmBin) {
      return B.resolve();
    }

    let bin = await exec('npm bin');

    if (Array.isArray(bin)) {
      bin = bin[0];
    }

    npmBin = bin.trim();
    log(`Determined npm bin: ${npmBin}`);
  });

  const doCoverage = function doCoverage(taskName, filePatterns, targetDir) {
    const subTaskName = `${taskName}:run`;
    const covTestFiles = utils.translatePaths([filePatterns], env.fileAliases);
    gulp.task(subTaskName, async function doSubTask() {
      const files = await globby(covTestFiles);
      const bins = ['nyc', '_mocha'].reduce(function getFullPaths(bins, item) {
        bins[item] = path.resolve(npmBin, item);
        return bins;
      }, {});
      const args = ['--reporter=lcov', '--reporter=text-lcov', '--reporter=cobertura', `--report-dir=${targetDir}`, '--exclude-after-remap=false', bins._mocha, '--reporter=dot', ...files, '--exit'];

      let env = _.clone(process.env);

      env.NO_PRECOMPILE = 1;
      env._TESTING = 1;
      env.NODE_ENV = 'coverage';
      log(`Running command: ${bins.nyc} ${args.join(' ')}`);
      return new B(function runCmd(resolve, reject) {
        const proc = spawn(bins.nyc, args, {
          env,
          stdio: opts.coverage.verbose ? 'inherit' : 'ignore'
        });
        proc.on('close', function onClose(code) {
          if (code === 0) {
            resolve();
          } else {
            reject(new Error(`Coverage command exit code: ${code}`));
          }
        });
        proc.on('error', function onError(err) {
          reject(new Error(`Coverage error: ${err}`));
        });
      });
    });
    gulp.task(taskName, gulp.series('clean', 'transpile', 'npm-bin', subTaskName));
  };

  if (opts.coverage) {
    doCoverage('coverage', opts.coverage.files, 'coverage');
    ['coveralls:run', 'coveralls'].map(taskName => gulp.task(taskName, function reportDeprecatedCoveralls() {
      log(`Coveralls integration has been removed as per ` + `https://github.com/appium/appium/issues/14648. ` + `Nothing will be done in scope of '${taskName}' task`);
    }));
  }

  if (opts['coverage-e2e']) {
    doCoverage('coverage-e2e', opts['coverage-e2e'].files, 'coverage-e2e');
  }
};

module.exports = {
  configure
};require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGliL3Rhc2tzL2NvdmVyYWdlLmpzIiwibmFtZXMiOlsiQiIsInJlcXVpcmUiLCJnbG9iYnkiLCJfIiwiY3AiLCJzcGF3biIsImV4ZWMiLCJwcm9taXNpZnkiLCJwYXRoIiwidXRpbHMiLCJsb2ciLCJjb25maWd1cmUiLCJndWxwIiwib3B0cyIsImVudiIsIm5wbUJpbiIsInRhc2siLCJnZXROcG1CaW4iLCJyZXNvbHZlIiwiYmluIiwiQXJyYXkiLCJpc0FycmF5IiwidHJpbSIsImRvQ292ZXJhZ2UiLCJ0YXNrTmFtZSIsImZpbGVQYXR0ZXJucyIsInRhcmdldERpciIsInN1YlRhc2tOYW1lIiwiY292VGVzdEZpbGVzIiwidHJhbnNsYXRlUGF0aHMiLCJmaWxlQWxpYXNlcyIsImRvU3ViVGFzayIsImZpbGVzIiwiYmlucyIsInJlZHVjZSIsImdldEZ1bGxQYXRocyIsIml0ZW0iLCJhcmdzIiwiX21vY2hhIiwiY2xvbmUiLCJwcm9jZXNzIiwiTk9fUFJFQ09NUElMRSIsIl9URVNUSU5HIiwiTk9ERV9FTlYiLCJueWMiLCJqb2luIiwicnVuQ21kIiwicmVqZWN0IiwicHJvYyIsInN0ZGlvIiwiY292ZXJhZ2UiLCJ2ZXJib3NlIiwib24iLCJvbkNsb3NlIiwiY29kZSIsIkVycm9yIiwib25FcnJvciIsImVyciIsInNlcmllcyIsIm1hcCIsInJlcG9ydERlcHJlY2F0ZWRDb3ZlcmFsbHMiLCJtb2R1bGUiLCJleHBvcnRzIl0sInNvdXJjZVJvb3QiOiIuLi8uLi8uLiIsInNvdXJjZXMiOlsibGliL3Rhc2tzL2NvdmVyYWdlLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIid1c2Ugc3RyaWN0JztcblxuY29uc3QgQiA9IHJlcXVpcmUoJ2JsdWViaXJkJyk7XG5jb25zdCBnbG9iYnkgPSByZXF1aXJlKCdnbG9iYnknKTtcbmNvbnN0IF8gPSByZXF1aXJlKCdsb2Rhc2gnKTtcbmNvbnN0IGNwID0gcmVxdWlyZSgnY2hpbGRfcHJvY2VzcycpO1xuY29uc3Qgc3Bhd24gPSBjcC5zcGF3bjtcbmNvbnN0IGV4ZWMgPSBCLnByb21pc2lmeShjcC5leGVjKTtcbmNvbnN0IHBhdGggPSByZXF1aXJlKCdwYXRoJyk7XG5jb25zdCB1dGlscyA9IHJlcXVpcmUoJy4uL3V0aWxzJyk7XG5jb25zdCBsb2cgPSByZXF1aXJlKCdmYW5jeS1sb2cnKTtcblxuXG5jb25zdCBjb25maWd1cmUgPSBmdW5jdGlvbiBjb25maWd1cmUgKGd1bHAsIG9wdHMsIGVudikge1xuICBsZXQgbnBtQmluO1xuICBndWxwLnRhc2soJ25wbS1iaW4nLCBhc3luYyBmdW5jdGlvbiBnZXROcG1CaW4gKCkge1xuICAgIGlmIChucG1CaW4pIHtcbiAgICAgIHJldHVybiBCLnJlc29sdmUoKTtcbiAgICB9XG4gICAgbGV0IGJpbiA9IGF3YWl0IGV4ZWMoJ25wbSBiaW4nKTtcbiAgICBpZiAoQXJyYXkuaXNBcnJheShiaW4pKSB7XG4gICAgICBiaW4gPSBiaW5bMF07XG4gICAgfVxuICAgIG5wbUJpbiA9IGJpbi50cmltKCk7IC8vIGVzbGludC1kaXNhYmxlLWxpbmUgcmVxdWlyZS1hdG9taWMtdXBkYXRlc1xuICAgIGxvZyhgRGV0ZXJtaW5lZCBucG0gYmluOiAke25wbUJpbn1gKTtcbiAgfSk7XG5cbiAgY29uc3QgZG9Db3ZlcmFnZSA9IGZ1bmN0aW9uIGRvQ292ZXJhZ2UgKHRhc2tOYW1lLCBmaWxlUGF0dGVybnMsIHRhcmdldERpcikge1xuICAgIGNvbnN0IHN1YlRhc2tOYW1lID0gYCR7dGFza05hbWV9OnJ1bmA7XG4gICAgY29uc3QgY292VGVzdEZpbGVzID0gdXRpbHMudHJhbnNsYXRlUGF0aHMoW2ZpbGVQYXR0ZXJuc10sIGVudi5maWxlQWxpYXNlcyk7XG4gICAgZ3VscC50YXNrKHN1YlRhc2tOYW1lLCBhc3luYyBmdW5jdGlvbiBkb1N1YlRhc2sgKCkge1xuICAgICAgY29uc3QgZmlsZXMgPSBhd2FpdCBnbG9iYnkoY292VGVzdEZpbGVzKTtcbiAgICAgIGNvbnN0IGJpbnMgPSBbJ255YycsICdfbW9jaGEnXS5yZWR1Y2UoZnVuY3Rpb24gZ2V0RnVsbFBhdGhzIChiaW5zLCBpdGVtKSB7XG4gICAgICAgIGJpbnNbaXRlbV0gPSBwYXRoLnJlc29sdmUobnBtQmluLCBpdGVtKTtcbiAgICAgICAgcmV0dXJuIGJpbnM7XG4gICAgICB9LCB7fSk7XG4gICAgICBjb25zdCBhcmdzID0gW1xuICAgICAgICAnLS1yZXBvcnRlcj1sY292JyxcbiAgICAgICAgJy0tcmVwb3J0ZXI9dGV4dC1sY292JywgLy8gQ292ZXJhbGxzIGNvbnN1bWVzIGxjb3YgYW5kIHRleHQtbGNvdiByZXBvcnRzXG4gICAgICAgICctLXJlcG9ydGVyPWNvYmVydHVyYScsIC8vIE1TIEF6dXJlIGNvbnN1bWVzIENvYmVydHVyYSBjb3ZlcmFnZSByZXBvcnRzXG4gICAgICAgIGAtLXJlcG9ydC1kaXI9JHt0YXJnZXREaXJ9YCxcbiAgICAgICAgJy0tZXhjbHVkZS1hZnRlci1yZW1hcD1mYWxzZScsXG4gICAgICAgIGJpbnMuX21vY2hhLFxuICAgICAgICAnLS1yZXBvcnRlcj1kb3QnLFxuICAgICAgICAuLi5maWxlcyxcbiAgICAgICAgJy0tZXhpdCcsXG4gICAgICBdO1xuICAgICAgbGV0IGVudiA9IF8uY2xvbmUocHJvY2Vzcy5lbnYpO1xuICAgICAgZW52Lk5PX1BSRUNPTVBJTEUgPSAxO1xuICAgICAgZW52Ll9URVNUSU5HID0gMTtcbiAgICAgIGVudi5OT0RFX0VOViA9ICdjb3ZlcmFnZSc7XG4gICAgICBsb2coYFJ1bm5pbmcgY29tbWFuZDogJHtiaW5zLm55Y30gJHthcmdzLmpvaW4oJyAnKX1gKTtcbiAgICAgIHJldHVybiBuZXcgQihmdW5jdGlvbiBydW5DbWQgKHJlc29sdmUsIHJlamVjdCkge1xuICAgICAgICBjb25zdCBwcm9jID0gc3Bhd24oYmlucy5ueWMsIGFyZ3MsIHtcbiAgICAgICAgICBlbnYsXG4gICAgICAgICAgc3RkaW86IG9wdHMuY292ZXJhZ2UudmVyYm9zZSA/ICdpbmhlcml0JyA6ICdpZ25vcmUnLFxuICAgICAgICB9KTtcbiAgICAgICAgcHJvYy5vbignY2xvc2UnLCBmdW5jdGlvbiBvbkNsb3NlIChjb2RlKSB7XG4gICAgICAgICAgaWYgKGNvZGUgPT09IDApIHtcbiAgICAgICAgICAgIHJlc29sdmUoKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgcmVqZWN0KG5ldyBFcnJvcihgQ292ZXJhZ2UgY29tbWFuZCBleGl0IGNvZGU6ICR7Y29kZX1gKSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgICAgcHJvYy5vbignZXJyb3InLCBmdW5jdGlvbiBvbkVycm9yIChlcnIpIHtcbiAgICAgICAgICByZWplY3QobmV3IEVycm9yKGBDb3ZlcmFnZSBlcnJvcjogJHtlcnJ9YCkpO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuICAgIH0pO1xuICAgIGd1bHAudGFzayh0YXNrTmFtZSwgZ3VscC5zZXJpZXMoJ2NsZWFuJywgJ3RyYW5zcGlsZScsICducG0tYmluJywgc3ViVGFza05hbWUpKTtcbiAgfTtcblxuICBpZiAob3B0cy5jb3ZlcmFnZSkge1xuICAgIGRvQ292ZXJhZ2UoJ2NvdmVyYWdlJywgb3B0cy5jb3ZlcmFnZS5maWxlcywgJ2NvdmVyYWdlJyk7XG4gICAgWydjb3ZlcmFsbHM6cnVuJywgJ2NvdmVyYWxscyddXG4gICAgICAubWFwKCh0YXNrTmFtZSkgPT4gZ3VscC50YXNrKHRhc2tOYW1lLCBmdW5jdGlvbiByZXBvcnREZXByZWNhdGVkQ292ZXJhbGxzICgpIHtcbiAgICAgICAgbG9nKGBDb3ZlcmFsbHMgaW50ZWdyYXRpb24gaGFzIGJlZW4gcmVtb3ZlZCBhcyBwZXIgYCArXG4gICAgICAgICAgYGh0dHBzOi8vZ2l0aHViLmNvbS9hcHBpdW0vYXBwaXVtL2lzc3Vlcy8xNDY0OC4gYCArXG4gICAgICAgICAgYE5vdGhpbmcgd2lsbCBiZSBkb25lIGluIHNjb3BlIG9mICcke3Rhc2tOYW1lfScgdGFza2ApO1xuICAgICAgfSkpO1xuICB9XG4gIGlmIChvcHRzWydjb3ZlcmFnZS1lMmUnXSkge1xuICAgIGRvQ292ZXJhZ2UoJ2NvdmVyYWdlLWUyZScsIG9wdHNbJ2NvdmVyYWdlLWUyZSddLmZpbGVzLCAnY292ZXJhZ2UtZTJlJyk7XG4gIH1cbn07XG5cbm1vZHVsZS5leHBvcnRzID0ge1xuICBjb25maWd1cmUsXG59O1xuIl0sIm1hcHBpbmdzIjoiQUFBQTs7OztBQUVBLE1BQU1BLENBQUMsR0FBR0MsT0FBTyxDQUFDLFVBQUQsQ0FBakI7O0FBQ0EsTUFBTUMsTUFBTSxHQUFHRCxPQUFPLENBQUMsUUFBRCxDQUF0Qjs7QUFDQSxNQUFNRSxDQUFDLEdBQUdGLE9BQU8sQ0FBQyxRQUFELENBQWpCOztBQUNBLE1BQU1HLEVBQUUsR0FBR0gsT0FBTyxDQUFDLGVBQUQsQ0FBbEI7O0FBQ0EsTUFBTUksS0FBSyxHQUFHRCxFQUFFLENBQUNDLEtBQWpCO0FBQ0EsTUFBTUMsSUFBSSxHQUFHTixDQUFDLENBQUNPLFNBQUYsQ0FBWUgsRUFBRSxDQUFDRSxJQUFmLENBQWI7O0FBQ0EsTUFBTUUsSUFBSSxHQUFHUCxPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFDQSxNQUFNUSxLQUFLLEdBQUdSLE9BQU8sQ0FBQyxVQUFELENBQXJCOztBQUNBLE1BQU1TLEdBQUcsR0FBR1QsT0FBTyxDQUFDLFdBQUQsQ0FBbkI7O0FBR0EsTUFBTVUsU0FBUyxHQUFHLFNBQVNBLFNBQVQsQ0FBb0JDLElBQXBCLEVBQTBCQyxJQUExQixFQUFnQ0MsR0FBaEMsRUFBcUM7RUFDckQsSUFBSUMsTUFBSjtFQUNBSCxJQUFJLENBQUNJLElBQUwsQ0FBVSxTQUFWLEVBQXFCLGVBQWVDLFNBQWYsR0FBNEI7SUFDL0MsSUFBSUYsTUFBSixFQUFZO01BQ1YsT0FBT2YsQ0FBQyxDQUFDa0IsT0FBRixFQUFQO0lBQ0Q7O0lBQ0QsSUFBSUMsR0FBRyxHQUFHLE1BQU1iLElBQUksQ0FBQyxTQUFELENBQXBCOztJQUNBLElBQUljLEtBQUssQ0FBQ0MsT0FBTixDQUFjRixHQUFkLENBQUosRUFBd0I7TUFDdEJBLEdBQUcsR0FBR0EsR0FB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
