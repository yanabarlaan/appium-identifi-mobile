"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("../logger"));

var _asyncbox = require("asyncbox");

const commands = {};

commands.startBootMonitor = async function startBootMonitor(opts = {}) {
  const {
    timeout = 240000,
    onWaitingDataMigration,
    onWaitingSystemApp,
    onFinished,
    onError,
    shouldPreboot
  } = opts;
  const udid = this.requireUdid('bootstatus');
  let status = '';
  let isBootingFinished = false;
  let error = null;
  let timeoutHandler = null;
  const args = [udid];

  if (shouldPreboot) {
    args.push('-b');
  }

  const bootMonitor = await this.exec('bootstatus', {
    args,
    asynchronous: true
  });
  bootMonitor.on('output', (stdout, stderr) => {
    status += stdout || stderr;

    if (stdout) {
      if (stdout.includes('Waiting on Data Migration') && onWaitingDataMigration) {
        onWaitingDataMigration();
      } else if (stdout.includes('Waiting on System App') && onWaitingSystemApp) {
        onWaitingSystemApp();
      }
    }
  });
  bootMonitor.on('exit', (code, signal) => {
    if (timeoutHandler) {
      clearTimeout(timeoutHandler);
    }

    if (code === 0) {
      if (onFinished) {
        onFinished();
      }

      isBootingFinished = true;
    } else {
      status = status || signal;
      error = new Error(status);

      if (onError) {
        onError(error);
      }
    }
  });
  await bootMonitor.start(0);

  const stopMonitor = async () => {
    if (bootMonitor.isRunning) {
      try {
        await bootMonitor.stop();
      } catch (e) {
        _logger.default.warn(e.message);
      }
    }
  };

  const start = process.hrtime();

  if (onFinished) {
    timeoutHandler = setTimeout(stopMonitor, timeout);
  } else {
    try {
      await (0, _asyncbox.waitForCondition)(() => {
        if (error) {
          throw error;
        }

        return isBootingFinished;
      }, {
        waitMs: timeout,
        intervalMs: 500
      });
    } catch (err) {
      await stopMonitor();
      const [seconds] = process.hrtime(start);
      throw new Error(`The simulator ${udid} has failed to finish booting after ${seconds}s. ` + `Original status: ${status}`);
    }
  }

  return bootMonitor;
};

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGliL3N1YmNvbW1hbmRzL2Jvb3RzdGF0dXMuanMiLCJuYW1lcyI6WyJjb21tYW5kcyIsInN0YXJ0Qm9vdE1vbml0b3IiLCJvcHRzIiwidGltZW91dCIsIm9uV2FpdGluZ0RhdGFNaWdyYXRpb24iLCJvbldhaXRpbmdTeXN0ZW1BcHAiLCJvbkZpbmlzaGVkIiwib25FcnJvciIsInNob3VsZFByZWJvb3QiLCJ1ZGlkIiwicmVxdWlyZVVkaWQiLCJzdGF0dXMiLCJpc0Jvb3RpbmdGaW5pc2hlZCIsImVycm9yIiwidGltZW91dEhhbmRsZXIiLCJhcmdzIiwicHVzaCIsImJvb3RNb25pdG9yIiwiZXhlYyIsImFzeW5jaHJvbm91cyIsIm9uIiwic3Rkb3V0Iiwic3RkZXJyIiwiaW5jbHVkZXMiLCJjb2RlIiwic2lnbmFsIiwiY2xlYXJUaW1lb3V0IiwiRXJyb3IiLCJzdGFydCIsInN0b3BNb25pdG9yIiwiaXNSdW5uaW5nIiwic3RvcCIsImUiLCJsb2ciLCJ3YXJuIiwibWVzc2FnZSIsInByb2Nlc3MiLCJocnRpbWUiLCJzZXRUaW1lb3V0Iiwid2FpdE1zIiwiaW50ZXJ2YWxNcyIsImVyciIsInNlY29uZHMiXSwic291cmNlUm9vdCI6Ii4uLy4uLy4uIiwic291cmNlcyI6WyJsaWIvc3ViY29tbWFuZHMvYm9vdHN0YXR1cy5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgeyB3YWl0Rm9yQ29uZGl0aW9uIH0gZnJvbSAnYXN5bmNib3gnO1xuXG5cbmNvbnN0IGNvbW1hbmRzID0ge307XG5cbi8qKlxuICogQHR5cGVkZWYge09iamVjdH0gQm9vdE1vbml0b3JPcHRpb25zXG4gKiBAcHJvcGVydHkgez9udW1iZXJ9IHRpbWVvdXQgWzI0MDAwMF0gLSBTaW11bGF0b3IgYm9vdGluZyB0aW1lb3V0IGluIG1zLlxuICogQHByb3BlcnR5IHs/RnVuY3Rpb259IG9uV2FpdGluZ0RhdGFNaWdyYXRpb24gLSBUaGlzIGV2ZW50IGlzIGZpcmVkIHdoZW4gZGF0YSBtaWdyYXRpb24gc3RhZ2Ugc3RhcnRzLlxuICogQHByb3BlcnR5IHs/RnVuY3Rpb259IG9uV2FpdGluZ1N5c3RlbUFwcCAtIFRoaXMgZXZlbnQgaXMgZmlyZWQgd2hlbiBzeXN0ZW0gYXBwIHdhaXQgc3RhZ2Ugc3RhcnRzLlxuICogQHByb3BlcnR5IHs/RnVuY3Rpb259IG9uRmluaXNoZWQgLSBUaGlzIGV2ZW50IGlzIGZpcmVkIHdoZW4gU2ltdWxhdG9yIGlzIGZ1bGx5IGJvb3RlZC5cbiAqIEBwcm9wZXJ0eSB7P0Z1bmN0aW9ufSBvbkVycm9yIC0gVGhpcyBldmVudCBpcyBmaXJlZCB3aGVuIHRoZXJlIHdhcyBhbiBlcnJvciB3aGlsZSBtb25pdG9yaW5nIHRoZSBib290aW5nIHByb2Nlc3NcbiAqIG9yIHdoZW4gdGhlIHRpbWVvdXQgaGFzIGV4cGlyZWQuXG4gKiBAcHJvcGVydHkgez9ib29sZWFufSBzaG91bGRQcmVib290IFtmYWxzZV0gV2hldGhlciB0byBwcmVib290IHRoZSBTaW11bGF0b3JcbiAqIGlmIHRoaXMgY29tbWFuZCBpcyBjYWxsZWQgYW5kIGl0IGlzIG5vdCBhbHJlYWR5IGluIGJvb3RlZCBvciBib290aW5nIHN0YXRlLlxuICovXG5cbi8qKlxuICogU3RhcnQgbW9uaXRvcmluZyBmb3IgYm9vdCBzdGF0dXMgb2YgdGhlIHBhcnRpY3VsYXIgU2ltdWxhdG9yLlxuICogSWYgb25GaW5pc2hlZCBwcm9wZXJ0eSBpcyBub3Qgc2V0IHRoZW4gdGhlIG1ldGhvZCB3aWxsIGJsb2NrXG4gKiB1bnRpbCBTaW11bGF0b3IgYm9vdGluZyBpcyBjb21wbGV0ZWQuXG4gKiBUaGUgbWV0aG9kIGlzIG9ubHkgYXZhaWxhYmxlIHNpbmNlIFhjb2RlOC5cbiAqXG4gKiBAcGFyYW0gez9Cb290TW9uaXRvck9wdGlvbnN9IG9wdHMgLSBNb25pdG9yaW5nIG9wdGlvbnMuXG4gKiBAcmV0dXJucyB7U3ViUHJvY2Vzc30gVGhlIGluc3RhbmNlIG9mIHRoZSBjb3JyZXNwb25kaW5nIG1vbml0b3JpbmcgcHJvY2Vzcy5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGUgU2ltdWxhdG9yIGZhaWxzIHRvIGZpbmlzaCBib290aW5nIHdpdGhpbiB0aGUgZ2l2ZW4gdGltZW91dCBhbmQgb25GaW5pc2hlZFxuICogcHJvcGVydHkgaXMgbm90IHNldC5cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGUgYHVkaWRgIGluc3RhbmNlIHByb3BlcnR5IGlzIHVuc2V0XG4gKi9cbmNvbW1hbmRzLnN0YXJ0Qm9vdE1vbml0b3IgPSBhc3luYyBmdW5jdGlvbiBzdGFydEJvb3RNb25pdG9yIChvcHRzID0ge30pIHtcbiAgY29uc3Qge1xuICAgIHRpbWVvdXQgPSAyNDAwMDAsXG4gICAgb25XYWl0aW5nRGF0YU1pZ3JhdGlvbixcbiAgICBvbldhaXRpbmdTeXN0ZW1BcHAsXG4gICAgb25GaW5pc2hlZCxcbiAgICBvbkVycm9yLFxuICAgIHNob3VsZFByZWJvb3QsXG4gIH0gPSBvcHRzO1xuICBjb25zdCB1ZGlkID0gdGhpcy5yZXF1aXJlVWRpZCgnYm9vdHN0YXR1cycpO1xuXG4gIGxldCBzdGF0dXMgPSAnJztcbiAgbGV0IGlzQm9vdGluZ0ZpbmlzaGVkID0gZmFsc2U7XG4gIGxldCBlcnJvciA9IG51bGw7XG4gIGxldCB0aW1lb3V0SGFuZGxlciA9IG51bGw7XG4gIGNvbnN0IGFyZ3MgPSBbdWRpZF07XG4gIGlmIChzaG91bGRQcmVib290KSB7XG4gICAgYXJncy5wdXNoKCctYicpO1xuICB9XG4gIGNvbnN0IGJvb3RNb25pdG9yID0gYXdhaXQgdGhpcy5leGVjKCdib290c3RhdHVzJywge1xuICAgIGFyZ3MsXG4gICAgYXN5bmNocm9ub3VzOiB0cnVlLFxuICB9KTtcbiAgYm9vdE1vbml0b3Iub24oJ291dHB1dCcsIChzdGRvdXQsIHN0ZGVycikgPT4ge1xuICAgIHN0YXR1cyArPSBzdGRvdXQgfHwgc3RkZXJyO1xuICAgIGlmIChzdGRvdXQpIHtcbiAgICAgIGlmIChzdGRvdXQuaW5jbHVkZXMoJ1dhaXRpbmcgb24gRGF0YSBNaWdyYXRpb24nKSAmJiBvbldhaXRpbmdEYXRhTWlncmF0aW9uKSB7XG4gICAgICAgIG9uV2FpdGluZ0RhdGFNaWdyYXRpb24oKTtcbiAgICAgIH0gZWxzZSBpZiAoc3Rkb3V0LmluY2x1ZGVzKCdXYWl0aW5nIG9uIFN5c3RlbSBBcHAnKSAmJiBvbldhaXRpbmdTeXN0ZW1BcHApIHtcbiAgICAgICAgb25XYWl0aW5nU3lzdGVtQXBwKCk7XG4gICAgICB9XG4gICAgfVxuICB9KTtcbiAgYm9vdE1vbml0b3Iub24oJ2V4aXQnLCAoY29kZSwgc2lnbmFsKSA9PiB7XG4gICAgaWYgKHRpbWVvdXRIYW5kbGVyKSB7XG4gICAgICBjbGVhclRpbWVvdXQodGltZW91dEhhbmRsZXIpO1xuICAgIH1cbiAgICBpZiAoY29kZSA9PT0gMCkge1xuICAgICAgaWYgKG9uRmluaXNoZWQpIHtcbiAgICAgICAgb25GaW5pc2hlZCgpO1xuICAgICAgfVxuICAgICAgaXNCb290aW5nRmluaXNoZWQgPSB0cnVlO1xuICAgIH0gZWxzZSB7XG4gICAgICBzdGF0dXMgPSBzdGF0dXMgfHwgc2lnbmFsO1xuICAgICAgZXJyb3IgPSBuZXcgRXJyb3Ioc3RhdHVzKTtcbiAgICAgIGlmIChvbkVycm9yKSB7XG4gICAgICAgIG9uRXJyb3IoZXJyb3IpO1xuICAgICAgfVxuICAgIH1cbiAgfSk7XG4gIGF3YWl0IGJvb3RNb25pdG9yLnN0YXJ0KDApO1xuICBjb25zdCBzdG9wTW9uaXRvciA9IGFzeW5jICgpID0+IHtcbiAgICBpZiAoYm9vdE1vbml0b3IuaXNSdW5uaW5nKSB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBib290TW9uaXRvci5zdG9wKCk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGxvZy53YXJuKGUubWVzc2FnZSk7XG4gICAgICB9XG4gICAgfVxuICB9O1xuICBjb25zdCBzdGFydCA9IHByb2Nlc3MuaHJ0aW1lKCk7XG4gIGlmIChvbkZpbmlzaGVkKSB7XG4gICAgdGltZW91dEhhbmRsZXIgPSBzZXRUaW1lb3V0KHN0b3BNb25pdG9yLCB0aW1lb3V0KTtcbiAgfSBlbHNlIHtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgd2FpdEZvckNvbmRpdGlvbigoKSA9PiB7XG4gICAgICAgIGlmIChlcnJvcikge1xuICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICB9XG4gICAgICAgIHJldHVybiBpc0Jvb3RpbmdGaW5pc2hlZDtcbiAgICAgIH0sIHt3YWl0TXM6IHRpbWVvdXQsIGludGVydmFsTXM6IDUwMH0pO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgYXdhaXQgc3RvcE1vbml0b3IoKTtcbiAgICAgIGNvbnN0IFtzZWNvbmRzXSA9IHByb2Nlc3MuaHJ0aW1lKHN0YXJ0KTtcbiAgICAgIHRocm93IG5ldyBFcnJvcihcbiAgICAgICAgYFRoZSBzaW11bGF0b3IgJHt1ZGlkfSBoYXMgZmFpbGVkIHRvIGZpbmlzaCBib290aW5nIGFmdGVyICR7c2Vjb25kc31zLiBgICtcbiAgICAgICAgYE9yaWdpbmFsIHN0YXR1czogJHtzdGF0dXN9YCk7XG4gICAgfVxuICB9XG4gIHJldHVybiBib290TW9uaXRvcjtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGNvbW1hbmRzO1xuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUdBLE1BQU1BLFFBQVEsR0FBRyxFQUFqQjs7QUEwQkFBLFFBQVEsQ0FBQ0MsZ0JBQVQsR0FBNEIsZUFBZUEsZ0JBQWYsQ0FBaUNDLElBQUksR0FBRyxFQUF4QyxFQUE0QztFQUN0RSxNQUFNO0lBQ0pDLE9BQU8sR0FBRyxNQUROO0lBRUpDLHNCQUZJO0lBR0pDLGtCQUhJO0lBSUpDLFVBSkk7SUFLSkMsT0FMSTtJQU1KQztFQU5JLElBT0ZOLElBUEo7RUFRQSxNQUFNTyxJQUFJLEdBQUcsS0FBS0MsV0FBTCxDQUFpQixZQUFqQixDQUFiO0VBRUEsSUFBSUMsTUFBTSxHQUFHLEVBQWI7RUFDQSxJQUFJQyxpQkFBaUIsR0FB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
