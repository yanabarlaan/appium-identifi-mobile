"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.Lockdown = exports.LOCKDOWN_PORT = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _baseService = require("../base-service");

const LOCKDOWN_PORT = 62078;
exports.LOCKDOWN_PORT = LOCKDOWN_PORT;
const LABEL = 'usbmuxd';
const PROTOCOL_VERSION = 2;

class Lockdown extends _baseService.BaseServicePlist {
  async queryType(timeout = 5000) {
    const data = await this._plistService.sendPlistAndReceive({
      Label: LABEL,
      ProtocolVersion: PROTOCOL_VERSION,
      Request: 'QueryType'
    }, timeout);

    if (data.Request === 'QueryType' && data.Type === 'com.apple.mobile.lockdown') {
      return data;
    } else {
      throw new Error(`Unexpected data: ${JSON.stringify(data)}`);
    }
  }

  async startSession(hostID, systemBUID, timeout = 5000) {
    const data = await this._plistService.sendPlistAndReceive({
      Label: LABEL,
      ProtocolVersion: PROTOCOL_VERSION,
      Request: 'StartSession',
      HostID: hostID,
      SystemBUID: systemBUID
    }, timeout);

    if (data.Request === 'StartSession' && data.SessionID) {
      return {
        sessionID: data.SessionID,
        enableSessionSSL: data.EnableSessionSSL
      };
    } else {
      throw new Error(`Unexpected data: ${JSON.stringify(data)}`);
    }
  }

  enableSessionSSL(hostPrivateKey, hostCertificate) {
    this._plistService.enableSessionSSL(hostPrivateKey, hostCertificate);
  }

  async getValue(query = {}, timeout = 5000) {
    const plist = Object.assign({
      Label: LABEL,
      ProtocolVersion: PROTOCOL_VERSION,
      Request: 'GetValue'
    }, query);
    const data = await this._plistService.sendPlistAndReceive(plist, timeout);

    if ((data === null || data === void 0 ? void 0 : data.Request) === 'GetValue' && !_lodash.default.isNil(data === null || data === void 0 ? void 0 : data.Value)) {
      return data.Value;
    }

    throw new Error(`Unexpected data received for ${JSON.stringify(query)} request: ` + JSON.stringify(data));
  }

  async startService(serviceName, timeout = 5000) {
    const data = await this._plistService.sendPlistAndReceive({
      Label: LABEL,
      ProtocolVersion: PROTOCOL_VERSION,
      Request: 'StartService',
      Service: serviceName
    }, timeout);

    if (data.Error) {
      throw new Error(`Unexpected data: ${JSON.stringify(data)}`);
    } else {
      return data;
    }
  }

}

exports.Lockdown = Lockdown;
var _default = Lockdown;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGliL2xvY2tkb3duL2luZGV4LmpzIiwibmFtZXMiOlsiTE9DS0RPV05fUE9SVCIsIkxBQkVMIiwiUFJPVE9DT0xfVkVSU0lPTiIsIkxvY2tkb3duIiwiQmFzZVNlcnZpY2VQbGlzdCIsInF1ZXJ5VHlwZSIsInRpbWVvdXQiLCJkYXRhIiwiX3BsaXN0U2VydmljZSIsInNlbmRQbGlzdEFuZFJlY2VpdmUiLCJMYWJlbCIsIlByb3RvY29sVmVyc2lvbiIsIlJlcXVlc3QiLCJUeXBlIiwiRXJyb3IiLCJKU09OIiwic3RyaW5naWZ5Iiwic3RhcnRTZXNzaW9uIiwiaG9zdElEIiwic3lzdGVtQlVJRCIsIkhvc3RJRCIsIlN5c3RlbUJVSUQiLCJTZXNzaW9uSUQiLCJzZXNzaW9uSUQiLCJlbmFibGVTZXNzaW9uU1NMIiwiRW5hYmxlU2Vzc2lvblNTTCIsImhvc3RQcml2YXRlS2V5IiwiaG9zdENlcnRpZmljYXRlIiwiZ2V0VmFsdWUiLCJxdWVyeSIsInBsaXN0IiwiT2JqZWN0IiwiYXNzaWduIiwiXyIsImlzTmlsIiwiVmFsdWUiLCJzdGFydFNlcnZpY2UiLCJzZXJ2aWNlTmFtZSIsIlNlcnZpY2UiXSwic291cmNlUm9vdCI6Ii4uLy4uLy4uIiwic291cmNlcyI6WyJsaWIvbG9ja2Rvd24vaW5kZXguanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IEJhc2VTZXJ2aWNlUGxpc3QgfSBmcm9tICcuLi9iYXNlLXNlcnZpY2UnO1xuXG5cbmNvbnN0IExPQ0tET1dOX1BPUlQgPSA2MjA3ODtcbmNvbnN0IExBQkVMID0gJ3VzYm11eGQnO1xuY29uc3QgUFJPVE9DT0xfVkVSU0lPTiA9IDI7XG5cbmNsYXNzIExvY2tkb3duIGV4dGVuZHMgQmFzZVNlcnZpY2VQbGlzdCB7XG4gIC8qKlxuICAgKiBNYWtlcyBhIHF1ZXJ5IHR5cGUgcmVxdWVzdCB0byBsb2NrZG93blxuICAgKiBAcGFyYW0ge251bWJlcn0gW3RpbWVvdXQ9NTAwMF0gdGhlIHRpbWVvdXQgb2YgcmVjZWl2aW5nIGEgcmVzcG9uc2UgZnJvbSBsb2NrZG93bmRcbiAgICogQHJldHVybnMge09iamVjdH1cbiAgICovXG4gIGFzeW5jIHF1ZXJ5VHlwZSAodGltZW91dCA9IDUwMDApIHtcbiAgICBjb25zdCBkYXRhID0gYXdhaXQgdGhpcy5fcGxpc3RTZXJ2aWNlLnNlbmRQbGlzdEFuZFJlY2VpdmUoe1xuICAgICAgTGFiZWw6IExBQkVMLFxuICAgICAgUHJvdG9jb2xWZXJzaW9uOiBQUk9UT0NPTF9WRVJTSU9OLFxuICAgICAgUmVxdWVzdDogJ1F1ZXJ5VHlwZSdcbiAgICB9LCB0aW1lb3V0KTtcbiAgICBpZiAoZGF0YS5SZXF1ZXN0ID09PSAnUXVlcnlUeXBlJyAmJiBkYXRhLlR5cGUgPT09ICdjb20uYXBwbGUubW9iaWxlLmxvY2tkb3duJykge1xuICAgICAgcmV0dXJuIGRhdGE7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgVW5leHBlY3RlZCBkYXRhOiAke0pTT04uc3RyaW5naWZ5KGRhdGEpfWApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBTdGFydHMgYSBsb2NrZG93biBzZXNzaW9uIHdoaWNoIGFsbG93cyB0byB1c2UgY2VydGFpbiBhcGlzXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBob3N0SUQgdGhlIGhvc3QgaWQgd2hpY2ggY2FuIGJlIHJldHJpZXZlZCBmcm9tIHRoZSBwYWlyIHJlY29yZFxuICAgKiBAcGFyYW0ge3N0cmluZ30gc3lzdGVtQlVJRCB0aGUgaG9zdCBCVUlEIHdoaWNoIGNhbiBiZSByZXRyaWV2ZWQgZnJvbSB0aGUgcGFpciByZWNvcmRcbiAgICogQHBhcmFtIHtudW1iZXJ9IFt0aW1lb3V0PTUwMDBdIHRoZSB0aW1lb3V0IG9mIHJlY2VpdmluZyBhIHJlc3BvbnNlIGZyb20gbG9ja2Rvd25kXG4gICAqIEByZXR1cm5zIHtPYmplY3R9XG4gICAqL1xuICBhc3luYyBzdGFydFNlc3Npb24gKGhvc3RJRCwgc3lzdGVtQlVJRCwgdGltZW91dCA9IDUwMDApIHtcbiAgICBjb25zdCBkYXRhID0gYXdhaXQgdGhpcy5fcGxpc3RTZXJ2aWNlLnNlbmRQbGlzdEFuZFJlY2VpdmUoe1xuICAgICAgTGFiZWw6IExBQkVMLFxuICAgICAgUHJvdG9jb2xWZXJzaW9uOiBQUk9UT0NPTF9WRVJTSU9OLFxuICAgICAgUmVxdWVzdDogJ1N0YXJ0U2Vzc2lvbicsXG4gICAgICBIb3N0SUQ6IGhvc3RJRCxcbiAgICAgIFN5c3RlbUJVSUQ6IHN5c3RlbUJVSURcbiAgICB9LCB0aW1lb3V0KTtcblxuICAgIGlmIChkYXRhLlJlcXVlc3QgPT09ICdTdGFydFNlc3Npb24nICYmIGRhdGEuU2Vzc2lvbklEKSB7XG4gICAgICByZXR1cm4geyBzZXNzaW9uSUQ6IGRhdGEuU2Vzc2lvbklELCBlbmFibGVTZXNzaW9uU1NMOiBkYXRhLkVuYWJsZVNlc3Npb25TU0wgfTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIGRhdGE6ICR7SlNPTi5zdHJpbmdpZnkoZGF0YSl9YCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEVuYWJsZXMgc3NsIGluIHRoZSB1bmRlcmx5aW5nIHNvY2tldCBzb2NrZXQgY29ubmVjdGlvblxuICAgKiBAcGFyYW0ge0J1ZmZlcn0gaG9zdFByaXZhdGVLZXkgdGhlIHByaXZhdGUga2V5IHdoaWNoIGNhbiBiZSByZXRyaWV2ZWQgZnJvbSB0aGUgcGFpciByZWNvcmRcbiAgICogQHBhcmFtIHtCdWZmZXJ9IGhvc3RDZXJ0aWZpY2F0ZSB0aGUgY2VydGlmaWNhdGUgd2hpY2ggY2FuIGJlIHJldHJpZXZlZCBmcm9tIHRoZSBwYWlyIHJlY29yZFxuICAgKi9cbiAgZW5hYmxlU2Vzc2lvblNTTCAoaG9zdFByaXZhdGVLZXksIGhvc3RDZXJ0aWZpY2F0ZSkge1xuICAgIHRoaXMuX3BsaXN0U2VydmljZS5lbmFibGVTZXNzaW9uU1NMKGhvc3RQcml2YXRlS2V5LCBob3N0Q2VydGlmaWNhdGUpO1xuICB9XG5cbiAgLyoqXG4gICogQHR5cGVkZWYge09iamVjdH0gUXVlcnlcbiAgKlxuICAqIEBwcm9wZXJ0eSB7P3N0cmluZ30ga2V5IFRoZSBrZXkgd2Ugd2FudCB0byBhY2Nlc3NcbiAgKiBAcHJvcGVydHkgez9zdHJpbmd9IGRvbWFpbiBUaGUgZG9tYWluIHdoZXJlIHdlIHdhbnQgdG8gYWNjZXNzXG4gICovXG5cbiAgLyoqXG4gICAqIEdldHMgdmFsdWVzIGZyb20gdGhlIGRldmljZSBhY2NvcmRpbmcgdG8gdGhlIHF1ZXJ5IHBhc3NlZFxuICAgKlxuICAgKiBAcGFyYW0ge1F1ZXJ5fSBxdWVyeSB0aGUgcXVlcnkgd2Ugd2FudCB0byBzZW5kIHRvIGxvY2tkb3duZFxuICAgKiBAcGFyYW0ge251bWJlcn0gW3RpbWVvdXQ9NTAwMF0gdGhlIHRpbWVvdXQgb2YgcmVjZWl2aW5nIGEgcmVzcG9uc2UgZnJvbSBsb2NrZG93bmRcbiAgICogQHJldHVybnMgeyp9IFRoZSBhY3R1YWwgcmVzcG9uc2UgdmFsdWUuIEl0IHNob3VsZCBuZXZlciBiZSBgbnVsbGAgb3IgYHVuZGVmaW5lZGBcbiAgICogQHRocm93cyB7RXJyb3J9IElmIGFuIHVuZXhwZWN0ZWQgcmVzcG9uc2UgaXMgcmVjZWl2ZWQgZnJvbSBsb2NrZG93bmRcbiAgICovXG4gIGFzeW5jIGdldFZhbHVlIChxdWVyeSA9IHt9LCB0aW1lb3V0ID0gNTAwMCkge1xuICAgIGNvbnN0IHBsaXN0ID0gT2JqZWN0LmFzc2lnbih7XG4gICAgICBMYWJlbDogTEFCRUwsXG4gICAgICBQcm90b2NvbFZlcnNpb246IFBST1RPQ09MX1ZFUlNJT04sXG4gICAgICBSZXF1ZXN0OiAnR2V0VmFsdWUnXG4gICAgfSwgcXVlcnkpO1xuICAgIGNvbnN0IGRhdGEgPSBhd2FpdCB0aGlzLl9wbGlzdFNlcnZpY2Uuc2VuZFBsaXN0QW5kUmVjZWl2ZShwbGlzdCwgdGltZW91dCk7XG4gICAgaWYgKGRhdGE/LlJlcXVlc3QgPT09ICdHZXRWYWx1ZScgJiYgIV8uaXNOaWwoZGF0YT8uVmFsdWUpKSB7XG4gICAgICByZXR1cm4gZGF0YS5WYWx1ZTtcbiAgICB9XG4gICAgdGhyb3cgbmV3IEVycm9yKGBVbmV4cGVjdGVkIGRhdGEgcmVjZWl2ZWQgZm9yICR7SlNPTi5zdHJpbmdpZnkocXVlcnkpfSByZXF1ZXN0OiBgICtcbiAgICAgIEpTT04uc3RyaW5naWZ5KGRhdGEpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTdGFydHMgYSBzZXJ2aWNlIG9uIHRoZSBwaG9uZSBjb3JyZXNwb25kaW5nIHRvIHRoZSBuYW1lXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBzZXJ2aWNlTmFtZSB0aGUgbmFtZSBvZiB0aGUgc2VydmljZSB3aGljaCB3ZSB3YW50IHRvIHN0YXJ0XG4gICAqIEBwYXJhbSB7bnVtYmVyfSBbdGltZW91dD01MDAwXSB0aGUgdGltZW91dCBvZiByZWNlaXZpbmcgYSByZXNwb25zZSBmcm9tIGxvY2tkb3duZFxuICAgKiBAcmV0dXJucyB7T2JqZWN0fVxuICAgKi9cbiAgYXN5bmMgc3RhcnRTZXJ2aWNlIChzZXJ2aWNlTmFtZSwgdGltZW91dCA9IDUwMDApIHtcbiAgICBjb25zdCBkYXRhID0gYXdhaXQgdGhpcy5fcGxpc3RTZXJ2aWNlLnNlbmRQbGlzdEFuZFJlY2VpdmUoe1xuICAgICAgTGFiZWw6IExBQkVMLFxuICAgICAgUHJvdG9jb2xWZXJzaW9uOiBQUk9UT0NPTF9WRVJTSU9OLFxuICAgICAgUmVxdWVzdDogJ1N0YXJ0U2VydmljZScsXG4gICAgICBTZXJ2aWNlOiBzZXJ2aWNlTmFtZSxcbiAgICB9LCB0aW1lb3V0KTtcblxuICAgIGlmIChkYXRhLkVycm9yKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuZXhwZWN0ZWQgZGF0YTogJHtKU09OLnN0cmluZ2lmeShkYXRhKX1gKTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIGRhdGE7XG4gICAgfVxuICB9XG59XG5cbmV4cG9ydCB7IExvY2tkb3duLCBMT0NLRE9XTl9QT1JUIH07XG5leHBvcnQgZGVm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
