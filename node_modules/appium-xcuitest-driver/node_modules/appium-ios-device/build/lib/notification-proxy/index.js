"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.NotificationProxyService = exports.NOTIFICATION_PROXY_SERVICE_NAME = void 0;

require("source-map-support/register");

var _plistServiceEncoder = _interopRequireDefault(require("../plist-service/transformer/plist-service-encoder"));

var _plistServiceDecoder = _interopRequireDefault(require("../plist-service/transformer/plist-service-decoder"));

var _lengthBasedSplitter = _interopRequireDefault(require("../util/transformer/length-based-splitter"));

var _constants = require("../constants");

var _lodash = _interopRequireDefault(require("lodash"));

var _baseService = require("../base-service");

const NOTIFICATION_PROXY_SERVICE_NAME = 'com.apple.mobile.notification_proxy';
exports.NOTIFICATION_PROXY_SERVICE_NAME = NOTIFICATION_PROXY_SERVICE_NAME;
const MAX_FRAME_SIZE = 16 * _constants.KB;
const RELAY_NOTIFICATION = 'RelayNotification';
const PROXY_DEATH = 'ProxyDeath';

class NotificationProxyService extends _baseService.BaseServiceSocket {
  constructor(socketClient) {
    super(socketClient);
    this._decoder = new _plistServiceDecoder.default();
    this._splitter = new _lengthBasedSplitter.default({
      readableStream: socketClient,
      littleEndian: false,
      maxFrameLength: MAX_FRAME_SIZE,
      lengthFieldOffset: 0,
      lengthFieldLength: 4,
      lengthAdjustment: 4
    });

    this._socketClient.pipe(this._splitter).pipe(this._decoder);

    this._encoder = new _plistServiceEncoder.default();

    this._encoder.pipe(this._socketClient);

    this._assignClientFailureHandlers(this._encoder);

    this._listeners = {};

    this._decoder.on('data', this._handleData.bind(this));
  }

  _handleData(data) {
    switch (data.Command) {
      case RELAY_NOTIFICATION:
        {
          const listener = this._listeners[data.Name];

          if (!listener) {
            return;
          }

          if (_lodash.default.isFunction(listener.notification)) {
            listener.notification();
          }

          break;
        }

      case PROXY_DEATH:
        {
          const listener = this._listeners[data.Name];

          if (!listener) {
            return;
          }

          if (_lodash.default.isFunction(listener.proxyDeath)) {
            listener.proxyDeath();
          }

          delete this._listeners[data.Name];
          break;
        }

      default:
        throw new Error(`Unknown data type ${JSON.stringify(data)}`);
    }
  }

  observeNotification(notification, listener) {
    if (this._listeners[notification]) {
      throw new Error(`Notification listener for ${notification} already exists. Another one can't be added`);
    }

    this._listeners[notification] = listener;

    this._encoder.write({
      Command: 'ObserveNotification',
      Name: notification
    });
  }

  postNotification(notification) {
    this._encoder.write({
      Command: 'PostNotification',
      Name: notification
    });
  }

  shutdown() {
    this._encoder.write({
      Command: 'Shutdown'
    });
  }

  close() {
    this.shutdown();
    super.close();
  }

}

exports.NotificationProxyService = NotificationProxyService;
var _default = NotificationProxyService;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGliL25vdGlmaWNhdGlvbi1wcm94eS9pbmRleC5qcyIsIm5hbWVzIjpbIk5PVElGSUNBVElPTl9QUk9YWV9TRVJWSUNFX05BTUUiLCJNQVhfRlJBTUVfU0laRSIsIktCIiwiUkVMQVlfTk9USUZJQ0FUSU9OIiwiUFJPWFlfREVBVEgiLCJOb3RpZmljYXRpb25Qcm94eVNlcnZpY2UiLCJCYXNlU2VydmljZVNvY2tldCIsImNvbnN0cnVjdG9yIiwic29ja2V0Q2xpZW50IiwiX2RlY29kZXIiLCJQbGlzdFNlcnZpY2VEZWNvZGVyIiwiX3NwbGl0dGVyIiwiTGVuZ3RoQmFzZWRTcGxpdHRlciIsInJlYWRhYmxlU3RyZWFtIiwibGl0dGxlRW5kaWFuIiwibWF4RnJhbWVMZW5ndGgiLCJsZW5ndGhGaWVsZE9mZnNldCIsImxlbmd0aEZpZWxkTGVuZ3RoIiwibGVuZ3RoQWRqdXN0bWVudCIsIl9zb2NrZXRDbGllbnQiLCJwaXBlIiwiX2VuY29kZXIiLCJQbGlzdFNlcnZpY2VFbmNvZGVyIiwiX2Fzc2lnbkNsaWVudEZhaWx1cmVIYW5kbGVycyIsIl9saXN0ZW5lcnMiLCJvbiIsIl9oYW5kbGVEYXRhIiwiYmluZCIsImRhdGEiLCJDb21tYW5kIiwibGlzdGVuZXIiLCJOYW1lIiwiXyIsImlzRnVuY3Rpb24iLCJub3RpZmljYXRpb24iLCJwcm94eURlYXRoIiwiRXJyb3IiLCJKU09OIiwic3RyaW5naWZ5Iiwib2JzZXJ2ZU5vdGlmaWNhdGlvbiIsIndyaXRlIiwicG9zdE5vdGlmaWNhdGlvbiIsInNodXRkb3duIiwiY2xvc2UiXSwic291cmNlUm9vdCI6Ii4uLy4uLy4uIiwic291cmNlcyI6WyJsaWIvbm90aWZpY2F0aW9uLXByb3h5L2luZGV4LmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBQbGlzdFNlcnZpY2VFbmNvZGVyIGZyb20gJy4uL3BsaXN0LXNlcnZpY2UvdHJhbnNmb3JtZXIvcGxpc3Qtc2VydmljZS1lbmNvZGVyJztcbmltcG9ydCBQbGlzdFNlcnZpY2VEZWNvZGVyIGZyb20gJy4uL3BsaXN0LXNlcnZpY2UvdHJhbnNmb3JtZXIvcGxpc3Qtc2VydmljZS1kZWNvZGVyJztcbmltcG9ydCBMZW5ndGhCYXNlZFNwbGl0dGVyIGZyb20gJy4uL3V0aWwvdHJhbnNmb3JtZXIvbGVuZ3RoLWJhc2VkLXNwbGl0dGVyJztcbmltcG9ydCB7IEtCIH0gZnJvbSAnLi4vY29uc3RhbnRzJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgeyBCYXNlU2VydmljZVNvY2tldCB9IGZyb20gJy4uL2Jhc2Utc2VydmljZSc7XG5cblxuY29uc3QgTk9USUZJQ0FUSU9OX1BST1hZX1NFUlZJQ0VfTkFNRSA9ICdjb20uYXBwbGUubW9iaWxlLm5vdGlmaWNhdGlvbl9wcm94eSc7XG5jb25zdCBNQVhfRlJBTUVfU0laRSA9IDE2ICogS0I7XG5cbmNvbnN0IFJFTEFZX05PVElGSUNBVElPTiA9ICdSZWxheU5vdGlmaWNhdGlvbic7XG5jb25zdCBQUk9YWV9ERUFUSCA9ICdQcm94eURlYXRoJztcblxuY2xhc3MgTm90aWZpY2F0aW9uUHJveHlTZXJ2aWNlIGV4dGVuZHMgQmFzZVNlcnZpY2VTb2NrZXQge1xuICBjb25zdHJ1Y3RvciAoc29ja2V0Q2xpZW50KSB7XG4gICAgc3VwZXIoc29ja2V0Q2xpZW50KTtcblxuICAgIHRoaXMuX2RlY29kZXIgPSBuZXcgUGxpc3RTZXJ2aWNlRGVjb2RlcigpO1xuICAgIHRoaXMuX3NwbGl0dGVyID0gbmV3IExlbmd0aEJhc2VkU3BsaXR0ZXIoe1xuICAgICAgcmVhZGFibGVTdHJlYW06IHNvY2tldENsaWVudCxcbiAgICAgIGxpdHRsZUVuZGlhbjogZmFsc2UsXG4gICAgICBtYXhGcmFtZUxlbmd0aDogTUFYX0ZSQU1FX1NJWkUsXG4gICAgICBsZW5ndGhGaWVsZE9mZnNldDogMCxcbiAgICAgIGxlbmd0aEZpZWxkTGVuZ3RoOiA0LFxuICAgICAgbGVuZ3RoQWRqdXN0bWVudDogNCxcbiAgICB9KTtcbiAgICB0aGlzLl9zb2NrZXRDbGllbnQucGlwZSh0aGlzLl9zcGxpdHRlcikucGlwZSh0aGlzLl9kZWNvZGVyKTtcblxuICAgIHRoaXMuX2VuY29kZXIgPSBuZXcgUGxpc3RTZXJ2aWNlRW5jb2RlcigpO1xuICAgIHRoaXMuX2VuY29kZXIucGlwZSh0aGlzLl9zb2NrZXRDbGllbnQpO1xuICAgIHRoaXMuX2Fzc2lnbkNsaWVudEZhaWx1cmVIYW5kbGVycyh0aGlzLl9lbmNvZGVyKTtcblxuICAgIHRoaXMuX2xpc3RlbmVycyA9IHt9O1xuICAgIHRoaXMuX2RlY29kZXIub24oJ2RhdGEnLCB0aGlzLl9oYW5kbGVEYXRhLmJpbmQodGhpcykpO1xuICB9XG5cbiAgX2hhbmRsZURhdGEgKGRhdGEpIHtcbiAgICBzd2l0Y2ggKGRhdGEuQ29tbWFuZCkge1xuICAgICAgY2FzZSBSRUxBWV9OT1RJRklDQVRJT046IHtcbiAgICAgICAgY29uc3QgbGlzdGVuZXIgPSB0aGlzLl9saXN0ZW5lcnNbZGF0YS5OYW1lXTtcbiAgICAgICAgaWYgKCFsaXN0ZW5lcikge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAoXy5pc0Z1bmN0aW9uKGxpc3RlbmVyLm5vdGlmaWNhdGlvbikpIHtcbiAgICAgICAgICBsaXN0ZW5lci5ub3RpZmljYXRpb24oKTtcbiAgICAgICAgfVxuICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIGNhc2UgUFJPWFlfREVBVEg6IHtcbiAgICAgICAgY29uc3QgbGlzdGVuZXIgPSB0aGlzLl9saXN0ZW5lcnNbZGF0YS5OYW1lXTtcbiAgICAgICAgaWYgKCFsaXN0ZW5lcikge1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuICAgICAgICBpZiAoXy5pc0Z1bmN0aW9uKGxpc3RlbmVyLnByb3h5RGVhdGgpKSB7XG4gICAgICAgICAgbGlzdGVuZXIucHJveHlEZWF0aCgpO1xuICAgICAgICB9XG4gICAgICAgIGRlbGV0ZSB0aGlzLl9saXN0ZW5lcnNbZGF0YS5OYW1lXTtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBkZWZhdWx0OlxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFVua25vd24gZGF0YSB0eXBlICR7SlNPTi5zdHJpbmdpZnkoZGF0YSl9YCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFRoZSBhcGkgdG8gbGlzdGVuIHRvIG5vdGlmaWNhdGlvbnMgdGhhdCB0aGUgcGhvbmUgYnJvYWRjYXN0c1xuICAgKiBAcGFyYW0ge3N0cmluZ30gbm90aWZpY2F0aW9uIFRoZSBuYW1lIG9mIHRoZSBub3RpZmljYXRpb24gd2hpY2ggaXMgZGVzaXJlZCB0byBiZSBvYnNlcnZlZFxuICAgKiBAcGFyYW0ge09iamVjdH0gbGlzdGVuZXIgVGhlIGxpc3RlbmVyIG9iamVjdCB3aGljaCB3aWxsIGJlIGludm9rZWQgd2hlbiB0aGVyZSBpcyBhIG5vdGlmaWNhdGlvbiBvciBpZiB0aGUgcHJveHkgaXMgZGVhZFxuICAgKi9cbiAgb2JzZXJ2ZU5vdGlmaWNhdGlvbiAobm90aWZpY2F0aW9uLCBsaXN0ZW5lcikge1xuICAgIGlmICh0aGlzLl9saXN0ZW5lcnNbbm90aWZpY2F0aW9uXSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBOb3RpZmljYXRpb24gbGlzdGVuZXIgZm9yICR7bm90aWZpY2F0aW9ufSBhbHJlYWR5IGV4aXN0cy4gQW5vdGhlciBvbmUgY2FuJ3QgYmUgYWRkZWRgKTtcbiAgICB9XG4gICAgdGhpcy5fbGlzdGVuZXJzW25vdGlmaWNhdGlvbl0gPSBsaXN0ZW5lcjtcbiAgICB0aGlzLl9lbmNvZGVyLndyaXRlKHtcbiAgICAgIENvbW1hbmQ6ICdPYnNlcnZlTm90aWZpY2F0aW9uJyxcbiAgICAgIE5hbWU6IG5vdGlmaWNhdGlvblxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFRoZSBhcGkgdG8gYnJvYWRjYXN0IG5vdGlmaWNhdGlvbnMgdG8gdGhlIHBob25lLiBUaGlzIGFsbG93cyB0aGUgY2xpZW50IHRvIHRhbGsgdG8gdGhlIGRhZW1vbnMgb3IgYXBwcyBvbiB0aGUgcGhvbmVcbiAgICogQHBhcmFtIHsqfSBub3RpZmljYXRpb24gVGhlIG5hbWUgb2YgdGhlIG5vdGlmaWNhdGlvbiB3aGljaCBpcyBkZXNpcmVkIG5vdGlmaWVkXG4gICAqL1xuICBwb3N0Tm90aWZpY2F0aW9uIChub3RpZmljYXRpb24pIHtcbiAgICB0aGlzLl9lbmNvZGVyLndyaXRlKHtcbiAgICAgIENvbW1hbmQ6ICdQb3N0Tm90aWZpY2F0aW9uJyxcbiAgICAgIE5hbWU6IG5vdGlmaWNhdGlvblxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFRoZSBhcGkgdG8gc2h1dGRvd24gdGhlIHByb3h5LiBDb25zZXF1ZW50bHksIGFsbCB0aGUgbm90aWZpY2F0aW9ucyB0aGF0IGFyZSBvYnNlcnZpbmcgd2lsbCByZWNpZXZlIHRoZSBwcm94eURlYXRoIHJlc3BvbnNlXG4gICAqIEBwYXJhbSB7Kn0gbm90aWZpY2F0aW9uIFRoZSBuYW1lIG9mIHRoZSBub3RpZmljYXRpb24gd2hpY2ggaXMgZGVzaXJlZCBub3RpZmllZFxuICAgKi9cbiAgc2h1dGRvd24gKCkge1xuICAgIHRoaXMuX2VuY29kZXIud3JpdGUoe1xuICAgICAgQ29tbWFuZDogJ1NodXRkb3duJyxcbiAgICB9KTtcbiAgfVxuXG4gIGNsb3NlICgpIHtcbiAgICB0aGlzLnNodXRkb3duKCk7XG4gICAgc3VwZXIuY2xvc2UoKTtcbiAgfVxufVxuXG5leHBvcnQgZGVmYXVsdCBOb3RpZmljYXRpb25Qcm94eVNlcnZpY2U7XG5leHBvcnQgeyBOb3RpZmljYXRpb25Qcm94eVNlcnZpY2UsIE5PVElGSUNBVElPTl9QUk9YWV9TRVJWSUNFX05BTUUgfTtcbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQSxNQUFNQSwrQkFBK0IsR0FBRyxxQ0FBeEM7O0FBQ0EsTUFBTUMsY0FBYyxHQUFHLEtBQUtDLGFBQTVCO0FBRUEsTUFBTUMsa0JBQWtCLEdBQUcsbUJBQTNC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
