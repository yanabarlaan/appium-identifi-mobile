"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.SyslogDecoder = void 0;
exports.unescape = unescape;

require("source-map-support/register");

var _stream = _interopRequireDefault(require("stream"));

const NEW_LINE_CODE = 0x0A;
const NULL_DELIMETER_CODE = 0x00;
const BACKSLASH_CODE = '\\'.codePointAt(0);
const SHIFTS_MAPPING = {
  '-': 0x80,
  '^': 0x40
};
const ESCAPE_TOKEN_LEN = 4;
const ESCAPE_TOKEN_PATTERN = /\\M(-|\^)(.)/;

function toUtf8Byte(escapedChar, modifier) {
  const shift = SHIFTS_MAPPING[modifier];
  return isNaN(shift) ? null : escapedChar.codePointAt(0) + shift;
}

function unescape(logBuffer) {
  const parseUtf8Chars = start => {
    let cursor = start;
    const token = new Uint8Array(ESCAPE_TOKEN_LEN);
    const utf8CharsAsBytes = [];

    while (cursor <= logBuffer.length - ESCAPE_TOKEN_LEN) {
      logBuffer.copy(token, 0, cursor, cursor + ESCAPE_TOKEN_LEN);
      const tokenStr = Buffer.from(token).toString('latin1');
      const tokenMatch = ESCAPE_TOKEN_PATTERN.exec(tokenStr);

      if (!tokenMatch) {
        break;
      }

      const byte = toUtf8Byte(tokenMatch[2], tokenMatch[1]);

      if (byte === null) {
        break;
      }

      utf8CharsAsBytes.push(byte);
      cursor += ESCAPE_TOKEN_LEN;
    }

    return utf8CharsAsBytes.length ? [cursor, Buffer.from(utf8CharsAsBytes).toString('utf8')] : [start, null];
  };

  let index = 0;
  let result = '';
  const bytesView = new Uint8Array(logBuffer);

  while (index < bytesView.length) {
    if (bytesView[index] === BACKSLASH_CODE) {
      const [newIndex, chars] = parseUtf8Chars(index);

      if (newIndex > index) {
        result += chars;
        index = newIndex;
        continue;
      }
    }

    result += String.fromCharCode(bytesView[index++]);
  }

  return result;
}

class SyslogDecoder extends _stream.default.Transform {
  constructor(bufferLength) {
    super({
      objectMode: true
    });
    this.bufferIndex = 0;
    this.buffer = Buffer.allocUnsafe(bufferLength);
  }

  _transform(data, encoding, onData) {
    this._decode(data);

    onData();
  }

  _decode(data) {
    for (let i = 0; i < data.length; i++) {
      if (data[i] === NULL_DELIMETER_CODE) {
        continue;
      }

      if (data[i] === NEW_LINE_CODE) {
        if (this.bufferIndex > 0) {
          const stringBuffer = Buffer.allocUnsafe(this.bufferIndex);
          this.buffer.copy(stringBuffer, 0, 0, this.bufferIndex);
          this.push(unescape(stringBuffer), 'utf8');
          this.bufferIndex = 0;
        }

        continue;
      }

      this.buffer[this.bufferIndex] = data[i];
      this.bufferIndex++;
    }
  }

}

exports.SyslogDecoder = SyslogDecoder;
var _default = SyslogDecoder;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGliL3N5c2xvZy90cmFuc2Zvcm1lci9zeXNsb2ctZGVjb2Rlci5qcyIsIm5hbWVzIjpbIk5FV19MSU5FX0NPREUiLCJOVUxMX0RFTElNRVRFUl9DT0RFIiwiQkFDS1NMQVNIX0NPREUiLCJjb2RlUG9pbnRBdCIsIlNISUZUU19NQVBQSU5HIiwiRVNDQVBFX1RPS0VOX0xFTiIsIkVTQ0FQRV9UT0tFTl9QQVRURVJOIiwidG9VdGY4Qnl0ZSIsImVzY2FwZWRDaGFyIiwibW9kaWZpZXIiLCJzaGlmdCIsImlzTmFOIiwidW5lc2NhcGUiLCJsb2dCdWZmZXIiLCJwYXJzZVV0ZjhDaGFycyIsInN0YXJ0IiwiY3Vyc29yIiwidG9rZW4iLCJVaW50OEFycmF5IiwidXRmOENoYXJzQXNCeXRlcyIsImxlbmd0aCIsImNvcHkiLCJ0b2tlblN0ciIsIkJ1ZmZlciIsImZyb20iLCJ0b1N0cmluZyIsInRva2VuTWF0Y2giLCJleGVjIiwiYnl0ZSIsInB1c2giLCJpbmRleCIsInJlc3VsdCIsImJ5dGVzVmlldyIsIm5ld0luZGV4IiwiY2hhcnMiLCJTdHJpbmciLCJmcm9tQ2hhckNvZGUiLCJTeXNsb2dEZWNvZGVyIiwiU3RyZWFtIiwiVHJhbnNmb3JtIiwiY29uc3RydWN0b3IiLCJidWZmZXJMZW5ndGgiLCJvYmplY3RNb2RlIiwiYnVmZmVySW5kZXgiLCJidWZmZXIiLCJhbGxvY1Vuc2FmZSIsIl90cmFuc2Zvcm0iLCJkYXRhIiwiZW5jb2RpbmciLCJvbkRhdGEiLCJfZGVjb2RlIiwiaSIsInN0cmluZ0J1ZmZlciJdLCJzb3VyY2VSb290IjoiLi4vLi4vLi4vLi4iLCJzb3VyY2VzIjpbImxpYi9zeXNsb2cvdHJhbnNmb3JtZXIvc3lzbG9nLWRlY29kZXIuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IFN0cmVhbSBmcm9tICdzdHJlYW0nO1xuXG5jb25zdCBORVdfTElORV9DT0RFID0gMHgwQTtcbmNvbnN0IE5VTExfREVMSU1FVEVSX0NPREUgPSAweDAwO1xuY29uc3QgQkFDS1NMQVNIX0NPREUgPSAnXFxcXCcuY29kZVBvaW50QXQoMCk7XG5jb25zdCBTSElGVFNfTUFQUElORyA9IHtcbiAgJy0nOiAweDgwLFxuICAnXic6IDB4NDAsXG59O1xuY29uc3QgRVNDQVBFX1RPS0VOX0xFTiA9IDQ7XG5jb25zdCBFU0NBUEVfVE9LRU5fUEFUVEVSTiA9IC9cXFxcTSgtfFxcXikoLikvO1xuXG5cbmZ1bmN0aW9uIHRvVXRmOEJ5dGUgKGVzY2FwZWRDaGFyLCBtb2RpZmllcikge1xuICBjb25zdCBzaGlmdCA9IFNISUZUU19NQVBQSU5HW21vZGlmaWVyXTtcbiAgcmV0dXJuIGlzTmFOKHNoaWZ0KSA/IG51bGwgOiBlc2NhcGVkQ2hhci5jb2RlUG9pbnRBdCgwKSArIHNoaWZ0O1xufVxuXG4vKipcbiAqIFVuZXNjYXBlcyB1dGY4LWVuY29kZWQgY2hhcmFjdGVycywgc28gdGhlIG91dHB1dCBsb29rc1xuICogbGlrZSBhIHZhbGlkIHN0cmluZy4gU2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9hcHBpdW0vYXBwaXVtL2lzc3Vlcy8xNDQ3NlxuICogZm9yIG1vcmUgZGV0YWlscy5cbiAqXG4gKiBAcGFyYW0ge0J1ZmZlcn0gbG9nQnVmZmVyIEEgc2luZ2xlIGVzY2FwZWQgbG9nIGxpbmVcbiAqIEByZXR1cm5zIHtzdHJpbmd9IFRoZSB1bmVzY2FwZWQgc3RyaW5nIG9yIHRoZSBzYW1lIHN0cmluZyBpZiBubyB1bmVzY2FwaW5nXG4gKiBpcyBuZWNlc3NhcnkuXG4gKi9cbmZ1bmN0aW9uIHVuZXNjYXBlIChsb2dCdWZmZXIpIHtcbiAgY29uc3QgcGFyc2VVdGY4Q2hhcnMgPSAoc3RhcnQpID0+IHtcbiAgICBsZXQgY3Vyc29yID0gc3RhcnQ7XG4gICAgY29uc3QgdG9rZW4gPSBuZXcgVWludDhBcnJheShFU0NBUEVfVE9LRU5fTEVOKTtcbiAgICBjb25zdCB1dGY4Q2hhcnNBc0J5dGVzID0gW107XG4gICAgd2hpbGUgKGN1cnNvciA8PSBsb2dCdWZmZXIubGVuZ3RoIC0gRVNDQVBFX1RPS0VOX0xFTikge1xuICAgICAgbG9nQnVmZmVyLmNvcHkodG9rZW4sIDAsIGN1cnNvciwgY3Vyc29yICsgRVNDQVBFX1RPS0VOX0xFTik7XG4gICAgICBjb25zdCB0b2tlblN0ciA9IEJ1ZmZlci5mcm9tKHRva2VuKS50b1N0cmluZygnbGF0aW4xJyk7XG4gICAgICBjb25zdCB0b2tlbk1hdGNoID0gRVNDQVBFX1RPS0VOX1BBVFRFUk4uZXhlYyh0b2tlblN0cik7XG4gICAgICBpZiAoIXRva2VuTWF0Y2gpIHtcbiAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICBjb25zdCBieXRlID0gdG9VdGY4Qnl0ZSh0b2tlbk1hdGNoWzJdLCB0b2tlbk1hdGNoWzFdKTtcbiAgICAgIGlmIChieXRlID09PSBudWxsKSB7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgdXRmOENoYXJzQXNCeXRlcy5wdXNoKGJ5dGUpO1xuICAgICAgY3Vyc29yICs9IEVTQ0FQRV9UT0tFTl9MRU47XG4gICAgfVxuICAgIHJldHVybiB1dGY4Q2hhcnNBc0J5dGVzLmxlbmd0aFxuICAgICAgPyBbY3Vyc29yLCBCdWZmZXIuZnJvbSh1dGY4Q2hhcnNBc0J5dGVzKS50b1N0cmluZygndXRmOCcpXVxuICAgICAgOiBbc3RhcnQsIG51bGxdO1xuICB9O1xuXG4gIGxldCBpbmRleCA9IDA7XG4gIGxldCByZXN1bHQgPSAnJztcbiAgY29uc3QgYnl0ZXNWaWV3ID0gbmV3IFVpbnQ4QXJyYXkobG9nQnVmZmVyKTtcbiAgd2hpbGUgKGluZGV4IDwgYnl0ZXNWaWV3Lmxlbmd0aCkge1xuICAgIGlmIChieXRlc1ZpZXdbaW5kZXhdID09PSBCQUNLU0xBU0hfQ09ERSkge1xuICAgICAgY29uc3QgW25ld0luZGV4LCBjaGFyc10gPSBwYXJzZVV0ZjhDaGFycyhpbmRleCk7XG4gICAgICBpZiAobmV3SW5kZXggPiBpbmRleCkge1xuICAgICAgICByZXN1bHQgKz0gY2hhcnM7XG4gICAgICAgIGluZGV4ID0gbmV3SW5kZXg7XG4gICAgICAgIGNvbnRpbnVlO1xuICAgICAgfVxuICAgIH1cbiAgICByZXN1bHQgKz0gU3RyaW5nLmZyb21DaGFyQ29kZShieXRlc1ZpZXdbaW5kZXgrK10pO1xuICB9XG5cbiAgcmV0dXJuIHJlc3VsdDtcbn1cblxuXG5jbGFzcyBTeXNsb2dEZWNvZGVyIGV4dGVuZHMgU3RyZWFtLlRyYW5zZm9ybSB7XG5cbiAgY29uc3RydWN0b3IgKGJ1ZmZlckxlbmd0aCkge1xuICAgIHN1cGVyKHsgb2JqZWN0TW9kZTogdHJ1ZSB9KTtcbiAgICB0aGlzLmJ1ZmZlckluZGV4ID0gMDtcbiAgICB0aGlzLmJ1ZmZlciA9IEJ1ZmZlci5hbGxvY1Vuc2FmZShidWZmZXJMZW5ndGgpO1xuICB9XG5cbiAgX3RyYW5zZm9ybSAoZGF0YSwgZW5jb2RpbmcsIG9uRGF0YSkge1xuICAgIHRoaXMuX2RlY29kZShkYXRhKTtcbiAgICBvbkRhdGEoKTtcbiAgfVxuXG4gIF9kZWNvZGUgKGRhdGEpIHtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGRhdGEubGVuZ3RoOyBpKyspIHtcbiAgICAgIC8vIERvbid0IHN0b3JlIHRoZSBudWxsIGRlbGltZXRlciBtZXNzYWdlc1xuICAgICAgaWYgKGRhdGFbaV0gPT09IE5VTExfREVMSU1FVEVSX0NPREUpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICAvLyBQdXNoIHRoZSBkYXRhIHdoZW4gbmV3IGxpbmUgaXMgc2VudFxuICAgICAgaWYgKGRhdGFbaV0gPT09IE5FV19MSU5FX0NPREUpIHtcbiAgICAgICAgaWYgKHRoaXMuYnVmZmVySW5kZXggPiAwKSB7XG4gICAgICAgICAgY29uc3Qgc3RyaW5nQnVmZmVyID0gQnVmZmVyLmFsbG9jVW5zYWZlKHRoaXMuYnVmZmVySW5kZXgpO1xuICAgICAgICAgIHRoaXMuYnVmZmVyLmNvcHkoc3RyaW5nQnVmZmVyLCAwLCAwLCB0aGlzLmJ1ZmZlckluZGV4KTtcbiAgICAgICAgICB0aGlzLnB1c2godW5lc2NhcGUoc3RyaW5nQnVmZmVyKSwgJ3V0ZjgnKTtcbiAgICAgICAgICB0aGlzLmJ1ZmZlckluZGV4ID0gMDtcbiAgICAgICAgfVxuICAgICAgICBjb250aW51ZTtcbiAgICAgIH1cbiAgICAgIHRoaXMuYnVmZmVyW3RoaXMuYnVmZmVySW5kZXhdID0gZGF0YVtpXTtcbiAgICAgIHRoaXMuYnVmZmVySW5kZXgrKztcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IHsgU3lzbG9nRGVjb2RlciwgdW5lc2NhcGUgfTtcbmV4cG9ydCBkZWZhdWx0IFN5c2xvZ0RlY29kZXI7XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7OztBQUFBOztBQUVBLE1BQU1BLGFBQWEsR0FBRyxJQUF0QjtBQUNBLE1BQU1DLG1CQUFtQixHQUFHLElBQTVCO0FBQ0EsTUFBTUMsY0FBYyxHQUFHLEtBQUtDLFdBQUwsQ0FBaUIsQ0FBakIsQ0FBdkI7QUFDQSxNQUFNQyxjQUFjLEdBQUc7RUFDckIsS0FBSyxJQURnQjtFQUVyQixLQUFLO0FBRmdCLENBQXZCO0FBSUEsTUFBTUMsZ0JBQWdCLEdBQUcsQ0FBekI7QUFDQSxNQUFNQyxvQkFBb0IsR0FBRyxjQUE3Qjs7QUFHQSxTQUFTQyxVQUFULENBQXFCQyxXQUFyQixFQUFrQ0MsUUFBbEMsRUFBNEM7RUFDMUMsTUFBTUMsS0FBSyxHQUFHTixjQUFjLENBQUNLLFFBQUQsQ0FBNUI7RUFDQSxPQUFPRSxLQUFLLENBQUNELEtBQUQsQ0FBTCxHQUFlLElBQWYsR0FBc0JGLFdBQVcsQ0FBQ0wsV0FBWixDQUF3QixDQUF4QixJQUE2Qk8sS0FBMUQ7QUFDRDs7QUFXRCxTQUFTRSxRQUFULENBQW1CQyxTQUFuQixFQUE4QjtFQUM1QixNQUFNQyxjQUFjLEdBQUlDLEtBQUQsSUFBVztJQUNoQyxJQUFJQyxNQUFNLEdBQUdELEtBQWI7SUFDQSxNQUFNRSxLQUFLLEdBQUcsSUFBSUMsVUFBSixDQUFlYixnQkFBZixDQUFkO0lBQ0EsTUFBTWMsZ0JBQWdCLEdBQUcsRUFBekI7O0lBQ0EsT0FBT0gsTUFBTSxJQUFJSCxTQUFTLENBQUNP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
