"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.WebInspectorService = exports.WEB_INSPECTOR_SERVICE_NAME = void 0;

require("source-map-support/register");

var _webinspectorDecoder = _interopRequireDefault(require("./transformer/webinspector-decoder"));

var _webinspectorEncoder = _interopRequireDefault(require("./transformer/webinspector-encoder"));

var _plistServiceDecoder = _interopRequireDefault(require("../plist-service/transformer/plist-service-decoder"));

var _plistServiceEncoder = _interopRequireDefault(require("../plist-service/transformer/plist-service-encoder"));

var _lengthBasedSplitter = _interopRequireDefault(require("../util/transformer/length-based-splitter"));

var _streamLogger = _interopRequireDefault(require("../util/transformer/stream-logger"));

var _lodash = _interopRequireDefault(require("lodash"));

var _support = require("@appium/support");

var _constants = require("../constants");

var _logger = _interopRequireDefault(require("../logger"));

var _baseService = require("../base-service");

const WEB_INSPECTOR_SERVICE_NAME = 'com.apple.webinspector';
exports.WEB_INSPECTOR_SERVICE_NAME = WEB_INSPECTOR_SERVICE_NAME;
const MAX_FRAME_SIZE = 20 * _constants.MB;
const PARTIAL_MESSAGE_SUPPORT_DEPRECATION_VERSION = 11;

class WebInspectorService extends _baseService.BaseServiceSocket {
  constructor(opts = {}) {
    const {
      majorOsVersion,
      isSimulator = false,
      socketChunkSize,
      verbose = false,
      verboseHexDump = false,
      socketClient,
      maxFrameLength = MAX_FRAME_SIZE
    } = opts;
    super(socketClient);

    if (_lodash.default.isFunction(socketClient.setMaxSendFragment) && !_lodash.default.isNil(socketChunkSize) && socketChunkSize > 0) {
      if (socketClient.setMaxSendFragment(socketChunkSize)) {
        _logger.default.debug(`Maximum TLS fragment size set to '${socketChunkSize}'`);
      } else {
        _logger.default.warn(`Unable to set TLS fragment size to '${socketChunkSize}'`);
      }
    }

    this._verbose = verbose;
    this._isSimulator = isSimulator;
    this._majorOsVersion = majorOsVersion;

    if (!isSimulator && majorOsVersion < PARTIAL_MESSAGE_SUPPORT_DEPRECATION_VERSION) {
      this._initializePartialMessageSupport(verboseHexDump, maxFrameLength);
    } else {
      this._initializeFullMessageSupport(verboseHexDump, maxFrameLength);
    }
  }

  _initializeFullMessageSupport(verbose, maxFrameLength) {
    this._decoder = new _plistServiceDecoder.default();

    this._socketClient.pipe(new _streamLogger.default(_streamLogger.default.RECEIVE, verbose)).pipe(this._splitter = new _lengthBasedSplitter.default({
      readableStream: this._socketClient,
      littleEndian: false,
      maxFrameLength,
      lengthFieldOffset: 0,
      lengthFieldLength: 4,
      lengthAdjustment: 4
    })).pipe(this._decoder);

    this._encoder = new _plistServiceEncoder.default();

    this._encoder.pipe(new _streamLogger.default(_streamLogger.default.SEND, verbose)).pipe(this._socketClient);
  }

  _initializePartialMessageSupport(verbose, maxFrameLength) {
    this._decoder = new _webinspectorDecoder.default(_constants.MB);

    this._socketClient.pipe(new _streamLogger.default(_streamLogger.default.RECEIVE, verbose)).pipe(this._splitter = new _lengthBasedSplitter.default({
      readableStream: this._socketClient,
      littleEndian: false,
      maxFrameLength,
      lengthFieldOffset: 0,
      lengthFieldLength: 4,
      lengthAdjustment: 4
    })).pipe(new _plistServiceDecoder.default()).pipe(this._decoder);

    this._encoder = new _webinspectorEncoder.default();

    this._encoder.pipe(new _plistServiceEncoder.default()).pipe(new _streamLogger.default(_streamLogger.default.SEND, verbose)).pipe(this._socketClient);
  }

  sendMessage(rpcObject) {
    if (_lodash.default.isNil(rpcObject)) {
      throw new Error('Cannot send a null object');
    }

    if (this._verbose) {
      _logger.default.debug('Sending message to Web Inspector:');

      _logger.default.debug(_support.util.jsonStringify(rpcObject));
    }

    this._encoder.write(rpcObject);

    if (!this._isSimulator && this._majorOsVersion >= PARTIAL_MESSAGE_SUPPORT_DEPRECATION_VERSION) {
      this._encoder.write(' ');
    }
  }

  listenMessage(onData) {
    this._decoder.on('data', data => {
      if (this._verbose) {
        _logger.default.debug('Received message from Web Inspector:');

        _logger.default.debug(_support.util.jsonStringify(data));
      }

      onData(data);
    });
  }

}

exports.WebInspectorService = WebInspectorService;
var _default = WebInspectorService;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGliL3dlYmluc3BlY3Rvci9pbmRleC5qcyIsIm5hbWVzIjpbIldFQl9JTlNQRUNUT1JfU0VSVklDRV9OQU1FIiwiTUFYX0ZSQU1FX1NJWkUiLCJNQiIsIlBBUlRJQUxfTUVTU0FHRV9TVVBQT1JUX0RFUFJFQ0FUSU9OX1ZFUlNJT04iLCJXZWJJbnNwZWN0b3JTZXJ2aWNlIiwiQmFzZVNlcnZpY2VTb2NrZXQiLCJjb25zdHJ1Y3RvciIsIm9wdHMiLCJtYWpvck9zVmVyc2lvbiIsImlzU2ltdWxhdG9yIiwic29ja2V0Q2h1bmtTaXplIiwidmVyYm9zZSIsInZlcmJvc2VIZXhEdW1wIiwic29ja2V0Q2xpZW50IiwibWF4RnJhbWVMZW5ndGgiLCJfIiwiaXNGdW5jdGlvbiIsInNldE1heFNlbmRGcmFnbWVudCIsImlzTmlsIiwibG9nIiwiZGVidWciLCJ3YXJuIiwiX3ZlcmJvc2UiLCJfaXNTaW11bGF0b3IiLCJfbWFqb3JPc1ZlcnNpb24iLCJfaW5pdGlhbGl6ZVBhcnRpYWxNZXNzYWdlU3VwcG9ydCIsIl9pbml0aWFsaXplRnVsbE1lc3NhZ2VTdXBwb3J0IiwiX2RlY29kZXIiLCJQbGlzdFNlcnZpY2VEZWNvZGVyIiwiX3NvY2tldENsaWVudCIsInBpcGUiLCJTdHJlYW1Mb2dnZXIiLCJSRUNFSVZFIiwiX3NwbGl0dGVyIiwiTGVuZ3RoQmFzZWRTcGxpdHRlciIsInJlYWRhYmxlU3RyZWFtIiwibGl0dGxlRW5kaWFuIiwibGVuZ3RoRmllbGRPZmZzZXQiLCJsZW5ndGhGaWVsZExlbmd0aCIsImxlbmd0aEFkanVzdG1lbnQiLCJfZW5jb2RlciIsIlBsaXN0U2VydmljZUVuY29kZXIiLCJTRU5EIiwiV2ViSW5zcGVjdG9yRGVjb2RlciIsIldlYkluc3BlY3RvckVuY29kZXIiLCJzZW5kTWVzc2FnZSIsInJwY09iamVjdCIsIkVycm9yIiwidXRpbCIsImpzb25TdHJpbmdpZnkiLCJ3cml0ZSIsImxpc3Rlbk1lc3NhZ2UiLCJvbkRhdGEiLCJvbiIsImRhdGEiXSwic291cmNlUm9vdCI6Ii4uLy4uLy4uIiwic291cmNlcyI6WyJsaWIvd2ViaW5zcGVjdG9yL2luZGV4LmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBXZWJJbnNwZWN0b3JEZWNvZGVyIGZyb20gJy4vdHJhbnNmb3JtZXIvd2ViaW5zcGVjdG9yLWRlY29kZXInO1xuaW1wb3J0IFdlYkluc3BlY3RvckVuY29kZXIgZnJvbSAnLi90cmFuc2Zvcm1lci93ZWJpbnNwZWN0b3ItZW5jb2Rlcic7XG5pbXBvcnQgUGxpc3RTZXJ2aWNlRGVjb2RlciBmcm9tICcuLi9wbGlzdC1zZXJ2aWNlL3RyYW5zZm9ybWVyL3BsaXN0LXNlcnZpY2UtZGVjb2Rlcic7XG5pbXBvcnQgUGxpc3RTZXJ2aWNlRW5jb2RlciBmcm9tICcuLi9wbGlzdC1zZXJ2aWNlL3RyYW5zZm9ybWVyL3BsaXN0LXNlcnZpY2UtZW5jb2Rlcic7XG5pbXBvcnQgTGVuZ3RoQmFzZWRTcGxpdHRlciBmcm9tICcuLi91dGlsL3RyYW5zZm9ybWVyL2xlbmd0aC1iYXNlZC1zcGxpdHRlcic7XG5pbXBvcnQgU3RyZWFtTG9nZ2VyIGZyb20gJy4uL3V0aWwvdHJhbnNmb3JtZXIvc3RyZWFtLWxvZ2dlcic7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgdXRpbCB9IGZyb20gJ0BhcHBpdW0vc3VwcG9ydCc7XG5pbXBvcnQgeyBNQiB9IGZyb20gJy4uL2NvbnN0YW50cyc7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgeyBCYXNlU2VydmljZVNvY2tldCB9IGZyb20gJy4uL2Jhc2Utc2VydmljZSc7XG5cblxuY29uc3QgV0VCX0lOU1BFQ1RPUl9TRVJWSUNFX05BTUUgPSAnY29tLmFwcGxlLndlYmluc3BlY3Rvcic7XG5jb25zdCBNQVhfRlJBTUVfU0laRSA9IDIwICogTUI7XG5cbmNvbnN0IFBBUlRJQUxfTUVTU0FHRV9TVVBQT1JUX0RFUFJFQ0FUSU9OX1ZFUlNJT04gPSAxMTtcblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBXZWJJbnNwZWN0b3JTZXJ2aWNlT3B0aW9uc1xuICpcbiAqIEBwcm9wZXJ0eSB7bnVtYmVyfSBtYWpvck9zVmVyc2lvbiBUaGUgbWFqb3IgdmVyc2lvbiBvZiB0aGUgb3MgdmVyc2lvblxuICogQHByb3BlcnR5IHtib29sZWFufSBpc1NpbXVsYXRvciBXaGV0aGVyIHRoZSBkZXZpY2UgaXMgYSBzaW11bGF0b3JcbiAqIEBwcm9wZXJ0eSB7P251bWJlcn0gc29ja2V0Q2h1bmtTaXplIFNpemUsIGluIGJ5dGVzIG9mIHRoZSBjaHVua3MgdG8gc2VuZCB0b1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmVhbCBkZXZpY2UgKG9ubHkgaU9TIDExKykuIERlZmF1bHRzIHRvXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAxNjM4NCBieXRlcyAodGhlIFRMU1NvY2tldCBtYXgpLlxuICogQHByb3BlcnR5IHtib29sZWFufSB2ZXJib3NlIFR1cm4gb24gbG9nZ2luZyBvZiBlYWNoIG1lc3NhZ2Ugc2VudCBvciByZWNlaXZlZC5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICBEZWZhdWx0cyB0byBmYWxzZVxuICogQHByb3BlcnR5IHtib29sZWFufSB2ZXJib3NlSGV4RHVtcCBUdXJuIG9uIGxvZ2dpbmcgb2YgX2FsbF8gY29tbXVuaWNhdGlvbiBhc1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZXggZHVtcC4gRGVmYXVsdHMgdG8gZmFsc2VcbiAqIEBwcm9wZXJ0eSB7Kn0gc29ja2V0Q2xpZW50IFRoZSBzb2NrZXQgY2xpZW50IHdoZXJlIHRoZSBjb21tdW5pY2F0aW9uIHdpbGwgaGFwcGVuXG4gKiBAcHJvcGVydHkge251bWJlcn0gbWF4RnJhbWVMZW5ndGggWzIwICogMTAyNCAqIDEwMjRdIC0gVGhlIG1heGltdW0gc2l6ZVxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluIGJ5dGVzIG9mIGEgc2luZ2xlIGRhdGEgZnJhbWVcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbiB0aGUgZGV2aWNlIGNvbW11bmljYXRpb24gcHJvdG9jb2xcbiAqL1xuXG5jbGFzcyBXZWJJbnNwZWN0b3JTZXJ2aWNlIGV4dGVuZHMgQmFzZVNlcnZpY2VTb2NrZXQge1xuICAvKipcbiAgICogVGhlIG1haW4gc2VydmljZSBmb3IgY29tbXVuaWNhdGlvbiB3aXRoIHRoZSB3ZWJpbnNwZWN0b3JkXG4gICAqXG4gICAqIEBwYXJhbSB7V2ViSW5zcGVjdG9yU2VydmljZU9wdGlvbnN9XG4gICAqL1xuICBjb25zdHJ1Y3RvciAob3B0cyA9IHt9KSB7XG4gICAgY29uc3Qge1xuICAgICAgbWFqb3JPc1ZlcnNpb24sXG4gICAgICBpc1NpbXVsYXRvciA9IGZhbHNlLFxuICAgICAgc29ja2V0Q2h1bmtTaXplLFxuICAgICAgdmVyYm9zZSA9IGZhbHNlLFxuICAgICAgdmVyYm9zZUhleER1bXAgPSBmYWxzZSxcbiAgICAgIHNvY2tldENsaWVudCxcbiAgICAgIG1heEZyYW1lTGVuZ3RoID0gTUFYX0ZSQU1FX1NJWkUsXG4gICAgfSA9IG9wdHM7XG5cbiAgICBzdXBlcihzb2NrZXRDbGllbnQpO1xuXG4gICAgLy8gc2V0IHRoZSBsYXJnZXN0IGZyYWdtZW50IHNpemUgZm9yIHRoZSBzb2NrZXQsIGlmIHRoZSBvcHRpb24gaXMgdGhlcmVcbiAgICBpZiAoXy5pc0Z1bmN0aW9uKHNvY2tldENsaWVudC5zZXRNYXhTZW5kRnJhZ21lbnQpICYmICFfLmlzTmlsKHNvY2tldENodW5rU2l6ZSkgJiYgc29ja2V0Q2h1bmtTaXplID4gMCkge1xuICAgICAgaWYgKHNvY2tldENsaWVudC5zZXRNYXhTZW5kRnJhZ21lbnQoc29ja2V0Q2h1bmtTaXplKSkge1xuICAgICAgICBsb2cuZGVidWcoYE1heGltdW0gVExTIGZyYWdtZW50IHNpemUgc2V0IHRvICcke3NvY2tldENodW5rU2l6ZX0nYCk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBhbnl0aGluZyBvdmVyIHRoZSBfYWN0dWFsXyBtYXhpbXVtIHdpbGwgZmFpbCwgYW5kIHRoaW5ncyB3aWxsIHJlbWFpbiB0aGUgc2FtZVxuICAgICAgICBsb2cud2FybihgVW5hYmxlIHRvIHNldCBUTFMgZnJhZ21lbnQgc2l6ZSB0byAnJHtzb2NrZXRDaHVua1NpemV9J2ApO1xuICAgICAgfVxuICAgIH1cblxuICAgIHRoaXMuX3ZlcmJvc2UgPSB2ZXJib3NlO1xuICAgIHRoaXMuX2lzU2ltdWxhdG9yID0gaXNTaW11bGF0b3I7XG4gICAgdGhpcy5fbWFqb3JPc1ZlcnNpb24gPSBtYWpvck9zVmVyc2lvbjtcblxuICAgIGlmICghaXNTaW11bGF0b3IgJiYgbWFqb3JPc1ZlcnNpb24gPCBQQVJUSUFMX01FU1NBR0VfU1VQUE9SVF9ERVBSRUNBVElPTl9WRVJTSU9OKSB7XG4gICAgICB0aGlzLl9pbml0aWFsaXplUGFydGlhbE1lc3NhZ2VTdXBwb3J0KHZlcmJvc2VIZXhEdW1wLCBtYXhGcmFtZUxlbmd0aCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX2luaXRpYWxpemVGdWxsTWVzc2FnZVN1cHBvcnQodmVyYm9zZUhleER1bXAsIG1heEZyYW1lTGVuZ3RoKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogSW50aWFsaXplcyB0aGUgZGF0YSBmbG93IGZvciBpT1MgMTErLlxuICAgKlxuICAgKiBAcGFyYW0ge2Jvb2xlYW59IHZlcmJvc2UgLSB3aGV0aGVyIHRvIHByaW50IG91dCB0aGUgaGV4IGR1bXAgZm9yIGNvbW11bmljYXRpb25cbiAgICogQHBhcmFtIHtudW1iZXJ9IG1heEZyYW1lTGVuZ3RoIC0gVGhlIG1heGltdW0gc2l6ZSBpbiBieXRlcyBvZiBhIHNpbmdsZSBkYXRhIGZyYW1lXG4gICAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGluIHRoZSBkZXZpY2UgY29tbXVuaWNhdGlvbiBwcm90b2NvbFxuICAgKi9cbiAgX2luaXRpYWxpemVGdWxsTWVzc2FnZVN1cHBvcnQgKHZlcmJvc2UsIG1heEZyYW1lTGVuZ3RoKSB7XG4gICAgdGhpcy5fZGVjb2RlciA9IG5ldyBQbGlzdFNlcnZpY2VEZWNvZGVyKCk7XG4gICAgdGhpcy5fc29ja2V0Q2xpZW50XG4gICAgICAvLyBsb2cgZmlyc3QsIGluIGNhc2UgdGhlcmUgaXMgYSBwcm9ibGVtIGluIHByb2Nlc3NpbmdcbiAgICAgIC5waXBlKG5ldyBTdHJlYW1Mb2dnZXIoU3RyZWFtTG9nZ2VyLlJFQ0VJVkUsIHZlcmJvc2UpKVxuICAgICAgLnBpcGUodGhpcy5fc3BsaXR0ZXIgPSBuZXcgTGVuZ3RoQmFzZWRTcGxpdHRlcih7XG4gICAgICAgIHJlYWRhYmxlU3RyZWFtOiB0aGlzLl9zb2NrZXRDbGllbnQsXG4gICAgICAgIGxpdHRsZUVuZGlhbjogZmFsc2UsXG4gICAgICAgIG1heEZyYW1lTGVuZ3RoLFxuICAgICAgICBsZW5ndGhGaWVsZE9mZnNldDogMCxcbiAgICAgICAgbGVuZ3RoRmllbGRMZW5ndGg6IDQsXG4gICAgICAgIGxlbmd0aEFkanVzdG1lbnQ6IDQsXG4gICAgICB9KSlcbiAgICAgIC5waXBlKHRoaXMuX2RlY29kZXIpO1xuXG4gICAgdGhpcy5fZW5jb2RlciA9IG5ldyBQbGlzdFNlcnZpY2VFbmNvZGVyKCk7XG4gICAgdGhpcy5fZW5jb2RlclxuICAgICAgLnBpcGUobmV3IFN0cmVhbUxvZ2dlcihTdHJlYW1Mb2dnZXIuU0VORCwgdmVyYm9zZSkpXG4gICAgICAucGlwZSh0aGlzLl9zb2NrZXRDbGllbnQpO1xuICB9XG5cbiAgLyoqXG4gICAqIEludGlhbGl6ZXMgdGhlIGRhdGEgZmxvdyBmb3IgaU9TIDwgMTEsIHdoZXJlIGRhdGEgaXMgc2VwYXJhdGVkIGludG8gcGFydGlhbFxuICAgKiBtZXNzYWdlcyBiZWZvcmUgc2VuZGluZy5cbiAgICpcbiAgICogQHBhcmFtIHtib29sZWFufSB2ZXJib3NlIC0gd2hldGhlciB0byBwcmludCBvdXQgdGhlIGhleCBkdW1wIGZvciBjb21tdW5pY2F0aW9uXG4gICAqIEBwYXJhbSB7bnVtYmVyfSBtYXhGcmFtZUxlbmd0aCAtIFRoZSBtYXhpbXVtIHNpemUgaW4gYnl0ZXMgb2YgYSBzaW5nbGUgZGF0YSBmcmFtZVxuICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpbiB0aGUgZGV2aWNlIGNvbW11bmljYXRpb24gcHJvdG9jb2xcbiAgICovXG4gIF9pbml0aWFsaXplUGFydGlhbE1lc3NhZ2VTdXBwb3J0ICh2ZXJib3NlLCBtYXhGcmFtZUxlbmd0aCkge1xuICAgIC8vIDFNQiBhcyBidWZmZXIgZm9yIGJ1bGRpbmcgd2ViaW5zcGVjdG9yIGZ1bGwgbWVzc2FnZXMuIFdlIGNhbiBpbmNyZWFzZSB0aGUgdmFsdWUgaWYgbW9yZSBidWZmZXIgaXMgbmVlZGVkXG4gICAgdGhpcy5fZGVjb2RlciA9IG5ldyBXZWJJbnNwZWN0b3JEZWNvZGVyKE1CKTtcbiAgICB0aGlzLl9zb2NrZXRDbGllbnRcbiAgICAgIC8vIGxvZyBmaXJzdCwgaW4gY2FzZSB0aGVyZSBpcyBhIHByb2JsZW0gaW4gcHJvY2Vzc2luZ1xuICAgICAgLnBpcGUobmV3IFN0cmVhbUxvZ2dlcihTdHJlYW1Mb2dnZXIuUkVDRUlWRSwgdmVyYm9zZSkpXG4gICAgICAucGlwZSh0aGlzLl9zcGxpdHRlciA9IG5ldyBMZW5ndGhCYXNlZFNwbGl0dGVyKHtcbiAgICAgICAgcmVhZGFibGVTdHJlYW06IHRoaXMuX3NvY2tldENsaWVudCxcbiAgICAgICAgbGl0dGxlRW5kaWFuOiBmYWxzZSxcbiAgICAgICAgbWF4RnJhbWVMZW5ndGgsXG4gICAgICAgIGxlbmd0aEZpZWxkT2Zmc2V0OiAwLFxuICAgICAgICBsZW5ndGhGaWVsZExlbmd0aDogNCxcbiAgICAgICAgbGVuZ3RoQWRqdXN0bWVudDogNCxcbiAgICAgIH0pKVxuICAgICAgLnBpcGUobmV3IFBsaXN0U2VydmljZURlY29kZXIoKSlcbiAgICAgIC5waXBlKHRoaXMuX2RlY29kZXIpO1xuXG4gICAgdGhpcy5fZW5jb2RlciA9IG5ldyBXZWJJbnNwZWN0b3JFbmNvZGVyKCk7XG4gICAgdGhpcy5fZW5jb2RlclxuICAgICAgLnBpcGUobmV3IFBsaXN0U2VydmljZUVuY29kZXIoKSlcbiAgICAgIC5waXBlKG5ldyBTdHJlYW1Mb2dnZXIoU3RyZWFtTG9nZ2VyLlNFTkQsIHZlcmJvc2UpKVxuICAgICAgLnBpcGUodGhpcy5fc29ja2V0Q2xpZW50KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZW5kcyBhbiBvYmplY3QgdG8gdGhlIHdlYmluc3BlY3RvcmQgc29ja2V0XG4gICAqIEBwYXJhbSB7T2JqZWN0fSBycGNPYmplY3QgVGhlIG9iamVjdCB0aGF0IHdpbGwgYmUgc2VudFxuICAgKiBAdGhyb3dzIFdpbGwgdGhyb3cgYW4gZXJyb3Igd2hlbiB0aGUgb2JqZWN0IGlzIG51bGwgb3IgdW5kZWZpbmVkXG4gICAqL1xuICBzZW5kTWVzc2FnZSAocnBjT2JqZWN0KSB7XG4gICAgaWYgKF8uaXNOaWwocnBjT2JqZWN0KSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdDYW5ub3Qgc2VuZCBhIG51bGwgb2JqZWN0Jyk7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMuX3ZlcmJvc2UpIHtcbiAgICAgIGxvZy5kZWJ1ZygnU2VuZGluZyBtZXNzYWdlIHRvIFdlYiBJbnNwZWN0b3I6Jyk7XG4gICAgICBsb2cuZGVidWcodXRpbC5qc29uU3RyaW5naWZ5KHJwY09iamVjdCkpO1xuICAgIH1cblxuICAgIHRoaXMuX2VuY29kZXIud3JpdGUocnBjT2JqZWN0KTtcblxuICAgIC8vIHdyaXRlIGFuIGVtcHR5IG1lc3NhZ2UsIHdoaWNoIG9uIHJlYWwgZGV2aWNlcyBlbnN1cmVzIHRoZSBhY3R1YWwgbWVzc2FnZVxuICAgIC8vIGdldHMgc2VudCB0byB0aGUgZGV2aWNlLiB3aXRob3V0IHRoaXMgaXQgd2lsbCBwZXJpb2RpY2FsbHkgaGFuZyB3aXRoXG4gICAgLy8gbm90aGluZyBzZW50XG4gICAgLy8gaG93ZXZlciwgdGhpcyBjYXVzZXMgd2ViaW5zcGVjdG9yZCB0byBjcmFzaCBvbiBkZXZpY2VzIHJ1bm5pbmcgaU9TIDEwXG4gICAgaWYgKCF0aGlzLl9pc1NpbXVsYXRvciAmJiB0aGlzLl9tYWpvck9zVmVyc2lvbiA+PSBQQVJUSUFMX01FU1NBR0VfU1VQUE9SVF9ERVBSRUNBVElPTl9WRVJTSU9OKSB7XG4gICAgICB0aGlzLl9lbmNvZGVyLndyaXRlKCcgJyk7XG4gICAgfVxuICB9XG5cbiAgLyoqIFRoZSBjYWxsYmFjayBmdW5jdGlvbiB3aGljaCB3aWxsIGJlIGNhbGxlZCBkdXJpbmcgbWVzc2FnZSBsaXN0ZW5pbmdcbiAgICogQG5hbWUgTWVzc2FnZUNhbGxiYWNrXG4gICAqIEBmdW5jdGlvblxuICAgKiBAcGFyYW0ge09iamVjdH0gb2JqZWN0IFRoZSBycGMgb2JqZWN0IHRoYXQgaXMgc2VudCBmcm9tIHRoZSB3ZWJpbnNwZWN0b3JkXG4gICovXG5cbiAgLyoqXG4gICAqIExpc3RlbiB0byBtZXNzYWdlcyBjb21pbmcgZnJvbSB3ZWJpbnNwZWN0b3JkXG4gICAqIEBwYXJhbSB7TWVzc2FnZUNhbGxiYWNrfSBjYWxsYmFja1xuICAgKi9cbiAgbGlzdGVuTWVzc2FnZSAob25EYXRhKSB7XG4gICAgdGhpcy5fZGVjb2Rlci5vbignZGF0YScsIChkYXRhKSA9PiB7XG4gICAgICBpZiAodGhpcy5fdmVyYm9zZSkge1xuICAgICAgICBsb2cuZGVidWcoJ1JlY2VpdmVkIG1lc3NhZ2UgZnJvbSBXZWIgSW5zcGVjdG9yOicpO1xuICAgICAgICBsb2cuZGVidWcodXRpbC5qc29uU3RyaW5naWZ5KGRhdGEpKTtcbiAgICAgIH1cbiAgICAgIG9uRGF0YShkYXRhKTtcbiAgICB9KTtcbiAgfVxufVxuXG5leHBvcnQgeyBXZWJJbnNwZWN0b3JTZXJ2aWNlLCBXRUJfSU5TUEVDVE9SX1NFUlZJQ0VfTkFNRSB9O1xuZXhwb3J0IGRlZmF1bHQgV2ViSW5zcGVjdG9yU2VydmljZTtcbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7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
