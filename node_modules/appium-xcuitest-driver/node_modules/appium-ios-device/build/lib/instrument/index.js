"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.InstrumentService = exports.INSTRUMENT_SERVICE_NAME_VERSION_14 = exports.INSTRUMENT_SERVICE_NAME = exports.INSTRUMENT_CHANNEL = void 0;

require("source-map-support/register");

var _baseService = require("../base-service");

var _headers = require("./headers");

var _dtxEncode = require("./transformer/dtx-encode");

var _dtxDecode = require("./transformer/dtx-decode");

var _events = _interopRequireDefault(require("events"));

var _lodash = _interopRequireDefault(require("lodash"));

var _asyncbox = require("asyncbox");

const CHECK_FREQ_MS = 500;
const WAIT_REPLY_TIME_MS = 10000;
const EMPTY_MESSAGE_SIZE = 16;
const CHANNEL_CANCELED = '_channelCanceled';
const CHANNEL_OFFSET = 2 ** 32;
const INSTRUMENT_SERVICE_NAME_VERSION_14 = 'com.apple.instruments.remoteserver.DVTSecureSocketProxy';
exports.INSTRUMENT_SERVICE_NAME_VERSION_14 = INSTRUMENT_SERVICE_NAME_VERSION_14;
const INSTRUMENT_SERVICE_NAME = 'com.apple.instruments.remoteserver';
exports.INSTRUMENT_SERVICE_NAME = INSTRUMENT_SERVICE_NAME;
const INSTRUMENT_CHANNEL = Object.freeze({
  DEVICE_INFO: 'com.apple.instruments.server.services.deviceinfo',
  PROCESS_CONTROL: 'com.apple.instruments.server.services.processcontrol',
  SYSMONTAP: 'com.apple.instruments.server.services.sysmontap',
  NETWORKING: 'com.apple.instruments.server.services.networking',
  MOBILE_NOTIFICATIONS: 'com.apple.instruments.server.services.mobilenotifications',
  GRAPHICS_OPENGL: 'com.apple.instruments.server.services.graphics.opengl',
  APPLICATION_LISTING: 'com.apple.instruments.server.services.device.applictionListing',
  CONDITION_INDUCER: 'com.apple.instruments.server.services.ConditionInducer'
});
exports.INSTRUMENT_CHANNEL = INSTRUMENT_CHANNEL;

function defaultDict(createValue) {
  return new Proxy(Object.create(null), {
    get(storage, property) {
      if (!(property in storage)) {
        storage[property] = createValue(property);
      }

      return storage[property];
    }

  });
}

class InstrumentService extends _baseService.BaseServiceSocket {
  constructor(socketClient, event) {
    super(socketClient);
    this._undefinedCallback = event;
    this._callbacks = new _events.default.EventEmitter();
    this._channelCallbacks = new _events.default.EventEmitter();
    this._replyQueues = defaultDict(() => []);
    this._channels = {};
    this._nextIdentifier = 1;
    this._encoder = new _dtxEncode.DTXEncoder();

    this._encoder.pipe(this._socketClient);

    this._assignClientFailureHandlers(this._encoder);

    this._decoder = new _dtxDecode.DTXDecoder();

    this._socketClient.pipe(this._decoder);

    this._decoder.on('data', this._handleData.bind(this));
  }

  registerSelectorCallback(selector, event) {
    this._callbacks.addListener(selector, event);
  }

  registerUndefinedCallback(event) {
    this._undefinedCallback = event;
  }

  async registerChannelCallback(channel, event) {
    const channelId = await this.makeChannel(channel);

    this._channelCallbacks.addListener(channelId, event);
  }

  async makeChannel(channel) {
    if (channel in this._channels) {
      return this._channels[channel];
    }

    const channelCode = Object.keys(this._channels).length + 1;
    await this._callChannel(true, 0, '_requestChannelWithCode:identifier:', channelCode, channel);
    this._channels[channel] = channelCode;
    return channelCode;
  }

  async callChannel(channel, selector, ...auxiliaries) {
    const channelCode = await this.makeChannel(channel);
    return await this._callChannel(true, channelCode, selector, ...auxiliaries);
  }

  async _callChannel(sync, channelCode, selector, ...auxiliaries) {
    const identifier = this._nextIdentifier;

    this._encoder.write({
      sync,
      channelCode,
      selector,
      auxiliaries,
      identifier
    });

    ++this._nextIdentifier;

    if (sync) {
      try {
        return await (0, _asyncbox.waitForCondition)(() => {
          const queue = this._replyQueues[identifier];
          const data = queue.shift();

          if (!_lodash.default.isUndefined(data)) {
            return data;
          }
        }, {
          waitMs: WAIT_REPLY_TIME_MS,
          intervalMs: CHECK_FREQ_MS,
          error: 'reply channel data timeout'
        });
      } catch (err) {
        this.close();
        throw new Error(err);
      }
    }
  }

  _handleData(data) {
    if (_lodash.default.includes(data.selector, CHANNEL_CANCELED)) {
      this.close();
    }

    if (data.conversationIndex === 1) {
      this._replyQueues[data.identifier].push(data);
    } else if (this._channelCallbacks.listenerCount(CHANNEL_OFFSET - data.channelCode) > 0) {
      this._channelCallbacks.emit(CHANNEL_OFFSET - data.channelCode, data);
    } else {
      const selector = data.selector;

      if (_lodash.default.isString(selector) && this._callbacks.listenerCount(selector) > 0) {
        this._callbacks.emit(selector, data);
      } else if (this._undefinedCallback) {
        this._undefinedCallback(data);
      }

      if (data.expectsReply) {
        this._replyAck(data);
      }
    }
  }

  _replyAck(data) {
    const reply = new _headers.DTXMessage({
      identifier: data.identifier,
      channelCode: data.channelCode,
      selector: Buffer.alloc(EMPTY_MESSAGE_SIZE),
      conversationIndex: data.conversationIndex + 1,
      flags: _headers.FLAG_TYPES.reply
    });

    this._socketClient.write(reply.build());
  }

}

exports.InstrumentService = InstrumentService;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGliL2luc3RydW1lbnQvaW5kZXguanMiLCJuYW1lcyI6WyJDSEVDS19GUkVRX01TIiwiV0FJVF9SRVBMWV9USU1FX01TIiwiRU1QVFlfTUVTU0FHRV9TSVpFIiwiQ0hBTk5FTF9DQU5DRUxFRCIsIkNIQU5ORUxfT0ZGU0VUIiwiSU5TVFJVTUVOVF9TRVJWSUNFX05BTUVfVkVSU0lPTl8xNCIsIklOU1RSVU1FTlRfU0VSVklDRV9OQU1FIiwiSU5TVFJVTUVOVF9DSEFOTkVMIiwiT2JqZWN0IiwiZnJlZXplIiwiREVWSUNFX0lORk8iLCJQUk9DRVNTX0NPTlRST0wiLCJTWVNNT05UQVAiLCJORVRXT1JLSU5HIiwiTU9CSUxFX05PVElGSUNBVElPTlMiLCJHUkFQSElDU19PUEVOR0wiLCJBUFBMSUNBVElPTl9MSVNUSU5HIiwiQ09ORElUSU9OX0lORFVDRVIiLCJkZWZhdWx0RGljdCIsImNyZWF0ZVZhbHVlIiwiUHJveHkiLCJjcmVhdGUiLCJnZXQiLCJzdG9yYWdlIiwicHJvcGVydHkiLCJJbnN0cnVtZW50U2VydmljZSIsIkJhc2VTZXJ2aWNlU29ja2V0IiwiY29uc3RydWN0b3IiLCJzb2NrZXRDbGllbnQiLCJldmVudCIsIl91bmRlZmluZWRDYWxsYmFjayIsIl9jYWxsYmFja3MiLCJldmVudHMiLCJFdmVudEVtaXR0ZXIiLCJfY2hhbm5lbENhbGxiYWNrcyIsIl9yZXBseVF1ZXVlcyIsIl9jaGFubmVscyIsIl9uZXh0SWRlbnRpZmllciIsIl9lbmNvZGVyIiwiRFRYRW5jb2RlciIsInBpcGUiLCJfc29ja2V0Q2xpZW50IiwiX2Fzc2lnbkNsaWVudEZhaWx1cmVIYW5kbGVycyIsIl9kZWNvZGVyIiwiRFRYRGVjb2RlciIsIm9uIiwiX2hhbmRsZURhdGEiLCJiaW5kIiwicmVnaXN0ZXJTZWxlY3RvckNhbGxiYWNrIiwic2VsZWN0b3IiLCJhZGRMaXN0ZW5lciIsInJlZ2lzdGVyVW5kZWZpbmVkQ2FsbGJhY2siLCJyZWdpc3RlckNoYW5uZWxDYWxsYmFjayIsImNoYW5uZWwiLCJjaGFubmVsSWQiLCJtYWtlQ2hhbm5lbCIsImNoYW5uZWxDb2RlIiwia2V5cyIsImxlbmd0aCIsIl9jYWxsQ2hhbm5lbCIsImNhbGxDaGFubmVsIiwiYXV4aWxpYXJpZXMiLCJzeW5jIiwiaWRlbnRpZmllciIsIndyaXRlIiwicXVldWUiLCJkYXRhIiwic2hpZnQiLCJfIiwiaXNVbmRlZmluZWQiLCJ3YWl0TXMiLCJpbnRlcnZhbE1zIiwiZXJyb3IiLCJlcnIiLCJjbG9zZSIsIkVycm9yIiwiaW5jbHVkZXMiLCJjb252ZXJzYXRpb25JbmRleCIsInB1c2giLCJsaXN0ZW5lckNvdW50IiwiZW1pdCIsImlzU3RyaW5nIiwiZXhwZWN0c1JlcGx5IiwiX3JlcGx5QWNrIiwicmVwbHkiLCJEVFhNZXNzYWdlIiwiQnVmZmVyIiwiYWxsb2MiLCJmbGFncyIsIkZMQUdfVFlQRVMiLCJidWlsZCJdLCJzb3VyY2VSb290IjoiLi4vLi4vLi4iLCJzb3VyY2VzIjpbImxpYi9pbnN0cnVtZW50L2luZGV4LmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8vIEFkYXB0ZWQgZnJvbSBodHRwczovL2dpdGh1Yi5jb20vWXVlQ2hlbi1DL3B5LWlvcy1kZXZpY2VcblxuaW1wb3J0IHtCYXNlU2VydmljZVNvY2tldH0gZnJvbSAnLi4vYmFzZS1zZXJ2aWNlJztcbmltcG9ydCB7RFRYTWVzc2FnZSwgRkxBR19UWVBFU30gZnJvbSAnLi9oZWFkZXJzJztcbmltcG9ydCB7RFRYRW5jb2Rlcn0gZnJvbSAnLi90cmFuc2Zvcm1lci9kdHgtZW5jb2RlJztcbmltcG9ydCB7RFRYRGVjb2Rlcn0gZnJvbSAnLi90cmFuc2Zvcm1lci9kdHgtZGVjb2RlJztcbmltcG9ydCBldmVudHMgZnJvbSAnZXZlbnRzJztcbmltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQge3dhaXRGb3JDb25kaXRpb259IGZyb20gJ2FzeW5jYm94JztcblxuY29uc3QgQ0hFQ0tfRlJFUV9NUyA9IDUwMDtcbmNvbnN0IFdBSVRfUkVQTFlfVElNRV9NUyA9IDEwMDAwO1xuY29uc3QgRU1QVFlfTUVTU0FHRV9TSVpFID0gMTY7XG5jb25zdCBDSEFOTkVMX0NBTkNFTEVEID0gJ19jaGFubmVsQ2FuY2VsZWQnO1xuY29uc3QgQ0hBTk5FTF9PRkZTRVQgPSAyICoqIDMyO1xuXG5jb25zdCBJTlNUUlVNRU5UX1NFUlZJQ0VfTkFNRV9WRVJTSU9OXzE0ID0gJ2NvbS5hcHBsZS5pbnN0cnVtZW50cy5yZW1vdGVzZXJ2ZXIuRFZUU2VjdXJlU29ja2V0UHJveHknO1xuY29uc3QgSU5TVFJVTUVOVF9TRVJWSUNFX05BTUUgPSAnY29tLmFwcGxlLmluc3RydW1lbnRzLnJlbW90ZXNlcnZlcic7XG5cbmV4cG9ydCBjb25zdCBJTlNUUlVNRU5UX0NIQU5ORUwgPSBPYmplY3QuZnJlZXplKHtcbiAgREVWSUNFX0lORk86ICdjb20uYXBwbGUuaW5zdHJ1bWVudHMuc2VydmVyLnNlcnZpY2VzLmRldmljZWluZm8nLFxuICBQUk9DRVNTX0NPTlRST0w6ICdjb20uYXBwbGUuaW5zdHJ1bWVudHMuc2VydmVyLnNlcnZpY2VzLnByb2Nlc3Njb250cm9sJyxcbiAgU1lTTU9OVEFQOiAnY29tLmFwcGxlLmluc3RydW1lbnRzLnNlcnZlci5zZXJ2aWNlcy5zeXNtb250YXAnLFxuICBORVRXT1JLSU5HOiAnY29tLmFwcGxlLmluc3RydW1lbnRzLnNlcnZlci5zZXJ2aWNlcy5uZXR3b3JraW5nJyxcbiAgTU9CSUxFX05PVElGSUNBVElPTlM6ICdjb20uYXBwbGUuaW5zdHJ1bWVudHMuc2VydmVyLnNlcnZpY2VzLm1vYmlsZW5vdGlmaWNhdGlvbnMnLFxuICBHUkFQSElDU19PUEVOR0w6ICdjb20uYXBwbGUuaW5zdHJ1bWVudHMuc2VydmVyLnNlcnZpY2VzLmdyYXBoaWNzLm9wZW5nbCcsXG4gIEFQUExJQ0FUSU9OX0xJU1RJTkc6ICdjb20uYXBwbGUuaW5zdHJ1bWVudHMuc2VydmVyLnNlcnZpY2VzLmRldmljZS5hcHBsaWN0aW9uTGlzdGluZycsXG4gIENPTkRJVElPTl9JTkRVQ0VSOiAnY29tLmFwcGxlLmluc3RydW1lbnRzLnNlcnZlci5zZXJ2aWNlcy5Db25kaXRpb25JbmR1Y2VyJ1xufSk7XG5cbmZ1bmN0aW9uIGRlZmF1bHREaWN0IChjcmVhdGVWYWx1ZSkge1xuICByZXR1cm4gbmV3IFByb3h5KE9iamVjdC5jcmVhdGUobnVsbCksIHtcbiAgICBnZXQgKHN0b3JhZ2UsIHByb3BlcnR5KSB7XG4gICAgICBpZiAoIShwcm9wZXJ0eSBpbiBzdG9yYWdlKSkge1xuICAgICAgICBzdG9yYWdlW3Byb3BlcnR5XSA9IGNyZWF0ZVZhbHVlKHByb3BlcnR5KTtcbiAgICAgIH1cbiAgICAgIHJldHVybiBzdG9yYWdlW3Byb3BlcnR5XTtcbiAgICB9XG4gIH0pO1xufVxuXG4vKiogVGhlIGNhbGxiYWNrIGZ1bmN0aW9uIHdoaWNoIHdpbGwgYmUgY2FsbGVkIGR1cmluZyB0aGUgZGF0YSB0cmFuc21pc3Npb24gaW4gaW5zdHJ1bWVudCBzZXJ2ZVxuICogQG5hbWUgRFRYQ2FsbGJhY2tcbiAqIEBmdW5jdGlvblxuICogQHBhcmFtIHtEVFhNZXNzYWdlfSBvYmplY3RcbiovXG5cbi8qKlxuICogQHBhcmFtIHtTb2NrZXR9IHNvY2tldENsaWVudCAgRFRYTWVzc2FnZS5zZWxlY3RvclxuICogQHBhcmFtIHs/RFRYQ2FsbGJhY2t9IGV2ZW50IGlmIGVtcHR5IHdpbGwgaWdub3JlIGFueSBtZXNzYWdlc1xuICovXG5jbGFzcyBJbnN0cnVtZW50U2VydmljZSBleHRlbmRzIEJhc2VTZXJ2aWNlU29ja2V0IHtcbiAgY29uc3RydWN0b3IgKHNvY2tldENsaWVudCwgZXZlbnQpIHtcbiAgICBzdXBlcihzb2NrZXRDbGllbnQpO1xuICAgIHRoaXMuX3VuZGVmaW5lZENhbGxiYWNrID0gZXZlbnQ7XG4gICAgdGhpcy5fY2FsbGJhY2tzID0gbmV3IGV2ZW50cy5FdmVudEVtaXR0ZXIoKTtcbiAgICB0aGlzLl9jaGFubmVsQ2FsbGJhY2tzID0gbmV3IGV2ZW50cy5FdmVudEVtaXR0ZXIoKTtcbiAgICB0aGlzLl9yZXBseVF1ZXVlcyA9IGRlZmF1bHREaWN0KCgpID0+IFtdKTtcbiAgICB0aGlzLl9jaGFubmVscyA9IHt9O1xuICAgIHRoaXMuX25leHRJZGVudGlmaWVyID0gMTtcbiAgICB0aGlzLl9lbmNvZGVyID0gbmV3IERUWEVuY29kZXIoKTtcbiAgICB0aGlzLl9lbmNvZGVyLnBpcGUodGhpcy5fc29ja2V0Q2xpZW50KTtcbiAgICB0aGlzLl9hc3NpZ25DbGllbnRGYWlsdXJlSGFuZGxlcnModGhpcy5fZW5jb2Rlcik7XG4gICAgdGhpcy5fZGVjb2RlciA9IG5ldyBEVFhEZWNvZGVyKCk7XG4gICAgdGhpcy5fc29ja2V0Q2xpZW50LnBpcGUodGhpcy5fZGVjb2Rlcik7XG4gICAgdGhpcy5fZGVjb2Rlci5vbignZGF0YScsIHRoaXMuX2hhbmRsZURhdGEuYmluZCh0aGlzKSk7XG4gIH1cblxuICAvKipcbiAgICogSWYgdGhlIHNlbGVjdG9yIGlzIHJlZ2lzdGVyZWQsIFRoZSBtZXNzYWdlIG9mIHRoZSBzZWxlY3RvciBldmVudCB3aWxsIGJlIHJldHVybmVkLiByZWZlciB0byB0aGlzLl9oYW5kbGVEYXRhXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBzZWxlY3RvciAgTGlzdGVuIGZvciByZXR1cm4gRFRYTWVzc2FnZS5zZWxlY3RvciBkYXRhXG4gICAqIEBwYXJhbSB7RFRYQ2FsbGJhY2t9IGV2ZW50XG4gICAqL1xuICByZWdpc3RlclNlbGVjdG9yQ2FsbGJhY2sgKHNlbGVjdG9yLCBldmVudCkge1xuICAgIHRoaXMuX2NhbGxiYWNrcy5hZGRMaXN0ZW5lcihzZWxlY3RvciwgZXZlbnQpO1xuICB9XG5cbiAgLyoqXG4gICAqIElmIHRoZSBldmVudCBpcyByZWdpc3RlcmVkLCBhbGwgdW5yZWdpc3RlcmVkIG1lc3NhZ2VzIHdpbGwgYmUgcmV0dXJuZWQgdG8gZXZlbnQuIHJlZmVyIHRvIHRoaXMuX2hhbmRsZURhdGFcbiAgICogQHBhcmFtIHtEVFhDYWxsYmFja30gZXZlbnRcbiAgICovXG4gIHJlZ2lzdGVyVW5kZWZpbmVkQ2FsbGJhY2sgKGV2ZW50KSB7XG4gICAgdGhpcy5fdW5kZWZpbmVkQ2FsbGJhY2sgPSBldmVudDtcbiAgfVxuXG4gIC8qKlxuICAgKiBJZiB0aGUgZXZlbnQgaXMgcmVnaXN0ZXJlZCwgdGhpcyBjaGFubmVsIHtDSEFOTkVMfSBtZXNzYWdlcyB3aWxsIGJlIHJldHVybmVkIHRvIGV2ZW50LiByZWZlciB0byB0aGlzLl9oYW5kbGVEYXRhXG4gICAqIEl0J3MgYWN0dWFsbHkgbGlzdGVuaW5nIGZvciBpbnQgY2hhbm5lbENvZGUuIEluIHRoaXMuX2NoYW5uZWwgb2JqZWN0IHRvIHJlY29yZCBjaGFubmVsIGtleSBhbmQgaW50IHZhbHVlXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBjaGFubmVsIGluc3RydW1lbnRzIHNlcnZpY2UgY2hhbm5lbCBlLmc6IElOU1RSVU1FTlRfQ0hBTk5FTC5ERVZJQ0VfSU5GTy5cbiAgICogQHBhcmFtIHtEVFhDYWxsYmFja30gZXZlbnRcbiAgICovXG4gIGFzeW5jIHJlZ2lzdGVyQ2hhbm5lbENhbGxiYWNrIChjaGFubmVsLCBldmVudCkge1xuICAgIGNvbnN0IGNoYW5uZWxJZCA9IGF3YWl0IHRoaXMubWFrZUNoYW5uZWwoY2hhbm5lbCk7XG4gICAgdGhpcy5fY2hhbm5lbENhbGxiYWNrcy5hZGRMaXN0ZW5lcihjaGFubmVsSWQsIGV2ZW50KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgYSBzZXJ2aWNlIGNoYW5uZWwsIGRhdGEgdHJhbnNtaXNzaW9uIG9mIHRoZSBzZXJ2aWNlIHdpbGwgdXNlIHRoaXMgY2hhbm5lbENvZGVcbiAgICogQHBhcmFtIHtzdHJpbmd9IGNoYW5uZWwgIGluc3RydW1lbnRzIHNlcnZpY2UgY2hhbm5lbCBlLmc6IElOU1RSVU1FTlRfQ0hBTk5FTC5ERVZJQ0VfSU5GT1xuICAgKiBAcmV0dXJucyB7UHJvbWlzZTxudW1iZXJ8Kj59IGluc3RydW1lbnRzIHNlcnZpY2UgY2hhbm5lbCBjb2RlIGZvciBkYXRhIHRyYW5zbWlzc2lvblxuICAgKi9cbiAgYXN5bmMgbWFrZUNoYW5uZWwgKGNoYW5uZWwpIHtcbiAgICBpZiAoY2hhbm5lbCBpbiB0aGlzLl9jaGFubmVscykge1xuICAgICAgcmV0dXJuIHRoaXMuX2NoYW5uZWxzW2NoYW5uZWxdO1xuICAgIH1cbiAgICBjb25zdCBjaGFubmVsQ29kZSA9IE9iamVjdC5rZXlzKHRoaXMuX2NoYW5uZWxzKS5sZW5ndGggKyAxO1xuICAgIGF3YWl0IHRoaXMuX2NhbGxDaGFubmVsKHRydWUsIDAsICdfcmVxdWVzdENoYW5uZWxXaXRoQ29kZTppZGVudGlmaWVyOicsIGNoYW5uZWxDb2RlLCBjaGFubmVsKTtcbiAgICB0aGlzLl9jaGFubmVsc1tjaGFubmVsXSA9IGNoYW5uZWxDb2RlO1xuICAgIHJldHVybiBjaGFubmVsQ29kZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbiBnZW5lcmFsLCB3ZSBjYWxsIHRoaXMgbWV0aG9kIHRvIHN0YXJ0IHRoZSBpbnN0cnVtZW50IGR0eCBzZXJ2aWNlXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBjaGFubmVsIGluc3RydW1lbnQgZHR4IHNlcnZpY2UgZS5nOiBJTlNUUlVNRU5UX0NIQU5ORUwuREVWSUNFX0lORk9cbiAgICogQHBhcmFtIHtzdHJpbmd9IHNlbGVjdG9yIGluc3RydW1lbnQgc2VydmljZSBtZXRob2QgbmFtZSAocmVmbGVjdGlvbiBjYWxscylcbiAgICogQHBhcmFtIHsuLi5hbnl9IGF1eGlsaWFyaWVzIHBhcmFtZXRlcnMgcmVxdWlyZWQgYnkgc2VsZWN0b3JcbiAgICogQHJldHVybnMge1Byb21pc2U8RFRYTWVzc2FnZT59XG4gICAqIGV4YW1wbGXvvJpcbiAgICogaW5zdHJ1bWVudFNlcnZpY2UuY2FsbENoYW5uZWwoSU5TVFJVTUVOVF9DSEFOTkVMLlBST0NFU1NfQ09OVFJPTCxcbiAgICAgICAgJ2xhdW5jaFN1c3BlbmRlZFByb2Nlc3NXaXRoRGV2aWNlUGF0aDpidW5kbGVJZGVudGlmaWVyOmVudmlyb25tZW50OmFyZ3VtZW50czpvcHRpb25zOicsICcnLFxuICAgICAgICBidW5kbGVJRCwge30sIFtdLCB7J1N0YXJ0U3VzcGVuZGVkS2V5JzogMCwgJ0tpbGxFeGlzdGluZyc6IDF9XG4gICAqL1xuICBhc3luYyBjYWxsQ2hhbm5lbCAoY2hhbm5lbCwgc2VsZWN0b3IsIC4uLmF1eGlsaWFyaWVzKSB7XG4gICAgY29uc3QgY2hhbm5lbENvZGUgPSBhd2FpdCB0aGlzLm1ha2VDaGFubmVsKGNoYW5uZWwpO1xuICAgIHJldHVybiBhd2FpdCB0aGlzLl9jYWxsQ2hhbm5lbCh0cnVlLCBjaGFubmVsQ29kZSwgc2VsZWN0b3IsIC4uLmF1eGlsaWFyaWVzKTtcbiAgfVxuXG4gIGFzeW5jIF9jYWxsQ2hhbm5lbCAoc3luYywgY2hhbm5lbENvZGUsIHNlbGVjdG9yLCAuLi5hdXhpbGlhcmllcykge1xuICAgIGNvbnN0IGlkZW50aWZpZXIgPSB0aGlzLl9uZXh0SWRlbnRpZmllcjtcbiAgICB0aGlzLl9lbmNvZGVyLndyaXRlKHtzeW5jLCBjaGFubmVsQ29kZSwgc2VsZWN0b3IsIGF1eGlsaWFyaWVzLCBpZGVudGlmaWVyfSk7XG4gICAgKyt0aGlzLl9uZXh0SWRlbnRpZmllcjtcbiAgICBpZiAoc3luYykge1xuICAgICAgdHJ5IHtcbiAgICAgICAgcmV0dXJuIGF3YWl0IHdhaXRGb3JDb25kaXRpb24oKCkgPT4ge1xuICAgICAgICAgIGNvbnN0IHF1ZXVlID0gdGhpcy5fcmVwbHlRdWV1ZXNbaWRlbnRpZmllcl07XG4gICAgICAgICAgY29uc3QgZGF0YSA9IHF1ZXVlLnNoaWZ0KCk7XG4gICAgICAgICAgaWYgKCFfLmlzVW5kZWZpbmVkKGRhdGEpKSB7XG4gICAgICAgICAgICByZXR1cm4gZGF0YTtcbiAgICAgICAgICB9XG4gICAgICAgIH0sIHt3YWl0TXM6IFdBSVRfUkVQTFlfVElNRV9NUywgaW50ZXJ2YWxNczogQ0hFQ0tfRlJFUV9NUywgZXJyb3I6ICdyZXBseSBjaGFubmVsIGRhdGEgdGltZW91dCd9KTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICB0aGlzLmNsb3NlKCk7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihlcnIpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBIYW5kbGluZyByZWdpc3RlcmVkIGFzeW5jaHJvbm91cyBtZXNzYWdlIGNhbGxiYWNrc1xuICAgKiBAcGFyYW0ge0RUWE1lc3NhZ2V9IGRhdGFcbiAgICogQHByaXZhdGVcbiAgICovXG4gIF9oYW5kbGVEYXRhIChkYXRhKSB7XG4gICAgaWYgKF8uaW5jbHVkZXMoZGF0YS5zZWxlY3RvciwgQ0hBTk5FTF9DQU5DRUxFRCkpIHtcbiAgICAgIHRoaXMuY2xvc2UoKTtcbiAgICB9XG4gICAgaWYgKGRhdGEuY29udmVyc2F0aW9uSW5kZXggPT09IDEpIHtcbiAgICAgIHRoaXMuX3JlcGx5UXVldWVzW2RhdGEuaWRlbnRpZmllcl0ucHVzaChkYXRhKTtcbiAgICB9IGVsc2UgaWYgKHRoaXMuX2NoYW5uZWxDYWxsYmFja3MubGlzdGVuZXJDb3VudChDSEFOTkVMX09GRlNFVCAtIGRhdGEuY2hhbm5lbENvZGUpID4gMCkge1xuICAgICAgdGhpcy5fY2hhbm5lbENhbGxiYWNrcy5lbWl0KENIQU5ORUxfT0ZGU0VUIC0gZGF0YS5jaGFubmVsQ29kZSwgZGF0YSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnN0IHNlbGVjdG9yID0gZGF0YS5zZWxlY3RvcjtcbiAgICAgIGlmIChfLmlzU3RyaW5nKHNlbGVjdG9yKSAmJiB0aGlzLl9jYWxsYmFja3MubGlzdGVuZXJDb3VudChzZWxlY3RvcikgPiAwKSB7XG4gICAgICAgIHRoaXMuX2NhbGxiYWNrcy5lbWl0KHNlbGVjdG9yLCBkYXRhKTtcbiAgICAgIH0gZWxzZSBpZiAodGhpcy5fdW5kZWZpbmVkQ2FsbGJhY2spIHtcbiAgICAgICAgdGhpcy5fdW5kZWZpbmVkQ2FsbGJhY2soZGF0YSk7XG4gICAgICB9XG4gICAgICBpZiAoZGF0YS5leHBlY3RzUmVwbHkpIHtcbiAgICAgICAgdGhpcy5fcmVwbHlBY2soZGF0YSk7XG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIHJldHVybiBhIGVtcHR5IGFjayBtZXNzYWdlXG4gICAqIEBwYXJhbSB7RFRYTWVzc2FnZX0gZGF0YVxuICAgKi9cbiAgX3JlcGx5QWNrIChkYXRhKSB7XG4gICAgY29uc3QgcmVwbHkgPSBuZXcgRFRYTWVzc2FnZSh7XG4gICAgICBpZGVudGlmaWVyOiBkYXRhLmlkZW50aWZpZXIsXG4gICAgICBjaGFubmVsQ29kZTogZGF0YS5jaGFubmVsQ29kZSxcbiAgICAgIHNlbGVjdG9yOiBCdWZmZXIuYWxsb2MoRU1QVFlfTUVTU0FHRV9TSVpFKSxcbiAgICAgIGNvbnZlcnNhdGlvbkluZGV4OiBkYXRhLmNvbnZlcnNhdGlvbkluZGV4ICsgMSxcbiAgICAgIGZsYWdzOiBGTEFHX1RZUEVTLnJlcGx5XG4gICAgfSk7XG4gICAgdGhpcy5fc29ja2V0Q2xpZW50LndyaXRlKHJlcGx5LmJ1aWxkKCkpO1xuICB9XG59XG5cbmV4cG9ydCB7IEluc3RydW1lbnRTZXJ2aWNlLCBJTlNUUlVNRU5UX1NFUlZJQ0VfTkFNRV9WRVJTSU9OXzE0LCBJTlNUUlVNRU5UX1NFUlZJQ0VfTkFNRSB9O1xuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUVBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLE1BQU1BLGFBQWEsR0FBRyxHQUF0QjtBQUNBLE1BQU1DLGtCQUFrQixHQUFHLEtBQTNCO0FBQ0EsTUFBTUMsa0JBQWtCLEdBQUcsRUFBM0I7QUFDQSxNQUFNQyxnQkFBZ0IsR0FBRyxrQkFBekI7QUFDQSxNQUFNQyxjQUFjLEdBQUcsS0FBSyxFQUE1QjtBQUVBLE1BQU1DLGtDQUFrQyxHQUFHLHlEQUEzQzs7QUFDQSxNQUFNQyx1QkFBdUIsR0FBRyxvQ0FBaEM7O0FBRU8sTUFBTUMsa0JBQWtCLEdBQUdDLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjO0VBQzlDQyxXQUFXLEVBQUUsa0RBRGlDO0VBRTlDQyxlQUFlLEVBQUUs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
