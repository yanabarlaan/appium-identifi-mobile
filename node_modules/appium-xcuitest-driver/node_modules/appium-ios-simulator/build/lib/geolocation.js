"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.setLocationWithAppleScript = setLocationWithAppleScript;
exports.setLocationWithIdb = setLocationWithIdb;
exports.setLocationWithLyft = setLocationWithLyft;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("./logger"));

var _teen_process = require("teen_process");

var _support = require("@appium/support");

const LYFT_SET_LOCATION = 'set-simulator-location';

async function setLocationWithLyft(udid, latitude, longitude) {
  try {
    await _support.fs.which(LYFT_SET_LOCATION);
  } catch (e) {
    throw new Error(`'${LYFT_SET_LOCATION}' binary has not been found in your PATH. ` + 'Please install it as "brew install lyft/formulae/set-simulator-location" by brew or ' + 'read https://github.com/lyft/set-simulator-location to set the binary by manual to ' + 'be able to set geolocation by the library.');
  }

  try {
    await (0, _teen_process.exec)(LYFT_SET_LOCATION, ['-c', latitude, longitude, '-u', udid]);
  } catch (e) {
    throw new Error(`Failed to set geolocation with '${LYFT_SET_LOCATION}'. ` + `Original error: ${e.stderr || e.message}`);
  }
}

async function setLocationWithIdb(idb, latitude, longitude) {
  if (!idb) {
    throw new Error('Failed to set geolocation with idb because it is not installed or the "launchWithIDB" capability was not set');
  }

  try {
    await idb.setLocation(latitude, longitude);
  } catch (e) {
    throw new Error(`Failed to set geolocation with idb. Original error: ${e.stderr || e.message}`);
  }
}

async function setLocationWithAppleScript(sim, latitude, longitude, menu = 'Debug') {
  const decimalSeparator = (await (0, _teen_process.exec)('/usr/bin/python', ['-c', 'from AppKit import NSNumberFormatter;' + 'import sys;' + 'sys.stdout.write(NSNumberFormatter.alloc().init().decimalSeparator())'])).stdout;
  const [latitudeStr, longitudeStr] = [latitude, longitude].map(coord => `${coord}`.replace(/[.,]/, decimalSeparator));
  const output = await sim.executeUIClientScript(`
    tell application "System Events"
      tell process "Simulator"
        set featureName to "Custom Location"
        set dstMenuItem to menu item (featureName & "â€¦") of menu 1 of menu item "Location" of menu 1 of menu bar item "${menu}" of menu bar 1
        click dstMenuItem
        delay 1
        set value of text field 1 of window featureName to "${latitudeStr}"
        delay 0.5
        set value of text field 2 of window featureName to "${longitudeStr}"
        delay 0.5
        click button "OK" of window featureName
        delay 0.5
        set isInvisible to (not (exists (window featureName)))
      end tell
    end tell
  `);

  _logger.default.debug(`Geolocation parameters dialog accepted: ${output}`);

  if (_lodash.default.trim(output) !== 'true') {
    throw new Error(`Failed to set geolocation with AppleScript. Original error: ${output}`);
  }
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGliL2dlb2xvY2F0aW9uLmpzIiwibmFtZXMiOlsiTFlGVF9TRVRfTE9DQVRJT04iLCJzZXRMb2NhdGlvbldpdGhMeWZ0IiwidWRpZCIsImxhdGl0dWRlIiwibG9uZ2l0dWRlIiwiZnMiLCJ3aGljaCIsImUiLCJFcnJvciIsImV4ZWMiLCJzdGRlcnIiLCJtZXNzYWdlIiwic2V0TG9jYXRpb25XaXRoSWRiIiwiaWRiIiwic2V0TG9jYXRpb24iLCJzZXRMb2NhdGlvbldpdGhBcHBsZVNjcmlwdCIsInNpbSIsIm1lbnUiLCJkZWNpbWFsU2VwYXJhdG9yIiwic3Rkb3V0IiwibGF0aXR1ZGVTdHIiLCJsb25naXR1ZGVTdHIiLCJtYXAiLCJjb29yZCIsInJlcGxhY2UiLCJvdXRwdXQiLCJleGVjdXRlVUlDbGllbnRTY3JpcHQiLCJsb2ciLCJkZWJ1ZyIsIl8iLCJ0cmltIl0sInNvdXJjZVJvb3QiOiIuLi8uLiIsInNvdXJjZXMiOlsibGliL2dlb2xvY2F0aW9uLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IHsgZnMgfSBmcm9tICdAYXBwaXVtL3N1cHBvcnQnO1xuXG5jb25zdCBMWUZUX1NFVF9MT0NBVElPTiA9ICdzZXQtc2ltdWxhdG9yLWxvY2F0aW9uJztcblxuLyoqXG4gKiBTZXQgY3VzdG9tIGdlb2xvY2F0aW9uIHBhcmFtZXRlcnMgZm9yIHRoZSBnaXZlbiBTaW11bGF0b3IgdXNpbmcgTFlGVF9TRVRfTE9DQVRJT04uXG4gKlxuICogQHBhcmFtIHtzdHJpbmd9IHVkaWQgLSBUaGUgdWRpZCB0byBzZXQgdGhlIGdpdmVuIGdlb2xvY2F0aW9uXG4gKiBAcGFyYW0ge3N0cmluZ3xudW1iZXJ9IGxhdGl0dWRlIC0gVGhlIGxhdGl0dWRlIHZhbHVlLCB3aGljaCBpcyBnb2luZyB0byBiZSBlbnRlcmVkXG4gKiAgIGludG8gdGhlIGNvcnJlc3BvbmRpbmcgZWRpdCBmaWVsZCwgZm9yIGV4YW1wbGUgJzM5LDAwMDYnLlxuICogQHBhcmFtIHtzdHJpbmd8bnVtYmVyfSBsb25naXR1ZGUgLSBUaGUgbG9uZ2l0dWRlIHZhbHVlLCB3aGljaCBpcyBnb2luZyB0byBiZSBlbnRlcmVkXG4gKiAgIGludG8gdGhlIGNvcnJlc3BvbmRpbmcgZWRpdCBmaWVsZCwgZm9yIGV4YW1wbGUgJzE5LDAwNjgnLlxuICogQHRocm93cyB7RXJyb3J9IElmIGl0IGZhaWxlZCB0byBzZXQgdGhlIGxvY2F0aW9uXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIHNldExvY2F0aW9uV2l0aEx5ZnQgKHVkaWQsIGxhdGl0dWRlLCBsb25naXR1ZGUpIHtcbiAgdHJ5IHtcbiAgICBhd2FpdCBmcy53aGljaChMWUZUX1NFVF9MT0NBVElPTik7XG4gIH0gY2F0Y2ggKGUpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYCcke0xZRlRfU0VUX0xPQ0FUSU9OfScgYmluYXJ5IGhhcyBub3QgYmVlbiBmb3VuZCBpbiB5b3VyIFBBVEguIGAgK1xuICAgICAgJ1BsZWFzZSBpbnN0YWxsIGl0IGFzIFwiYnJldyBpbnN0YWxsIGx5ZnQvZm9ybXVsYWUvc2V0LXNpbXVsYXRvci1sb2NhdGlvblwiIGJ5IGJyZXcgb3IgJyArXG4gICAgICAncmVhZCBodHRwczovL2dpdGh1Yi5jb20vbHlmdC9zZXQtc2ltdWxhdG9yLWxvY2F0aW9uIHRvIHNldCB0aGUgYmluYXJ5IGJ5IG1hbnVhbCB0byAnICtcbiAgICAgICdiZSBhYmxlIHRvIHNldCBnZW9sb2NhdGlvbiBieSB0aGUgbGlicmFyeS4nKTtcbiAgfVxuXG4gIHRyeSB7XG4gICAgYXdhaXQgZXhlYyhMWUZUX1NFVF9MT0NBVElPTiwgW1xuICAgICAgJy1jJywgbGF0aXR1ZGUsIGxvbmdpdHVkZSxcbiAgICAgICctdScsIHVkaWRcbiAgICBdKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIHNldCBnZW9sb2NhdGlvbiB3aXRoICcke0xZRlRfU0VUX0xPQ0FUSU9OfScuIGAgK1xuICAgICAgYE9yaWdpbmFsIGVycm9yOiAke2Uuc3RkZXJyIHx8IGUubWVzc2FnZX1gKTtcbiAgfVxufVxuXG4vKipcbiAqIFNldCBjdXN0b20gZ2VvbG9jYXRpb24gcGFyYW1ldGVycyBmb3IgdGhlIGdpdmVuIFNpbXVsYXRvciB1c2luZyBpZGIuXG4gKlxuICogQHBhcmFtIHtPYmplY3R9IGlkYiAtIFRoZSBJREIgaW5zdGFuY2VcbiAqIEBwYXJhbSB7c3RyaW5nfG51bWJlcn0gbGF0aXR1ZGUgLSBUaGUgbGF0aXR1ZGUgdmFsdWUsIHdoaWNoIGlzIGdvaW5nIHRvIGJlIGVudGVyZWRcbiAqICAgaW50byB0aGUgY29ycmVzcG9uZGluZyBlZGl0IGZpZWxkLCBmb3IgZXhhbXBsZSAnMzksMDAwNicuXG4gKiBAcGFyYW0ge3N0cmluZ3xudW1iZXJ9IGxvbmdpdHVkZSAtIFRoZSBsb25naXR1ZGUgdmFsdWUsIHdoaWNoIGlzIGdvaW5nIHRvIGJlIGVudGVyZWRcbiAqICAgaW50byB0aGUgY29ycmVzcG9uZGluZyBlZGl0IGZpZWxkLCBmb3IgZXhhbXBsZSAnMTksMDA2OCcuXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgaXQgZmFpbGVkIHRvIHNldCB0aGUgbG9jYXRpb25cbiAqL1xuYXN5bmMgZnVuY3Rpb24gc2V0TG9jYXRpb25XaXRoSWRiIChpZGIsIGxhdGl0dWRlLCBsb25naXR1ZGUpIHtcbiAgaWYgKCFpZGIpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byBzZXQgZ2VvbG9jYXRpb24gd2l0aCBpZGIgYmVjYXVzZSBpdCBpcyBub3QgaW5zdGFsbGVkIG9yIHRoZSBcImxhdW5jaFdpdGhJREJcIiBjYXBhYmlsaXR5IHdhcyBub3Qgc2V0Jyk7XG4gIH1cblxuICB0cnkge1xuICAgIGF3YWl0IGlkYi5zZXRMb2NhdGlvbihsYXRpdHVkZSwgbG9uZ2l0dWRlKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIHNldCBnZW9sb2NhdGlvbiB3aXRoIGlkYi4gT3JpZ2luYWwgZXJyb3I6ICR7ZS5zdGRlcnIgfHwgZS5tZXNzYWdlfWApO1xuICB9XG59XG5cblxuLyoqXG4gKiBTZXQgY3VzdG9tIGdlb2xvY2F0aW9uIHBhcmFtZXRlcnMgZm9yIHRoZSBnaXZlbiBTaW11bGF0b3IgdXNpbmcgQXBwbGVTY3JpcHRcbiAqXG4gKiBAcGFyYW0ge09iamVjdH0gc2ltIC0gVGhlIFNpbXVsYXRvclhjb2RlIG9iamVjdFxuICogQHBhcmFtIHtzdHJpbmd8bnVtYmVyfSBsYXRpdHVkZSAtIFRoZSBsYXRpdHVkZSB2YWx1ZSwgd2hpY2ggaXMgZ29pbmcgdG8gYmUgZW50ZXJlZFxuICogICBpbnRvIHRoZSBjb3JyZXNwb25kaW5nIGVkaXQgZmllbGQsIGZvciBleGFtcGxlICczOSwwMDA2Jy5cbiAqIEBwYXJhbSB7c3RyaW5nfG51bWJlcn0gbG9uZ2l0dWRlIC0gVGhlIGxvbmdpdHVkZSB2YWx1ZSwgd2hpY2ggaXMgZ29pbmcgdG8gYmUgZW50ZXJlZFxuICogICBpbnRvIHRoZSBjb3JyZXNwb25kaW5nIGVkaXQgZmllbGQsIGZvciBleGFtcGxlICcxOSwwMDY4Jy5cbiAqIEBwYXJhbSB7c3RyaW5nfSBbbWVudT1EZWJ1Z10gLSBUaGUgbWVudSBmaWVsZCBpbiB3aGljaCB0aGUgJ0xvY2F0aW9uJyBmZWF0dXJlIGlzIGZvdW5kXG4gKiBAdGhyb3dzIHtFcnJvcn0gSWYgaXQgZmFpbGVkIHRvIHNldCB0aGUgbG9jYXRpb25cbiAqL1xuYXN5bmMgZnVuY3Rpb24gc2V0TG9jYXRpb25XaXRoQXBwbGVTY3JpcHQgKHNpbSwgbGF0aXR1ZGUsIGxvbmdpdHVkZSwgbWVudSA9ICdEZWJ1ZycpIHtcbiAgLy8gTWFrZSBzdXJlIHN5c3RlbS13aWRlIGRlY2ltYWwgc2VwYXJhdG9yIGlzIHVzZWRcbiAgY29uc3QgZGVjaW1hbFNlcGFyYXRvciA9IChhd2FpdCBleGVjKCcvdXNyL2Jpbi9weXRob24nLCBbXG4gICAgJy1jJyxcbiAgICAnZnJvbSBBcHBLaXQgaW1wb3J0IE5TTnVtYmVyRm9ybWF0dGVyOycgK1xuICAgICdpbXBvcnQgc3lzOycgK1xuICAgICdzeXMuc3Rkb3V0LndyaXRlKE5TTnVtYmVyRm9ybWF0dGVyLmFsbG9jKCkuaW5pdCgpLmRlY2ltYWxTZXBhcmF0b3IoKSknXG4gIF0pKS5zdGRvdXQ7XG5cbiAgY29uc3QgW2xhdGl0dWRlU3RyLCBsb25naXR1ZGVTdHJdID0gW2xhdGl0dWRlLCBsb25naXR1ZGVdXG4gICAgLm1hcCgoY29vcmQpID0+IGAke2Nvb3JkfWAucmVwbGFjZSgvWy4sXS8sIGRlY2ltYWxTZXBhcmF0b3IpKTtcblxuICBjb25zdCBvdXRwdXQgPSBhd2FpdCBzaW0uZXhlY3V0ZVVJQ2xpZW50U2NyaXB0KGBcbiAgICB0ZWxsIGFwcGxpY2F0aW9uIFwiU3lzdGVtIEV2ZW50c1wiXG4gICAgICB0ZWxsIHByb2Nlc3MgXCJTaW11bGF0b3JcIlxuICAgICAgICBzZXQgZmVhdHVyZU5hbWUgdG8gXCJDdXN0b20gTG9jYXRpb25cIlxuICAgICAgICBzZXQgZHN0TWVudUl0ZW0gdG8gbWVudSBpdGVtIChmZWF0dXJlTmFtZSAmIFwi4oCmXCIpIG9mIG1lbnUgMSBvZiBtZW51IGl0ZW0gXCJMb2NhdGlvblwiIG9mIG1lbnUgMSBvZiBtZW51IGJhciBpdGVtIFwiJHttZW51fVwiIG9mIG1lbnUgYmFyIDFcbiAgICAgICAgY2xpY2sgZHN0TWVudUl0ZW1cbiAgICAgICAgZGVsYXkgMVxuICAgICAgICBzZXQgdmFsdWUgb2YgdGV4dCBmaWVsZCAxIG9mIHdpbmRvdyBmZWF0dXJlTmFtZSB0byBcIiR7bGF0aXR1ZGVTdHJ9XCJcbiAgICAgICAgZGVsYXkgMC41XG4gICAgICAgIHNldCB2YWx1ZSBvZiB0ZXh0IGZpZWxkIDIgb2Ygd2luZG93IGZlYXR1cmVOYW1lIHRvIFwiJHtsb25naXR1ZGVTdHJ9XCJcbiAgICAgICAgZGVsYXkgMC41XG4gICAgICAgIGNsaWNrIGJ1dHRvbiBcIk9LXCIgb2Ygd2luZG93IGZlYXR1cmVOYW1lXG4gICAgICAgIGRlbGF5IDAuNVxuICAgICAgICBzZXQgaXNJbnZpc2libGUgdG8gKG5vdCAoZXhpc3RzICh3aW5kb3cgZmVhdHVyZU5hbWUpKSlcbiAgICAgIGVuZCB0ZWxsXG4gICAgZW5kIHRlbGxcbiAgYCk7XG4gIGxvZy5kZWJ1ZyhgR2VvbG9jYXRpb24gcGFyYW1ldGVycyBkaWFsb2cgYWNjZXB0ZWQ6ICR7b3V0cHV0fWApO1xuICBpZiAoXy50cmltKG91dHB1dCkgIT09ICd0cnVlJykge1xuICAgIHRocm93IG5ldyBFcnJvcihgRmFpbGVkIHRvIHNldCBnZW9sb2NhdGlvbiB3aXRoIEFwcGxlU2NyaXB0LiBPcmlnaW5hbCBlcnJvcjogJHtvdXRwdXR9YCk7XG4gIH1cbn1cblxuZXhwb3J0IHtcbiAgc2V0TG9jYXRpb25XaXRoTHlmdCwgc2V0TG9jYXRpb25XaXRoSWRiLCBzZXRMb2NhdGlvbldpdGhBcHBsZVNjcmlwdFxufTtcbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUVBLE1BQU1BLGlCQUFpQixHQUFHLHdCQUExQjs7QUFZQSxlQUFlQyxtQkFBZixDQUFvQ0MsSUFBcEMsRUFBMENDLFFBQTFDLEVBQW9EQyxTQUFwRCxFQUErRDtFQUM3RCxJQUFJO0lBQ0YsTUFBTUMsV0FBQSxDQUFHQyxLQUFILENBQVNOLGlCQUFULENBQU47RUFDRCxDQUZELENBRUUsT0FBT08sQ0FBUCxFQUFVO0lBQ1YsTUFBTSxJQUFJQyxLQUFKLENBQVcsSUFBR1IsaUJBQWtCLDRDQUF0QixHQUNkLHNGQURjLEdBRWQscUZBRmMsR0FHZCw0Q0FISSxDQUFOO0VBSUQ7O0VBRUQsSUFBSTtJQUNGLE1BQU0sSUFBQVMsa0JBQUEsRUFBS1QsaUJBQUwsRUFBd0IsQ0FDNUIsSUFENEIsRUFDdEJHLFFBRHNCLEVBQ1pDLFNBRFksRUFFNUIsSUFGNEIsRUFFdEJGLElBRnNCLENBQXhCLENBQU47RUFJRCxDQUxELENBS0UsT0FBT0ssQ0FBUCxFQUFVO0lBQ1YsTUFBTSxJQUFJQyxLQUFKLENBQVcsbUNBQWtDUixpQkFBa0IsS0FBckQsR0FDYixtQkFBa0JPLENBQUMsQ0FBQ0csTUFBRixJQUFZSCxDQUFDLENBQUNJLE9BQVEsRUFEckMsQ0FBTjtFQUVEO0FBQ0Y7O0FBWUQsZUFBZUMsa0JBQWYsQ0FBbUNDLEdBQW5DLEVBQXdDVixRQUF4QyxFQUFrREMsU0FBbEQsRUFBNkQ7RUFDM0QsSUFBSSxDQUFDUyxHQUFMLEVBQVU7SUFDUixNQUFNLElBQUlMLEtBQUosQ0FBVSw4R0FBVixDQUFOO0VBQ0Q7O0VBRUQsSUFBSTtJQUNGLE1BQU1LLEdBQUcsQ0FBQ0MsV0FBSixDQUFnQlgsUUFBaEIsRUFBMEJDLFNBQTFCLENBQU47RUFDRCxDQUZELENBRUUsT0FBT0csQ0FBUCxFQUFVO0lBQ1YsTUFBTSxJQUFJQyxLQUFKLENBQVcsdURBQXNERCxDQUFDLENBQUNHLE1BQUYsSUFBWUgsQ0FBQyxDQUFDSSxPQUFRLEVBQXZGLENBQU47RUFDRDtBQUNGOztBQWNELGVBQWVJLDBCQUFmLENBQTJDQyxHQUEzQyxFQUFnRGIsUUFBaEQsRUFBMERDLFNBQTFELEVBQXFFYSxJQUFJLEdBQUcsT0FBNUUsRUFBcUY7RUFFbkYsTUFBTUMsZ0JBQWdCLEdBQUcsQ0FBQyxNQUFNLElBQUFULGtCQUFBLEVBQUssaUJBQUwsRUFBd0IsQ0FDdEQsSUFEc0QsRUFFdEQsMENBQ0EsYUFEQSxHQUVBLHVFQUpzRCxDQUF4QixDQUFQLEVBS3JCVSxNQUxKO0VBT0EsTUFBTSxDQUFDQyxXQUFELEVBQWNDLFlBQWQsSUFBOEIsQ0FBQ2xCLFFBQUQsRUFBV0MsU0FBWCxFQUNqQ2tCLEdBRGlDLENBQzVCQyxLQUFELElBQVksR0FBRUEsS0FBTSxFQUFULENBQVdDLE9BQVgsQ0FBbUIsTUFBbkIsRUFBMkJOLGdCQUEzQixDQURrQixDQUFwQztFQUdBLE1BQU1PLE1BQU0sR0FBRyxNQUFNVCxHQUFHLENBQUNVLHFCQUFKLENBQTJCO0FBQ2xEO0FBQ0E7QUFDQTtBQUNBLHlIQUF5SFQsSUFBSztBQUM5SDtBQUNBO0FBQ0EsOERBQThERyxXQUFZO0FBQzFFO0FBQ0EsOERBQThEQyxZQUFhO0FBQzNFO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLEdBaEJ1QixDQUFyQjs7RUFpQkFNLGVBQUEsQ0FBSUMsS0FBSixDQUFXLDJDQUEwQ0gsTUFBTyxFQUE1RDs7RUFDQSxJQUFJSSxlQUFBLENBQUVDLElBQUYsQ0FBT0wsTUFBUCxNQUFtQixNQUF2QixFQUErQjtJQUM3QixNQUFNLElBQUlqQixLQUFKLENBQVcsK0RBQThEaUIsTUFBTyxFQUFoRixDQUFOO0VBQ0Q7QUFDRiJ9
