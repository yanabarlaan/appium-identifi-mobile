"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.downloadFile = downloadFile;
exports.uploadFile = uploadFile;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _fs = _interopRequireDefault(require("./fs"));

var _bluebird = _interopRequireDefault(require("bluebird"));

var _util = require("./util");

var _logger = _interopRequireDefault(require("./logger"));

var _jsftp = _interopRequireDefault(require("jsftp"));

var _timing = _interopRequireDefault(require("./timing"));

var _axios = _interopRequireDefault(require("axios"));

var _formData = _interopRequireDefault(require("form-data"));

const DEFAULT_TIMEOUT_MS = 4 * 60 * 1000;

function toAxiosAuth(auth) {
  if (!_lodash.default.isPlainObject(auth)) {
    return null;
  }

  const axiosAuth = {
    username: _lodash.default.get(auth, 'username', _lodash.default.get(auth, 'user')),
    password: _lodash.default.get(auth, 'password', _lodash.default.get(auth, 'pass'))
  };
  return axiosAuth.username && axiosAuth.password ? axiosAuth : null;
}

async function uploadFileToHttp(localFileStream, parsedUri, uploadOptions = {}) {
  const {
    method = 'POST',
    timeout = DEFAULT_TIMEOUT_MS,
    headers,
    auth,
    fileFieldName = 'file',
    formFields
  } = uploadOptions;
  const {
    href
  } = parsedUri;
  const requestOpts = {
    url: href,
    method,
    timeout,
    maxContentLength: Infinity,
    maxBodyLength: Infinity
  };
  const axiosAuth = toAxiosAuth(auth);

  if (axiosAuth) {
    requestOpts.auth = axiosAuth;
  }

  if (fileFieldName) {
    const form = new _formData.default();
    form.append(fileFieldName, localFileStream);

    if (formFields) {
      let pairs = [];

      if (_lodash.default.isArray(formFields)) {
        pairs = formFields;
      } else if (_lodash.default.isPlainObject(formFields)) {
        pairs = _lodash.default.toPairs(formFields);
      }

      for (const [key, value] of pairs) {
        if (_lodash.default.toLower(key) !== _lodash.default.toLower(fileFieldName)) {
          form.append(key, value);
        }
      }
    }

    requestOpts.headers = { ...(_lodash.default.isPlainObject(headers) ? headers : {}),
      ...form.getHeaders()
    };
    requestOpts.data = form;
  } else {
    if (_lodash.default.isPlainObject(headers)) {
      requestOpts.headers = headers;
    }

    requestOpts.data = localFileStream;
  }

  _logger.default.debug(`Performing ${method} to ${href} with options (excluding data): ` + JSON.stringify(_lodash.default.omit(requestOpts, ['data'])));

  const {
    status,
    statusText
  } = await (0, _axios.default)(requestOpts);

  _logger.default.info(`Server response: ${status} ${statusText}`);
}

async function uploadFileToFtp(localFileStream, parsedUri, uploadOptions = {}) {
  const {
    auth
  } = uploadOptions;
  const {
    hostname,
    port,
    protocol,
    pathname
  } = parsedUri;
  const ftpOpts = {
    host: hostname,
    port: !_lodash.default.isUndefined(port) ? _lodash.default.parseInt(port) : 21
  };

  if (auth !== null && auth !== void 0 && auth.user && auth !== null && auth !== void 0 && auth.pass) {
    ftpOpts.user = auth.user;
    ftpOpts.pass = auth.pass;
  }

  _logger.default.debug(`${protocol} upload options: ${JSON.stringify(ftpOpts)}`);

  return await new _bluebird.default((resolve, reject) => {
    new _jsftp.default(ftpOpts).put(localFileStream, pathname, err => {
      if (err) {
        reject(err);
      } else {
        resolve();
      }
    });
  });
}

function isHttpUploadOptions(opts, url) {
  try {
    const {
      protocol
    } = new URL(url);
    return protocol === 'http:' || protocol === 'https:';
  } catch {
    return false;
  }
}

function isNotHttpUploadOptions(opts, url) {
  try {
    const {
      protocol
    } = new URL(url);
    return protocol === 'ftp:';
  } catch {
    return false;
  }
}

async function uploadFile(localPath, remoteUri, uploadOptions = {}) {
  if (!(await _fs.default.exists(localPath))) {
    throw new Error(`'${localPath}' does not exists or is not accessible`);
  }

  const {
    isMetered = true
  } = uploadOptions;
  const url = new URL(remoteUri);
  const {
    size
  } = await _fs.default.stat(localPath);

  if (isMetered) {
    _logger.default.info(`Uploading '${localPath}' of ${(0, _util.toReadableSizeString)(size)} size to '${remoteUri}'`);
  }

  const timer = new _timing.default().start();

  if (isHttpUploadOptions(uploadOptions, url)) {
    if (!uploadOptions.fileFieldName) {
      uploadOptions.headers = { ...(_lodash.default.isPlainObject(uploadOptions.headers) ? uploadOptions.headers : {}),
        'Content-Length': size
      };
    }

    await uploadFileToHttp(_fs.default.createReadStream(localPath), url, uploadOptions);
  } else if (isNotHttpUploadOptions(uploadOptions, url)) {
    await uploadFileToFtp(_fs.default.createReadStream(localPath), url, uploadOptions);
  } else {
    throw new Error(`Cannot upload the file at '${localPath}' to '${remoteUri}'. ` + `Unsupported remote protocol '${url.protocol}'. ` + `Only http/https and ftp/ftps protocols are supported.`);
  }

  if (isMetered) {
    _logger.default.info(`Uploaded '${localPath}' of ${(0, _util.toReadableSizeString)(size)} size in ` + `${timer.getDuration().asSeconds.toFixed(3)}s`);
  }
}

async function downloadFile(remoteUrl, dstPath, downloadOptions = {}) {
  const {
    isMetered = true,
    auth,
    timeout = DEFAULT_TIMEOUT_MS,
    headers
  } = downloadOptions;
  const requestOpts = {
    url: remoteUrl,
    responseType: 'stream',
    timeout
  };
  const axiosAuth = toAxiosAuth(auth);

  if (axiosAuth) {
    requestOpts.auth = axiosAuth;
  }

  if (_lodash.default.isPlainObject(headers)) {
    requestOpts.headers = headers;
  }

  const timer = new _timing.default().start();
  let responseLength;

  try {
    const writer = _fs.default.createWriteStream(dstPath);

    const {
      data: responseStream,
      headers: responseHeaders
    } = await (0, _axios.default)(requestOpts);
    responseLength = parseInt(responseHeaders['content-length'], 10);
    responseStream.pipe(writer);
    await new _bluebird.default((resolve, reject) => {
      responseStream.once('error', reject);
      writer.once('finish', resolve);
      writer.once('error', e => {
        responseStream.unpipe(writer);
        reject(e);
      });
    });
  } catch (err) {
    throw new Error(`Cannot download the file from ${remoteUrl}: ${err.message}`);
  }

  const {
    size
  } = await _fs.default.stat(dstPath);

  if (responseLength && size !== responseLength) {
    await _fs.default.rimraf(dstPath);
    throw new Error(`The size of the file downloaded from ${remoteUrl} (${size} bytes) ` + `differs from the one in Content-Length response header (${responseLength} bytes)`);
  }

  if (isMetered) {
    const secondsElapsed = timer.getDuration().asSeconds;

    _logger.default.debug(`${remoteUrl} (${(0, _util.toReadableSizeString)(size)}) ` + `has been downloaded to '${dstPath}' in ${secondsElapsed.toFixed(3)}s`);

    if (secondsElapsed >= 2) {
      const bytesPerSec = Math.floor(size / secondsElapsed);

      _logger.default.debug(`Approximate download speed: ${(0, _util.toReadableSizeString)(bytesPerSec)}/s`);
    }
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJERUZBVUxUX1RJTUVPVVRfTVMiLCJ0b0F4aW9zQXV0aCIsImF1dGgiLCJfIiwiaXNQbGFpbk9iamVjdCIsImF4aW9zQXV0aCIsInVzZXJuYW1lIiwiZ2V0IiwicGFzc3dvcmQiLCJ1cGxvYWRGaWxlVG9IdHRwIiwibG9jYWxGaWxlU3RyZWFtIiwicGFyc2VkVXJpIiwidXBsb2FkT3B0aW9ucyIsIm1ldGhvZCIsInRpbWVvdXQiLCJoZWFkZXJzIiwiZmlsZUZpZWxkTmFtZSIsImZvcm1GaWVsZHMiLCJocmVmIiwicmVxdWVzdE9wdHMiLCJ1cmwiLCJtYXhDb250ZW50TGVuZ3RoIiwiSW5maW5pdHkiLCJtYXhCb2R5TGVuZ3RoIiwiZm9ybSIsIkZvcm1EYXRhIiwiYXBwZW5kIiwicGFpcnMiLCJpc0FycmF5IiwidG9QYWlycyIsImtleSIsInZhbHVlIiwidG9Mb3dlciIsImdldEhlYWRlcnMiLCJkYXRhIiwibG9nIiwiZGVidWciLCJKU09OIiwic3RyaW5naWZ5Iiwib21pdCIsInN0YXR1cyIsInN0YXR1c1RleHQiLCJpbmZvIiwidXBsb2FkRmlsZVRvRnRwIiwiaG9zdG5hbWUiLCJwb3J0IiwicHJvdG9jb2wiLCJwYXRobmFtZSIsImZ0cE9wdHMiLCJob3N0IiwiaXNVbmRlZmluZWQiLCJwYXJzZUludCIsInVzZXIiLCJwYXNzIiwiQiIsInJlc29sdmUiLCJyZWplY3QiLCJGdHAiLCJwdXQiLCJlcnIiLCJpc0h0dHBVcGxvYWRPcHRpb25zIiwib3B0cyIsIlVSTCIsImlzTm90SHR0cFVwbG9hZE9wdGlvbnMiLCJ1cGxvYWRGaWxlIiwibG9jYWxQYXRoIiwicmVtb3RlVXJpIiwiZnMiLCJleGlzdHMiLCJFcnJvciIsImlzTWV0ZXJlZCIsInNpemUiLCJzdGF0IiwidGltZXIiLCJUaW1lciIsInN0YXJ0IiwiY3JlYXRlUmVhZFN0cmVhbSIsImdldER1cmF0aW9uIiwiYXNTZWNvbmRzIiwidG9GaXhlZCIsImRvd25sb2FkRmlsZSIsInJlbW90ZVVybCIsImRzdFBhdGgiLCJkb3dubG9hZE9wdGlvbnMiLCJyZXNwb25zZVR5cGUiLCJyZXNwb25zZUxlbmd0aCIsIndyaXRlciIsImNyZWF0ZVdyaXRlU3RyZWFtIiwicmVzcG9uc2VTdHJlYW0iLCJyZXNwb25zZUhlYWRlcnMiLCJwaXBlIiwib25jZSIsImUiLCJ1bnBpcGUiLCJtZXNzYWdlIiwicmltcmFmIiwic2Vjb25kc0VsYXBzZWQiLCJieXRlc1BlclNlYyIsIk1hdGgiLCJmbG9vciJdLCJzb3VyY2VzIjpbIi4uLy4uL2xpYi9uZXQuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBmcyBmcm9tICcuL2ZzJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcbmltcG9ydCB7IHRvUmVhZGFibGVTaXplU3RyaW5nIH0gZnJvbSAnLi91dGlsJztcbmltcG9ydCBsb2cgZnJvbSAnLi9sb2dnZXInO1xuaW1wb3J0IEZ0cCBmcm9tICdqc2Z0cCc7XG5pbXBvcnQgVGltZXIgZnJvbSAnLi90aW1pbmcnO1xuaW1wb3J0IGF4aW9zIGZyb20gJ2F4aW9zJztcbmltcG9ydCBGb3JtRGF0YSBmcm9tICdmb3JtLWRhdGEnO1xuXG5jb25zdCBERUZBVUxUX1RJTUVPVVRfTVMgPSA0ICogNjAgKiAxMDAwO1xuXG4vKipcbiAqIENvbnZlcnRzIHtAbGlua2NvZGUgQXV0aENyZWRlbnRpYWxzfSB0byBjcmVkZW50aWFscyB1bmRlcnN0b29kIGJ5IHtAbGlua2NvZGUgYXhpb3N9LlxuICogQHBhcmFtIHtBdXRoQ3JlZGVudGlhbHMgfCBpbXBvcnQoJ2F4aW9zJykuQXhpb3NCYXNpY0NyZWRlbnRpYWxzfSBhdXRoXG4gKiBAcmV0dXJucyB7aW1wb3J0KCdheGlvcycpLkF4aW9zQmFzaWNDcmVkZW50aWFscz99XG4gKi9cbmZ1bmN0aW9uIHRvQXhpb3NBdXRoIChhdXRoKSB7XG4gIGlmICghXy5pc1BsYWluT2JqZWN0KGF1dGgpKSB7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICBjb25zdCBheGlvc0F1dGggPSB7XG4gICAgdXNlcm5hbWU6IF8uZ2V0KGF1dGgsICd1c2VybmFtZScsIF8uZ2V0KGF1dGgsICd1c2VyJykpLFxuICAgIHBhc3N3b3JkOiBfLmdldChhdXRoLCAncGFzc3dvcmQnLCBfLmdldChhdXRoLCAncGFzcycpKSxcbiAgfTtcbiAgcmV0dXJuIChheGlvc0F1dGgudXNlcm5hbWUgJiYgYXhpb3NBdXRoLnBhc3N3b3JkKSA/IGF4aW9zQXV0aCA6IG51bGw7XG59XG5cbi8qKlxuICogQHBhcmFtIHtOb2RlSlMuUmVhZGFibGVTdHJlYW19IGxvY2FsRmlsZVN0cmVhbVxuICogQHBhcmFtIHtVUkx9IHBhcnNlZFVyaVxuICogQHBhcmFtIHtIdHRwVXBsb2FkT3B0aW9ucyAmIE5ldE9wdGlvbnN9IFt1cGxvYWRPcHRpb25zXVxuICovXG5hc3luYyBmdW5jdGlvbiB1cGxvYWRGaWxlVG9IdHRwIChsb2NhbEZpbGVTdHJlYW0sIHBhcnNlZFVyaSwgdXBsb2FkT3B0aW9ucyA9IC8qKiBAdHlwZSB7SHR0cFVwbG9hZE9wdGlvbnMgJiBOZXRPcHRpb25zfSAqLyh7fSkpIHtcbiAgY29uc3Qge1xuICAgIG1ldGhvZCA9ICdQT1NUJyxcbiAgICB0aW1lb3V0ID0gREVGQVVMVF9USU1FT1VUX01TLFxuICAgIGhlYWRlcnMsXG4gICAgYXV0aCxcbiAgICBmaWxlRmllbGROYW1lID0gJ2ZpbGUnLFxuICAgIGZvcm1GaWVsZHMsXG4gIH0gPSB1cGxvYWRPcHRpb25zO1xuICBjb25zdCB7IGhyZWYgfSA9IHBhcnNlZFVyaTtcblxuICAvKiogQHR5cGUge2ltcG9ydCgnYXhpb3MnKS5BeGlvc1JlcXVlc3RDb25maWd9ICovXG4gIGNvbnN0IHJlcXVlc3RPcHRzID0ge1xuICAgIHVybDogaHJlZixcbiAgICBtZXRob2QsXG4gICAgdGltZW91dCxcbiAgICBtYXhDb250ZW50TGVuZ3RoOiBJbmZpbml0eSxcbiAgICBtYXhCb2R5TGVuZ3RoOiBJbmZpbml0eSxcbiAgfTtcbiAgY29uc3QgYXhpb3NBdXRoID0gdG9BeGlvc0F1dGgoYXV0aCk7XG4gIGlmIChheGlvc0F1dGgpIHtcbiAgICByZXF1ZXN0T3B0cy5hdXRoID0gYXhpb3NBdXRoO1xuICB9XG4gIGlmIChmaWxlRmllbGROYW1lKSB7XG4gICAgY29uc3QgZm9ybSA9IG5ldyBGb3JtRGF0YSgpO1xuICAgIGZvcm0uYXBwZW5kKGZpbGVGaWVsZE5hbWUsIGxvY2FsRmlsZVN0cmVhbSk7XG4gICAgaWYgKGZvcm1GaWVsZHMpIHtcbiAgICAgIGxldCBwYWlycyA9IFtdO1xuICAgICAgaWYgKF8uaXNBcnJheShmb3JtRmllbGRzKSkge1xuICAgICAgICBwYWlycyA9IGZvcm1GaWVsZHM7XG4gICAgICB9IGVsc2UgaWYgKF8uaXNQbGFpbk9iamVjdChmb3JtRmllbGRzKSkge1xuICAgICAgICBwYWlycyA9IF8udG9QYWlycyhmb3JtRmllbGRzKTtcbiAgICAgIH1cbiAgICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIHBhaXJzKSB7XG4gICAgICAgIGlmIChfLnRvTG93ZXIoa2V5KSAhPT0gXy50b0xvd2VyKGZpbGVGaWVsZE5hbWUpKSB7XG4gICAgICAgICAgZm9ybS5hcHBlbmQoa2V5LCB2YWx1ZSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gICAgcmVxdWVzdE9wdHMuaGVhZGVycyA9IHtcbiAgICAgIC4uLihfLmlzUGxhaW5PYmplY3QoaGVhZGVycykgPyBoZWFkZXJzIDoge30pLFxuICAgICAgLi4uZm9ybS5nZXRIZWFkZXJzKClcbiAgICB9O1xuICAgIHJlcXVlc3RPcHRzLmRhdGEgPSBmb3JtO1xuICB9IGVsc2Uge1xuICAgIGlmIChfLmlzUGxhaW5PYmplY3QoaGVhZGVycykpIHtcbiAgICAgIHJlcXVlc3RPcHRzLmhlYWRlcnMgPSBoZWFkZXJzO1xuICAgIH1cbiAgICByZXF1ZXN0T3B0cy5kYXRhID0gbG9jYWxGaWxlU3RyZWFtO1xuICB9XG4gIGxvZy5kZWJ1ZyhgUGVyZm9ybWluZyAke21ldGhvZH0gdG8gJHtocmVmfSB3aXRoIG9wdGlvbnMgKGV4Y2x1ZGluZyBkYXRhKTogYCArXG4gICAgSlNPTi5zdHJpbmdpZnkoXy5vbWl0KHJlcXVlc3RPcHRzLCBbJ2RhdGEnXSkpKTtcblxuICBjb25zdCB7c3RhdHVzLCBzdGF0dXNUZXh0fSA9IGF3YWl0IGF4aW9zKHJlcXVlc3RPcHRzKTtcbiAgbG9nLmluZm8oYFNlcnZlciByZXNwb25zZTogJHtzdGF0dXN9ICR7c3RhdHVzVGV4dH1gKTtcbn1cblxuLyoqXG4gKiBAcGFyYW0ge3N0cmluZyB8IEJ1ZmZlciB8IE5vZGVKUy5SZWFkYWJsZVN0cmVhbX0gbG9jYWxGaWxlU3RyZWFtXG4gKiBAcGFyYW0ge1VSTH0gcGFyc2VkVXJpXG4gKiBAcGFyYW0ge05vdEh0dHBVcGxvYWRPcHRpb25zICYgTmV0T3B0aW9uc30gW3VwbG9hZE9wdGlvbnNdXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIHVwbG9hZEZpbGVUb0Z0cCAobG9jYWxGaWxlU3RyZWFtLCBwYXJzZWRVcmksIHVwbG9hZE9wdGlvbnMgPSAvKiogQHR5cGUge05vdEh0dHBVcGxvYWRPcHRpb25zICYgTmV0T3B0aW9uc30gKi8oe30pKSB7XG4gIGNvbnN0IHtcbiAgICBhdXRoLFxuICB9ID0gdXBsb2FkT3B0aW9ucztcbiAgY29uc3Qge1xuICAgIGhvc3RuYW1lLFxuICAgIHBvcnQsXG4gICAgcHJvdG9jb2wsXG4gICAgcGF0aG5hbWUsXG4gIH0gPSBwYXJzZWRVcmk7XG5cbiAgY29uc3QgZnRwT3B0cyA9IHtcbiAgICBob3N0OiBob3N0bmFtZSxcbiAgICBwb3J0OiAhXy5pc1VuZGVmaW5lZChwb3J0KSA/IF8ucGFyc2VJbnQocG9ydCkgOiAyMSxcbiAgfTtcbiAgaWYgKGF1dGg/LnVzZXIgJiYgYXV0aD8ucGFzcykge1xuICAgIGZ0cE9wdHMudXNlciA9IGF1dGgudXNlcjtcbiAgICBmdHBPcHRzLnBhc3MgPSBhdXRoLnBhc3M7XG4gIH1cbiAgbG9nLmRlYnVnKGAke3Byb3RvY29sfSB1cGxvYWQgb3B0aW9uczogJHtKU09OLnN0cmluZ2lmeShmdHBPcHRzKX1gKTtcbiAgcmV0dXJuIGF3YWl0IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICBuZXcgRnRwKGZ0cE9wdHMpLnB1dChsb2NhbEZpbGVTdHJlYW0sIHBhdGhuYW1lLCAoZXJyKSA9PiB7XG4gICAgICBpZiAoZXJyKSB7XG4gICAgICAgIHJlamVjdChlcnIpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVzb2x2ZSgpO1xuICAgICAgfVxuICAgIH0pO1xuICB9KTtcbn1cblxuLyoqXG4gKiBSZXR1cm5zIGB0cnVlYCBpZiBwYXJhbXMgYXJlIHZhbGlkIGZvciB7QGxpbmtjb2RlIHVwbG9hZEZpbGVUb0h0dHB9LlxuICogQHBhcmFtIHthbnl9IG9wdHNcbiAqIEBwYXJhbSB7VVJMfSB1cmxcbiAqIEByZXR1cm5zIHtvcHRzIGlzIEh0dHBVcGxvYWRPcHRpb25zICYgTmV0T3B0aW9uc31cbiAqL1xuZnVuY3Rpb24gaXNIdHRwVXBsb2FkT3B0aW9ucyAob3B0cywgdXJsKSB7XG4gIHRyeSB7XG4gICAgY29uc3Qge3Byb3RvY29sfSA9IG5ldyBVUkwodXJsKTtcbiAgICByZXR1cm4gcHJvdG9jb2wgPT09ICdodHRwOicgfHwgcHJvdG9jb2wgPT09ICdodHRwczonO1xuICB9IGNhdGNoIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbn1cblxuLyoqXG4gKiBSZXR1cm5zIGB0cnVlYCBpZiBwYXJhbXMgYXJlIHZhbGlkIGZvciB7QGxpbmtjb2RlIHVwbG9hZEZpbGVUb0Z0cH0uXG4gKiBAcGFyYW0ge2FueX0gb3B0c1xuICogQHBhcmFtIHtVUkx9IHVybFxuICogQHJldHVybnMge29wdHMgaXMgTm90SHR0cFVwbG9hZE9wdGlvbnMgJiBOZXRPcHRpb25zfVxuICovXG5mdW5jdGlvbiBpc05vdEh0dHBVcGxvYWRPcHRpb25zIChvcHRzLCB1cmwpIHtcbiAgdHJ5IHtcbiAgICBjb25zdCB7cHJvdG9jb2x9ID0gbmV3IFVSTCh1cmwpO1xuICAgIHJldHVybiBwcm90b2NvbCA9PT0gJ2Z0cDonO1xuICB9IGNhdGNoIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbn1cbi8qKlxuICogVXBsb2FkcyB0aGUgZ2l2ZW4gZmlsZSB0byBhIHJlbW90ZSBsb2NhdGlvbi4gSFRUUChTKSBhbmQgRlRQXG4gKiBwcm90b2NvbHMgYXJlIHN1cHBvcnRlZC5cbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gbG9jYWxQYXRoIC0gVGhlIHBhdGggdG8gYSBmaWxlIG9uIHRoZSBsb2NhbCBzdG9yYWdlLlxuICogQHBhcmFtIHtzdHJpbmd9IHJlbW90ZVVyaSAtIFRoZSByZW1vdGUgVVJJIHRvIHVwbG9hZCB0aGUgZmlsZSB0by5cbiAqIEBwYXJhbSB7KEh0dHBVcGxvYWRPcHRpb25zfE5vdEh0dHBVcGxvYWRPcHRpb25zKSAmIE5ldE9wdGlvbnN9IFt1cGxvYWRPcHRpb25zXVxuICogQHJldHVybnMge1Byb21pc2U8dm9pZD59XG4gKi9cbmFzeW5jIGZ1bmN0aW9uIHVwbG9hZEZpbGUgKGxvY2FsUGF0aCwgcmVtb3RlVXJpLCB1cGxvYWRPcHRpb25zID0gLyoqIEB0eXBlIHsoSHR0cFVwbG9hZE9wdGlvbnN8Tm90SHR0cFVwbG9hZE9wdGlvbnMpICYgTmV0T3B0aW9uc30gKi8oe30pKSB7XG4gIGlmICghYXdhaXQgZnMuZXhpc3RzKGxvY2FsUGF0aCkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IgKGAnJHtsb2NhbFBhdGh9JyBkb2VzIG5vdCBleGlzdHMgb3IgaXMgbm90IGFjY2Vzc2libGVgKTtcbiAgfVxuXG4gIGNvbnN0IHtcbiAgICBpc01ldGVyZWQgPSB0cnVlLFxuICB9ID0gdXBsb2FkT3B0aW9ucztcbiAgY29uc3QgdXJsID0gbmV3IFVSTChyZW1vdGVVcmkpO1xuICBjb25zdCB7c2l6ZX0gPSBhd2FpdCBmcy5zdGF0KGxvY2FsUGF0aCk7XG4gIGlmIChpc01ldGVyZWQpIHtcbiAgICBsb2cuaW5mbyhgVXBsb2FkaW5nICcke2xvY2FsUGF0aH0nIG9mICR7dG9SZWFkYWJsZVNpemVTdHJpbmcoc2l6ZSl9IHNpemUgdG8gJyR7cmVtb3RlVXJpfSdgKTtcbiAgfVxuICBjb25zdCB0aW1lciA9IG5ldyBUaW1lcigpLnN0YXJ0KCk7XG4gIGlmIChpc0h0dHBVcGxvYWRPcHRpb25zKHVwbG9hZE9wdGlvbnMsIHVybCkpIHtcbiAgICBpZiAoIXVwbG9hZE9wdGlvbnMuZmlsZUZpZWxkTmFtZSkge1xuICAgICAgdXBsb2FkT3B0aW9ucy5oZWFkZXJzID0ge1xuICAgICAgICAuLi4oXy5pc1BsYWluT2JqZWN0KHVwbG9hZE9wdGlvbnMuaGVhZGVycykgPyB1cGxvYWRPcHRpb25zLmhlYWRlcnMgOiB7fSksXG4gICAgICAgICdDb250ZW50LUxlbmd0aCc6IHNpemVcbiAgICAgIH07XG4gICAgfVxuICAgIGF3YWl0IHVwbG9hZEZpbGVUb0h0dHAoZnMuY3JlYXRlUmVhZFN0cmVhbShsb2NhbFBhdGgpLCB1cmwsIHVwbG9hZE9wdGlvbnMpO1xuICB9IGVsc2UgaWYgKGlzTm90SHR0cFVwbG9hZE9wdGlvbnModXBsb2FkT3B0aW9ucywgdXJsKSkge1xuICAgIGF3YWl0IHVwbG9hZEZpbGVUb0Z0cChmcy5jcmVhdGVSZWFkU3RyZWFtKGxvY2FsUGF0aCksIHVybCwgdXBsb2FkT3B0aW9ucyk7XG4gIH0gZWxzZSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgdXBsb2FkIHRoZSBmaWxlIGF0ICcke2xvY2FsUGF0aH0nIHRvICcke3JlbW90ZVVyaX0nLiBgICtcbiAgICAgIGBVbnN1cHBvcnRlZCByZW1vdGUgcHJvdG9jb2wgJyR7dXJsLnByb3RvY29sfScuIGAgK1xuICAgICAgYE9ubHkgaHR0cC9odHRwcyBhbmQgZnRwL2Z0cHMgcHJvdG9jb2xzIGFyZSBzdXBwb3J0ZWQuYCk7XG4gIH1cbiAgaWYgKGlzTWV0ZXJlZCkge1xuICAgIGxvZy5pbmZvKGBVcGxvYWRlZCAnJHtsb2NhbFBhdGh9JyBvZiAke3RvUmVhZGFibGVTaXplU3RyaW5nKHNpemUpfSBzaXplIGluIGAgK1xuICAgICAgYCR7dGltZXIuZ2V0RHVyYXRpb24oKS5hc1NlY29uZHMudG9GaXhlZCgzKX1zYCk7XG4gIH1cbn1cblxuLyoqXG4gKiBEb3dubG9hZHMgdGhlIGdpdmVuIGZpbGUgdmlhIEhUVFAoUylcbiAqXG4gKiBAcGFyYW0ge3N0cmluZ30gcmVtb3RlVXJsIC0gVGhlIHJlbW90ZSB1cmxcbiAqIEBwYXJhbSB7c3RyaW5nfSBkc3RQYXRoIC0gVGhlIGxvY2FsIHBhdGggdG8gZG93bmxvYWQgdGhlIGZpbGUgdG9cbiAqIEBwYXJhbSB7RG93bmxvYWRPcHRpb25zICYgTmV0T3B0aW9uc30gW2Rvd25sb2FkT3B0aW9uc11cbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiBkb3dubG9hZCBvcGVyYXRpb24gZmFpbHNcbiAqL1xuYXN5bmMgZnVuY3Rpb24gZG93bmxvYWRGaWxlIChyZW1vdGVVcmwsIGRzdFBhdGgsIGRvd25sb2FkT3B0aW9ucyA9IC8qKiBAdHlwZSB7RG93bmxvYWRPcHRpb25zICYgTmV0T3B0aW9uc30gKi8oe30pKSB7XG4gIGNvbnN0IHtcbiAgICBpc01ldGVyZWQgPSB0cnVlLFxuICAgIGF1dGgsXG4gICAgdGltZW91dCA9IERFRkFVTFRfVElNRU9VVF9NUyxcbiAgICBoZWFkZXJzLFxuICB9ID0gZG93bmxvYWRPcHRpb25zO1xuXG4gIC8qKlxuICAgKiBAdHlwZSB7aW1wb3J0KCdheGlvcycpLkF4aW9zUmVxdWVzdENvbmZpZ31cbiAgICovXG4gIGNvbnN0IHJlcXVlc3RPcHRzID0ge1xuICAgIHVybDogcmVtb3RlVXJsLFxuICAgIHJlc3BvbnNlVHlwZTogJ3N0cmVhbScsXG4gICAgdGltZW91dCxcbiAgfTtcbiAgY29uc3QgYXhpb3NBdXRoID0gdG9BeGlvc0F1dGgoYXV0aCk7XG4gIGlmIChheGlvc0F1dGgpIHtcbiAgICByZXF1ZXN0T3B0cy5hdXRoID0gYXhpb3NBdXRoO1xuICB9XG4gIGlmIChfLmlzUGxhaW5PYmplY3QoaGVhZGVycykpIHtcbiAgICByZXF1ZXN0T3B0cy5oZWFkZXJzID0gaGVhZGVycztcbiAgfVxuXG4gIGNvbnN0IHRpbWVyID0gbmV3IFRpbWVyKCkuc3RhcnQoKTtcbiAgbGV0IHJlc3BvbnNlTGVuZ3RoO1xuICB0cnkge1xuICAgIGNvbnN0IHdyaXRlciA9IGZzLmNyZWF0ZVdyaXRlU3RyZWFtKGRzdFBhdGgpO1xuICAgIGNvbnN0IHtcbiAgICAgIGRhdGE6IHJlc3BvbnNlU3RyZWFtLFxuICAgICAgaGVhZGVyczogcmVzcG9uc2VIZWFkZXJzLFxuICAgIH0gPSBhd2FpdCBheGlvcyhyZXF1ZXN0T3B0cyk7XG4gICAgcmVzcG9uc2VMZW5ndGggPSBwYXJzZUludChyZXNwb25zZUhlYWRlcnNbJ2NvbnRlbnQtbGVuZ3RoJ10sIDEwKTtcbiAgICByZXNwb25zZVN0cmVhbS5waXBlKHdyaXRlcik7XG5cbiAgICBhd2FpdCBuZXcgQigocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICByZXNwb25zZVN0cmVhbS5vbmNlKCdlcnJvcicsIHJlamVjdCk7XG4gICAgICB3cml0ZXIub25jZSgnZmluaXNoJywgcmVzb2x2ZSk7XG4gICAgICB3cml0ZXIub25jZSgnZXJyb3InLCAoZSkgPT4ge1xuICAgICAgICByZXNwb25zZVN0cmVhbS51bnBpcGUod3JpdGVyKTtcbiAgICAgICAgcmVqZWN0KGUpO1xuICAgICAgfSk7XG4gICAgfSk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIHRocm93IG5ldyBFcnJvcihgQ2Fubm90IGRvd25sb2FkIHRoZSBmaWxlIGZyb20gJHtyZW1vdGVVcmx9OiAke2Vyci5tZXNzYWdlfWApO1xuICB9XG5cbiAgY29uc3Qge3NpemV9ID0gYXdhaXQgZnMuc3RhdChkc3RQYXRoKTtcbiAgaWYgKHJlc3BvbnNlTGVuZ3RoICYmIHNpemUgIT09IHJlc3BvbnNlTGVuZ3RoKSB7XG4gICAgYXdhaXQgZnMucmltcmFmKGRzdFBhdGgpO1xuICAgIHRocm93IG5ldyBFcnJvcihgVGhlIHNpemUgb2YgdGhlIGZpbGUgZG93bmxvYWRlZCBmcm9tICR7cmVtb3RlVXJsfSAoJHtzaXplfSBieXRlcykgYCArXG4gICAgICBgZGlmZmVycyBmcm9tIHRoZSBvbmUgaW4gQ29udGVudC1MZW5ndGggcmVzcG9uc2UgaGVhZGVyICgke3Jlc3BvbnNlTGVuZ3RofSBieXRlcylgKTtcbiAgfVxuICBpZiAoaXNNZXRlcmVkKSB7XG4gICAgY29uc3Qgc2Vjb25kc0VsYXBzZWQgPSB0aW1lci5nZXREdXJhdGlvbigpLmFzU2Vjb25kcztcbiAgICBsb2cuZGVidWcoYCR7cmVtb3RlVXJsfSAoJHt0b1JlYWRhYmxlU2l6ZVN0cmluZyhzaXplKX0pIGAgK1xuICAgICAgYGhhcyBiZWVuIGRvd25sb2FkZWQgdG8gJyR7ZHN0UGF0aH0nIGluICR7c2Vjb25kc0VsYXBzZWQudG9GaXhlZCgzKX1zYCk7XG4gICAgaWYgKHNlY29uZHNFbGFwc2VkID49IDIpIHtcbiAgICAgIGNvbnN0IGJ5dGVzUGVyU2VjID0gTWF0aC5mbG9vcihzaXplIC8gc2Vjb25kc0VsYXBzZWQpO1xuICAgICAgbG9nLmRlYnVnKGBBcHByb3hpbWF0ZSBkb3dubG9hZCBzcGVlZDogJHt0b1JlYWRhYmxlU2l6ZVN0cmluZyhieXRlc1BlclNlYyl9L3NgKTtcbiAgICB9XG4gIH1cbn1cblxuZXhwb3J0IHsgdXBsb2FkRmlsZSwgZG93bmxvYWRGaWxlIH07XG5cbi8qKlxuICogQ29tbW9uIG9wdGlvbnMgZm9yIHtAbGlua2NvZGUgdXBsb2FkRmlsZX0gYW5kIHtAbGlua2NvZGUgZG93bmxvYWRGaWxlfS5cbiAqIEB0eXBlZGVmIE5ldE9wdGlvbnNcbiAqIEBwcm9wZXJ0eSB7Ym9vbGVhbn0gW2lzTWV0ZXJlZD10cnVlXSAtIFdoZXRoZXIgdG8gbG9nIHRoZSBhY3R1YWwgZG93bmxvYWQgcGVyZm9ybWFuY2VcbiAqIChlLmcuIHRpbWluZ3MgYW5kIHNwZWVkKVxuICogQHByb3BlcnR5IHtBdXRoQ3JlZGVudGlhbHN9IGF1dGhcbiAqL1xuXG4vKipcbiAqIFNwZWNpZmljIG9wdGlvbnMgZm9yIHtAbGlua2NvZGUgZG93bmxvYWRGaWxlfS5cbiAqIEB0eXBlZGVmIERvd25sb2FkT3B0aW9uc1xuICogQHByb3BlcnR5IHtudW1iZXJ9IFt0aW1lb3V0XSAtIFRoZSBhY3R1YWwgcmVxdWVzdCB0aW1lb3V0IGluIG1pbGxpc2Vjb25kczsgZGVmYXVsdHMgdG8ge0BsaW5rY29kZSBERUZBVUxUX1RJTUVPVVRfTVN9XG4gKiBAcHJvcGVydHkge1JlY29yZDxzdHJpbmcsYW55Pn0gaGVhZGVycyAtIFJlcXVlc3QgaGVhZGVycyBtYXBwaW5nXG4gKi9cblxuLyoqXG4gKiBCYXNpYyBhdXRoIGNyZWRlbnRpYWxzOyB1c2VkIGJ5IHtAbGlua2NvZGUgTmV0T3B0aW9uc30uXG4gKiBAdHlwZWRlZiBBdXRoQ3JlZGVudGlhbHNcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSB1c2VyIC0gTm9uLWVtcHR5IHVzZXIgbmFtZVxuICogQHByb3BlcnR5IHtzdHJpbmd9IHBhc3MgLSBOb24tZW1wdHkgcGFzc3dvcmRcbiAqL1xuXG4vKipcbiAqIFRoaXMgdHlwZSBpcyB1c2VkIGluIHtAbGlua2NvZGUgdXBsb2FkRmlsZX0gaWYgdGhlIHJlbW90ZSBsb2NhdGlvbiB1c2VzIHRoZSBgZnRwYCBwcm90b2NvbCwgYW5kIGRpc3Rpbmd1aXNoZXMgdGhlIHR5cGUgZnJvbSB7QGxpbmtjb2RlIEh0dHBVcGxvYWRPcHRpb25zfS5cbiAqIEB0eXBlZGVmIE5vdEh0dHBVcGxvYWRPcHRpb25zXG4gKiBAcHJvcGVydHkge25ldmVyfSBoZWFkZXJzXG4gKiBAcHJvcGVydHkge25ldmVyfSBtZXRob2RcbiAqIEBwcm9wZXJ0eSB7bmV2ZXJ9IHRpbWVvdXRcbiAqIEBwcm9wZXJ0eSB7bmV2ZXJ9IGZpbGVGaWVsZE5hbWVcbiAqIEBwcm9wZXJ0eSB7bmV2ZXJ9IGZvcm1GaWVsZHNcbiAqL1xuXG4vKipcbiAqIFNwZWNpZmljIG9wdGlvbnMgZm9yIHtAbGlua2NvZGUgdXBsb2FkRmlsZX0gaWYgdGhlIHJlbW90ZSBsb2NhdGlvbiB1c2VzIHRoZSBgaHR0cChzKWAgcHJvdG9jb2xcbiAqIEB0eXBlZGVmIEh0dHBVcGxvYWRPcHRpb25zXG4gKiBAcHJvcGVydHkge1JlY29yZDxzdHJpbmcsYW55Pn0gaGVhZGVycyAtIEFkZGl0aW9uYWwgcmVxdWVzdCBoZWFkZXJzIG1hcHBpbmdcbiAqIEBwcm9wZXJ0eSB7aW1wb3J0KCdheGlvcycpLk1ldGhvZH0gW21ldGhvZD0nUE9TVCddIC0gVGhlIEhUVFAgbWV0aG9kIHVzZWQgZm9yIGZpbGUgdXBsb2FkXG4gKiBAcHJvcGVydHkge251bWJlcn0gW3RpbWVvdXRdIC0gVGhlIGFjdHVhbCByZXF1ZXN0IHRpbWVvdXQgaW4gbWlsbGlzZWNvbmRzOyBkZWZhdWx0cyB0byB7QGxpbmtjb2RlIERFRkFVTFRfVElNRU9VVF9NU31cbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBbZmlsZUZpZWxkTmFtZT0nZmlsZSddIC0gVGhlIG5hbWUgb2YgdGhlIGZvcm0gZmllbGQgY29udGFpbmluZyB0aGUgZmlsZVxuICogY29udGVudCB0byBiZSB1cGxvYWRlZC4gQW55IGZhbHN5IHZhbHVlIG1ha2UgdGhlIHJlcXVlc3QgdG8gdXNlIG5vbi1tdWx0aXBhcnQgdXBsb2FkXG4gKiBAcHJvcGVydHkge1JlY29yZDxzdHJpbmcsYW55Pn0gW2Zvcm1GaWVsZHNdIC0gVGhlIGFkZGl0aW9uYWwgZm9ybSBmaWVsZHNcbiAqIHRvIGJlIGluY2x1ZGVkIGludG8gdGhlIHVwbG9hZCByZXF1ZXN0LiBUaGlzIHByb3BlcnR5IGlzIG9ubHkgY29uc2lkZXJlZCBpZlxuICogYGZpbGVGaWVsZE5hbWVgIGlzIHNldFxuICovXG5cbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsTUFBTUEsa0JBQWtCLEdBQUcsSUFBSSxFQUFKLEdBQVMsSUFBcEM7O0FBT0EsU0FBU0MsV0FBVCxDQUFzQkMsSUFBdEIsRUFBNEI7RUFDMUIsSUFBSSxDQUFDQyxnQkFBRUMsYUFBRixDQUFnQkYs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