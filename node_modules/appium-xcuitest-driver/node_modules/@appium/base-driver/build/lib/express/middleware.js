"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.allowCrossDomain = allowCrossDomain;
exports.allowCrossDomainAsyncExecute = allowCrossDomainAsyncExecute;
exports.catch404Handler = catch404Handler;
exports.catchAllHandler = catchAllHandler;
exports.defaultToJSONContentType = defaultToJSONContentType;
exports.fixPythonContentType = fixPythonContentType;
Object.defineProperty(exports, "handleIdempotency", {
  enumerable: true,
  get: function () {
    return _idempotency.handleIdempotency;
  }
});

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("./logger"));

var _protocol = require("../protocol");

var _idempotency = require("./idempotency");

function allowCrossDomain(req, res, next) {
  try {
    res.header('Access-Control-Allow-Origin', '*');
    res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, OPTIONS, DELETE');
    res.header('Access-Control-Allow-Headers', 'Cache-Control, Pragma, Origin, X-Requested-With, Content-Type, Accept, User-Agent');

    if ('OPTIONS' === req.method) {
      return res.sendStatus(200);
    }
  } catch (err) {
    _logger.default.error(`Unexpected error: ${err.stack}`);
  }

  next();
}

function allowCrossDomainAsyncExecute(basePath) {
  return (req, res, next) => {
    const receiveAsyncResponseRegExp = new RegExp(`${_lodash.default.escapeRegExp(basePath)}/session/[a-f0-9-]+/(appium/)?receive_async_response`);

    if (!receiveAsyncResponseRegExp.test(req.url)) {
      return next();
    }

    allowCrossDomain(req, res, next);
  };
}

function fixPythonContentType(basePath) {
  return (req, res, next) => {
    if (new RegExp(`^${_lodash.default.escapeRegExp(basePath)}`).test(req.path) && /^Python/.test(req.headers['user-agent'])) {
      if (req.headers['content-type'] === 'application/x-www-form-urlencoded') {
        req.headers['content-type'] = 'application/json; charset=utf-8';
      }
    }

    next();
  };
}

function defaultToJSONContentType(req, res, next) {
  if (!req.headers['content-type']) {
    req.headers['content-type'] = 'application/json; charset=utf-8';
  }

  next();
}

function catchAllHandler(err, req, res, next) {
  if (res.headersSent) {
    return next(err);
  }

  _logger.default.error(`Uncaught error: ${err.message}`);

  _logger.default.error('Sending generic error response');

  const error = _protocol.errors.UnknownError;
  res.status(error.w3cStatus()).json(patchWithSessionId(req, {
    status: error.code(),
    value: {
      error: error.error(),
      message: `An unknown server-side error occurred while processing the command: ${err.message}`,
      stacktrace: err.stack
    }
  }));

  _logger.default.error(err);
}

function catch404Handler(req, res) {
  _logger.default.debug(`No route found for ${req.url}`);

  const error = _protocol.errors.UnknownCommandError;
  res.status(error.w3cStatus()).json(patchWithSessionId(req, {
    status: error.code(),
    value: {
      error: error.error(),
      message: 'The requested resource could not be found, or a request was ' + 'received using an HTTP method that is not supported by the mapped ' + 'resource',
      stacktrace: ''
    }
  }));
}

const SESSION_ID_PATTERN = /\/session\/([^/]+)/;

function patchWithSessionId(req, body) {
  const match = SESSION_ID_PATTERN.exec(req.url);

  if (match) {
    body.sessionId = match[1];
  }

  return body;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJhbGxvd0Nyb3NzRG9tYWluIiwicmVxIiwicmVzIiwibmV4dCIsImhlYWRlciIsIm1ldGhvZCIsInNlbmRTdGF0dXMiLCJlcnIiLCJsb2ciLCJlcnJvciIsInN0YWNrIiwiYWxsb3dDcm9zc0RvbWFpbkFzeW5jRXhlY3V0ZSIsImJhc2VQYXRoIiwicmVjZWl2ZUFzeW5jUmVzcG9uc2VSZWdFeHAiLCJSZWdFeHAiLCJfIiwiZXNjYXBlUmVnRXhwIiwidGVzdCIsInVybCIsImZpeFB5dGhvbkNvbnRlbnRUeXBlIiwicGF0aCIsImhlYWRlcnMiLCJkZWZhdWx0VG9KU09OQ29udGVudFR5cGUiLCJjYXRjaEFsbEhhbmRsZXIiLCJoZWFkZXJzU2VudCIsIm1lc3NhZ2UiLCJlcnJvcnMiLCJVbmtub3duRXJyb3IiLCJzdGF0dXMiLCJ3M2NTdGF0dXMiLCJqc29uIiwicGF0Y2hXaXRoU2Vzc2lvbklkIiwiY29kZSIsInZhbHVlIiwic3RhY2t0cmFjZSIsImNhdGNoNDA0SGFuZGxlciIsImRlYnVnIiwiVW5rbm93bkNvbW1hbmRFcnJvciIsIlNFU1NJT05fSURfUEFUVEVSTiIsImJvZHkiLCJtYXRjaCIsImV4ZWMiLCJzZXNzaW9uSWQiXSwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvZXhwcmVzcy9taWRkbGV3YXJlLmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCB7IGVycm9ycyB9IGZyb20gJy4uL3Byb3RvY29sJztcbmltcG9ydCB7IGhhbmRsZUlkZW1wb3RlbmN5IH0gZnJvbSAnLi9pZGVtcG90ZW5jeSc7XG5cbmZ1bmN0aW9uIGFsbG93Q3Jvc3NEb21haW4gKHJlcSwgcmVzLCBuZXh0KSB7XG4gIHRyeSB7XG4gICAgcmVzLmhlYWRlcignQWNjZXNzLUNvbnRyb2wtQWxsb3ctT3JpZ2luJywgJyonKTtcbiAgICByZXMuaGVhZGVyKCdBY2Nlc3MtQ29udHJvbC1BbGxvdy1NZXRob2RzJywgJ0dFVCwgUE9TVCwgUFVULCBPUFRJT05TLCBERUxFVEUnKTtcbiAgICByZXMuaGVhZGVyKCdBY2Nlc3MtQ29udHJvbC1BbGxvdy1IZWFkZXJzJywgJ0NhY2hlLUNvbnRyb2wsIFByYWdtYSwgT3JpZ2luLCBYLVJlcXVlc3RlZC1XaXRoLCBDb250ZW50LVR5cGUsIEFjY2VwdCwgVXNlci1BZ2VudCcpO1xuXG4gICAgLy8gbmVlZCB0byByZXNwb25kIDIwMCB0byBPUFRJT05TXG4gICAgaWYgKCdPUFRJT05TJyA9PT0gcmVxLm1ldGhvZCkge1xuICAgICAgcmV0dXJuIHJlcy5zZW5kU3RhdHVzKDIwMCk7XG4gICAgfVxuICB9IGNhdGNoIChlcnIpIHtcbiAgICBsb2cuZXJyb3IoYFVuZXhwZWN0ZWQgZXJyb3I6ICR7ZXJyLnN0YWNrfWApO1xuICB9XG4gIG5leHQoKTtcbn1cblxuZnVuY3Rpb24gYWxsb3dDcm9zc0RvbWFpbkFzeW5jRXhlY3V0ZSAoYmFzZVBhdGgpIHtcbiAgcmV0dXJuIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgIC8vIHRoZXJlIGFyZSB0d28gcGF0aHMgZm9yIGFzeW5jIHJlc3BvbnNlcywgc28gY292ZXIgYm90aFxuICAgIC8vIGh0dHBzOi8vcmVnZXgxMDEuY29tL3IvdHhZaUV6LzFcbiAgICBjb25zdCByZWNlaXZlQXN5bmNSZXNwb25zZVJlZ0V4cCA9IG5ldyBSZWdFeHAoYCR7Xy5lc2NhcGVSZWdFeHAoYmFzZVBhdGgpfS9zZXNzaW9uL1thLWYwLTktXSsvKGFwcGl1bS8pP3JlY2VpdmVfYXN5bmNfcmVzcG9uc2VgKTtcbiAgICBpZiAoIXJlY2VpdmVBc3luY1Jlc3BvbnNlUmVnRXhwLnRlc3QocmVxLnVybCkpIHtcbiAgICAgIHJldHVybiBuZXh0KCk7XG4gICAgfVxuICAgIGFsbG93Q3Jvc3NEb21haW4ocmVxLCByZXMsIG5leHQpO1xuICB9O1xufVxuXG5mdW5jdGlvbiBmaXhQeXRob25Db250ZW50VHlwZSAoYmFzZVBhdGgpIHtcbiAgcmV0dXJuIChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICAgIC8vIGhhY2sgYmVjYXVzZSBweXRob24gY2xpZW50IGxpYnJhcnkgZ2l2ZXMgdXMgd3JvbmcgY29udGVudC10eXBlXG4gICAgaWYgKG5ldyBSZWdFeHAoYF4ke18uZXNjYXBlUmVnRXhwKGJhc2VQYXRoKX1gKS50ZXN0KHJlcS5wYXRoKSAmJiAvXlB5dGhvbi8udGVzdChyZXEuaGVhZGVyc1sndXNlci1hZ2VudCddKSkge1xuICAgICAgaWYgKHJlcS5oZWFkZXJzWydjb250ZW50LXR5cGUnXSA9PT0gJ2FwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZCcpIHtcbiAgICAgICAgcmVxLmhlYWRlcnNbJ2NvbnRlbnQtdHlwZSddID0gJ2FwcGxpY2F0aW9uL2pzb247IGNoYXJzZXQ9dXRmLTgnO1xuICAgICAgfVxuICAgIH1cbiAgICBuZXh0KCk7XG4gIH07XG59XG5cbmZ1bmN0aW9uIGRlZmF1bHRUb0pTT05Db250ZW50VHlwZSAocmVxLCByZXMsIG5leHQpIHtcbiAgaWYgKCFyZXEuaGVhZGVyc1snY29udGVudC10eXBlJ10pIHtcbiAgICByZXEuaGVhZGVyc1snY29udGVudC10eXBlJ10gPSAnYXBwbGljYXRpb24vanNvbjsgY2hhcnNldD11dGYtOCc7XG4gIH1cbiAgbmV4dCgpO1xufVxuXG5mdW5jdGlvbiBjYXRjaEFsbEhhbmRsZXIgKGVyciwgcmVxLCByZXMsIG5leHQpIHtcbiAgaWYgKHJlcy5oZWFkZXJzU2VudCkge1xuICAgIHJldHVybiBuZXh0KGVycik7XG4gIH1cblxuICBsb2cuZXJyb3IoYFVuY2F1Z2h0IGVycm9yOiAke2Vyci5tZXNzYWdlfWApO1xuICBsb2cuZXJyb3IoJ1NlbmRpbmcgZ2VuZXJpYyBlcnJvciByZXNwb25zZScpO1xuICBjb25zdCBlcnJvciA9IGVycm9ycy5Vbmtub3duRXJyb3I7XG4gIHJlcy5zdGF0dXMoZXJyb3IudzNjU3RhdHVzKCkpLmpzb24ocGF0Y2hXaXRoU2Vzc2lvbklkKHJlcSwge1xuICAgIHN0YXR1czogZXJyb3IuY29kZSgpLFxuICAgIHZhbHVlOiB7XG4gICAgICBlcnJvcjogZXJyb3IuZXJyb3IoKSxcbiAgICAgIG1lc3NhZ2U6IGBBbiB1bmtub3duIHNlcnZlci1zaWRlIGVycm9yIG9jY3VycmVkIHdoaWxlIHByb2Nlc3NpbmcgdGhlIGNvbW1hbmQ6ICR7ZXJyLm1lc3NhZ2V9YCxcbiAgICAgIHN0YWNrdHJhY2U6IGVyci5zdGFjayxcbiAgICB9XG4gIH0pKTtcbiAgbG9nLmVycm9yKGVycik7XG59XG5cbmZ1bmN0aW9uIGNhdGNoNDA0SGFuZGxlciAocmVxLCByZXMpIHtcbiAgbG9nLmRlYnVnKGBObyByb3V0ZSBmb3VuZCBmb3IgJHtyZXEudXJsfWApO1xuICBjb25zdCBlcnJvciA9IGVycm9ycy5Vbmtub3duQ29tbWFuZEVycm9yO1xuICByZXMuc3RhdHVzKGVycm9yLnczY1N0YXR1cygpKS5qc29uKHBhdGNoV2l0aFNlc3Npb25JZChyZXEsIHtcbiAgICBzdGF0dXM6IGVycm9yLmNvZGUoKSxcbiAgICB2YWx1ZToge1xuICAgICAgZXJyb3I6IGVycm9yLmVycm9yKCksXG4gICAgICBtZXNzYWdlOiAnVGhlIHJlcXVlc3RlZCByZXNvdXJjZSBjb3VsZCBub3QgYmUgZm91bmQsIG9yIGEgcmVxdWVzdCB3YXMgJyArXG4gICAgICAgICdyZWNlaXZlZCB1c2luZyBhbiBIVFRQIG1ldGhvZCB0aGF0IGlzIG5vdCBzdXBwb3J0ZWQgYnkgdGhlIG1hcHBlZCAnICtcbiAgICAgICAgJ3Jlc291cmNlJyxcbiAgICAgIHN0YWNrdHJhY2U6ICcnLFxuICAgIH1cbiAgfSkpO1xufVxuXG5cbmNvbnN0IFNFU1NJT05fSURfUEFUVEVSTiA9IC9cXC9zZXNzaW9uXFwvKFteL10rKS87XG5cbmZ1bmN0aW9uIHBhdGNoV2l0aFNlc3Npb25JZCAocmVxLCBib2R5KSB7XG4gIGNvbnN0IG1hdGNoID0gU0VTU0lPTl9JRF9QQVRURVJOLmV4ZWMocmVxLnVybCk7XG4gIGlmIChtYXRjaCkge1xuICAgIGJvZHkuc2Vzc2lvbklkID0gbWF0Y2hbMV07XG4gIH1cbiAgcmV0dXJuIGJvZHk7XG59XG5cbmV4cG9ydCB7XG4gIGFsbG93Q3Jvc3NEb21haW4sIGZpeFB5dGhvbkNvbnRlbnRUeXBlLCBkZWZhdWx0VG9KU09OQ29udGVudFR5cGUsXG4gIGNhdGNoQWxsSGFuZGxlciwgYWxsb3dDcm9zc0RvbWFpbkFzeW5jRXhlY3V0ZSwgaGFuZGxlSWRlbXBvdGVuY3ksXG4gIGNhdGNoNDA0SGFuZGxlcixcbn07XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxTQUFTQSxnQkFBVCxDQUEyQkMsR0FBM0IsRUFBZ0NDLEdBQWhDLEVBQXFDQyxJQUFyQyxFQUEyQztFQUN6QyxJQUFJO0lBQ0ZELEdBQUcsQ0FBQ0UsTUFBSixDQUFXLDZCQUFYLEVBQTBDLEdBQTFDO0lBQ0FGLEdBQUcsQ0FBQ0UsTUFBSixDQUFXLDhCQUFYLEVBQTJDLGlDQUEzQztJQUNBRixHQUFHLENBQUNFLE1BQUosQ0FBVyw4QkFBWCxFQUEyQyxtRkFBM0M7O0lBR0EsSUFBSSxjQUFjSCxHQUFHLENBQUNJLE1BQXRCLEVBQThCO01BQzVCLE9BQU9ILEdBQUcsQ0FBQ0ksVUFBSixDQUFlLEdBQWYsQ0FBUDtJQUNEO0VBQ0YsQ0FURCxDQVNFLE9BQU9DLEdBQVAsRUFBWTtJQUNaQyxnQkFBSUMsS0FBSixDQUFXLHFCQUFvQkYsR0FBRyxDQUFDRyxLQUFNLEVBQXpDO0VBQ0Q7O0VBQ0RQLElBQUk7QUFDTDs7QUFFRCxTQUFTUSw0QkFBVCxDQUF1Q0MsUUFBdkMsRUFBaUQ7RUFDL0MsT0FBTyxDQUFDWCxHQUFELEVBQU1DLEdBQU4sRUFBV0MsSUFBWCxLQUFvQjtJQUd6QixNQUFNVSwwQkFBMEIsR0FBRyxJQUFJQyxNQUFKLENBQVksR0FBRUMsZ0JBQUVDLFlBQUYsQ0FBZUosUUFBZixDQUF5QixzREFBdkMsQ0FBbkM7O0lBQ0EsSUFBSSxDQUFDQywwQkFBMEIsQ0FBQ0ksSUFBM0Is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