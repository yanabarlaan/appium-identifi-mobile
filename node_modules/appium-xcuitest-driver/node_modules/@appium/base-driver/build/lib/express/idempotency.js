"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.handleIdempotency = handleIdempotency;

require("source-map-support/register");

var _logger = _interopRequireDefault(require("./logger"));

var _lruCache = _interopRequireDefault(require("lru-cache"));

var _support = require("@appium/support");

var _os = _interopRequireDefault(require("os"));

var _path = _interopRequireDefault(require("path"));

var _events = require("events");

const CACHE_SIZE = 1024;
const IDEMPOTENT_RESPONSES = new _lruCache.default({
  max: CACHE_SIZE,
  updateAgeOnGet: true,

  dispose(key, {
    response
  }) {
    if (response) {
      _support.fs.rimrafSync(response);
    }
  }

});
const MONITORED_METHODS = ['POST', 'PATCH'];
const IDEMPOTENCY_KEY_HEADER = 'x-idempotency-key';
process.on('exit', () => {
  const resPaths = [...IDEMPOTENT_RESPONSES.values()].map(({
    response
  }) => response).filter(Boolean);

  for (const resPath of resPaths) {
    try {
      _support.fs.rimrafSync(resPath);
    } catch (ign) {}
  }
});

function cacheResponse(key, req, res) {
  const responseStateListener = new _events.EventEmitter();
  IDEMPOTENT_RESPONSES.set(key, {
    method: req.method,
    path: req.path,
    response: null,
    responseStateListener
  });

  const tmpFile = _path.default.resolve(_os.default.tmpdir(), `${_support.util.uuidV4()}.response`);

  const responseListener = _support.fs.createWriteStream(tmpFile, {
    emitClose: true
  });

  const originalSocketWriter = res.socket.write.bind(res.socket);

  const patchedWriter = (chunk, encoding, next) => {
    if (responseListener.writable) {
      responseListener.write(chunk);
    }

    return originalSocketWriter(chunk, encoding, next);
  };

  res.socket.write = patchedWriter;
  let writeError = null;
  let isResponseFullySent = false;
  responseListener.once('error', e => {
    writeError = e;
  });
  res.once('finish', () => {
    isResponseFullySent = true;
    responseListener.end();
  });
  res.once('close', () => {
    if (!isResponseFullySent) {
      responseListener.end();
    }
  });
  responseListener.once('close', () => {
    var _res$socket;

    if (((_res$socket = res.socket) === null || _res$socket === void 0 ? void 0 : _res$socket.write) === patchedWriter) {
      res.socket.write = originalSocketWriter;
    }

    if (!IDEMPOTENT_RESPONSES.has(key)) {
      _logger.default.info(`Could not cache the response identified by '${key}'. ` + `Cache consistency has been damaged`);

      return responseStateListener.emit('ready', null);
    }

    if (writeError) {
      _logger.default.info(`Could not cache the response identified by '${key}': ${writeError.message}`);

      IDEMPOTENT_RESPONSES.delete(key);
      return responseStateListener.emit('ready', null);
    }

    if (!isResponseFullySent) {
      _logger.default.info(`Could not cache the response identified by '${key}', ` + `because it has not been completed`);

      _logger.default.info('Does the client terminate connections too early?');

      IDEMPOTENT_RESPONSES.delete(key);
      return responseStateListener.emit('ready', null);
    }

    IDEMPOTENT_RESPONSES.get(key).response = tmpFile;
    responseStateListener.emit('ready', tmpFile);
  });
}

async function handleIdempotency(req, res, next) {
  const key = req.headers[IDEMPOTENCY_KEY_HEADER];

  if (!key) {
    return next();
  }

  if (!MONITORED_METHODS.includes(req.method)) {
    return next();
  }

  _logger.default.debug(`Request idempotency key: ${key}`);

  if (!IDEMPOTENT_RESPONSES.has(key)) {
    cacheResponse(key, req, res);
    return next();
  }

  const {
    method: storedMethod,
    path: storedPath,
    response,
    responseStateListener
  } = IDEMPOTENT_RESPONSES.get(key);

  if (req.method !== storedMethod || req.path !== storedPath) {
    _logger.default.warn(`Got two different requests with the same idempotency key '${key}'`);

    _logger.default.warn('Is the client generating idempotency keys properly?');

    return next();
  }

  const rerouteCachedResponse = async cachedResPath => {
    if (!(await _support.fs.exists(cachedResPath))) {
      IDEMPOTENT_RESPONSES.delete(key);

      _logger.default.warn(`Could not read the cached response identified by key '${key}'`);

      _logger.default.warn('The temporary storage is not accessible anymore');

      return next();
    }

    _support.fs.createReadStream(cachedResPath).pipe(res.socket);
  };

  if (response) {
    _logger.default.info(`The same request with the idempotency key '${key}' has been already processed`);

    _logger.default.info(`Rerouting its response to the current request`);

    await rerouteCachedResponse(response);
  } else {
    _logger.default.info(`The same request with the idempotency key '${key}' is being processed`);

    _logger.default.info(`Waiting for the response to be rerouted to the current request`);

    responseStateListener.once('ready', async cachedResponsePath => {
      if (!cachedResponsePath) {
        return next();
      }

      await rerouteCachedResponse(cachedResponsePath);
    });
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJDQUNIRV9TSVpFIiwiSURFTVBPVEVOVF9SRVNQT05TRVMiLCJMUlUiLCJtYXgiLCJ1cGRhdGVBZ2VPbkdldCIsImRpc3Bvc2UiLCJrZXkiLCJyZXNwb25zZSIsImZzIiwicmltcmFmU3luYyIsIk1PTklUT1JFRF9NRVRIT0RTIiwiSURFTVBPVEVOQ1lfS0VZX0hFQURFUiIsInByb2Nlc3MiLCJvbiIsInJlc1BhdGhzIiwidmFsdWVzIiwibWFwIiwiZmlsdGVyIiwiQm9vbGVhbiIsInJlc1BhdGgiLCJpZ24iLCJjYWNoZVJlc3BvbnNlIiwicmVxIiwicmVzIiwicmVzcG9uc2VTdGF0ZUxpc3RlbmVyIiwiRXZlbnRFbWl0dGVyIiwic2V0IiwibWV0aG9kIiwicGF0aCIsInRtcEZpbGUiLCJyZXNvbHZlIiwib3MiLCJ0bXBkaXIiLCJ1dGlsIiwidXVpZFY0IiwicmVzcG9uc2VMaXN0ZW5lciIsImNyZWF0ZVdyaXRlU3RyZWFtIiwiZW1pdENsb3NlIiwib3JpZ2luYWxTb2NrZXRXcml0ZXIiLCJzb2NrZXQiLCJ3cml0ZSIsImJpbmQiLCJwYXRjaGVkV3JpdGVyIiwiY2h1bmsiLCJlbmNvZGluZyIsIm5leHQiLCJ3cml0YWJsZSIsIndyaXRlRXJyb3IiLCJpc1Jlc3BvbnNlRnVsbHlTZW50Iiwib25jZSIsImUiLCJlbmQiLCJoYXMiLCJsb2ciLCJpbmZvIiwiZW1pdCIsIm1lc3NhZ2UiLCJkZWxldGUiLCJnZXQiLCJoYW5kbGVJZGVtcG90ZW5jeSIsImhlYWRlcnMiLCJpbmNsdWRlcyIsImRlYnVnIiwic3RvcmVkTWV0aG9kIiwic3RvcmVkUGF0aCIsIndhcm4iLCJyZXJvdXRlQ2FjaGVkUmVzcG9uc2UiLCJjYWNoZWRSZXNQYXRoIiwiZXhpc3RzIiwiY3JlYXRlUmVhZFN0cmVhbSIsInBpcGUiLCJjYWNoZWRSZXNwb25zZVBhdGgiXSwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvZXhwcmVzcy9pZGVtcG90ZW5jeS5qcyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCBMUlUgZnJvbSAnbHJ1LWNhY2hlJztcbmltcG9ydCB7IGZzLCB1dGlsIH0gZnJvbSAnQGFwcGl1bS9zdXBwb3J0JztcbmltcG9ydCBvcyBmcm9tICdvcyc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IEV2ZW50RW1pdHRlciB9IGZyb20gJ2V2ZW50cyc7XG5cblxuY29uc3QgQ0FDSEVfU0laRSA9IDEwMjQ7XG5jb25zdCBJREVNUE9URU5UX1JFU1BPTlNFUyA9IG5ldyBMUlUoe1xuICBtYXg6IENBQ0hFX1NJWkUsXG4gIHVwZGF0ZUFnZU9uR2V0OiB0cnVlLFxuICBkaXNwb3NlIChrZXksIHtyZXNwb25zZX0pIHtcbiAgICBpZiAocmVzcG9uc2UpIHtcbiAgICAgIGZzLnJpbXJhZlN5bmMocmVzcG9uc2UpO1xuICAgIH1cbiAgfSxcbn0pO1xuY29uc3QgTU9OSVRPUkVEX01FVEhPRFMgPSBbJ1BPU1QnLCAnUEFUQ0gnXTtcbmNvbnN0IElERU1QT1RFTkNZX0tFWV9IRUFERVIgPSAneC1pZGVtcG90ZW5jeS1rZXknO1xuXG5wcm9jZXNzLm9uKCdleGl0JywgKCkgPT4ge1xuICBjb25zdCByZXNQYXRocyA9IFsuLi5JREVNUE9URU5UX1JFU1BPTlNFUy52YWx1ZXMoKV1cbiAgICAubWFwKCh7cmVzcG9uc2V9KSA9PiByZXNwb25zZSlcbiAgICAuZmlsdGVyKEJvb2xlYW4pO1xuICBmb3IgKGNvbnN0IHJlc1BhdGggb2YgcmVzUGF0aHMpIHtcbiAgICB0cnkge1xuICAgICAgLy8gQXN5bmNocm9ub3VzIGNhbGxzIGFyZSBub3Qgc3VwcG9ydGVkIGluIG9uRXhpdCBoYW5kbGVyXG4gICAgICBmcy5yaW1yYWZTeW5jKHJlc1BhdGgpO1xuICAgIH0gY2F0Y2ggKGlnbikge31cbiAgfVxufSk7XG5cblxuZnVuY3Rpb24gY2FjaGVSZXNwb25zZSAoa2V5LCByZXEsIHJlcykge1xuICBjb25zdCByZXNwb25zZVN0YXRlTGlzdGVuZXIgPSBuZXcgRXZlbnRFbWl0dGVyKCk7XG4gIElERU1QT1RFTlRfUkVTUE9OU0VTLnNldChrZXksIHtcbiAgICBtZXRob2Q6IHJlcS5tZXRob2QsXG4gICAgcGF0aDogcmVxLnBhdGgsXG4gICAgcmVzcG9uc2U6IG51bGwsXG4gICAgcmVzcG9uc2VTdGF0ZUxpc3RlbmVyLFxuICB9KTtcbiAgY29uc3QgdG1wRmlsZSA9IHBhdGgucmVzb2x2ZShvcy50bXBkaXIoKSwgYCR7dXRpbC51dWlkVjQoKX0ucmVzcG9uc2VgKTtcbiAgY29uc3QgcmVzcG9uc2VMaXN0ZW5lciA9IGZzLmNyZWF0ZVdyaXRlU3RyZWFtKHRtcEZpbGUsIHtcbiAgICBlbWl0Q2xvc2U6IHRydWUsXG4gIH0pO1xuICBjb25zdCBvcmlnaW5hbFNvY2tldFdyaXRlciA9IHJlcy5zb2NrZXQud3JpdGUuYmluZChyZXMuc29ja2V0KTtcbiAgY29uc3QgcGF0Y2hlZFdyaXRlciA9IChjaHVuaywgZW5jb2RpbmcsIG5leHQpID0+IHtcbiAgICBpZiAocmVzcG9uc2VMaXN0ZW5lci53cml0YWJsZSkge1xuICAgICAgcmVzcG9uc2VMaXN0ZW5lci53cml0ZShjaHVuayk7XG4gICAgfVxuICAgIHJldHVybiBvcmlnaW5hbFNvY2tldFdyaXRlcihjaHVuaywgZW5jb2RpbmcsIG5leHQpO1xuICB9O1xuICByZXMuc29ja2V0LndyaXRlID0gcGF0Y2hlZFdyaXRlcjtcbiAgbGV0IHdyaXRlRXJyb3IgPSBudWxsO1xuICBsZXQgaXNSZXNwb25zZUZ1bGx5U2VudCA9IGZhbHNlO1xuICByZXNwb25zZUxpc3RlbmVyLm9uY2UoJ2Vycm9yJywgKGUpID0+IHtcbiAgICB3cml0ZUVycm9yID0gZTtcbiAgfSk7XG4gIHJlcy5vbmNlKCdmaW5pc2gnLCAoKSA9PiB7XG4gICAgaXNSZXNwb25zZUZ1bGx5U2VudCA9IHRydWU7XG4gICAgcmVzcG9uc2VMaXN0ZW5lci5lbmQoKTtcbiAgfSk7XG4gIHJlcy5vbmNlKCdjbG9zZScsICgpID0+IHtcbiAgICBpZiAoIWlzUmVzcG9uc2VGdWxseVNlbnQpIHtcbiAgICAgIHJlc3BvbnNlTGlzdGVuZXIuZW5kKCk7XG4gICAgfVxuICB9KTtcbiAgcmVzcG9uc2VMaXN0ZW5lci5vbmNlKCdjbG9zZScsICgpID0+IHtcbiAgICBpZiAocmVzLnNvY2tldD8ud3JpdGUgPT09IHBhdGNoZWRXcml0ZXIpIHtcbiAgICAgIHJlcy5zb2NrZXQud3JpdGUgPSBvcmlnaW5hbFNvY2tldFdyaXRlcjtcbiAgICB9XG5cbiAgICBpZiAoIUlERU1QT1RFTlRfUkVTUE9OU0VTLmhhcyhrZXkpKSB7XG4gICAgICBsb2cuaW5mbyhgQ291bGQgbm90IGNhY2hlIHRoZSByZXNwb25zZSBpZGVudGlmaWVkIGJ5ICcke2tleX0nLiBgICtcbiAgICAgICAgYENhY2hlIGNvbnNpc3RlbmN5IGhhcyBiZWVuIGRhbWFnZWRgKTtcbiAgICAgIHJldHVybiByZXNwb25zZVN0YXRlTGlzdGVuZXIuZW1pdCgncmVhZHknLCBudWxsKTtcbiAgICB9XG4gICAgaWYgKHdyaXRlRXJyb3IpIHtcbiAgICAgIGxvZy5pbmZvKGBDb3VsZCBub3QgY2FjaGUgdGhlIHJlc3BvbnNlIGlkZW50aWZpZWQgYnkgJyR7a2V5fSc6ICR7d3JpdGVFcnJvci5tZXNzYWdlfWApO1xuICAgICAgSURFTVBPVEVOVF9SRVNQT05TRVMuZGVsZXRlKGtleSk7XG4gICAgICByZXR1cm4gcmVzcG9uc2VTdGF0ZUxpc3RlbmVyLmVtaXQoJ3JlYWR5JywgbnVsbCk7XG4gICAgfVxuICAgIGlmICghaXNSZXNwb25zZUZ1bGx5U2VudCkge1xuICAgICAgbG9nLmluZm8oYENvdWxkIG5vdCBjYWNoZSB0aGUgcmVzcG9uc2UgaWRlbnRpZmllZCBieSAnJHtrZXl9JywgYCArXG4gICAgICAgIGBiZWNhdXNlIGl0IGhhcyBub3QgYmVlbiBjb21wbGV0ZWRgKTtcbiAgICAgIGxvZy5pbmZvKCdEb2VzIHRoZSBjbGllbnQgdGVybWluYXRlIGNvbm5lY3Rpb25zIHRvbyBlYXJseT8nKTtcbiAgICAgIElERU1QT1RFTlRfUkVTUE9OU0VTLmRlbGV0ZShrZXkpO1xuICAgICAgcmV0dXJuIHJlc3BvbnNlU3RhdGVMaXN0ZW5lci5lbWl0KCdyZWFkeScsIG51bGwpO1xuICAgIH1cblxuICAgIElERU1QT1RFTlRfUkVTUE9OU0VTLmdldChrZXkpLnJlc3BvbnNlID0gdG1wRmlsZTtcbiAgICByZXNwb25zZVN0YXRlTGlzdGVuZXIuZW1pdCgncmVhZHknLCB0bXBGaWxlKTtcbiAgfSk7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGhhbmRsZUlkZW1wb3RlbmN5IChyZXEsIHJlcywgbmV4dCkge1xuICBjb25zdCBrZXkgPSByZXEuaGVhZGVyc1tJREVNUE9URU5DWV9LRVlfSEVBREVSXTtcbiAgaWYgKCFrZXkpIHtcbiAgICByZXR1cm4gbmV4dCgpO1xuICB9XG4gIGlmICghTU9OSVRPUkVEX01FVEhPRFMuaW5jbHVkZXMocmVxLm1ldGhvZCkpIHtcbiAgICAvLyBHRVQsIERFTEVURSwgZXRjLiByZXF1ZXN0cyBhcmUgaWRlbXBvdGVudCBieSBkZWZhdWx0XG4gICAgLy8gdGhlcmUgaXMgbm8gbmVlZCB0byBjYWNoZSB0aGVtXG4gICAgcmV0dXJuIG5leHQoKTtcbiAgfVxuXG4gIGxvZy5kZWJ1ZyhgUmVxdWVzdCBpZGVtcG90ZW5jeSBrZXk6ICR7a2V5fWApO1xuICBpZiAoIUlERU1QT1RFTlRfUkVTUE9OU0VTLmhhcyhrZXkpKSB7XG4gICAgY2FjaGVSZXNwb25zZShrZXksIHJlcSwgcmVzKTtcbiAgICByZXR1cm4gbmV4dCgpO1xuICB9XG5cbiAgY29uc3Qge1xuICAgIG1ldGhvZDogc3RvcmVkTWV0aG9kLFxuICAgIHBhdGg6IHN0b3JlZFBhdGgsXG4gICAgcmVzcG9uc2UsXG4gICAgcmVzcG9uc2VTdGF0ZUxpc3RlbmVyLFxuICB9ID0gSURFTVBPVEVOVF9SRVNQT05TRVMuZ2V0KGtleSk7XG4gIGlmIChyZXEubWV0aG9kICE9PSBzdG9yZWRNZXRob2QgfHwgcmVxLnBhdGggIT09IHN0b3JlZFBhdGgpIHtcbiAgICBsb2cud2FybihgR290IHR3byBkaWZmZXJlbnQgcmVxdWVzdHMgd2l0aCB0aGUgc2FtZSBpZGVtcG90ZW5jeSBrZXkgJyR7a2V5fSdgKTtcbiAgICBsb2cud2FybignSXMgdGhlIGNsaWVudCBnZW5lcmF0aW5nIGlkZW1wb3RlbmN5IGtleXMgcHJvcGVybHk/Jyk7XG4gICAgcmV0dXJuIG5leHQoKTtcbiAgfVxuXG4gIGNvbnN0IHJlcm91dGVDYWNoZWRSZXNwb25zZSA9IGFzeW5jIChjYWNoZWRSZXNQYXRoKSA9PiB7XG4gICAgaWYgKCFhd2FpdCBmcy5leGlzdHMoY2FjaGVkUmVzUGF0aCkpIHtcbiAgICAgIElERU1QT1RFTlRfUkVTUE9OU0VTLmRlbGV0ZShrZXkpO1xuICAgICAgbG9nLndhcm4oYENvdWxkIG5vdCByZWFkIHRoZSBjYWNoZWQgcmVzcG9uc2UgaWRlbnRpZmllZCBieSBrZXkgJyR7a2V5fSdgKTtcbiAgICAgIGxvZy53YXJuKCdUaGUgdGVtcG9yYXJ5IHN0b3JhZ2UgaXMgbm90IGFjY2Vzc2libGUgYW55bW9yZScpO1xuICAgICAgcmV0dXJuIG5leHQoKTtcbiAgICB9XG4gICAgZnMuY3JlYXRlUmVhZFN0cmVhbShjYWNoZWRSZXNQYXRoKS5waXBlKHJlcy5zb2NrZXQpO1xuICB9O1xuXG4gIGlmIChyZXNwb25zZSkge1xuICAgIGxvZy5pbmZvKGBUaGUgc2FtZSByZXF1ZXN0IHdpdGggdGhlIGlkZW1wb3RlbmN5IGtleSAnJHtrZXl9JyBoYXMgYmVlbiBhbHJlYWR5IHByb2Nlc3NlZGApO1xuICAgIGxvZy5pbmZvKGBSZXJvdXRpbmcgaXRzIHJlc3BvbnNlIHRvIHRoZSBjdXJyZW50IHJlcXVlc3RgKTtcbiAgICBhd2FpdCByZXJvdXRlQ2FjaGVkUmVzcG9uc2UocmVzcG9uc2UpO1xuICB9IGVsc2Uge1xuICAgIGxvZy5pbmZvKGBUaGUgc2FtZSByZXF1ZXN0IHdpdGggdGhlIGlkZW1wb3RlbmN5IGtleSAnJHtrZXl9JyBpcyBiZWluZyBwcm9jZXNzZWRgKTtcbiAgICBsb2cuaW5mbyhgV2FpdGluZyBmb3IgdGhlIHJlc3BvbnNlIHRvIGJlIHJlcm91dGVkIHRvIHRoZSBjdXJyZW50IHJlcXVlc3RgKTtcbiAgICByZXNwb25zZVN0YXRlTGlzdGVuZXIub25jZSgncmVhZHknLCBhc3luYyAoY2FjaGVkUmVzcG9uc2VQYXRoKSA9PiB7XG4gICAgICBpZiAoIWNhY2hlZFJlc3BvbnNlUGF0aCkge1xuICAgICAgICByZXR1cm4gbmV4dCgpO1xuICAgICAgfVxuICAgICAgYXdhaXQgcmVyb3V0ZUNhY2hlZFJlc3BvbnNlKGNhY2hlZFJlc3BvbnNlUGF0aCk7XG4gICAgfSk7XG4gIH1cbn1cblxuZXhwb3J0IHsgaGFuZGxlSWRlbXBvdGVuY3kgfTtcbiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFHQSxNQUFNQSxVQUFVLEdBQUcsSUFBbkI7QUFDQSxNQUFNQyxvQkFBb0IsR0FBRyxJQUFJQyxpQkFBSixDQUFRO0VBQ25DQyxHQUFHLEVBQUVILFVBRDhCO0VBRW5DSSxjQUFjLEVBQUUsSUFGbUI7O0VBR25DQyxPQUFPLENBQUVDLEdBQUYsRUFBTztJQUFDQztFQUFELENBQVAsRUFBbUI7SUFDeEIsSUFBSUEsUUFBSixFQUFjO01BQ1pDLFlBQUdDLFVBQUgsQ0FBY0YsUUFBZDtJQUNEO0VBQ0Y7O0FBUGtDLENBQVIsQ0FBN0I7QUFTQSxNQUFNRyxpQkFBaUIsR0FBRyxDQUFDLE1BQUQsRUFBUyxPQUFULENBQTFCO0FBQ0EsTUFBTUMsc0JBQXNCLEdBQUcsbUJBQS9CO0FBRUFDLE9BQU8sQ0FBQ0MsRUFBUixDQUFXLE1BQVgsRUFBbUIsTUFBTTtFQUN2QixNQUFNQyxRQUFRLEdBQUcsQ0FBQyxHQUFHYixvQkFBb0IsQ0FBQ2MsTUFBckIsRUFBSixFQUNkQyxHQURjLENBQ1YsQ0FBQztJQUFDVDtFQUFELENBQUQsS0FBZ0JBLFFBRE4sRUFFZFUsTUFGYyxDQUVQQyxPQUZPLENBQWpCOztFQUdBLEtBQUssTUFBTUMsT0FBWCxJ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