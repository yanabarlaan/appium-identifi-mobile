"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.configureServer = configureServer;
exports.normalizeBasePath = normalizeBasePath;
exports.server = server;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _path = _interopRequireDefault(require("path"));

var _express = _interopRequireDefault(require("express"));

var _http = _interopRequireDefault(require("http"));

var _serveFavicon = _interopRequireDefault(require("serve-favicon"));

var _bodyParser = _interopRequireDefault(require("body-parser"));

var _methodOverride = _interopRequireDefault(require("method-override"));

var _logger = _interopRequireDefault(require("./logger"));

var _expressLogging = require("./express-logging");

var _middleware = require("./middleware");

var _static = require("./static");

var _crash = require("./crash");

var _websocket = require("./websocket");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _constants = require("../constants");

var _events = require("events");

const KEEP_ALIVE_TIMEOUT_MS = 10 * 60 * 1000;

async function server(opts = {}) {
  const {
    routeConfiguringFunction,
    port,
    hostname = null,
    allowCors = true,
    basePath = _constants.DEFAULT_BASE_PATH,
    extraMethodMap = {},
    serverUpdaters = [],
    keepAliveTimeout = KEEP_ALIVE_TIMEOUT_MS
  } = opts;
  const app = (0, _express.default)();

  const httpServer = _http.default.createServer(app);

  return await new _bluebird.default(async (resolve, reject) => {
    try {
      configureHttp({
        httpServer,
        reject,
        keepAliveTimeout
      });
      configureServer({
        app,
        addRoutes: routeConfiguringFunction,
        allowCors,
        basePath,
        extraMethodMap
      });

      for (const updater of serverUpdaters) {
        await updater(app, httpServer);
      }

      app.all('*', _middleware.catch404Handler);
      await startServer({
        httpServer,
        hostname,
        port,
        keepAliveTimeout
      });
      resolve(httpServer);
    } catch (err) {
      reject(err);
    }
  });
}

function configureServer({
  app,
  addRoutes,
  allowCors = true,
  basePath = _constants.DEFAULT_BASE_PATH,
  extraMethodMap = {}
}) {
  basePath = normalizeBasePath(basePath);
  app.use(_expressLogging.endLogFormatter);
  app.use((0, _serveFavicon.default)(_path.default.resolve(_static.STATIC_DIR, 'favicon.ico')));
  app.use(_express.default.static(_static.STATIC_DIR));
  app.use(`${basePath}/produce_error`, _crash.produceError);
  app.use(`${basePath}/crash`, _crash.produceCrash);

  if (allowCors) {
    app.use(_middleware.allowCrossDomain);
  } else {
    app.use((0, _middleware.allowCrossDomainAsyncExecute)(basePath));
  }

  app.use(_middleware.handleIdempotency);
  app.use((0, _middleware.fixPythonContentType)(basePath));
  app.use(_middleware.defaultToJSONContentType);
  app.use(_bodyParser.default.urlencoded({
    extended: true
  }));
  app.use((0, _methodOverride.default)());
  app.use(_middleware.catchAllHandler);
  app.use(_bodyParser.default.json({
    limit: '1gb'
  }));
  app.use(_expressLogging.startLogFormatter);
  addRoutes(app, {
    basePath,
    extraMethodMap
  });
  app.all('/welcome', _static.welcome);
  app.all('/test/guinea-pig', _static.guineaPig);
  app.all('/test/guinea-pig-scrollable', _static.guineaPigScrollable);
  app.all('/test/guinea-pig-app-banner', _static.guineaPigAppBanner);
}

function configureHttp({
  httpServer,
  reject,
  keepAliveTimeout
}) {
  const serverState = {
    notifier: new _events.EventEmitter(),
    closed: false
  };
  httpServer.addWebSocketHandler = _websocket.addWebSocketHandler;
  httpServer.removeWebSocketHandler = _websocket.removeWebSocketHandler;
  httpServer.removeAllWebSocketHandlers = _websocket.removeAllWebSocketHandlers;
  httpServer.getWebSocketHandlers = _websocket.getWebSocketHandlers;
  const close = httpServer.close.bind(httpServer);

  httpServer.close = async () => await new _bluebird.default((resolve, reject) => {
    serverState.closed = true;
    serverState.notifier.emit('shutdown');

    _logger.default.info('Waiting until the server is closed');

    httpServer.on('close', () => {
      _logger.default.info('Received server close event');

      resolve();
    });
    close(err => {
      if (err) reject(err);
    });
  });

  httpServer.on('error', err => {
    if (err.code === 'EADDRNOTAVAIL') {
      _logger.default.error('Could not start REST http interface listener. ' + 'Requested address is not available.');
    } else {
      _logger.default.error('Could not start REST http interface listener. The requested ' + 'port may already be in use. Please make sure there is no ' + 'other instance of this server running already.');
    }

    reject(err);
  });
  httpServer.on('connection', socket => {
    socket.setTimeout(keepAliveTimeout);
    socket.on('error', reject);

    function destroy() {
      socket.destroy();
    }

    socket._openReqCount = 0;
    socket.once('close', () => serverState.notifier.removeListener('shutdown', destroy));
    serverState.notifier.once('shutdown', destroy);
  });
  httpServer.on('request', function (req, res) {
    const socket = req.connection || req.socket;
    socket._openReqCount++;
    res.on('finish', function () {
      socket._openReqCount--;

      if (serverState.closed && socket._openReqCount === 0) {
        socket.destroy();
      }
    });
  });
}

async function startServer({
  httpServer,
  port,
  hostname,
  keepAliveTimeout
}) {
  const serverArgs = [port];

  if (hostname) {
    serverArgs.push(hostname);
  }

  const startPromise = _bluebird.default.promisify(httpServer.listen, {
    context: httpServer
  })(...serverArgs);

  httpServer.keepAliveTimeout = keepAliveTimeout;
  httpServer.headersTimeout = keepAliveTimeout + 5 * 1000;
  await startPromise;
}

function normalizeBasePath(basePath) {
  if (!_lodash.default.isString(basePath)) {
    throw new Error(`Invalid path prefix ${basePath}`);
  }

  basePath = basePath.replace(/\/$/, '');

  if (basePath !== '' && basePath[0] !== '/') {
    basePath = `/${basePath}`;
  }

  return basePath;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJLRUVQX0FMSVZFX1RJTUVPVVRfTVMiLCJzZXJ2ZXIiLCJvcHRzIiwicm91dGVDb25maWd1cmluZ0Z1bmN0aW9uIiwicG9ydCIsImhvc3RuYW1lIiwiYWxsb3dDb3JzIiwiYmFzZVBhdGgiLCJERUZBVUxUX0JBU0VfUEFUSCIsImV4dHJhTWV0aG9kTWFwIiwic2VydmVyVXBkYXRlcnMiLCJrZWVwQWxpdmVUaW1lb3V0IiwiYXBwIiwiaHR0cFNlcnZlciIsImh0dHAiLCJjcmVhdGVTZXJ2ZXIiLCJCIiwicmVzb2x2ZSIsInJlamVjdCIsImNvbmZpZ3VyZUh0dHAiLCJjb25maWd1cmVTZXJ2ZXIiLCJhZGRSb3V0ZXMiLCJ1cGRhdGVyIiwiYWxsIiwiY2F0Y2g0MDRIYW5kbGVyIiwic3RhcnRTZXJ2ZXIiLCJlcnIiLCJub3JtYWxpemVCYXNlUGF0aCIsInVzZSIsImVuZExvZ0Zvcm1hdHRlciIsInBhdGgiLCJTVEFUSUNfRElSIiwiZXhwcmVzcyIsInN0YXRpYyIsInByb2R1Y2VFcnJvciIsInByb2R1Y2VDcmFzaCIsImFsbG93Q3Jvc3NEb21haW4iLCJoYW5kbGVJZGVtcG90ZW5jeSIsImRlZmF1bHRUb0pTT05Db250ZW50VHlwZSIsImJvZHlQYXJzZXIiLCJ1cmxlbmNvZGVkIiwiZXh0ZW5kZWQiLCJjYXRjaEFsbEhhbmRsZXIiLCJqc29uIiwibGltaXQiLCJzdGFydExvZ0Zvcm1hdHRlciIsIndlbGNvbWUiLCJndWluZWFQaWciLCJndWluZWFQaWdTY3JvbGxhYmxlIiwiZ3VpbmVhUGlnQXBwQmFubmVyIiwic2VydmVyU3RhdGUiLCJub3RpZmllciIsIkV2ZW50RW1pdHRlciIsImNsb3NlZCIsImFkZFdlYlNvY2tldEhhbmRsZXIiLCJyZW1vdmVXZWJTb2NrZXRIYW5kbGVyIiwicmVtb3ZlQWxsV2ViU29ja2V0SGFuZGxlcnMiLCJnZXRXZWJTb2NrZXRIYW5kbGVycyIsImNsb3NlIiwiYmluZCIsImVtaXQiLCJsb2ciLCJpbmZvIiwib24iLCJjb2RlIiwiZXJyb3IiLCJzb2NrZXQiLCJzZXRUaW1lb3V0IiwiZGVzdHJveSIsIl9vcGVuUmVxQ291bnQiLCJvbmNlIiwicmVtb3ZlTGlzdGVuZXIiLCJyZXEiLCJyZXMiLCJjb25uZWN0aW9uIiwic2VydmVyQXJncyIsInB1c2giLCJzdGFydFByb21pc2UiLCJwcm9taXNpZnkiLCJsaXN0ZW4iLCJjb250ZXh0IiwiaGVhZGVyc1RpbWVvdXQiLCJfIiwiaXNTdHJpbmciLCJFcnJvciIsInJlcGxhY2UiXSwic291cmNlcyI6WyIuLi8uLi8uLi9saWIvZXhwcmVzcy9zZXJ2ZXIuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBwYXRoIGZyb20gJ3BhdGgnO1xuaW1wb3J0IGV4cHJlc3MgZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgaHR0cCBmcm9tICdodHRwJztcbmltcG9ydCBmYXZpY29uIGZyb20gJ3NlcnZlLWZhdmljb24nO1xuaW1wb3J0IGJvZHlQYXJzZXIgZnJvbSAnYm9keS1wYXJzZXInO1xuaW1wb3J0IG1ldGhvZE92ZXJyaWRlIGZyb20gJ21ldGhvZC1vdmVycmlkZSc7XG5pbXBvcnQgbG9nIGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCB7IHN0YXJ0TG9nRm9ybWF0dGVyLCBlbmRMb2dGb3JtYXR0ZXIgfSBmcm9tICcuL2V4cHJlc3MtbG9nZ2luZyc7XG5pbXBvcnQge1xuICBhbGxvd0Nyb3NzRG9tYWluLCBmaXhQeXRob25Db250ZW50VHlwZSwgZGVmYXVsdFRvSlNPTkNvbnRlbnRUeXBlLFxuICBjYXRjaEFsbEhhbmRsZXIsIGFsbG93Q3Jvc3NEb21haW5Bc3luY0V4ZWN1dGUsIGhhbmRsZUlkZW1wb3RlbmN5LFxuICBjYXRjaDQwNEhhbmRsZXIsXG59IGZyb20gJy4vbWlkZGxld2FyZSc7XG5pbXBvcnQgeyBndWluZWFQaWcsIGd1aW5lYVBpZ1Njcm9sbGFibGUsIGd1aW5lYVBpZ0FwcEJhbm5lciwgd2VsY29tZSwgU1RBVElDX0RJUiB9IGZyb20gJy4vc3RhdGljJztcbmltcG9ydCB7IHByb2R1Y2VFcnJvciwgcHJvZHVjZUNyYXNoIH0gZnJvbSAnLi9jcmFzaCc7XG5pbXBvcnQge1xuICBhZGRXZWJTb2NrZXRIYW5kbGVyLCByZW1vdmVXZWJTb2NrZXRIYW5kbGVyLCByZW1vdmVBbGxXZWJTb2NrZXRIYW5kbGVycyxcbiAgZ2V0V2ViU29ja2V0SGFuZGxlcnNcbn0gZnJvbSAnLi93ZWJzb2NrZXQnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IHsgREVGQVVMVF9CQVNFX1BBVEggfSBmcm9tICcuLi9jb25zdGFudHMnO1xuaW1wb3J0IHsgRXZlbnRFbWl0dGVyIH0gZnJvbSAnZXZlbnRzJztcblxuXG5jb25zdCBLRUVQX0FMSVZFX1RJTUVPVVRfTVMgPSAxMCAqIDYwICogMTAwMDsgLy8gMTAgbWludXRlc1xuXG5cbmFzeW5jIGZ1bmN0aW9uIHNlcnZlciAob3B0cyA9IHt9KSB7XG4gIGNvbnN0IHtcbiAgICByb3V0ZUNvbmZpZ3VyaW5nRnVuY3Rpb24sXG4gICAgcG9ydCxcbiAgICBob3N0bmFtZSA9IG51bGwsXG4gICAgYWxsb3dDb3JzID0gdHJ1ZSxcbiAgICBiYXNlUGF0aCA9IERFRkFVTFRfQkFTRV9QQVRILFxuICAgIGV4dHJhTWV0aG9kTWFwID0ge30sXG4gICAgc2VydmVyVXBkYXRlcnMgPSBbXSxcbiAgICBrZWVwQWxpdmVUaW1lb3V0ID0gS0VFUF9BTElWRV9USU1FT1VUX01TLFxuICB9ID0gb3B0cztcblxuICAvLyBjcmVhdGUgdGhlIGFjdHVhbCBodHRwIHNlcnZlclxuICBjb25zdCBhcHAgPSBleHByZXNzKCk7XG4gIGNvbnN0IGh0dHBTZXJ2ZXIgPSBodHRwLmNyZWF0ZVNlcnZlcihhcHApO1xuICByZXR1cm4gYXdhaXQgbmV3IEIoYXN5bmMgKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgIC8vIHdlIHB1dCBhbiBhc3luYyBmdW5jdGlvbiBhcyB0aGUgcHJvbWlzZSBjb25zdHJ1Y3RvciBiZWNhdXNlIHdlIHdhbnQgc29tZSB0aGluZ3MgdG8gaGFwcGVuIGluXG4gICAgLy8gc2VyaWFsIChhcHBsaWNhdGlvbiBvZiBwbHVnaW4gdXBkYXRlcywgZm9yIGV4YW1wbGUpLiBCdXQgd2Ugc3RpbGwgbmVlZCB0byB1c2UgYSBwcm9taXNlIGhlcmVcbiAgICAvLyBiZWNhdXNlIHNvbWUgZWxlbWVudHMgb2Ygc2VydmVyIHN0YXJ0IGZhaWx1cmUgb25seSBoYXBwZW4gaW4gaHR0cFNlcnZlciBsaXN0ZW5lcnMuIFNvIHRoZVxuICAgIC8vIHdheSB3ZSByZXNvbHZlIGl0IGlzIHRvIHVzZSBhbiBhc3luYyBmdW5jdGlvbiBoZXJlIGJ1dCB0byB3cmFwIGFsbCB0aGUgaW5uZXIgbG9naWMgaW5cbiAgICAvLyB0cnkvY2F0Y2ggc28gYW55IGVycm9ycyBjYW4gYmUgcGFzc2VkIHRvIHJlamVjdC5cbiAgICB0cnkge1xuICAgICAgY29uZmlndXJlSHR0cCh7aHR0cFNlcnZlciwgcmVqZWN0LCBrZWVwQWxpdmVUaW1lb3V0fSk7XG4gICAgICBjb25maWd1cmVTZXJ2ZXIoe2FwcCwgYWRkUm91dGVzOiByb3V0ZUNvbmZpZ3VyaW5nRnVuY3Rpb24sIGFsbG93Q29ycywgYmFzZVBhdGgsIGV4dHJhTWV0aG9kTWFwfSk7XG4gICAgICAvLyBhbGxvdyBleHRlbnNpb25zIHRvIHVwZGF0ZSB0aGUgYXBwIGFuZCBodHRwIHNlcnZlciBvYmplY3RzXG4gICAgICBmb3IgKGNvbnN0IHVwZGF0ZXIgb2Ygc2VydmVyVXBkYXRlcnMpIHtcbiAgICAgICAgYXdhaXQgdXBkYXRlcihhcHAsIGh0dHBTZXJ2ZXIpO1xuICAgICAgfVxuXG4gICAgICAvLyBvbmNlIGFsbCBjb25maWd1cmF0aW9ucyBhbmQgdXBkYXRlcnMgaGF2ZSBiZWVuIGFwcGxpZWQsIG1ha2Ugc3VyZSB0byBzZXQgdXAgYSBjYXRjaGFsbFxuICAgICAgLy8gaGFuZGxlciBzbyB0aGF0IGFueXRoaW5nIHVua25vd24gNDA0cy4gQnV0IGRvIHRoaXMgYWZ0ZXIgZXZlcnl0aGluZyBlbHNlIHNpbmNlIHdlIGRvbid0XG4gICAgICAvLyB3YW50IHRvIGJsb2NrIGV4dGVuc2lvbnMnIGFiaWxpdHkgdG8gYWRkIHJvdXRlcyBpZiB0aGV5IHdhbnQuXG4gICAgICBhcHAuYWxsKCcqJywgY2F0Y2g0MDRIYW5kbGVyKTtcblxuICAgICAgYXdhaXQgc3RhcnRTZXJ2ZXIoe2h0dHBTZXJ2ZXIsIGhvc3RuYW1lLCBwb3J0LCBrZWVwQWxpdmVUaW1lb3V0fSk7XG4gICAgICByZXNvbHZlKGh0dHBTZXJ2ZXIpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgcmVqZWN0KGVycik7XG4gICAgfVxuICB9KTtcblxufVxuXG5mdW5jdGlvbiBjb25maWd1cmVTZXJ2ZXIgKHtcbiAgYXBwLFxuICBhZGRSb3V0ZXMsXG4gIGFsbG93Q29ycyA9IHRydWUsXG4gIGJhc2VQYXRoID0gREVGQVVMVF9CQVNFX1BBVEgsXG4gIGV4dHJhTWV0aG9kTWFwID0ge30sXG59KSB7XG4gIGJhc2VQYXRoID0gbm9ybWFsaXplQmFzZVBhdGgoYmFzZVBhdGgpO1xuXG4gIGFwcC51c2UoZW5kTG9nRm9ybWF0dGVyKTtcblxuICAvLyBzZXQgdXAgc3RhdGljIGFzc2V0c1xuICBhcHAudXNlKGZhdmljb24ocGF0aC5yZXNvbHZlKFNUQVRJQ19ESVIsICdmYXZpY29uLmljbycpKSk7XG4gIGFwcC51c2UoZXhwcmVzcy5zdGF0aWMoU1RBVElDX0RJUikpO1xuXG4gIC8vIGNyYXNoIHJvdXRlcywgZm9yIHRlc3RpbmdcbiAgYXBwLnVzZShgJHtiYXNlUGF0aH0vcHJvZHVjZV9lcnJvcmAsIHByb2R1Y2VFcnJvcik7XG4gIGFwcC51c2UoYCR7YmFzZVBhdGh9L2NyYXNoYCwgcHJvZHVjZUNyYXNoKTtcblxuICAvLyBhZGQgbWlkZGxld2FyZXNcbiAgaWYgKGFsbG93Q29ycykge1xuICAgIGFwcC51c2UoYWxsb3dDcm9zc0RvbWFpbik7XG4gIH0gZWxzZSB7XG4gICAgYXBwLnVzZShhbGxvd0Nyb3NzRG9tYWluQXN5bmNFeGVjdXRlKGJhc2VQYXRoKSk7XG4gIH1cbiAgYXBwLnVzZShoYW5kbGVJZGVtcG90ZW5jeSk7XG4gIGFwcC51c2UoZml4UHl0aG9uQ29udGVudFR5cGUoYmFzZVBhdGgpKTtcbiAgYXBwLnVzZShkZWZhdWx0VG9KU09OQ29udGVudFR5cGUpO1xuICBhcHAudXNlKGJvZHlQYXJzZXIudXJsZW5jb2RlZCh7ZXh0ZW5kZWQ6IHRydWV9KSk7XG4gIGFwcC51c2UobWV0aG9kT3ZlcnJpZGUoKSk7XG4gIGFwcC51c2UoY2F0Y2hBbGxIYW5kbGVyKTtcblxuICAvLyBtYWtlIHN1cmUgYXBwaXVtIG5ldmVyIGZhaWxzIGJlY2F1c2Ugb2YgYSBmaWxlIHNpemUgdXBsb2FkIGxpbWl0XG4gIGFwcC51c2UoYm9keVBhcnNlci5qc29uKHtsaW1pdDogJzFnYid9KSk7XG5cbiAgLy8gc2V0IHVwIHN0YXJ0IGxvZ2dpbmcgKHdoaWNoIGRlcGVuZHMgb24gYm9keVBhcnNlciBkb2luZyBpdHMgdGhpbmcpXG4gIGFwcC51c2Uoc3RhcnRMb2dGb3JtYXR0ZXIpO1xuXG4gIGFkZFJvdXRlcyhhcHAsIHtiYXNlUGF0aCwgZXh0cmFNZXRob2RNYXB9KTtcblxuICAvLyBkeW5hbWljIHJvdXRlcyBmb3IgdGVzdGluZywgZXRjLlxuICBhcHAuYWxsKCcvd2VsY29tZScsIHdlbGNvbWUpO1xuICBhcHAuYWxsKCcvdGVzdC9ndWluZWEtcGlnJywgZ3VpbmVhUGlnKTtcbiAgYXBwLmFsbCgnL3Rlc3QvZ3VpbmVhLXBpZy1zY3JvbGxhYmxlJywgZ3VpbmVhUGlnU2Nyb2xsYWJsZSk7XG4gIGFwcC5hbGwoJy90ZXN0L2d1aW5lYS1waWctYXBwLWJhbm5lcicsIGd1aW5lYVBpZ0FwcEJhbm5lcik7XG59XG5cbmZ1bmN0aW9uIGNvbmZpZ3VyZUh0dHAgKHtodHRwU2VydmVyLCByZWplY3QsIGtlZXBBbGl2ZVRpbWVvdXR9KSB7XG4gIGNvbnN0IHNlcnZlclN0YXRlID0ge1xuICAgIG5vdGlmaWVyOiBuZXcgRXZlbnRFbWl0dGVyKCksXG4gICAgY2xvc2VkOiBmYWxzZSxcbiAgfTtcbiAgaHR0cFNlcnZlci5hZGRXZWJTb2NrZXRIYW5kbGVyID0gYWRkV2ViU29ja2V0SGFuZGxlcjtcbiAgaHR0cFNlcnZlci5yZW1vdmVXZWJTb2NrZXRIYW5kbGVyID0gcmVtb3ZlV2ViU29ja2V0SGFuZGxlcjtcbiAgaHR0cFNlcnZlci5yZW1vdmVBbGxXZWJTb2NrZXRIYW5kbGVycyA9IHJlbW92ZUFsbFdlYlNvY2tldEhhbmRsZXJzO1xuICBodHRwU2VydmVyLmdldFdlYlNvY2tldEhhbmRsZXJzID0gZ2V0V2ViU29ja2V0SGFuZGxlcnM7XG5cbiAgLy8gaHR0cC5TZXJ2ZXIuY2xvc2UoKSBvbmx5IHN0b3BzIG5ldyBjb25uZWN0aW9ucywgYnV0IHdlIG5lZWQgdG8gd2FpdCB1bnRpbFxuICAvLyBhbGwgY29ubmVjdGlvbnMgYXJlIGNsb3NlZCBhbmQgdGhlIGBjbG9zZWAgZXZlbnQgaXMgZW1pdHRlZFxuICBjb25zdCBjbG9zZSA9IGh0dHBTZXJ2ZXIuY2xvc2UuYmluZChodHRwU2VydmVyKTtcbiAgaHR0cFNlcnZlci5jbG9zZSA9IGFzeW5jICgpID0+IGF3YWl0IG5ldyBCKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAvLyBodHRwczovL2dpdGh1Yi5jb20vbm9kZWpzL25vZGUtdjAueC1hcmNoaXZlL2lzc3Vlcy85MDY2I2lzc3VlY29tbWVudC0xMjQyMTA1NzZcbiAgICBzZXJ2ZXJTdGF0ZS5jbG9zZWQgPSB0cnVlO1xuICAgIHNlcnZlclN0YXRlLm5vdGlmaWVyLmVtaXQoJ3NodXRkb3duJyk7XG4gICAgbG9nLmluZm8oJ1dhaXRpbmcgdW50aWwgdGhlIHNlcnZlciBpcyBjbG9zZWQnKTtcbiAgICBodHRwU2VydmVyLm9uKCdjbG9zZScsICgpID0+IHtcbiAgICAgIGxvZy5pbmZvKCdSZWNlaXZlZCBzZXJ2ZXIgY2xvc2UgZXZlbnQnKTtcbiAgICAgIHJlc29sdmUoKTtcbiAgICB9KTtcbiAgICBjbG9zZSgoZXJyKSA9PiB7XG4gICAgICBpZiAoZXJyKSByZWplY3QoZXJyKTsgLy8gZXNsaW50LWRpc2FibGUtbGluZSBjdXJseVxuICAgIH0pO1xuICB9KTtcblxuICBodHRwU2VydmVyLm9uKCdlcnJvcicsIChlcnIpID0+IHtcbiAgICBpZiAoZXJyLmNvZGUgPT09ICdFQUREUk5PVEFWQUlMJykge1xuICAgICAgbG9nLmVycm9yKCdDb3VsZCBub3Qgc3RhcnQgUkVTVCBodHRwIGludGVyZmFjZSBsaXN0ZW5lci4gJyArXG4gICAgICAgICAgICAgICAgJ1JlcXVlc3RlZCBhZGRyZXNzIGlzIG5vdCBhdmFpbGFibGUuJyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGxvZy5lcnJvcignQ291bGQgbm90IHN0YXJ0IFJFU1QgaHR0cCBpbnRlcmZhY2UgbGlzdGVuZXIuIFRoZSByZXF1ZXN0ZWQgJyArXG4gICAgICAgICAgICAgICAgJ3BvcnQgbWF5IGFscmVhZHkgYmUgaW4gdXNlLiBQbGVhc2UgbWFrZSBzdXJlIHRoZXJlIGlzIG5vICcgK1xuICAgICAgICAgICAgICAgICdvdGhlciBpbnN0YW5jZSBvZiB0aGlzIHNlcnZlciBydW5uaW5nIGFscmVhZHkuJyk7XG4gICAgfVxuICAgIHJlamVjdChlcnIpO1xuICB9KTtcblxuICBodHRwU2VydmVyLm9uKCdjb25uZWN0aW9uJywgKHNvY2tldCkgPT4ge1xuICAgIHNvY2tldC5zZXRUaW1lb3V0KGtlZXBBbGl2ZVRpbWVvdXQpO1xuICAgIHNvY2tldC5vbignZXJyb3InLCByZWplY3QpO1xuXG4gICAgZnVuY3Rpb24gZGVzdHJveSAoKSB7XG4gICAgICBzb2NrZXQuZGVzdHJveSgpO1xuICAgIH1cbiAgICBzb2NrZXQuX29wZW5SZXFDb3VudCA9IDA7XG4gICAgc29ja2V0Lm9uY2UoJ2Nsb3NlJywgKCkgPT4gc2VydmVyU3RhdGUubm90aWZpZXIucmVtb3ZlTGlzdGVuZXIoJ3NodXRkb3duJywgZGVzdHJveSkpO1xuICAgIHNlcnZlclN0YXRlLm5vdGlmaWVyLm9uY2UoJ3NodXRkb3duJywgZGVzdHJveSk7XG4gIH0pO1xuXG4gIGh0dHBTZXJ2ZXIub24oJ3JlcXVlc3QnLCBmdW5jdGlvbiAocmVxLCByZXMpIHtcbiAgICBjb25zdCBzb2NrZXQgPSByZXEuY29ubmVjdGlvbiB8fCByZXEuc29ja2V0O1xuICAgIHNvY2tldC5fb3BlblJlcUNvdW50Kys7XG4gICAgcmVzLm9uKCdmaW5pc2gnLCBmdW5jdGlvbiAoKSB7XG4gICAgICBzb2NrZXQuX29wZW5SZXFDb3VudC0tO1xuICAgICAgaWYgKHNlcnZlclN0YXRlLmNsb3NlZCAmJiBzb2NrZXQuX29wZW5SZXFDb3VudCA9PT0gMCkge1xuICAgICAgICBzb2NrZXQuZGVzdHJveSgpO1xuICAgICAgfVxuICAgIH0pO1xuICB9KTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc3RhcnRTZXJ2ZXIgKHtodHRwU2VydmVyLCBwb3J0LCBob3N0bmFtZSwga2VlcEFsaXZlVGltZW91dH0pIHtcbiAgY29uc3Qgc2VydmVyQXJncyA9IFtwb3J0XTtcbiAgaWYgKGhvc3RuYW1lKSB7XG4gICAgLy8gSWYgdGhlIGhvc3RuYW1lIGlzIG9taXR0ZWQsIHRoZSBzZXJ2ZXIgd2lsbCBhY2NlcHRcbiAgICAvLyBjb25uZWN0aW9ucyBvbiBhbnkgSVAgYWRkcmVzc1xuICAgIHNlcnZlckFyZ3MucHVzaChob3N0bmFtZSk7XG4gIH1cbiAgY29uc3Qgc3RhcnRQcm9taXNlID0gQi5wcm9taXNpZnkoaHR0cFNlcnZlci5saXN0ZW4sIHtjb250ZXh0OiBodHRwU2VydmVyfSkoLi4uc2VydmVyQXJncyk7XG4gIGh0dHBTZXJ2ZXIua2VlcEFsaXZlVGltZW91dCA9IGtlZXBBbGl2ZVRpbWVvdXQ7XG4gIC8vIGhlYWRlcnMgdGltZW91dCBtdXN0IGJlIGdyZWF0ZXIgdGhhbiBrZWVwQWxpdmVUaW1lb3V0XG4gIGh0dHBTZXJ2ZXIuaGVhZGVyc1RpbWVvdXQgPSBrZWVwQWxpdmVUaW1lb3V0ICsgNSAqIDEwMDA7XG4gIGF3YWl0IHN0YXJ0UHJvbWlzZTtcbn1cblxuZnVuY3Rpb24gbm9ybWFsaXplQmFzZVBhdGggKGJhc2VQYXRoKSB7XG4gIGlmICghXy5pc1N0cmluZyhiYXNlUGF0aCkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgcGF0aCBwcmVmaXggJHtiYXNlUGF0aH1gKTtcbiAgfVxuXG4gIC8vIGVuc3VyZSB0aGUgcGF0aCBwcmVmaXggZG9lcyBub3QgZW5kIGluICcvJywgc2luY2Ugb3VyIG1ldGhvZCBtYXBcbiAgLy8gc3RhcnRzIGFsbCBwYXRocyB3aXRoICcvJ1xuICBiYXNlUGF0aCA9IGJhc2VQYXRoLnJlcGxhY2UoL1xcLyQvLCAnJyk7XG5cbiAgLy8gbGlrZXdpc2UsIGVuc3VyZSB0aGUgcGF0aCBwcmVmaXggZG9lcyBhbHdheXMgU1RBUlQgd2l0aCAvLCB1bmxlc3MgdGhlIHBhdGhcbiAgLy8gaXMgZW1wdHkgbWVhbmluZyBubyBiYXNlIHBhdGggYXQgYWxsXG4gIGlmIChiYXNlUGF0aCAhPT0gJycgJiYgYmFzZVBhdGhbMF0gIT09ICcvJykge1xuICAgIGJhc2VQYXRoID0gYC8ke2Jhc2VQYXRofWA7XG4gIH1cblxuICByZXR1cm4gYmFzZVBhdGg7XG59XG5cbmV4cG9ydCB7IHNlcnZlciwgY29uZmlndXJlU2VydmVyLCBub3JtYWxpemVCYXNlUGF0aCB9O1xuIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBS0E7O0FBQ0E7O0FBQ0E7O0FBSUE7O0FBQ0E7O0FBQ0E7O0FBR0EsTUFBTUEscUJBQXFCLEdBQUcsS0FBSyxFQUFMLEdBQVUsSUFBeEM7O0FBR0EsZUFBZUMsTUFBZixDQUF1QkMsSUFBSSxHQUFHLEVBQTlCLEVBQWtDO0VBQ2hDLE1BQU07SUFDSkMsd0JBREk7SUFFSkMsSUFGSTtJQUdKQyxRQUFRLEdBQUcsSUFIUDtJQUlKQyxTQUFTLEdBQUcsSUFKUjtJQUtKQyxRQUFRLEdBQUdDLDRCQUxQO0lBTUpDLGNBQWMsR0FBRyxFQU5iO0lBT0pDLGNB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