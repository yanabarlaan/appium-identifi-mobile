"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _support = require("@appium/support");

var _path = _interopRequireDefault(require("path"));

var _appiumIosDevice = require("appium-ios-device");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _logger = _interopRequireDefault(require("./logger"));

var _lodash = _interopRequireDefault(require("lodash"));

var _teen_process = require("teen_process");

var _appUtils = require("./app-utils");

var _iosFsHelpers = require("./ios-fs-helpers");

const APPLICATION_INSTALLED_NOTIFICATION = 'com.apple.mobile.application_installed';
const INSTALLATION_STAGING_DIR = 'PublicStaging';
const APPLICATION_NOTIFICATION_TIMEOUT_MS = 30 * 1000;
const IOS_DEPLOY_TIMEOUT_MS = 4 * 60 * 1000;
const IOS_DEPLOY = 'ios-deploy';
const APP_INSTALL_STRATEGY = Object.freeze({
  SERIAL: 'serial',
  PARALLEL: 'parallel',
  IOS_DEPLOY
});

class IOSDeploy {
  constructor(udid) {
    this.udid = udid;
  }

  async remove(bundleid) {
    const service = await _appiumIosDevice.services.startInstallationProxyService(this.udid);

    try {
      await service.uninstallApplication(bundleid);
    } finally {
      service.close();
    }
  }

  async removeApp(bundleId) {
    await this.remove(bundleId);
  }

  async install(app, timeout, strategy = null) {
    if (strategy && !_lodash.default.values(APP_INSTALL_STRATEGY).includes(_lodash.default.toLower(strategy))) {
      throw new Error(`App installation strategy '${strategy}' is unknown. ` + `Only the following strategies are supported: ${_lodash.default.values(APP_INSTALL_STRATEGY)}`);
    }

    _logger.default.debug(`Using '${strategy !== null && strategy !== void 0 ? strategy : APP_INSTALL_STRATEGY.SERIAL}' app deployment strategy. ` + `You could change it by providing another value to the 'appInstallStrategy' capability`);

    const installWithIosDeploy = async () => {
      try {
        await _support.fs.which(IOS_DEPLOY);
      } catch (err) {
        throw new Error(`'${IOS_DEPLOY}' utility has not been found in PATH. Is it installed?`);
      }

      try {
        await (0, _teen_process.exec)(IOS_DEPLOY, ['--id', this.udid, '--bundle', app], {
          timeout: timeout !== null && timeout !== void 0 ? timeout : IOS_DEPLOY_TIMEOUT_MS
        });
      } catch (err) {
        throw new Error(err.stderr || err.stdout || err.message);
      }
    };

    const timer = new _support.timing.Timer().start();

    if (_lodash.default.toLower(strategy) === APP_INSTALL_STRATEGY.IOS_DEPLOY) {
      await installWithIosDeploy();
    } else {
      const afcService = await _appiumIosDevice.services.startAfcService(this.udid);

      try {
        const bundleId = await (0, _appUtils.extractBundleId)(app);

        const bundlePathOnPhone = _path.default.join(INSTALLATION_STAGING_DIR, bundleId);

        await (0, _iosFsHelpers.pushFolder)(afcService, app, bundlePathOnPhone, {
          timeoutMs: timeout,
          enableParallelPush: _lodash.default.toLower(strategy) === APP_INSTALL_STRATEGY.PARALLEL
        });
        await this.installOrUpgradeApplication(bundlePathOnPhone, await this.isAppInstalled(bundleId));
      } catch (err) {
        _logger.default.warn(`Error installing app '${app}': ${err.message}`);

        if (err instanceof _bluebird.default.TimeoutError) {
          _logger.default.warn(`Consider increasing the value of 'appPushTimeout' capability`);
        }

        _logger.default.warn(`Falling back to '${IOS_DEPLOY}' usage`);

        try {
          await installWithIosDeploy();
        } catch (err1) {
          throw new Error(`Could not install '${app}':\n` + `  - ${err.message}\n` + `  - ${err1.message}`);
        }
      } finally {
        afcService.close();
      }
    }

    _logger.default.info(`App installation succeeded after ${timer.getDuration().asMilliSeconds.toFixed(0)}ms`);
  }

  async installOrUpgradeApplication(bundlePathOnPhone, isUpgrade = false) {
    const notificationService = await _appiumIosDevice.services.startNotificationProxyService(this.udid);
    const installationService = await _appiumIosDevice.services.startInstallationProxyService(this.udid);
    const appInstalledNotification = new _bluebird.default(resolve => {
      notificationService.observeNotification(APPLICATION_INSTALLED_NOTIFICATION, {
        notification: resolve
      });
    });
    const clientOptions = {
      PackageType: 'Developer'
    };

    try {
      if (isUpgrade) {
        _logger.default.debug(`An upgrade of the existing application is going to be performed`);

        await installationService.upgradeApplication(bundlePathOnPhone, clientOptions);
      } else {
        _logger.default.debug(`A new application installation is going to be performed`);

        await installationService.installApplication(bundlePathOnPhone, clientOptions);
      }

      try {
        await appInstalledNotification.timeout(APPLICATION_NOTIFICATION_TIMEOUT_MS, `Could not get the application installed notification within ` + `${APPLICATION_NOTIFICATION_TIMEOUT_MS}ms but we will continue`);
      } catch (e) {
        _logger.default.warn(`Failed to receive the notification. Error: ${e.message}`);
      }
    } finally {
      installationService.close();
      notificationService.close();
    }
  }

  async installApp(...args) {
    return await this.install(...args);
  }

  async isAppInstalled(bundleid) {
    const service = await _appiumIosDevice.services.startInstallationProxyService(this.udid);

    try {
      const applications = await service.lookupApplications({
        bundleIds: bundleid
      });
      return !!applications[bundleid];
    } finally {
      service.close();
    }
  }

  async getUserInstalledBundleIdsByBundleName(bundleName) {
    const service = await _appiumIosDevice.services.startInstallationProxyService(this.udid);

    try {
      const applications = await service.listApplications({
        applicationType: 'User'
      });
      return _lodash.default.reduce(applications, (acc, {
        CFBundleName
      }, key) => {
        if (CFBundleName === bundleName) {
          acc.push(key);
        }

        return acc;
      }, []);
    } finally {
      service.close();
    }
  }

  async getPlatformVersion() {
    return await _appiumIosDevice.utilities.getOSVersion(this.udid);
  }

}

var _default = IOSDeploy;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGliL2lvcy1kZXBsb3kuanMiLCJuYW1lcyI6WyJBUFBMSUNBVElPTl9JTlNUQUxMRURfTk9USUZJQ0FUSU9OIiwiSU5TVEFMTEFUSU9OX1NUQUdJTkdfRElSIiwiQVBQTElDQVRJT05fTk9USUZJQ0FUSU9OX1RJTUVPVVRfTVMiLCJJT1NfREVQTE9ZX1RJTUVPVVRfTVMiLCJJT1NfREVQTE9ZIiwiQVBQX0lOU1RBTExfU1RSQVRFR1kiLCJPYmplY3QiLCJmcmVlemUiLCJTRVJJQUwiLCJQQVJBTExFTCIsIklPU0RlcGxveSIsImNvbnN0cnVjdG9yIiwidWRpZCIsInJlbW92ZSIsImJ1bmRsZWlkIiwic2VydmljZSIsInNlcnZpY2VzIiwic3RhcnRJbnN0YWxsYXRpb25Qcm94eVNlcnZpY2UiLCJ1bmluc3RhbGxBcHBsaWNhdGlvbiIsImNsb3NlIiwicmVtb3ZlQXBwIiwiYnVuZGxlSWQiLCJpbnN0YWxsIiwiYXBwIiwidGltZW91dCIsInN0cmF0ZWd5IiwiXyIsInZhbHVlcyIsImluY2x1ZGVzIiwidG9Mb3dlciIsIkVycm9yIiwibG9nIiwiZGVidWciLCJpbnN0YWxsV2l0aElvc0RlcGxveSIsImZzIiwid2hpY2giLCJlcnIiLCJleGVjIiwic3RkZXJyIiwic3Rkb3V0IiwibWVzc2FnZSIsInRpbWVyIiwidGltaW5nIiwiVGltZXIiLCJzdGFydCIsImFmY1NlcnZpY2UiLCJzdGFydEFmY1NlcnZpY2UiLCJleHRyYWN0QnVuZGxlSWQiLCJidW5kbGVQYXRoT25QaG9uZSIsInBhdGgiLCJqb2luIiwicHVzaEZvbGRlciIsInRpbWVvdXRNcyIsImVuYWJsZVBhcmFsbGVsUHVzaCIsImluc3RhbGxPclVwZ3JhZGVBcHBsaWNhdGlvbiIsImlzQXBwSW5zdGFsbGVkIiwid2FybiIsIkIiLCJUaW1lb3V0RXJyb3IiLCJlcnIxIiwiaW5mbyIsImdldER1cmF0aW9uIiwiYXNNaWxsaVNlY29uZHMiLCJ0b0ZpeGVkIiwiaXNVcGdyYWRlIiwibm90aWZpY2F0aW9uU2VydmljZSIsInN0YXJ0Tm90aWZpY2F0aW9uUHJveHlTZXJ2aWNlIiwiaW5zdGFsbGF0aW9uU2VydmljZSIsImFwcEluc3RhbGxlZE5vdGlmaWNhdGlvbiIsInJlc29sdmUiLCJvYnNlcnZlTm90aWZpY2F0aW9uIiwibm90aWZpY2F0aW9uIiwiY2xpZW50T3B0aW9ucyIsIlBhY2thZ2VUeXBlIiwidXBncmFkZUFwcGxpY2F0aW9uIiwiaW5zdGFsbEFwcGxpY2F0aW9uIiwiZSIsImluc3RhbGxBcHAiLCJhcmdzIiwiYXBwbGljYXRpb25zIiwibG9va3VwQXBwbGljYXRpb25zIiwiYnVuZGxlSWRzIiwiZ2V0VXNlckluc3RhbGxlZEJ1bmRsZUlkc0J5QnVuZGxlTmFtZSIsImJ1bmRsZU5hbWUiLCJsaXN0QXBwbGljYXRpb25zIiwiYXBwbGljYXRpb25UeXBlIiwicmVkdWNlIiwiYWNjIiwiQ0ZCdW5kbGVOYW1lIiwia2V5IiwicHVzaCIsImdldFBsYXRmb3JtVmVyc2lvbiIsInV0aWxpdGllcyIsImdldE9TVmVyc2lvbiJdLCJzb3VyY2VSb290IjoiLi4vLi4iLCJzb3VyY2VzIjpbImxpYi9pb3MtZGVwbG95LmpzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGZzLCB0aW1pbmcgfSBmcm9tICdAYXBwaXVtL3N1cHBvcnQnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBzZXJ2aWNlcywgdXRpbGl0aWVzIH0gZnJvbSAnYXBwaXVtLWlvcy1kZXZpY2UnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IHsgZXhlYyB9IGZyb20gJ3RlZW5fcHJvY2Vzcyc7XG5pbXBvcnQgeyBleHRyYWN0QnVuZGxlSWQgfSBmcm9tICcuL2FwcC11dGlscyc7XG5pbXBvcnQgeyBwdXNoRm9sZGVyIH0gZnJvbSAnLi9pb3MtZnMtaGVscGVycyc7XG5cbmNvbnN0IEFQUExJQ0FUSU9OX0lOU1RBTExFRF9OT1RJRklDQVRJT04gPSAnY29tLmFwcGxlLm1vYmlsZS5hcHBsaWNhdGlvbl9pbnN0YWxsZWQnO1xuY29uc3QgSU5TVEFMTEFUSU9OX1NUQUdJTkdfRElSID0gJ1B1YmxpY1N0YWdpbmcnO1xuY29uc3QgQVBQTElDQVRJT05fTk9USUZJQ0FUSU9OX1RJTUVPVVRfTVMgPSAzMCAqIDEwMDA7XG5jb25zdCBJT1NfREVQTE9ZX1RJTUVPVVRfTVMgPSA0ICogNjAgKiAxMDAwO1xuY29uc3QgSU9TX0RFUExPWSA9ICdpb3MtZGVwbG95JztcbmNvbnN0IEFQUF9JTlNUQUxMX1NUUkFURUdZID0gT2JqZWN0LmZyZWV6ZSh7XG4gIFNFUklBTDogJ3NlcmlhbCcsXG4gIFBBUkFMTEVMOiAncGFyYWxsZWwnLFxuICBJT1NfREVQTE9ZLFxufSk7XG5cblxuY2xhc3MgSU9TRGVwbG95IHtcblxuICBjb25zdHJ1Y3RvciAodWRpZCkge1xuICAgIHRoaXMudWRpZCA9IHVkaWQ7XG4gIH1cblxuICBhc3luYyByZW1vdmUgKGJ1bmRsZWlkKSB7XG4gICAgY29uc3Qgc2VydmljZSA9IGF3YWl0IHNlcnZpY2VzLnN0YXJ0SW5zdGFsbGF0aW9uUHJveHlTZXJ2aWNlKHRoaXMudWRpZCk7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IHNlcnZpY2UudW5pbnN0YWxsQXBwbGljYXRpb24oYnVuZGxlaWQpO1xuICAgIH0gZmluYWxseSB7XG4gICAgICBzZXJ2aWNlLmNsb3NlKCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgcmVtb3ZlQXBwIChidW5kbGVJZCkge1xuICAgIGF3YWl0IHRoaXMucmVtb3ZlKGJ1bmRsZUlkKTtcbiAgfVxuXG4gIGFzeW5jIGluc3RhbGwgKGFwcCwgdGltZW91dCwgc3RyYXRlZ3kgPSBudWxsKSB7XG4gICAgaWYgKHN0cmF0ZWd5ICYmICFfLnZhbHVlcyhBUFBfSU5TVEFMTF9TVFJBVEVHWSkuaW5jbHVkZXMoXy50b0xvd2VyKHN0cmF0ZWd5KSkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgQXBwIGluc3RhbGxhdGlvbiBzdHJhdGVneSAnJHtzdHJhdGVneX0nIGlzIHVua25vd24uIGAgK1xuICAgICAgICBgT25seSB0aGUgZm9sbG93aW5nIHN0cmF0ZWdpZXMgYXJlIHN1cHBvcnRlZDogJHtfLnZhbHVlcyhBUFBfSU5TVEFMTF9TVFJBVEVHWSl9YCk7XG4gICAgfVxuICAgIGxvZy5kZWJ1ZyhgVXNpbmcgJyR7c3RyYXRlZ3kgPz8gQVBQX0lOU1RBTExfU1RSQVRFR1kuU0VSSUFMfScgYXBwIGRlcGxveW1lbnQgc3RyYXRlZ3kuIGAgK1xuICAgICAgYFlvdSBjb3VsZCBjaGFuZ2UgaXQgYnkgcHJvdmlkaW5nIGFub3RoZXIgdmFsdWUgdG8gdGhlICdhcHBJbnN0YWxsU3RyYXRlZ3knIGNhcGFiaWxpdHlgKTtcblxuICAgIGNvbnN0IGluc3RhbGxXaXRoSW9zRGVwbG95ID0gYXN5bmMgKCkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgZnMud2hpY2goSU9TX0RFUExPWSk7XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGAnJHtJT1NfREVQTE9ZfScgdXRpbGl0eSBoYXMgbm90IGJlZW4gZm91bmQgaW4gUEFUSC4gSXMgaXQgaW5zdGFsbGVkP2ApO1xuICAgICAgfVxuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgZXhlYyhJT1NfREVQTE9ZLCBbXG4gICAgICAgICAgJy0taWQnLCB0aGlzLnVkaWQsXG4gICAgICAgICAgJy0tYnVuZGxlJywgYXBwLFxuICAgICAgICBdLCB7dGltZW91dDogdGltZW91dCA/PyBJT1NfREVQTE9ZX1RJTUVPVVRfTVN9KTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoZXJyLnN0ZGVyciB8fCBlcnIuc3Rkb3V0IHx8IGVyci5tZXNzYWdlKTtcbiAgICAgIH1cbiAgICB9O1xuXG4gICAgY29uc3QgdGltZXIgPSBuZXcgdGltaW5nLlRpbWVyKCkuc3RhcnQoKTtcbiAgICBpZiAoXy50b0xvd2VyKHN0cmF0ZWd5KSA9PT0gQVBQX0lOU1RBTExfU1RSQVRFR1kuSU9TX0RFUExPWSkge1xuICAgICAgYXdhaXQgaW5zdGFsbFdpdGhJb3NEZXBsb3koKTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgYWZjU2VydmljZSA9IGF3YWl0IHNlcnZpY2VzLnN0YXJ0QWZjU2VydmljZSh0aGlzLnVkaWQpO1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgYnVuZGxlSWQgPSBhd2FpdCBleHRyYWN0QnVuZGxlSWQoYXBwKTtcbiAgICAgICAgY29uc3QgYnVuZGxlUGF0aE9uUGhvbmUgPSBwYXRoLmpvaW4oSU5TVEFMTEFUSU9OX1NUQUdJTkdfRElSLCBidW5kbGVJZCk7XG4gICAgICAgIGF3YWl0IHB1c2hGb2xkZXIoYWZjU2VydmljZSwgYXBwLCBidW5kbGVQYXRoT25QaG9uZSwge1xuICAgICAgICAgIHRpbWVvdXRNczogdGltZW91dCxcbiAgICAgICAgICBlbmFibGVQYXJhbGxlbFB1c2g6IF8udG9Mb3dlcihzdHJhdGVneSkgPT09IEFQUF9JTlNUQUxMX1NUUkFURUdZLlBBUkFMTEVMLFxuICAgICAgICB9KTtcbiAgICAgICAgYXdhaXQgdGhpcy5pbnN0YWxsT3JVcGdyYWRlQXBwbGljYXRpb24oYnVuZGxlUGF0aE9uUGhvbmUsIGF3YWl0IHRoaXMuaXNBcHBJbnN0YWxsZWQoYnVuZGxlSWQpKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBsb2cud2FybihgRXJyb3IgaW5zdGFsbGluZyBhcHAgJyR7YXBwfSc6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gICAgICAgIGlmIChlcnIgaW5zdGFuY2VvZiBCLlRpbWVvdXRFcnJvcikge1xuICAgICAgICAgIGxvZy53YXJuKGBDb25zaWRlciBpbmNyZWFzaW5nIHRoZSB2YWx1ZSBvZiAnYXBwUHVzaFRpbWVvdXQnIGNhcGFiaWxpdHlgKTtcbiAgICAgICAgfVxuICAgICAgICBsb2cud2FybihgRmFsbGluZyBiYWNrIHRvICcke0lPU19ERVBMT1l9JyB1c2FnZWApO1xuICAgICAgICB0cnkge1xuICAgICAgICAgIGF3YWl0IGluc3RhbGxXaXRoSW9zRGVwbG95KCk7XG4gICAgICAgIH0gY2F0Y2ggKGVycjEpIHtcbiAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYENvdWxkIG5vdCBpbnN0YWxsICcke2FwcH0nOlxcbmAgK1xuICAgICAgICAgICAgYCAgLSAke2Vyci5tZXNzYWdlfVxcbmAgK1xuICAgICAgICAgICAgYCAgLSAke2VycjEubWVzc2FnZX1gKTtcbiAgICAgICAgfVxuICAgICAgfSBmaW5hbGx5IHtcbiAgICAgICAgYWZjU2VydmljZS5jbG9zZSgpO1xuICAgICAgfVxuICAgIH1cbiAgICBsb2cuaW5mbyhgQXBwIGluc3RhbGxhdGlvbiBzdWNjZWVkZWQgYWZ0ZXIgJHt0aW1lci5nZXREdXJhdGlvbigpLmFzTWlsbGlTZWNvbmRzLnRvRml4ZWQoMCl9bXNgKTtcbiAgfVxuXG4gIGFzeW5jIGluc3RhbGxPclVwZ3JhZGVBcHBsaWNhdGlvbiAoYnVuZGxlUGF0aE9uUGhvbmUsIGlzVXBncmFkZSA9IGZhbHNlKSB7XG4gICAgY29uc3Qgbm90aWZpY2F0aW9uU2VydmljZSA9IGF3YWl0IHNlcnZpY2VzLnN0YXJ0Tm90aWZpY2F0aW9uUHJveHlTZXJ2aWNlKHRoaXMudWRpZCk7XG4gICAgY29uc3QgaW5zdGFsbGF0aW9uU2VydmljZSA9IGF3YWl0IHNlcnZpY2VzLnN0YXJ0SW5zdGFsbGF0aW9uUHJveHlTZXJ2aWNlKHRoaXMudWRpZCk7XG4gICAgY29uc3QgYXBwSW5zdGFsbGVkTm90aWZpY2F0aW9uID0gbmV3IEIoKHJlc29sdmUpID0+IHtcbiAgICAgIG5vdGlmaWNhdGlvblNlcnZpY2Uub2JzZXJ2ZU5vdGlmaWNhdGlvbihBUFBMSUNBVElPTl9JTlNUQUxMRURfTk9USUZJQ0FUSU9OLCB7XG4gICAgICAgIG5vdGlmaWNhdGlvbjogcmVzb2x2ZVxuICAgICAgfSk7XG4gICAgfSk7XG4gICAgY29uc3QgY2xpZW50T3B0aW9ucyA9IHtQYWNrYWdlVHlwZTogJ0RldmVsb3Blcid9O1xuICAgIHRyeSB7XG4gICAgICBpZiAoaXNVcGdyYWRlKSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgQW4gdXBncmFkZSBvZiB0aGUgZXhpc3RpbmcgYXBwbGljYXRpb24gaXMgZ29pbmcgdG8gYmUgcGVyZm9ybWVkYCk7XG4gICAgICAgIGF3YWl0IGluc3RhbGxhdGlvblNlcnZpY2UudXBncmFkZUFwcGxpY2F0aW9uKGJ1bmRsZVBhdGhPblBob25lLCBjbGllbnRPcHRpb25zKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgQSBuZXcgYXBwbGljYXRpb24gaW5zdGFsbGF0aW9uIGlzIGdvaW5nIHRvIGJlIHBlcmZvcm1lZGApO1xuICAgICAgICBhd2FpdCBpbnN0YWxsYXRpb25TZXJ2aWNlLmluc3RhbGxBcHBsaWNhdGlvbihidW5kbGVQYXRoT25QaG9uZSwgY2xpZW50T3B0aW9ucyk7XG4gICAgICB9XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBhcHBJbnN0YWxsZWROb3RpZmljYXRpb24udGltZW91dChBUFBMSUNBVElPTl9OT1RJRklDQVRJT05fVElNRU9VVF9NUyxcbiAgICAgICAgICBgQ291bGQgbm90IGdldCB0aGUgYXBwbGljYXRpb24gaW5zdGFsbGVkIG5vdGlmaWNhdGlvbiB3aXRoaW4gYCArXG4gICAgICAgICAgYCR7QVBQTElDQVRJT05fTk9USUZJQ0FUSU9OX1RJTUVPVVRfTVN9bXMgYnV0IHdlIHdpbGwgY29udGludWVgKTtcbiAgICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgICAgbG9nLndhcm4oYEZhaWxlZCB0byByZWNlaXZlIHRoZSBub3RpZmljYXRpb24uIEVycm9yOiAke2UubWVzc2FnZX1gKTtcbiAgICAgIH1cbiAgICB9IGZpbmFsbHkge1xuICAgICAgaW5zdGFsbGF0aW9uU2VydmljZS5jbG9zZSgpO1xuICAgICAgbm90aWZpY2F0aW9uU2VydmljZS5jbG9zZSgpO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGluc3RhbGxBcHAgKC4uLmFyZ3MpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy5pbnN0YWxsKC4uLmFyZ3MpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJldHVybiBhbiBhcHBsaWNhdGlvbiBvYmplY3QgaWYgdGVzdCBhcHAgaGFzICdidW5kbGVpZCcuXG4gICAqIFRoZSB0YXJnZXQgYnVuZGxlaWQgY2FuIGJlIFVzZXIgYW5kIFN5c3RlbSBhcHBzLlxuICAgKiBAcGFyYW0ge3N0cmluZ30gYnVuZGxlaWQgVGhlIGJ1bmRsZUlkIHRvIGVuc3VyZSBpdCBpcyBpbnN0YWxsZWRcbiAgICogQHJldHVybiB7Ym9vbGVhbn0gUmV0dXJucyBUcnVlIGlmIHRoZSBidW5kbGVpZCBleGlzdHMgaW4gdGhlIHJlc3VsdCBvZiAnbGlzdEFwcGxpY2F0aW9ucycgbGlrZTpcbiAgICogeyBcImNvbS5hcHBsZS5QcmVmZXJlbmNlc1wiOntcbiAgICogICBcIlVJUmVxdWlyZWREZXZpY2VDYXBhYmlsaXRpZXNcIjpbXCJhcm02NFwiXSxcbiAgICogICBcIlVJUmVxdWlyZXNGdWxsU2NyZWVuXCI6dHJ1ZSxcbiAgICogICBcIkNGQnVuZGxlSW5mb0RpY3Rpb25hcnlWZXJzaW9uXCI6XCI2LjBcIixcbiAgICogICBcIkVudGl0bGVtZW50c1wiOlxuICAgKiAgICAge1wiY29tLmFwcGxlLmZyb250Ym9hcmQuZGVsZXRlLWFwcGxpY2F0aW9uLXNuYXBzaG90c1wiOnRydWUsLi5cbiAgICovXG4gIGFzeW5jIGlzQXBwSW5zdGFsbGVkIChidW5kbGVpZCkge1xuICAgIGNvbnN0IHNlcnZpY2UgPSBhd2FpdCBzZXJ2aWNlcy5zdGFydEluc3RhbGxhdGlvblByb3h5U2VydmljZSh0aGlzLnVkaWQpO1xuICAgIHRyeSB7XG4gICAgICBjb25zdCBhcHBsaWNhdGlvbnMgPSBhd2FpdCBzZXJ2aWNlLmxvb2t1cEFwcGxpY2F0aW9ucyh7IGJ1bmRsZUlkczogYnVuZGxlaWQgfSk7XG4gICAgICByZXR1cm4gISFhcHBsaWNhdGlvbnNbYnVuZGxlaWRdO1xuICAgIH0gZmluYWxseSB7XG4gICAgICBzZXJ2aWNlLmNsb3NlKCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBidW5kbGVOYW1lIFRoZSBuYW1lIG9mIENGQnVuZGxlTmFtZSBpbiBJbmZvLnBsaXN0XG4gICAqXG4gICAqIEByZXR1cm5zIHtBcnJheTxzdHJpbmc+fSBBIGxpc3Qgb2YgVXNlciBsZXZlbCBhcHBzJyBidW5kbGUgaWRzIHdoaWNoIGhhc1xuICAgKiAgICAgICAgICAgICAgICAgICAgICAgICAgJ0NGQnVuZGxlTmFtZScgYXR0cmlidXRlIGFzICdidW5kbGVOYW1lJy5cbiAgICovXG4gIGFzeW5jIGdldFVzZXJJbnN0YWxsZWRCdW5kbGVJZHNCeUJ1bmRsZU5hbWUgKGJ1bmRsZU5hbWUpIHtcbiAgICBjb25zdCBzZXJ2aWNlID0gYXdhaXQgc2VydmljZXMuc3RhcnRJbnN0YWxsYXRpb25Qcm94eVNlcnZpY2UodGhpcy51ZGlkKTtcbiAgICB0cnkge1xuICAgICAgY29uc3QgYXBwbGljYXRpb25zID0gYXdhaXQgc2VydmljZS5saXN0QXBwbGljYXRpb25zKHthcHBsaWNhdGlvblR5cGU6ICdVc2VyJ30pO1xuICAgICAgcmV0dXJuIF8ucmVkdWNlKGFwcGxpY2F0aW9ucywgKGFjYywge0NGQnVuZGxlTmFtZX0sIGtleSkgPT4ge1xuICAgICAgICBpZiAoQ0ZCdW5kbGVOYW1lID09PSBidW5kbGVOYW1lKSB7XG4gICAgICAgICAgYWNjLnB1c2goa2V5KTtcbiAgICAgICAgfVxuICAgICAgICByZXR1cm4gYWNjO1xuICAgICAgfSwgW10pO1xuICAgIH0gZmluYWxseSB7XG4gICAgICBzZXJ2aWNlLmNsb3NlKCk7XG4gICAgfVxuICB9XG5cbiAgYXN5bmMgZ2V0UGxhdGZvcm1WZXJzaW9uICgpIHtcbiAgICByZXR1cm4gYXdhaXQgdXRpbGl0aWVzLmdldE9TVmVyc2lvbih0aGlzLnVkaWQpO1xuICB9XG59XG5cbmV4cG9y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
