"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.helpers = exports.default = void 0;

require("source-map-support/register");

var _baseDriver = require("@appium/base-driver");

var _bluebird = _interopRequireDefault(require("bluebird"));

const GET = 'GET';
const POST = 'POST';
const DELETE = 'DELETE';
const SUPPORTED_METHODS = [GET, POST, DELETE];
let helpers = {},
    extensions = {};
exports.helpers = helpers;
const WDA_ROUTES = {
  '/wda/touch/perform': {
    POST: 'performTouch'
  },
  '/wda/touch/multi/perform': {
    POST: 'performMultiAction'
  },
  '/wda/screen': {
    GET: 'getScreenInfo'
  },
  '/wda/alert/buttons': {
    GET: 'getAlertButtons'
  },
  '/wda/apps/launch': {
    POST: 'mobileLaunchApp'
  },
  '/wda/apps/terminate': {
    POST: 'mobileTerminateApp'
  },
  '/wda/apps/activate': {
    POST: 'mobileActivateApp'
  },
  '/wda/apps/state': {
    POST: 'mobileQueryAppState'
  },
  '/wda/keys': {
    POST: 'keys'
  },
  '/wda/touch_id': {
    POST: 'touchId'
  },
  '/wda/keyboard/dismiss': {
    POST: 'hideKeyboard'
  },
  '/wda/lock': {
    POST: 'lock'
  },
  '/wda/unlock': {
    POST: 'unlock'
  },
  '/wda/locked': {
    GET: 'isLocked'
  },
  '/wda/tap/nil': {
    POST: 'clickCoords'
  },
  '/window/size': {
    GET: 'getWindowSize'
  }
};

function wdaRouteToCommandName(endpoint, method) {
  return WDA_ROUTES[endpoint] ? WDA_ROUTES[endpoint][method] : null;
}

helpers.proxyCommand = async function proxyCommand(endpoint, method, body, isSessionCommand = true) {
  if (this.shutdownUnexpectedly) {
    return;
  }

  if (!endpoint) {
    this.log.errorAndThrow('Proxying requires an endpoint');
  } else if (!SUPPORTED_METHODS.includes(method)) {
    this.log.errorAndThrow(`Proxying only works for the following requests: ${SUPPORTED_METHODS.join(', ')}`);
  }

  if (!this.wda) {
    throw new Error('Cannot call proxyCommand without WDA driver active');
  }

  const proxy = isSessionCommand ? this.wda.jwproxy : this.wda.noSessionProxy;

  if (!proxy) {
    throw new Error('Cannot call proxyCommand without WDA proxy active');
  }

  let cmdName = wdaRouteToCommandName(endpoint, method) || (0, _baseDriver.routeToCommandName)(endpoint, method);

  const timeout = this._getCommandTimeout(cmdName);

  if (!cmdName) {
    cmdName = 'Unknown';
    this.log.info(`Proxying to WDA with an unknown route: ${method} ${endpoint}`);
  }

  if (!timeout) {
    return await proxy.command(endpoint, method, body);
  }

  this.log.debug(`Setting custom timeout to ${timeout} ms for '${cmdName}' command`);
  let isCommandExpired = false;
  const res = await _bluebird.default.resolve(proxy.command(endpoint, method, body)).timeout(timeout).catch(_bluebird.default.Promise.TimeoutError, () => {
    isCommandExpired = true;
  });

  if (isCommandExpired) {
    proxy.cancelActiveRequests();
    const errMsg = `Appium did not get any response from '${cmdName}' command in ${timeout} ms`;
    await this.startUnexpectedShutdown(new _baseDriver.errors.TimeoutError(errMsg));
    this.log.errorAndThrow(errMsg);
  }

  return res;
};

Object.assign(extensions, helpers);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibGliL2NvbW1hbmRzL3Byb3h5LWhlbHBlci5qcyIsIm5hbWVzIjpbIkdFVCIsIlBPU1QiLCJERUxFVEUiLCJTVVBQT1JURURfTUVUSE9EUyIsImhlbHBlcnMiLCJleHRlbnNpb25zIiwiV0RBX1JPVVRFUyIsIndkYVJvdXRlVG9Db21tYW5kTmFtZSIsImVuZHBvaW50IiwibWV0aG9kIiwicHJveHlDb21tYW5kIiwiYm9keSIsImlzU2Vzc2lvbkNvbW1hbmQiLCJzaHV0ZG93blVuZXhwZWN0ZWRseSIsImxvZyIsImVycm9yQW5kVGhyb3ciLCJpbmNsdWRlcyIsImpvaW4iLCJ3ZGEiLCJFcnJvciIsInByb3h5Iiwiandwcm94eSIsIm5vU2Vzc2lvblByb3h5IiwiY21kTmFtZSIsInJvdXRlVG9Db21tYW5kTmFtZSIsInRpbWVvdXQiLCJfZ2V0Q29tbWFuZFRpbWVvdXQiLCJpbmZvIiwiY29tbWFuZCIsImRlYnVnIiwiaXNDb21tYW5kRXhwaXJlZCIsInJlcyIsIkIiLCJyZXNvbHZlIiwiY2F0Y2giLCJQcm9taXNlIiwiVGltZW91dEVycm9yIiwiY2FuY2VsQWN0aXZlUmVxdWVzdHMiLCJlcnJNc2ciLCJzdGFydFVuZXhwZWN0ZWRTaHV0ZG93biIsImVycm9ycyIsIk9iamVjdCIsImFzc2lnbiJdLCJzb3VyY2VSb290IjoiLi4vLi4vLi4iLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9wcm94eS1oZWxwZXIuanMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgZXJyb3JzLCByb3V0ZVRvQ29tbWFuZE5hbWUgfSBmcm9tICdAYXBwaXVtL2Jhc2UtZHJpdmVyJztcbmltcG9ydCBCIGZyb20gJ2JsdWViaXJkJztcblxuXG5jb25zdCBHRVQgPSAnR0VUJztcbmNvbnN0IFBPU1QgPSAnUE9TVCc7XG5jb25zdCBERUxFVEUgPSAnREVMRVRFJztcbmNvbnN0IFNVUFBPUlRFRF9NRVRIT0RTID0gW0dFVCwgUE9TVCwgREVMRVRFXTtcblxubGV0IGhlbHBlcnMgPSB7fSwgZXh0ZW5zaW9ucyA9IHt9O1xuXG5jb25zdCBXREFfUk9VVEVTID0ge1xuICAnL3dkYS90b3VjaC9wZXJmb3JtJzoge1xuICAgIFBPU1Q6ICdwZXJmb3JtVG91Y2gnLFxuICB9LFxuICAnL3dkYS90b3VjaC9tdWx0aS9wZXJmb3JtJzoge1xuICAgIFBPU1Q6ICdwZXJmb3JtTXVsdGlBY3Rpb24nLFxuICB9LFxuICAnL3dkYS9zY3JlZW4nOiB7XG4gICAgR0VUOiAnZ2V0U2NyZWVuSW5mbycsXG4gIH0sXG4gICcvd2RhL2FsZXJ0L2J1dHRvbnMnOiB7XG4gICAgR0VUOiAnZ2V0QWxlcnRCdXR0b25zJyxcbiAgfSxcbiAgJy93ZGEvYXBwcy9sYXVuY2gnOiB7XG4gICAgUE9TVDogJ21vYmlsZUxhdW5jaEFwcCcsXG4gIH0sXG4gICcvd2RhL2FwcHMvdGVybWluYXRlJzoge1xuICAgIFBPU1Q6ICdtb2JpbGVUZXJtaW5hdGVBcHAnLFxuICB9LFxuICAnL3dkYS9hcHBzL2FjdGl2YXRlJzoge1xuICAgIFBPU1Q6ICdtb2JpbGVBY3RpdmF0ZUFwcCcsXG4gIH0sXG4gICcvd2RhL2FwcHMvc3RhdGUnOiB7XG4gICAgUE9TVDogJ21vYmlsZVF1ZXJ5QXBwU3RhdGUnLFxuICB9LFxuICAnL3dkYS9rZXlzJzoge1xuICAgIFBPU1Q6ICdrZXlzJyxcbiAgfSxcbiAgJy93ZGEvdG91Y2hfaWQnOiB7XG4gICAgUE9TVDogJ3RvdWNoSWQnLFxuICB9LFxuICAnL3dkYS9rZXlib2FyZC9kaXNtaXNzJzoge1xuICAgIFBPU1Q6ICdoaWRlS2V5Ym9hcmQnLFxuICB9LFxuICAnL3dkYS9sb2NrJzoge1xuICAgIFBPU1Q6ICdsb2NrJyxcbiAgfSxcbiAgJy93ZGEvdW5sb2NrJzoge1xuICAgIFBPU1Q6ICd1bmxvY2snLFxuICB9LFxuICAnL3dkYS9sb2NrZWQnOiB7XG4gICAgR0VUOiAnaXNMb2NrZWQnLFxuICB9LFxuICAnL3dkYS90YXAvbmlsJzoge1xuICAgIFBPU1Q6ICdjbGlja0Nvb3JkcycsXG4gIH0sXG4gICcvd2luZG93L3NpemUnOiB7XG4gICAgR0VUOiAnZ2V0V2luZG93U2l6ZScsXG4gIH0sXG59O1xuXG5mdW5jdGlvbiB3ZGFSb3V0ZVRvQ29tbWFuZE5hbWUgKGVuZHBvaW50LCBtZXRob2QpIHtcbiAgcmV0dXJuIFdEQV9ST1VURVNbZW5kcG9pbnRdID8gV0RBX1JPVVRFU1tlbmRwb2ludF1bbWV0aG9kXSA6IG51bGw7XG59XG5cbmhlbHBlcnMucHJveHlDb21tYW5kID0gYXN5bmMgZnVuY3Rpb24gcHJveHlDb21tYW5kIChlbmRwb2ludCwgbWV0aG9kLCBib2R5LCBpc1Nlc3Npb25Db21tYW5kID0gdHJ1ZSkge1xuICBpZiAodGhpcy5zaHV0ZG93blVuZXhwZWN0ZWRseSkge1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGlmICghZW5kcG9pbnQpIHtcbiAgICB0aGlzLmxvZy5lcnJvckFuZFRocm93KCdQcm94eWluZyByZXF1aXJlcyBhbiBlbmRwb2ludCcpO1xuICB9IGVsc2UgaWYgKCFTVVBQT1JURURfTUVUSE9EUy5pbmNsdWRlcyhtZXRob2QpKSB7XG4gICAgdGhpcy5sb2cuZXJyb3JBbmRUaHJvdyhgUHJveHlpbmcgb25seSB3b3JrcyBmb3IgdGhlIGZvbGxvd2luZyByZXF1ZXN0czogJHtTVVBQT1JURURfTUVUSE9EUy5qb2luKCcsICcpfWApO1xuICB9XG5cbiAgaWYgKCF0aGlzLndkYSkge1xuICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IGNhbGwgcHJveHlDb21tYW5kIHdpdGhvdXQgV0RBIGRyaXZlciBhY3RpdmUnKTtcbiAgfVxuICBjb25zdCBwcm94eSA9IGlzU2Vzc2lvbkNvbW1hbmQgPyB0aGlzLndkYS5qd3Byb3h5IDogdGhpcy53ZGEubm9TZXNzaW9uUHJveHk7XG4gIGlmICghcHJveHkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0Nhbm5vdCBjYWxsIHByb3h5Q29tbWFuZCB3aXRob3V0IFdEQSBwcm94eSBhY3RpdmUnKTtcbiAgfVxuXG4gIGxldCBjbWROYW1lID0gd2RhUm91dGVUb0NvbW1hbmROYW1lKGVuZHBvaW50LCBtZXRob2QpIHx8IHJvdXRlVG9Db21tYW5kTmFtZShlbmRwb2ludCwgbWV0aG9kKTtcbiAgY29uc3QgdGltZW91dCA9IHRoaXMuX2dldENvbW1hbmRUaW1lb3V0KGNtZE5hbWUpO1xuICBpZiAoIWNtZE5hbWUpIHtcbiAgICAvLyB0aGlzIHNob3VsZCBuZXZlciBoYXBwZW4gZXhjZXB0IHdoZW4gYWRkaW5nIG5ldyByb3V0ZXNcbiAgICBjbWROYW1lID0gJ1Vua25vd24nOyAvLyBqdXN0IGZvciBsb2dnaW5nIHB1cnBvc2VzIGJlbG93XG4gICAgdGhpcy5sb2cuaW5mbyhgUHJveHlpbmcgdG8gV0RBIHdpdGggYW4gdW5rbm93biByb3V0ZTogJHttZXRob2R9ICR7ZW5kcG9pbnR9YCk7XG4gIH1cblxuICBpZiAoIXRpbWVvdXQpIHtcbiAgICByZXR1cm4gYXdhaXQgcHJveHkuY29tbWFuZChlbmRwb2ludCwgbWV0aG9kLCBib2R5KTtcbiAgfVxuXG4gIHRoaXMubG9nLmRlYnVnKGBTZXR0aW5nIGN1c3RvbSB0aW1lb3V0IHRvICR7dGltZW91dH0gbXMgZm9yICcke2NtZE5hbWV9JyBjb21tYW5kYCk7XG4gIGxldCBpc0NvbW1hbmRFeHBpcmVkID0gZmFsc2U7XG4gIGNvbnN0IHJlcyA9IGF3YWl0IEIucmVzb2x2ZShwcm94eS5jb21tYW5kKGVuZHBvaW50LCBtZXRob2QsIGJvZHkpKVxuICAgICAgICAgICAgICAgIC50aW1lb3V0KHRpbWVvdXQpXG4gICAgICAgICAgICAgICAgLmNhdGNoKEIuUHJvbWlzZS5UaW1lb3V0RXJyb3IsICgpID0+IHtcbiAgICAgICAgICAgICAgICAgIGlzQ29tbWFuZEV4cGlyZWQgPSB0cnVlO1xuICAgICAgICAgICAgICAgIH0pO1xuICBpZiAoaXNDb21tYW5kRXhwaXJlZCkge1xuICAgIHByb3h5LmNhbmNlbEFjdGl2ZVJlcXVlc3RzKCk7XG4gICAgY29uc3QgZXJyTXNnID0gYEFwcGl1bSBkaWQgbm90IGdldCBhbnkgcmVzcG9uc2UgZnJvbSAnJHtjbWROYW1lfScgY29tbWFuZCBpbiAke3RpbWVvdXR9IG1zYDtcbiAgICBhd2FpdCB0aGlzLnN0YXJ0VW5leHBlY3RlZFNodXRkb3duKG5ldyBlcnJvcnMuVGltZW91dEVycm9yKGVyck1zZykpO1xuICAgIHRoaXMubG9nLmVycm9yQW5kVGhyb3coZXJyTXNnKTtcbiAgfVxuICByZXR1cm4gcmVzO1xufTtcblxuT2JqZWN0LmFzc2lnbihleHRlbnNpb25zLCBoZWxwZXJzKTtcbmV4cG9ydCB7IGhlbHBlcnMgfTtcbmV4cG9ydCBkZWZhdWx0IGV4dGVuc2lvbnM7XG4iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBR0EsTUFBTUEsR0FBRyxHQUFHLEtBQVo7QUFDQSxNQUFNQyxJQUFJLEdBQUcsTUFBYjtBQUNBLE1BQU1DLE1BQU0sR0FBRyxRQUFmO0FBQ0EsTUFBTUMsaUJBQWlCLEdBQUcsQ0FBQ0gsR0FBRCxFQUFNQyxJQUFOLEVBQVlDLE1BQVosQ0FBMUI7QUFFQSxJQUFJRSxPQUFPLEdBQUcsRUFBZDtBQUFBLElBQWtCQyxVQUFVLEdBQUcsRUFBL0I7O0FBRUEsTUFBTUMsVUFBVSxHQUFHO0VBQ2pCLHNCQUFzQjtJQUNwQkwsSUFBSSxFQUFFO0VBRGMsQ0FETDtFQUlqQiw0QkFBNEI7SUFDMUJBLElBQUksRUFBRTtFQURvQixDQUpYO0VBT2pCLGVBQWU7SUFDYkQsR0FBRyxFQUFFO0VBRFEsQ0FQRTtFQVVqQixzQkFBc0I7SUFDcEJBLEdBQUcsRUFBRTtFQURlLENBVkw7RUFhakIsb0JBQW9CO0lBQ2xCQyxJQUFJLEVBQUU7RUFEWSxDQWJIO0VBZ0JqQix1QkFBdUI7SUFDckJBLElBQUksRUFBRTtFQURlLENBaEJOO0VBbUJqQixzQkFBc0I7SUFDcEJBLElBQUksRUFBRTtFQURjLENBbkJMO0VBc0JqQixtQkFBbUI7SUFDakJBLElBQUksRUFBRTtFQURXLENBdEJGO0VBeUJqQixhQUFhO0lBQ1hBLElBQUksRUFBRTtFQURLLENBekJJO0VBNEJqQixpQkFBaUI7SUFDZkEsSUFBSSxFQUFFO0VBRFMsQ0E1QkE7RUErQmpCLHlCQUF5QjtJQUN2QkEsSUFBSSxFQUFFO0VBRGlCLENBL0JSO0VBa0NqQixhQUFhO0lBQ1hBLElBQUksRUFBRTtFQURLLENBbENJO0VBcUNqQixlQUFlO0lBQ2JBLElBQUksRUFBRTtFQURPLENBckNFO0VBd0NqQixlQUFlO0lBQ2JELEdBQUcsRUFBRTtFQURRLENBeENFO0VBMkNqQixnQkFBZ0I7SUFDZEMsSUFBSSxFQUFFO0VBRFEsQ0EzQ0M7RUE4Q2pCLGdCQUFnQjtJQUNkRCxHQUFHLEVBQUU7RUFEUztBQTlDQyxDQUFuQjs7QUFtREEsU0FBU08scUJBQVQsQ0FBZ0NDLFFBQWhDLEVBQTBDQyxNQUExQyxFQUFrRDtFQUNoRCxPQUFPSCxVQUFVLENBQUNFLFFBQUQsQ0FBVixHQUF1QkYsVUFBVSxDQUFDRSxRQUFELENBQVYsQ0FBcUJDLE1BQXJCLENBQXZCLEdBQXNELElBQTdEO0FBQ0Q7O0FBRURMLE9BQU8sQ0FBQ00sWUFBUixHQUF1QixlQUFlQSxZQUFmLENBQTZCRixRQUE3QixFQUF1Q0MsTUFBdkMsRUFBK0NFLElBQS9DLEVBQXFEQyxnQkFBZ0IsR0FBRyxJQUF4RSxFQUE4RTtFQUNuRyxJQUFJLEtBQUtDLG9CQUFULEVBQStCO0lBQzdCO0VBQ0Q7O0VBRUQsSUFBSSxDQUFDTCxRQUFMLEVBQWU7SUFDYixLQUFLTSxHQUFMLENBQVNDLGFBQVQsQ0FBdUIsK0JBQXZCO0VBQ0QsQ0FGRCxNQUVPLElBQUksQ0FBQ1osaUJBQWlCLENBQUNhLFFBQWxCLENBQTJCUCxNQUEzQixDQUFMLEVBQXlDO0lBQzlDLEtBQUtLLEdBQUwsQ0FBU0MsYUFBVCxDQUF3QixtREFBa0RaLGlCQUFpQixDQUFDYyxJQUFsQixDQUF1QixJQUF2QixDQUE2QixFQUF2RztFQUNEOztFQUVELElBQUksQ0FBQyxLQUFLQyxHQUFWLEVBQWU7SUFDYixNQUFNLElBQUlDLEtBQUosQ0FBVSxvREFBVixDQUFOO0VBQ0Q7O0VBQ0QsTUFBTUMsS0FBSyxHQUFHUixnQkFBZ0IsR0FBRyxLQUFLTSxHQUFMLENBQVNHLE9BQVosR0FBc0IsS0FBS0gsR0FBTCxDQUFTSSxjQUE3RDs7RUFDQSxJQUFJLENBQUNGLEtBQUwsRUFBWTtJQUNWLE1BQU0sSUFBSUQsS0FBSixDQUFVLG1EQUFWLENBQU47RUFDRDs7RUFFRCxJQUFJSSxPQUFPLEdBQUdoQixxQkFBcUIsQ0FBQ0MsUUFBRCxFQUFXQyxNQUFYLENBQXJCLElBQTJDLElBQUFlLDhCQUFBLEVBQW1CaEIsUUFBbkIsRUFBNkJDLE1BQTdCLENBQXpEOztFQUNBLE1BQU1nQixPQUFPLEdBQUcsS0FBS0Msa0JBQUwsQ0FBd0JILE9BQXhCLENBQWhCOztFQUNBLElBQUksQ0FBQ0EsT0FBTCxFQUFjO0lBRVpBLE9BQU8sR0FBRyxTQUFWO0lBQ0EsS0FBS1QsR0FBTCxDQUFTYSxJQUFULENBQWUsMENBQXlDbEIsTUFBTyxJQUFHRCxRQUFTLEVBQTNFO0VBQ0Q7O0VBRUQsSUFBSSxDQUFDaUIsT0FBTCxFQUFjO0lBQ1osT0FBTyxNQUFNTCxLQUFLLENBQUNRLE9BQU4sQ0FBY3BCLFFBQWQsRUFBd0JDLE1BQXhCLEVBQWdDRSxJQUFoQyxDQUFiO0VBQ0Q7O0VBRUQsS0FBS0csR0FBTCxDQUFTZSxLQUFULENBQWdCLDZCQUE0QkosT0FBUSxZQUFXRixPQUFRLFdBQXZFO0VBQ0EsSUFBSU8sZ0JBQWdCLEdBQUcsS0FBdkI7RUFDQSxNQUFNQyxHQUFHLEdBQUcsTUFBTUMsaUJBQUEsQ0FBRUMsT0FBRixDQUFVYixLQUFLLENBQUNRLE9BQU4sQ0FBY3BCLFFBQWQsRUFBd0JDLE1BQXhCLEVBQWdDRSxJQUFoQyxDQUFWLEVBQ0hjLE9BREcsQ0FDS0EsT0FETCxFQUVIUyxLQUZHLENBRUdGLGlCQUFBLENBQUVHLE9BQUYsQ0FBVUMsWUFGYixFQUUyQixNQUFNO0lBQ25DTixnQkFBZ0IsR0FBRyxJQUFuQjtFQUNELENBSkcsQ0FBbEI7O0VBS0EsSUFBSUEsZ0JBQUosRUFBc0I7SUFDcEJWLEtBQUssQ0FBQ2lCLG9CQUFOO0lBQ0EsTUFBTUMsTUFBTSxHQUFJLHlDQUF3Q2YsT0FBUSxnQkFBZUUsT0FBUSxLQUF2RjtJQUNBLE1BQU0sS0FBS2MsdUJBQUwsQ0FBNkIsSUFBSUMsa0JBQUEsQ0FBT0osWUFBWCxDQUF3QkUsTUFBeEIsQ0FBN0IsQ0FBTjtJQUNBLEtBQUt4QixHQUFMLENBQVNDLGFBQVQsQ0FBdUJ1QixNQUF2QjtFQUNEOztFQUNELE9BQU9QLEdBQVA7QUFDRCxDQTdDRDs7QUErQ0FVLE1BQU0sQ0FBQ0MsTUFBUCxDQUFjckMsVUFBZCxFQUEwQkQsT0FBMUI7ZUFFZUMsVSJ9
